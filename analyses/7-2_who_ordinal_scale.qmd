---
title: "7-2 WHO 8-point Outcome Scale"
description: |
  Working analyses of the WHO 8-point outcome scale outcome.
author: "James Totterdell"
date: last-modified
---

# Preamble {#preamble}

```{r}
#| label: pkgs
#| code-summary: Load packages
library(tidyverse)
library(labelled)
library(kableExtra)
library(cmdstanr)
library(posterior)
library(bayestestR)
library(bayesplot)
library(matrixStats)
library(ggdist)
library(patchwork)
library(lubridate)

theme_set(theme_classic(base_size = 10, base_family = "Palatino") +
  theme(panel.grid = element_blank(),
        strip.background = element_blank()))
bayesplot_theme_set(theme_set(theme_classic(base_size = 10, base_family = "Palatino") +
  theme(panel.grid = element_blank(),
        strip.background = element_blank())))
```

```{r}
logit <- function(x) log(x) - log(1 - x)
expit <- function(x) 1 / (1 + exp(-x))
ordered_logit <- function(x) {
  c(
    1 - expit(-x[1]),
    expit(-x[1:(length(x)-1)]) - expit(-x[2:(length(x))]),
    expit(-tail(x, 1))
  )
}
```

```{r}
#| label: data
#| code-summary: Prepare dataset
devtools::load_all()
all_dat <- read_all_no_daily()

acs_itt_dat <- all_dat %>% 
  filter_acs_itt() %>%
  transmute_model_cols() %>%
  left_join(
    all_dat %>% 
      select(
        StudyPatientID, 
        D28_who,
        D28_death),
    by = "StudyPatientID")
acs_itt_nona_dat <- acs_itt_dat %>%
  filter(!is.na(D28_who))
```

# Descriptive {#descriptive}

## Age

```{r}
#| label: fig-who-dist-age
#| fig-cap: |
#|   Distribution of days alive and free of hospital by age group
#| fig-height: 4
pdat <- all_dat %>%
  filter_acs_itt() %>%
  filter(!is.na(D28_who)) %>%
  dplyr::count(
    agegrp = cut(AgeAtEntry, c(18, seq(25, 75, 5), 100), include.lowest = T, right = F),
    who = ordered(D28_who, levels = 1:8), 
    .drop = F) %>%
  group_by(agegrp) %>%
  mutate(p = n / sum(n))
pdat2 <- pdat %>%
  group_by(agegrp) %>%
  summarise(n = sum(n))

p1 <- ggplot(pdat2, aes(agegrp, n)) +
  geom_col(colour = "grey40", fill = "grey40") +
  geom_vline(xintercept = 60, linetype = 2) +
  labs(y = "Number of\nparticipants",
       x = "Age at entry") +
  geom_vline(xintercept = 8.5, linetype = 2) +
  theme(axis.text.x = element_text(hjust = 1, angle = 45))

p2 <- ggplot(pdat, aes(agegrp, p)) +
  geom_col(aes(fill = who)) +
  labs(x = "Age", y = "Cumulative\nproportion") +
  scale_fill_viridis_d("WHO scale", option = "A", direction = -1) +
  guides(fill = guide_legend(reverse = F)) +
  geom_vline(xintercept = 8.5, linetype = 2) +
  theme(axis.text.x = element_text(hjust = 1, angle = 45)) +
  theme(legend.key.size = unit(0.5, "lines"))
p <- p1 | p2
```

```{r}
path <- file.path("outputs", "figures", "outcomes", "secondary")
ggsave(file.path(path, "7-2-age.pdf"), p, height = 2.5, width = 6)
```

## Country

```{r}
#| label: fig-dafh-dist-country
#| fig-cap: |
#|   Distribution of days alive and free of hospital by country.
#| fig-height: 4
pdat <- all_dat %>%
  filter_acs_itt() %>%
  filter(!is.na(D28_who)) %>%
  dplyr::count(
    Country = factor(PT_CountryName, levels = c("India", "Australia", "Nepal", "New Zealand"),
                     labels = c("India", "Australia", "Nepal", "New\nZealand")),
    who = ordered(D28_who, levels = 1:8), 
    .drop = F) %>%
  group_by(Country) %>%
  mutate(p = n / sum(n)) %>%
  mutate(cp = cumsum(p)) %>%
  ungroup()
pdat2 <- pdat %>%
  group_by(Country) %>%
  summarise(n = sum(n))

p1 <- ggplot(pdat2, aes(Country, n)) +
  geom_col() +
    labs(
      y = "Number of\nparticipants", 
      x = "Country of enrolment")

p2 <- ggplot(pdat, aes(Country, p)) +
  geom_col(aes(fill = who)) +
  labs(x = "Anticoagulation intervention", y = "Cumulative\nproportion") +
  scale_fill_viridis_d("WHO scale", option = "A", direction = -1) +
  guides(fill = guide_legend(reverse = F)) +
  theme(legend.key.size = unit(0.5, "lines"))
p <- p1 | p2
```

```{r}
path <- file.path("outputs", "figures", "outcomes", "secondary")
ggsave(file.path(path, "7-2-country.pdf"), p, height = 2.5, width = 6)
```

## Site

```{r}
#| label: fig-who-dist-site
#| fig-cap: |
#|   Distribution of WHO scale by study site
#| fig-height: 4
pdat <- all_dat %>%
  filter_acs_itt() %>%
  filter(!is.na(D28_who)) %>%
  dplyr::count(
    Country = factor(PT_CountryName, levels = c("India", "Australia", "Nepal", "New Zealand"),
                     labels = c("India", "Australia", "Nepal", "New\nZealand")),
    Site = fct_infreq(Location),
    who = ordered(D28_who, levels = 1:8)) %>%
  complete(who = ordered(1:8), nesting(Country, Site), fill = list(n = 0)) %>%
  group_by(Country, Site) %>%
  mutate(p = n / sum(n)) %>%
  mutate(cp = cumsum(p)) %>%
  ungroup() %>%
  mutate(
    Country = droplevels(Country),
    Site = droplevels(Site)
  )
pdat2 <- pdat %>%
  group_by(Country, Site) %>%
  summarise(n = sum(n)) %>%
  ungroup()

p1 <- ggplot(pdat2, aes(Site, n)) +
  facet_grid( ~ Country, scales = "free_x", space = "free_x") +
  geom_col() +
    labs(
      y = "Number of\nparticipants", 
      x = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.border = element_rect(fill = NA))

p2 <- ggplot(pdat, aes(Site, p)) +
  facet_grid( ~ Country, scales = "free_x", space = "free_x") +
  geom_col(aes(fill = who)) +
  labs(x = "Anticoagulation intervention", y = "Cumulative\nproportion") +
  scale_fill_viridis_d("DAFH", option = "A", direction = -1) +
  guides(fill = guide_legend(reverse = F, ncol = 1)) +
  theme(axis.text.x = element_text(hjust = 1, angle = 45)) +
  theme(legend.key.size = unit(0.25, "lines"))

p <- p1 / p2 +
  plot_layout(guides = 'collect')
```

```{r}
path <- file.path("outputs", "figures", "outcomes", "secondary")
ggsave(file.path(path, "7-2-country-site.pdf"), p, height = 4, width = 6.25)
```

## Calendar Time

```{r}
#| label: fig-who-dist-calendar
#| fig-cap: |
#|   Distribution of WHO scale by calendar time.
#| fig-height: 4
pdat <- acs_itt_nona_dat %>%
  dplyr::count(
    yr = year(RandDate), mth = month(RandDate),
    who = ordered(D28_who, levels = 1:8), 
    .drop = F) %>%
  group_by(yr, mth) %>%
  mutate(p = n / sum(n)) %>%
  mutate(cp = cumsum(p)) %>%
  ungroup()
p1 <- pdat %>%
  group_by(yr, mth) %>%
  summarise(n = sum(n)) %>%
  ggplot(., aes(mth, n))  +
  facet_grid( ~ yr, drop = T, scales = "free_x", space = "free") +
    geom_col() +
    labs(
      y = "Number of\nparticipants", 
      x = "Calendar date (month of year)") +
  scale_x_continuous(breaks = 1:12)
p2 <- ggplot(pdat, aes(mth, p)) +
  facet_grid( ~ yr, drop = T, scales = "free_x", space = "free") +
  geom_col(aes(fill = who)) +
  labs(x = "Calendar date (month of year)", y = "Cumulative\nproportion") +
  scale_fill_viridis_d("DAFH", option = "A", direction = -1) +
  guides(fill = guide_legend(reverse = F)) +
  theme(legend.key.size = unit(0.5, "lines")) +
  scale_x_continuous(breaks = 1:12)
p <- p1 | p2
p
```

```{r}
path <- file.path("outputs", "figures", "outcomes", "secondary")
ggsave(file.path(path, "7-2-calendar-time.pdf"), p, height = 2, width = 6)
```

## Day 28

```{r}
ovr_counts <- acs_itt_dat %>%
  dplyr::count(D28_who, D28_death) %>%
  mutate(
    p = n / sum(n),
    p_ex_miss = c(n[!is.na(D28_who)] / sum(n * !is.na(D28_who)), NA)
  )
trt_counts <- acs_itt_nona_dat %>%
  dplyr::count(CAssignment, D28_who = factor(as.integer(D28_who))) %>%
  complete(CAssignment, D28_who, fill = list(n = 0)) %>%
  group_by(CAssignment) %>%
  mutate(p = n / sum(n))
ovr_counts
```

```{r}
acs_itt_dat %>%
  dplyr::count(CAssignment, D28_who, D28_death) %>%
  spread(CAssignment, n, fill = 0)
```

```{r}
p <- acs_itt_nona_dat %>%
  dplyr::count(
    CAssignment = factor(CAssignment, labels = str_replace(intervention_labels()$CAssignment[-1], "<br>", "\n")), 
    D28_who = ordered(as.integer(D28_who), levels = 1:8)
  ) %>%
  group_by(CAssignment) %>%
  mutate(p = n / sum(n)) %>%
  ggplot(., aes(CAssignment, p)) +
  geom_col(aes(fill = D28_who)) +
  scale_fill_viridis_d(option = "A", direction = -1) +
  guides(fill = guide_legend(reverse = F)) +
  labs(fill = "WHO scale", y = "Cumulative proportion", x = "Anticoagulation intervention")
p
```

```{r}
pth <- file.path("outputs", "figures", "outcomes", "secondary")
ggsave(file.path(pth, "outcome-7-2-descriptive.pdf"), p, height = 3, width = 6)
```

```{r}
acs_itt_nona_dat %>%
  dplyr::count(CAssignment, D28_who = factor(as.integer(D28_who))) %>%
  complete(CAssignment, D28_who, fill = list(n = 0)) %>%
  group_by(CAssignment) %>%
  mutate(p = n / sum(n)) %>%
  ggplot(., aes(D28_who, p)) +
  facet_wrap( ~ CAssignment) +
  geom_point() +
  geom_segment(aes(xend = D28_who, y = 0, yend = p))
```

### Sample Cumulative Logits

Proportional odds looks reasonable for all logits except 1.

```{r}
trt_counts %>% 
  group_by(CAssignment) %>% 
  mutate(clogit = logit(cumsum(p))) %>%
  group_by(D28_who) %>%
  mutate(rel_clogit = clogit - mean(clogit)) %>%
  filter(D28_who != 8) %>%
  ggplot(., aes(CAssignment, rel_clogit)) +
  facet_wrap( ~ D28_who) +
  geom_point() +
  labs(y = "Relative (to mean) sample cumulative logit")

trt_counts %>% 
  group_by(CAssignment) %>% 
  mutate(clogit = logit(cumsum(p))) %>%
  group_by(D28_who) %>%
  mutate(rel_clogit = clogit - mean(clogit)) %>%
  filter(D28_who != 8) %>%
  ggplot(., aes(D28_who, rel_clogit)) +
  facet_wrap( ~ CAssignment) +
  geom_point() +
  labs(y = "Relative (to mean) sample cumulative logit")
```

# Modelling (Day 28) {#modelling}

## Primary Model

## Simplified (Treatment Only)

```{r}
#| label: fit-simple-model
#| code-summary: Fit simple model (treatment only)
seed <- 81350
mod <- cmdstan_model("stan/logistic_cumulative_ordinal.stan")

mdat <- all_dat %>%
  filter(ENR_rec == 1, WTH_FU == 0, ACS_ITT == 1, !is.na(D28_who)) %>%
  select(CAssignment, D28_who)

C <- contr.orthonorm(4)
X <- model.matrix(
  ~ CAssignment, 
  data = mdat, 
  contrast = list(CAssignment = contr.orthonorm))[, -1]
y <- as.integer(mdat$D28_who)
N <- nrow(X)
K <- ncol(X)
J <- max(y)
beta_sd <- rep(1, K)
p_par <- rep(1 / J, J)

sdat <- list(
  N = N, K = K, J = J, X = X, y = y, beta_sd = beta_sd, p_par = p_par
)

snk <- capture.output(mfit <- mod$sample(
  data = sdat,
  seed = seed,
  refresh = 0,
  iter_sampling = 2500,
  chains = 8,
  parallel_chains = 8
))
```

```{r}
#| label: fit-simple-samples
#| code-summary: Get posterior draws

p_rvar <- as_draws_rvars(mfit$draws("p"))$p
a_rvar <- as_draws_rvars(mfit$draws("alpha"))$alpha
b_rvar <- as_draws_rvars(mfit$draws("beta"))$beta

b_uncon_rvar <- C %**% b_rvar
b_trt_rvar <- transform_coding(C, contr.treatment(4)) %**% b_rvar

# Treatment specific level probabilities
p_C1 <- ordered_logit(a_rvar - b_uncon_rvar[1])
p_C2 <- ordered_logit(a_rvar - b_uncon_rvar[2])
p_C3 <- ordered_logit(a_rvar - b_uncon_rvar[3])
p_C4 <- ordered_logit(a_rvar - b_uncon_rvar[4])
p_df <- expand_grid(
  CAssignment = c("C1", "C2", "C3", "C4"),
  who = 1:8
) %>%
  mutate(
    p = c(p_C1, p_C2, p_C3, p_C4),
    med = median(p),
    lo = quantile(p, prob = 0.025)[1, ],
    hi = quantile(p, prob = 0.975)[1, ]
  )
```

```{r}
#| label: fig-model-simple-versus-observed
#| code-summary: Compare model level probabilities to observed
#| fig-cap: |
#|   Posterior probability of outcome levels by treatment group
#|   compared to observed proportions.
obs <- all_dat %>%
  filter(ENR_rec == 1, WTH_FU == 0, ACS_ITT == 1, !is.na(D28_who)) %>%
  dplyr::count(CAssignment, D28_who = as.integer(D28_who)) %>%
  complete(CAssignment, D28_who, fill = list(n = 0)) %>%
  group_by(CAssignment) %>%
  mutate(p = n / sum(n))

ggplot(p_df, aes(who + 0.1, med)) +
  facet_wrap( ~ CAssignment) +
  geom_pointrange(aes(ymin = lo, ymax = hi), fatten = 1, colour = "red") +
  geom_point(data = obs, aes(D28_who - 0.1, p), shape = 10) +
  labs(
    x = "WHO outcome scale",
    y = "Probability of outcome"
  )
```

### Non-proportional odds

There is evidence of non-proportional odds with respect to the first logit. This is explored below. In this model, the first logit has a distinct parameter, but all other logits share a parameter.

```{r}
#| label: fig-model-simple-nonprop-odds
#| code-summary: Compare non-proportional odds model
#| fig-cap: |
#|   Compare posterior logits assuming proportional odds and 
#|   non-proportional odds at the first logit only.
seed <- 81350
modagg <- cmdstan_model("stan/logistic_cumulative_ordinal_agg.stan")
modagg1nprop <- cmdstan_model("stan/logistic_cumulative_ordinal_agg_1np.stan")

mdatagg <- mdat %>%
  dplyr::count(CAssignment, D28_who) %>%
  spread(D28_who, n, fill = 0) %>%
  rowwise() %>%
  mutate(n = sum(across(2:9, ~ .))) %>%
  ungroup()

X <- model.matrix(
  ~ CAssignment, 
  data = mdatagg, 
  contrast = list(CAssignment = contr.orthonorm))[, -1]
y <- as.matrix(mdatagg[, 2:9])
n <- mdatagg$n
N <- nrow(X)
K <- ncol(X)
J <- ncol(y)
beta_sd <- rep(1, K)
p_par <- rep(1 / J, J)

sdat <- list(
  N = N, K = K, J = J, 
  X = X, y = y, n = n, 
  beta_sd = beta_sd, p_par = p_par
)

snk <- capture.output(mfitagg <- modagg$sample(
  data = sdat,
  seed = seed,
  refresh = 0,
  iter_sampling = 2500,
  chains = 8,
  parallel_chains = 8
))

snk <- capture.output(mfitaggnp <- modagg1nprop$sample(
  data = sdat,
  seed = seed,
  refresh = 0,
  iter_sampling = 2500,
  chains = 8,
  parallel_chains = 8
))

beta_rvar <- as_draws_rvars(mfitagg$draws("beta"))$beta
np_beta_rvar <- as_draws_rvars(mfitaggnp$draws("beta"))$beta
np_beta1_rvar <- as_draws_rvars(mfitaggnp$draws("beta1"))$beta1

b_uncon_rvar <- C %**% beta_rvar
np_b_uncon_rvar <- C %**% np_beta_rvar
np_b1_uncon_rvar <- C %**% np_beta1_rvar

b_trt_rvar <- transform_coding(C, contr.treatment(4)) %**% beta_rvar
np_b1_trt_rvar <- transform_coding(C, contr.treatment(4)) %**% np_beta_rvar
np_b_trt_rvar <- transform_coding(C, contr.treatment(4)) %**% np_beta1_rvar

pdat <- expand_grid(
  D28_who = 1:7,
  CAssignment = c("C1", "C2", "C3", "C4")
) %>%
  mutate(
    clogit = rep(-b_uncon_rvar, times = 7),
    clogit_np = c(-np_b1_uncon_rvar, rep(-np_b_uncon_rvar, times = 6))
  )

ggplot(pdat,
       aes(CAssignment, y = median(clogit))) +
  facet_wrap( ~ D28_who) +
  geom_pointrange(aes(
    ymin = quantile(clogit, 0.025)[1, ],
    ymax = quantile(clogit, 0.975)[1, ],
    colour = "Prop odds"),
    fatten = 1,
    position = position_nudge(x = -0.1)) +
  geom_pointrange(aes(
    y = median(clogit_np),
    ymin = quantile(clogit_np, 0.025)[1, ],
    ymax = quantile(clogit_np, 0.975)[1, ],
    colour = "Non-prop odds"),
    fatten = 1,
    position = position_nudge(x = 0.1)) +
  geom_point(data = trt_counts %>% 
    group_by(CAssignment) %>% 
    mutate(clogit = logit(cumsum(p))) %>%
    group_by(D28_who) %>%
    mutate(rel_clogit = clogit - mean(clogit)) %>%
    filter(D28_who != 8),
    aes(CAssignment, rel_clogit, colour = "Observed")) +
  scale_colour_manual(
    "Model", 
    values = c(
      "Observed" = "black",
      "Prop odds" = "blue", 
      "Non-prop odds" = "red")) +
  labs(y = "Outcome specific logit\nposterior median and 95%C")
```

```{r}
#| label: fig-model-simple-nonprop-odds-probs
#| code-summary: Compare non-proportional odds model probabilities
#| fig-cap: |
#|   Compare posterior summaries for outcome level probabilities 
#|   assuming proportional odds and non-proportional odds at 
#|   the first logit only.
alpha_rvar <- as_draws_rvars(mfitagg$draws("alpha"))$alpha
alphanp_rvar <- as_draws_rvars(mfitaggnp$draws("alpha"))$alpha

p_C1 <- ordered_logit(alpha_rvar - b_uncon_rvar[1])
p_C2 <- ordered_logit(alpha_rvar - b_uncon_rvar[2])
p_C3 <- ordered_logit(alpha_rvar - b_uncon_rvar[3])
p_C4 <- ordered_logit(alpha_rvar - b_uncon_rvar[4])

pnp_C1 <- ordered_logit(
  c(alphanp_rvar[1] - np_b1_uncon_rvar[1],
    alphanp_rvar[-1] - np_b_uncon_rvar[1]
))
pnp_C2 <- ordered_logit(
  c(alphanp_rvar[1] - np_b1_uncon_rvar[2],
    alphanp_rvar[-1] - np_b_uncon_rvar[2]
))
pnp_C3 <- ordered_logit(
  c(alphanp_rvar[1] - np_b1_uncon_rvar[3],
    alphanp_rvar[-1] - np_b_uncon_rvar[3]
))
pnp_C4 <- ordered_logit(
  c(alphanp_rvar[1] - np_b1_uncon_rvar[4],
    alphanp_rvar[-1] - np_b_uncon_rvar[4]
))

p_df <- expand_grid(
  CAssignment = c("C1", "C2", "C3", "C4"),
  who = 1:8
) %>%
  mutate(
    p = c(p_C1, p_C2, p_C3, p_C4),
    pnp = c(pnp_C1, pnp_C2, pnp_C3, pnp_C4)
  )

ggplot(p_df, aes(who, mean(p))) +
  facet_wrap( ~ CAssignment) +
    geom_pointrange(aes(
    ymin = quantile(p, 0.025)[1, ],
    ymax = quantile(p, 0.975)[1, ],
    colour = "Prop odds"),
    fatten = 1,
    position = position_nudge(x = -0.15)) +
  geom_pointrange(aes(
    y = mean(pnp),
    ymin = quantile(pnp, 0.025)[1, ],
    ymax = quantile(pnp, 0.975)[1, ],
    colour = "Non-prop odds"),
    fatten = 1,
    position = position_nudge(x = 0.15)) +
  geom_point(data = obs, aes(D28_who, p)) +
  labs(
    x = "WHO outcome scale",
    y = "Posterior mean and 95% CrI for outcome probability"
  )+
  scale_colour_manual(
    "Model", 
    values = c(
      "Observed" = "black",
      "Prop odds" = "blue", 
      "Non-prop odds" = "red"))
```
