---
title: "7-8 EQ-5D-5L"
description: |
  Analyse of the EQ-5D-5L outcome.
author: 
  - name: James Totterdell
    affiliation: University of Sydney
  - name: Rob Mahar
    affiliation: University of Melbourne
date: last-modified
---

## Preamble

```{r}
#| label: pkgs
#| code-summary: Load packages
library(tidyverse)
library(labelled)
library(kableExtra)
library(cmdstanr)
library(posterior)
library(bayestestR)
library(bayesplot)
library(matrixStats)
library(ggdist)
library(patchwork)
library(lubridate)
library(eq5d)

theme_set(theme_classic(base_size = 10, base_family = "Palatino") +
  theme(panel.grid = element_blank(),
        strip.background = element_blank()))
bayesplot_theme_set(theme_set(theme_classic(base_size = 10, base_family = "Palatino") +
  theme(panel.grid = element_blank(),
        strip.background = element_blank())))
```

```{r}
#| label: data
#| code-summary: Prepare dataset
devtools::load_all()
all_dat <- read_all_no_daily()

acs_itt_dat <- all_dat %>% 
  filter_acs_itt() %>%
  transmute_model_cols_grp_aus_nz() %>%
  left_join(
    all_dat %>% select(StudyPatientID, starts_with("D28_EQ")),
    by = "StudyPatientID")

```


## Descriptive

```{r}
acs_itt_dat %>% 
  dplyr::count(CAssignment, 
        D28_EQAnxietyDepression, 
        D28_EQMobility,
        D28_EQPersonalCare,
        D28_EQUsualActivities,
        D28_EQPainDiscomfort) %>%
  gather(key, value, -n, -CAssignment) %>%
  group_by(CAssignment, key) %>%
  filter(!is.na(value), value != 0) %>%
  mutate(p = n / sum(n)) %>%
  ungroup() %>%
  mutate(value = factor(value)) %>%
  ggplot(., aes(CAssignment, p, fill = value)) +
  facet_wrap( ~ key) +
  geom_bar(stat = "identity") +
  scale_fill_viridis_d(option = "A", direction = -1, begin = 0, end = 0.9) +
  labs(x = "Assigned intervention - domain C", y = "Cumulative proportion", fill = "Score") +
  theme(legend.position = "right", legend.direction = "vertical",
        panel.grid.major = element_blank(),
        axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5)) 
```

```{r}
eq5d <- acs_itt_dat %>% select(CAssignment, starts_with("D28_EQ")) %>%
  mutate(eq5d_state = paste0(D28_EQMobility, 
                           D28_EQPersonalCare,
                           D28_EQUsualActivities,
                           D28_EQPainDiscomfort,
                           D28_EQAnxietyDepression))

# Looks like '00000' indicates either zero score (inlcuding on VAS), or more likely missing.
head(t(table(eq5d$D28_EQOverallHealthScore, eq5d$eq5d_state)))

eq5d_nona <- eq5d %>%  
  filter(eq5d_state != "00000") %>% # Looks like these are missing
  filter(eq5d_state != "NANANANANA") # Looks like these are missing

counts <- with(eq5d_nona, table(eq5d_state, CAssignment))
nms    <- colnames(counts)
counts <- lapply(colnames(counts), function(x) counts[,x])
names(counts) <- nms 

counts <- lapply(counts, function(x) x[order(-x, names(x))])
counts <- lapply(counts, function(x) x[x>0])
counts <- lapply(counts, function(x) cbind(names(x),
                                           x,
                                           round(x/sum(x)*100,1), 
                                           cumsum(x), 
                                           round(cumsum(x/sum(x))*100,1))[c(1:10,length(x)),])
counts  <- lapply(counts, function(x) rbind(x[1:10,], c("...", "", "", "", ""), x[11,]))
counts <- do.call(rbind, counts) %>% as.tibble() 

make_table <- function(format = "html", fn = NULL)
{
out <- counts %>% kable(format = format, digits = 2, booktabs = TRUE, linesep = "", align = "lrrrrr", longtable = TRUE,
                        col.names = c("Health state", "n", "%", "n", "%"),
                        caption = "Prevelance of 10 most frequent, and worst, reported EQ-5D-5L profiles by treatment (day 28).") %>%
  kable_styling(latex_options = "HOLD_position", font_size = 12) %>%
  group_rows("C1", 1, 12) %>%
  group_rows("C2", 13, 24) %>%
  group_rows("C3", 25, 36) %>%
  group_rows("C4", 37, 48) %>%
  add_header_above(c(" " = 1, "Frequency" = 2, "Cumulative frequency" = 2))
  if (!is.null(fn) & format == "latex") {
      out
      save_tex_table(out, fn)
  } else {
      return(out)
  }
}
make_table()  %>% kable_styling()
make_table(format = "latex", fn = "7-8_eq5d5l_counts.tex")
```

# Get breakdown table.
```{r}

get_profiles <- function(x)
{
  acs_itt_dat %>% 
    dplyr::count(CAssignment, !!sym(x)) %>%
    filter(!!sym(x) != 0) %>%
    spread(CAssignment, n, fill = 0) %>%
    mutate(Overall = C1 + C2 + C3 + C4) %>% 
    rbind(colSums(.[-c(1),])) %>% select(-!!sym(x)) %>%
    mutate(across(C1:Overall, ~ sprintf("%i (%.0f)", .x, 100 * .x / sum(.x))))
}

tab1 <-  get_profiles("D28_EQMobility") 
tab2 <-  get_profiles("D28_EQPersonalCare")
tab3 <-  get_profiles("D28_EQUsualActivities")
tab4 <-  get_profiles("D28_EQPainDiscomfort")
tab5 <-  get_profiles("D28_EQAnxietyDepression")

marg <- c(1:5, "Any mobility problem",
          1:5, "Any self care problem",
          1:5, "Any usual activities problem",
          1:5, "Any pain/discomfort problem",
          1:5, "Any anxiety/depression problem")
          
make_table <- function(format = "html", fn = NULL)
{
  out <- bind_cols(marg, bind_rows(tab1, tab2, tab3, tab4, tab5))
  out <- kable(out,
    col.names = c("EQ-5D-5L", names(out)[-1]),
    caption = "Distribution of responses on the EQ-5D-5L (day 28).",
    align = "lrrrr", format = format, digits = 2, booktabs = TRUE, linesep = "", longtable = TRUE) %>%  
    kable_styling(latex_options = "HOLD_position", font_size = 11) %>%
    collapse_rows(1, valign = "top", latex_hline = 'custom', custom_latex_hline = 1) %>%
    group_rows("Mobility",           1,   6) %>%
    group_rows("Self care",          7,  12) %>%
    group_rows("Usual activities",   13, 18) %>%
    group_rows("Pain/discomfort",    19, 24) %>%
    group_rows("Anxiety/depression", 25, 30) 
    if (!is.null(fn) & format == "latex") {
      out
      save_tex_table(out, fn)
    } else {
      return(out)
    }
}
make_table()  %>% kable_styling()
make_table(format = "latex", fn = "7-8_eq5d5l_distribution.tex")


```

# Get VAS table.


```{r}
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}

vas <- eq5d %>%
  select(CAssignment, D28_EQOverallHealthScore) %>%
  mutate(D28_EQOverallHealthScore = ifelse(D28_EQOverallHealthScore == 0, NA, D28_EQOverallHealthScore)) %>%
  group_by(CAssignment) %>%
  summarise(n       = n(),
            Mean    = round(mean(D28_EQOverallHealthScore, na.rm = T), 1),
            SD      = round(sd(D28_EQOverallHealthScore, na.rm = T), 1),
            Median  = median(D28_EQOverallHealthScore, na.rm = T),
            Mode    = getmode(D28_EQOverallHealthScore),
            Min     = min(D28_EQOverallHealthScore, na.rm = T),
            Max     = max(D28_EQOverallHealthScore, na.rm = T),
            `Missing, n (%)` = paste0(sum(is.na(D28_EQOverallHealthScore)), " (", round(sum(is.na(D28_EQOverallHealthScore))/n(),4)*100,")")) %>% t %>% as.data.frame()
names(vas) <- vas[1,]
vas <- vas[-1,]

make_table <- function(format = "html", fn = NULL)
{  
 out <- vas %>% kable(
    caption = "Descriptive summary of EQ-5D VAS (day 28).",
    align = "rrrr", format = format, digits = 2, booktabs = TRUE, linesep = "", longtable = TRUE) %>%  
    kable_styling(latex_options = "HOLD_position", font_size = 11) %>%
    collapse_rows(1, valign = "top", latex_hline = 'custom', custom_latex_hline = 1)
    if (!is.null(fn) & format == "latex") {
      out
      save_tex_table(out, fn)
    } else {
      return(out)
    }
}

make_table()  %>% kable_styling()
make_table(format = "latex", fn = "7-8_eq5d_vas.tex")

```
