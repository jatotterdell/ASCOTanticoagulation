---
title: "7-1 Time to clinical recovery during the first 28 days"
description: |
  The first day, during the 28 days after enrolment, on which a patient satisfies categories 1, 2, or 3 on the WHO eight-point ordinal outcome scale (it will be assumed that the participant is not hospitalised on the first day following discharge and that on the day of discharge the participant is still considered hospitalised but not requiring supplemental oxygen nor ongoing medical care if the site has mistakenly indicated the patient was not hospitalised).
author:
  - name: James Totterdell
    affiliation: University of Sydney
  - name: Rob Mahar
    affiliation: University of Melbourne
date: last-modified
execute:
  eval: false
---

# Preamble


```{r}
#| label: pkgs
#| code-summary: Load packages
library(tidyverse)
library(labelled)
library(kableExtra)
library(cmdstanr)
library(posterior)
library(bayestestR)
library(bayesplot)
library(matrixStats)
library(plotly)
library(lubridate)
library(ggdist)
library(patchwork)

theme_set(theme_classic(base_size = 10, base_family = "Palatino") +
  theme(panel.grid = element_blank(),
        strip.background = element_blank()))
bayesplot_theme_set(theme_set(theme_classic(base_size = 10, base_family = "Palatino") +
  theme(panel.grid = element_blank(),
        strip.background = element_blank())))
color_scheme_set("red")
options(digits = 4)
```

```{r}
#| label: models
#| code-summary: Load Models
mlogit_mod <- cmdstan_model("stan/tte/tte_competing_alt.stan")
mlogit_rw <- cmdstan_model("stan/tte/tte_competing_rw.stan")
mlogit_epoch <- cmdstan_model("stan/tte/tte_competing_epoch.stan") 
```

```{r}
#| label: helpers
#| code-smmary: Helper functions
mlogit <- function(x) exp(x) / (1 + rvar_sum(exp(x)))

make_ttr_summary <- function(dat, format = "html") {
  tdat <- dat %>%
    group_by(
      Intervention = 
        factor(CAssignment, 
               levels = c("C1", "C2", "C3", "C4"),
               labels = c("Standard", "Intermediate", 
                          "Standard plus aspirin", "Therapeutic"))) %>%
    summarise(
      Randomised = n(),
      Known = sum(!is.na(out_ttr)),
      Died = sprintf("%i (%.1f)", sum(out_rec == 2), 100 * mean(out_rec == 2)),
      Recovered = sprintf("%i (%.1f)", sum(out_rec == 1), 100 * mean(out_rec == 1)),
      Unrecovered = sprintf("%i (%.1f)", sum(out_rec == 0), 100 * mean(out_rec == 0)),
      `TTR, Median (Q1, Q3)` = sprintf(
        "%i (%.2f, %.2f)",
        median(out_ttr[out_rec == 1]),
        quantile(out_ttr[out_rec == 1], 0.25),
        quantile(out_ttr[out_rec == 1], 0.75)
      )
    ) 
  kable(
    tdat,
    format = format,
    align = "lrrrrrr",
    booktabs = TRUE) %>%
    kable_styling(
      font_size = 9,
      latex_options = "HOLD_position"
    )
}

make_odds_ratio_table <- function(drws, format = "html") {
  tdat <- as_tibble(drws$OR, rownames = "Factor") %>%
  pivot_longer(Recovery:Death) %>%
  mutate(name = factor(name, levels = c("Recovery", "Death"))) %>%
  arrange(name) %>%
  mutate(
    Median = sprintf("%.2f", median(value)),
    `95\\% CrI` = sprintf("(%.2f, %.2f)", quantile(value, 0.025), quantile(value, 0.975)),
    `Mean (SD)` = sprintf("%.2f (%.2f)", mean(value), sd(value)),
    `Pr(OR > 1)` = sprintf("%.2f", Pr(value > 1))
  )
  kable(
    tdat %>% select(-name, -value),
    format = format,
    align = "lrrrr",
    booktabs = TRUE,
    escape = F
  ) %>%
    kable_styling(
      font_size = 9,
      latex_options = "HOLD_position"
    ) %>%
    group_rows("Recovery", 1, nrow(drws$OR)) %>%
    group_rows("Death", nrow(drws$OR) + 1, 2*nrow(drws$OR))
}

get_arm_specific_probs <- function(drws, shift = FALSE) {
  haztbl <- vector("list", nrow(drws$Ccon))
  names(haztbl) <- rownames(drws$Ccon)
  if(shift) {
    alph <- drws$alpha_shift
  } else {
    alph <- drws$alpha
  }
  for (k in 1:nrow(drws$Ccon)) {
    haz <- t(do.call(cbind, apply(sweep(alph, 2, drws$Ccon[k, ], "+"), 1, mlogit)))
    haz <- cbind(1 - (haz[, 1] + haz[, 2]), haz)
    colnames(haz) <- c("haz0", "haz1", "haz2")
    haztbl[[k]] <- bind_cols(time = 1:28, as_tibble(haz)) %>%
      mutate(
        surv = cumprod(haz0),
        prob1 = haz1 * lag(surv, default = rvar(1)),
        prob2 = haz2 * lag(surv, default = rvar(1)),
        cprob1 = cumsum(prob1),
        cprob2 = cumsum(prob2)
      )
  }
  out <- bind_rows(haztbl, .id = "intervention")
  return(out)
}

plot_baseline_hazard <- function(drws) {
  as_tibble(drws$alpha, rownames = "day") %>% 
    mutate(day = as.numeric(day)) %>%
    rename(Recovery = V1, Death = V2) %>%
    pivot_longer(Recovery:Death) %>%
    ggplot(., 
           aes(xdist=value, y = day)) + 
    facet_wrap( ~ name, scales = "free_x") +
    stat_pointinterval() +
    labs(x = "Baseline cause-specific hazard (logit)", y = "Study day") +
    scale_y_continuous(breaks = c(1, 7, 14, 21, 28))
}
```

```{r}
#| label: data
#| code-summary: Prepare dataset
devtools::load_all()
all_dat <- read_all_no_daily()

acs_itt_dat <- all_dat %>% 
  filter_acs_itt() %>%
  transmute_model_cols_grp_aus_nz() %>%
  left_join(
    all_dat %>% 
      select(
        StudyPatientID, 
        out_rec,
        out_ttr),
    by = "StudyPatientID")
acs_itt_nona_dat <- acs_itt_dat %>% 
  filter(!is.na(out_ttr))

ttr_seq <- expand_grid(
  StudyPatientID = unique(acs_itt_nona_dat$StudyPatientID),
  time = 1:28)
acs_itt_outdat <- acs_itt_nona_dat %>%
  left_join(ttr_seq, by = "StudyPatientID") %>%
  filter(time <= out_ttr) %>%
  mutate(
    y = if_else(out_ttr == time, out_rec, 0),
    y0 = if_else(out_ttr > time | out_ttr == time & out_rec == 0, 1, 0), # Not recovered or died
    y1 = if_else(out_ttr == time & out_rec == 1, 1, 0), # Recovered
    y2 = if_else(out_ttr == time & out_rec == 2, 1, 0)  # Died
  )
acs_itt_outdat_agg <- acs_itt_outdat %>%
  complete(CAssignment, time, fill = list(y = 0)) %>%
  group_by(CAssignment, time) %>%
  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = "drop") %>%
  group_by(CAssignment) %>%
  mutate(cy1 = cumsum(y1), 
         cp1 = cy1 / n[1],
         cy2 = cumsum(y2),
         cp2 = cy2 / n[1],
         cpn = (n[1] - cy1 - cy2) / n[1]) %>%
  ungroup() %>%
  mutate(CAssignment = factor(
    CAssignment, labels = str_replace(intervention_labels()$CAssignment[-1], "<br>", " ")))


acs_itt_concurc2_dat <- acs_itt_dat %>%
  filter_concurrent_intermediate()
acs_itt_concurc2_nona_dat <- acs_itt_concurc2_dat %>% 
  filter(!is.na(out_ttr)) %>%
  left_join(ttr_seq, by = "StudyPatientID") %>%
  filter(time <= out_ttr) %>%
  mutate(
    y = if_else(out_ttr == time, out_rec, 0),
    y0 = if_else(out_ttr > time | out_ttr == time & out_rec == 0, 1, 0), # Not recovered or died
    y1 = if_else(out_ttr == time & out_rec == 1, 1, 0), # Recovered
    y2 = if_else(out_ttr == time & out_rec == 2, 1, 0)  # Died
  )

# Aspirin
acs_itt_concurc3_dat <- acs_itt_dat %>%
  filter_concurrent_std_aspirin()
acs_itt_concurc3_nona_dat <- acs_itt_concurc3_dat %>% 
  filter(!is.na(out_ttr)) %>%
  left_join(ttr_seq, by = "StudyPatientID") %>%
  filter(time <= out_ttr) %>%
  mutate(
    y = if_else(out_ttr == time, out_rec, 0),
    y0 = if_else(out_ttr > time | out_ttr == time & out_rec == 0, 1, 0), # Not recovered or died
    y1 = if_else(out_ttr == time & out_rec == 1, 1, 0), # Recovered
    y2 = if_else(out_ttr == time & out_rec == 2, 1, 0)  # Died
  )

acs_itt_concurc4_dat <- acs_itt_dat %>%
  filter_concurrent_therapeutic()
acs_itt_concurc4_nona_dat <- acs_itt_concurc4_dat %>% 
  filter(!is.na(out_ttr)) %>%
  left_join(ttr_seq, by = "StudyPatientID") %>%
  filter(time <= out_ttr) %>%
  mutate(
    y = if_else(out_ttr == time, out_rec, 0),
    y0 = if_else(out_ttr > time | out_ttr == time & out_rec == 0, 1, 0), # Not recovered or died
    y1 = if_else(out_ttr == time & out_rec == 1, 1, 0), # Recovered
    y2 = if_else(out_ttr == time & out_rec == 2, 1, 0)  # Died
  )
```


# Derivation

Time to clinical recovery is taken as the first day from the index admission at which the patient had a WHO outcome score of 3 or less. If a participant died before recovery, then they are treated as censored at the day of death. No allowance is made for participants who recovered but then subsequently died (i.e. they are just counted as recovered on the relevant day). If recovery and death reportedly occurred on the same day (e.g. daily status WHO scale < 4 but discharge outcome of death on same day), then the patient is considered to have not recovered. For participants whose WHO outcome score was greater than 3 on the day of discharge, their day of recovery was counted as the first day after discharge.

**Question: Should probably set this up with death as competing risk, i.e. cause specific hazard time to first of death or recovery with censoring at 28 days.**

# Descriptive

## Time to recovery

```{r}
#| tbl-cap: Summary of time to recovery to day 28 by anticoagulation intervention.
save_tex_table(
  make_ttr_summary(acs_itt_dat, "latex"),
  file.path("outcomes", "secondary", "7-1-acs-itt-summary")
)
make_ttr_summary(acs_itt_dat)
```

```{r}
#| label: fig-ttr-dist
#| fig-cap: |
#|   Distribution of time to recovery. 
acs_itt_nona_dat %>%
  dplyr::count(out_rec, out_ttr) %>%
  ggplot(., aes(out_ttr, n, fill = factor(out_rec, labels = c("censored", "recovered", "died")))) +
  geom_col() +
  scale_x_continuous(breaks = 1:28) +
  scale_fill_viridis_d(option = "A", begin = 0.2, end = 0.8) +
  labs(x = "Time to recovery (to day 28)", y = "Count", fill = "Outcome")
```

## Anticoagulation

```{r}
#| label: fig-7-1-anticoagulation
#| fig-cap: |
#|   Progression to recovery by anticoagulation intervention.
p <- acs_itt_outdat_agg %>% 
  select(-y1, -y2, -cy1, -cy2) %>% 
  pivot_longer(cp1:cpn) %>% 
  mutate(name = factor(
    name, 
    levels = c("cp1", "cp2", "cpn"), 
    labels = c("Recovered", "Died", "Not recovered"))) %>%
  ggplot(., aes(time, value, fill = name, colour = name)) + 
  facet_wrap(~CAssignment) + 
  geom_col(width = 1) +
  scale_fill_viridis_d(option = "B", begin = 0.2, end = 0.8) +
  scale_colour_viridis_d(option = "B", begin = 0.2, end = 0.8) +
  scale_x_continuous(breaks = c(1, 7, 14, 21, 28)) +
  labs(x = "Study day", y = "Cumulative proportion", fill = "Status", colour = "Status") +
  theme(panel.grid.minor = element_blank())
path <- file.path("outputs", "figures", "outcomes", "secondary")
ggsave(file.path(path, "outcome-7-1-descriptive.pdf"), p, height = 2.5, width = 6)
p
```

## Age

```{r}
#| label: fig-7-1-age
#| fig-cap: |
#|   Progression to recovery by anticoagulation intervention.
tmp_agg <- acs_itt_outdat %>%
  complete(agegte60, time, fill = list(y = 0)) %>%
  group_by(agegte60, time) %>%
  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = "drop") %>%
  group_by(agegte60) %>%
  mutate(cy1 = cumsum(y1), 
         cp1 = cy1 / n[1],
         cy2 = cumsum(y2),
         cp2 = cy2 / n[1],
         cy0 = (n[1] - cy1 - cy2),
         cpn = (n[1] - cy1 - cy2) / n[1]) %>%
  ungroup() %>%
  mutate(agegte60 = factor(agegte60, levels = c(0, 1), labels = c("Age < 60", "Age 60+")))
p <- tmp_agg %>% 
  select(-y1, -y2, -cp1, -cp2, -cpn) %>% 
  pivot_longer(cy1:cy0) %>% 
  mutate(name = factor(
    name, 
    levels = c("cy1", "cy2", "cy0"), 
    labels = c("Recovered", "Died", "Not recovered"))) %>%
  ggplot(., aes(time, value, fill = name, colour = name)) + 
  facet_wrap(~agegte60, scales = "free_y") + 
  geom_col(width = 1) +
  scale_fill_viridis_d(option = "B", begin = 0.2, end = 0.8) +
  scale_colour_viridis_d(option = "B", begin = 0.2, end = 0.8) +
  scale_x_continuous(breaks = c(1, 7, 14, 21, 28)) +
  labs(x = "Study day", y = "Cumulative proportion", fill = "Status", colour = "Status") +
  theme(panel.grid.minor = element_blank())
path <- file.path("outputs", "figures", "outcomes", "secondary")
ggsave(file.path(path, "7-1-age.pdf"), p, height = 2, width = 6)
p
```

## Country

```{r}
#| label: fig-7-1-country
#| fig-cap: |
#|   Progression to recovery by country.
tmp_agg <- acs_itt_outdat %>%
  complete(country, time, fill = list(y = 0)) %>%
  group_by(country, time) %>%
  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = "drop") %>%
  group_by(country) %>%
  mutate(cy1 = cumsum(y1), 
         cp1 = cy1 / n[1],
         cy2 = cumsum(y2),
         cp2 = cy2 / n[1],
         cy0 = (n[1] - cy1 - cy2),
         cpn = (n[1] - cy1 - cy2) / n[1]) %>%
  ungroup() %>%
  mutate(country = factor(country, levels = c("IN", "AU", "NP", "NZ"),
                          labels = c("India", "Australia", "Nepal", "New Zealand")))
p <- tmp_agg %>% 
  select(-y1, -y2, -cp1, -cp2, -cpn) %>% 
  pivot_longer(cy1:cy0) %>% 
  mutate(name = factor(
    name, 
    levels = c("cy1", "cy2", "cy0"), 
    labels = c("Recovered", "Died", "Not recovered"))) %>%
  ggplot(., aes(time, value, fill = name, colour = name)) + 
  facet_wrap(~country, scales = "free_y") + 
  geom_col(width = 1) +
  scale_fill_viridis_d(option = "B", begin = 0.2, end = 0.8) +
  scale_colour_viridis_d(option = "B", begin = 0.2, end = 0.8) +
  scale_x_continuous(breaks = c(1, 7, 14, 21, 28)) +
  labs(x = "Study day", y = "Cumulative count", fill = "Status", colour = "Status") +
  theme(panel.grid.minor = element_blank())
path <- file.path("outputs", "figures", "outcomes", "secondary")
ggsave(file.path(path, "7-1-country.pdf"), p, height = 2.5, width = 6)
p
```

## Calender Time

```{r}
#| label: fig-7-1-calender-tiime
#| fig-cap: |
#|   Progression to recovery by calendar time
tmp_agg <- acs_itt_outdat %>%
  mutate(yr = year(RandDate), mth = month(RandDate)) %>%
  complete(nesting(yr, mth), time, fill = list(y = 0)) %>%
  group_by(yr, mth, time) %>%
  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = "drop") %>%
  group_by(yr, mth) %>%
  mutate(cy1 = cumsum(y1), 
         cp1 = cy1 / n[1],
         cy2 = cumsum(y2),
         cp2 = cy2 / n[1],
         cy0 = (n[1] - cy1 - cy2),
         cpn = (n[1] - cy1 - cy2) / n[1]) %>%
  ungroup() %>%
  mutate(label = fct_inorder(paste(yr, mth, sep = "-")))
p <- tmp_agg %>% 
  select(-y1, -y2, -cp1, -cp2, -cpn) %>% 
  pivot_longer(cy1:cy0) %>% 
  mutate(name = factor(
    name, 
    levels = c("cy1", "cy2", "cy0"), 
    labels = c("Recovered", "Died", "Not recovered"))) %>%
  ggplot(., aes(time, value, fill = name, colour = name)) + 
  facet_wrap(~label, scales = "free_y", ncol = 5) + 
  geom_col(width = 1) +
  scale_fill_viridis_d(option = "B", begin = 0.2, end = 0.8) +
  scale_colour_viridis_d(option = "B", begin = 0.2, end = 0.8) +
  scale_x_continuous(breaks = c(1, 7, 14, 21, 28)) +
  labs(x = "Study day", y = "Cumulative count", fill = "Status", colour = "Status") +
  theme(panel.grid.minor = element_blank(),
        legend.position = "bottom")
path <- file.path("outputs", "figures", "outcomes", "secondary")
ggsave(file.path(path, "7-1-calendar-time.pdf"), p, height = 4, width = 6)
p
```

## Site

```{r}
#| label: fig-7-1-site
#| fig-cap: |
#|   Progression to recovery by site.
tmp_agg <- acs_itt_outdat %>%
  complete(nesting(country, site_raw), time, fill = list(y = 0)) %>%
  mutate(site_raw = fct_infreq(site_raw)) %>%
  group_by(country, site_raw, time) %>%
  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = "drop") %>%
  group_by(country, site_raw) %>%
  mutate(cy1 = cumsum(y1), 
         cp1 = cy1 / n[1],
         cy2 = cumsum(y2),
         cp2 = cy2 / n[1],
         cy0 = (n[1] - cy1 - cy2),
         cpn = (n[1] - cy1 - cy2) / n[1]) %>%
  ungroup()

plot_country <- function(ctr, ncol = 2) {
  tmp_agg %>% 
    filter(country == ctr) %>%
    select(-y1, -y2, -cp1, -cp2, -cpn) %>% 
    pivot_longer(cy1:cy0) %>% 
    mutate(name = factor(
      name, 
      levels = c("cy1", "cy2", "cy0"), 
      labels = c("Recovered", "Died", "Not recovered"))) %>%
    ggplot(., aes(time, value, fill = name, colour = name)) + 
    facet_wrap( ~ site_raw, scales = "free_y", ncol = ncol) + 
    geom_col(width = 1) +
    scale_fill_viridis_d(option = "B", begin = 0.2, end = 0.8) +
    scale_colour_viridis_d(option = "B", begin = 0.2, end = 0.8) +
    scale_x_continuous(breaks = c(1, 7, 14, 21, 28)) +
    scale_y_continuous(breaks = function(x) unique(floor(pretty(seq(0, (max(x) + 1) * 1.1))))) +
    labs(x = "Study day", y = "Cumulative\ncount", fill = "Status", colour = "Status") +
    theme(panel.grid.minor = element_blank(),
          legend.position = "bottom",
          plot.title = element_text(size = rel(1), face = "bold"))
}

p_in <- plot_country("IN", 6) + labs(title = "Sites India")
p_au <- plot_country("AU", 6) + labs(title = "Sites Australia")
p_np <- plot_country("NP", 2) + labs(title = "Sites Nepal")
p_nz <- plot_country("NZ", 4) + labs(title = "Sites New Zealand")
p1 <- p_in / p_au
p2 <- (p_np | p_nz) + plot_layout(widths = c(1, 2))
p <- (p1 / p2) + 
  plot_layout(guides = "collect", heights = c(2,3.5,1)) &
  theme(legend.position='bottom')
path <- file.path("outputs", "figures", "outcomes", "secondary")
ggsave(file.path(path, "7-1-country-site.pdf"), p, height = 7, width = 6)
p
```


# Modelling

Time to clinical recovery will be analysed using a multinomial logit model for the cause-specific hazard functions where the events considered are recovery ($r=1$) or death by day 28 ($r=2$),
$$
\lambda_r(t) = \frac{\exp(\alpha_{tr} + x^{\mathsf{T}}\beta_r)}{1 + \sum_{j=1}^2 \exp(\alpha_{tj} + x^{\mathsf{T}}\beta_j)}, 
\quad r=1,2, \quad t=1,...,T
$$
Under this model, the coefficient $\exp(\beta_{rj})$ denotes the factor by which the cause-specific odds change for a one unit change in $x_j$ (assumed constant over all $t$), e.g.
$$
\ln\left(\frac{\lambda_r(t|x)}{\lambda_0(t|x)}\right) = \alpha_{tr} + x^\mathsf{T}\beta_r
$$
where
$$
\lambda_0(t|x) = 1 - \sum_{r=1}^R\lambda_r(t|x) = \frac{1}{1 + \sum_{j=1}^2 \exp(\alpha_{tj} + x^{\mathsf{T}}\beta_j)}
$$
denotes conditional survival (i.e not event).


## Reduced (anticoagulation intervention only)

```{r}
obs_pp <- acs_itt_outdat %>% 
  group_by(CAssignment, time) %>% 
  summarise(s0 = sum(y0), s1 = sum(y1), s2 = sum(y2)) %>% 
  mutate(
    p0 = s0 / (s0 + s1 + s2),
    p1 = s1 / (s0 + s1 + s2),
    p2 = s2 / (s0 + s1 + s2))
```

```{r}
ctr <- contr.orthonorm
X <- make_X_design(acs_itt_outdat, ctr = ctr)
Xm <- X[, -c(1, 5, 6)]
sdat <- list(
  N = nrow(acs_itt_outdat),
  R = 2,
  K = ncol(Xm),
  T = 28,
  time = acs_itt_outdat$time,
  X = Xm,
  y = as.matrix(acs_itt_outdat[, c("y0", "y1", "y2")]),
  beta_sd = c(1, 1, 1)
)

fit <- mlogit_mod$sample(
  data = sdat, 
  chains = 1,
  parallel_chains = 1,
  iter_sampling = 500, 
  iter_warmup = 500)
fit_lin <- mlogit_linear$sample(
  data = sdat, 
  chains = 1,
  parallel_chains = 1,
  iter_sampling = 500, 
  iter_warmup = 500)
fit_rw <- mlogit_rw$sample(
  data = sdat, 
  chains = 1,
  parallel_chains = 1,
  iter_sampling = 500, 
  iter_warmup = 500)

drws <- as_draws_rvars(fit$draws())
drws_lin <- as_draws_rvars(fit_lin$draws())
drws_rw <- as_draws_rvars(fit_rw$draws())

rownames(drws$beta) <- colnames(sdat$X)
drws$Ccon <- attr(X, "contrasts")$randC %**% drws$beta
rownames(drws$Ccon) <- c("C1", "C2", "C3", "C4")
drws$Ctrt <- drws$Ccon[-1, ] - drws$Ccon[1, ]

rownames(drws_rw$beta) <- colnames(sdat$X)
drws_rw$Ccon <- attr(X, "contrasts")$randC %**% drws_rw$beta
rownames(drws_rw$Ccon) <- c("C1", "C2", "C3", "C4")
drws_rw$Ctrt <- drws_rw$Ccon[-1, ] - drws_rw$Ccon[1, ]


haz <- get_arm_specific_probs(drws_rw)
pdat <- haz %>% 
  select(intervention, time, unrecovered = surv, recovered = cprob1, died = cprob2) %>%
  pivot_longer(unrecovered:died, names_to = "event", values_to = "posterior")
ggplot(pdat, aes(time, fill = event, colour = event)) +
  facet_wrap( ~ intervention) +
  geom_rect(aes(xmin = time, 
                xmax = time + 1,
                ymin = quantile(posterior, 0.025), 
                ymax = quantile(posterior, 0.975)),
              alpha = 0.25, colour = NA) +
  geom_step(aes(y = median(posterior))) +
  scale_fill_viridis_d(option = "B", begin = 0.2, end = 0.8) +
  scale_colour_viridis_d(option = "B", begin = 0.2, end = 0.8) +
  scale_x_continuous(breaks = c(1, 7, 14, 21, 28), limits = c(1, 28))


as_tibble(drws$alpha, rownames = "day") %>% 
  pivot_longer(V1:V2) %>%
  ggplot(., 
         aes(xdist=value, y = fct_inorder(day))) + 
  facet_wrap( ~ name, scales = "free_x") +
  stat_slabinterval() +
  xlim(-5, 0)

as_tibble(drws_rw$alpha, rownames = "day") %>% 
  pivot_longer(V1:V2) %>%
  ggplot(., 
         aes(xdist=value, y = fct_inorder(day))) + 
  facet_wrap( ~ name, scales = "free_x") +
  stat_slabinterval()
```

## Reduced (no epoch or site)

```{r}
#| eval: false
#| code-summary: Fit and save the model
X <- make_X_design(
  acs_itt_outdat, 
  c("inelgc3", "agegte60", "ctry"))
Xm <- X[, -1]
sdat <- list(
  N = nrow(acs_itt_outdat),
  R = 2,
  K = ncol(Xm),
  T = 28,
  time = acs_itt_outdat$time,
  X = Xm,
  y = as.matrix(acs_itt_outdat[, c("y0", "y1", "y2")]),
  beta_sd = c(1, 1, 1, 1, 1, 10, 2.5, 1, 1)
)

fit <- mlogit_rw$sample(
  data = sdat, 
  seed = 214056,
  chains = 8,
  parallel_chains = 8,
  iter_sampling = 2500, 
  iter_warmup = 1000,
  adapt_delta = 0.95)
fit$save_output_files(
  dir = file.path("outputs", "models", "secondary", "7-1-ttr"),
  basename = "no_epoch_site",
  timestamp = FALSE, 
  random = FALSE)
fit$save_object(file.path("outputs", "models", "secondary", "7-1-ttr", "no_epoch_site.rds"))
```


```{r}
#| code-summary: Load the model and summarise draws
fit <- as_cmdstan_fit(
  grep("no_epoch_site-[0-9].csv", 
       list.files(
         file.path("outputs", "models", "secondary", "7-1-ttr"), 
         full.names = T), 
       value = T)
)

drws <- as_draws_rvars(fit$draws())
rownames(drws$beta) <- colnames(sdat$X)
drws$Ccon <- contr.orthonorm(4) %**% drws$beta[1:3, ]
rownames(drws$Ccon) <- c("Standard", "Intermediate", "Standard plus aspirin", "Therapeutic")
drws$Ctrt <- drws$Ccon[-1, ] - drws$Ccon[1, ]

drws$OR <- exp(rbind(
  drws$Ctrt,
  drws$beta[-(1:5), ]
))
rownames(drws$OR)[-(1:3)] <- 
  c("Ineligible aspirin", "Age 60+", "Australia/New Zealand", "Nepal")
colnames(drws$OR) <- c("Recovery", "Death")
```


## Reduced (no site)

```{r}
#| code-summary: Prepare data
X <- make_X_design(acs_itt_outdat, c("inelgc3", "agegte60", "ctry"))
Xm <- X[, -1]
epoch <- acs_itt_outdat$epoch
M_epoch <- max(acs_itt_outdat$epoch)
sdat <- list(
  N = nrow(acs_itt_outdat),
  R = 2,
  K = ncol(Xm),
  M_epoch = M_epoch,
  T = 28,
  time = acs_itt_outdat$time,
  epoch = epoch,
  X = Xm,
  y = as.matrix(acs_itt_outdat[, c("y0", "y1", "y2")]),
  beta_sd = c(1, 1, 1, 1, 1, 10, 2.5, 1, 1)
)
```

```{r}
#| eval: false
#| code-summary: Fit model
fit <- mlogit_epoch$sample(
  data = sdat, 
  chains = 1,
  parallel_chains = 1,
  iter_sampling = 200, 
  iter_warmup = 200)
fit$save_output_files(
  dir = file.path("outputs", "models", "secondary", "7-1-ttr"),
  basename = "epoch_only",
  timestamp = FALSE, 
  random = FALSE)
fit$save_object(file.path("outputs", "models", "secondary", "7-1-ttr", "epoch_only.rds"))
```

```{r}
#| code-summary: Load model and prepare draws
fit <- as_cmdstan_fit(
  grep("epoch_only-[0-9].csv", 
       list.files(
         file.path("outputs", "models", "secondary", "7-1-ttr"), 
         full.names = T), 
       value = T)
)

drws <- as_draws_rvars(fit$draws())
rownames(drws$beta) <- colnames(sdat$X)
drws$Ccon <- attr(X, "contrasts")$randC %**% drws$beta[1:3, ]
rownames(drws$Ccon) <- c("C1", "C2", "C3", "C4")
drws$Ctrt <- drws$Ccon[-1, ] - drws$Ccon[1, ]

as_tibble(drws$gamma_site, rownames = "day") %>% 
  pivot_longer(V1:V2) %>%
  ggplot(., 
         aes(xdist=value, y = fct_inorder(day))) + 
  facet_wrap( ~ name, scales = "free_x") +
  stat_slabinterval()
```

## Primary Model

## Sensitivity: Concurrent Enrolements

### Intermediate dose

```{r}
#| tbl-cap: Summary of time to recovery to day 28 by anticoagulation intervention.
save_tex_table(
  make_ttr_summary(acs_itt_concurc2_dat, "latex"),
  file.path("outcomes", "secondary", "7-1-acs-itt-intermediate-summary")
)
make_ttr_summary(acs_itt_concurc2_dat)
```

```{r}
#| label: fig-7-1-anticoagulation-acs-itt-intermediate
#| fig-cap: |
#|   Progression to recovery by anticoagulation intervention.
p <- acs_itt_concurc2_nona_dat %>%
  complete(CAssignment, time, fill = list(y = 0)) %>%
  group_by(CAssignment, time) %>%
  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = "drop") %>%
  group_by(CAssignment) %>%
  mutate(cy1 = cumsum(y1), 
         cp1 = cy1 / n[1],
         cy2 = cumsum(y2),
         cp2 = cy2 / n[1],
         cpn = (n[1] - cy1 - cy2) / n[1]) %>%
  ungroup() %>%
  mutate(CAssignment = factor(
    CAssignment, 
    levels = c("C1", "C2", "C3", "C4"), 
    labels = str_replace(intervention_labels()$CAssignment[-1], "<br>", " "))) %>%
  select(-y1, -y2, -cy1, -cy2) %>% 
  pivot_longer(cp1:cpn) %>% 
  mutate(name = factor(
    name, 
    levels = c("cp1", "cp2", "cpn"), 
    labels = c("Recovered", "Died", "Not recovered"))) %>%
  ggplot(., aes(time, value, fill = name, colour = name)) + 
  facet_wrap(~CAssignment) + 
  geom_col(width = 1) +
  scale_fill_viridis_d(option = "B", begin = 0.2, end = 0.8) +
  scale_colour_viridis_d(option = "B", begin = 0.2, end = 0.8) +
  scale_x_continuous(breaks = c(1, 7, 14, 21, 28)) +
  labs(x = "Study day", y = "Cumulative proportion", fill = "Status", colour = "Status") +
  theme(panel.grid.minor = element_blank())
path <- file.path("outputs", "figures", "outcomes", "secondary")
ggsave(
  file.path(path, "outcome-7-1-descriptive-acs-itt-intermediate.pdf"), 
  p, height = 2.5, width = 6)
p
```

```{r}
# Sanity check frequentist fit with smoothed time
freqfit <-vgam(
  cbind(y0, y1, y2) ~ s(time) + CAssignment + agegte60 + ctry, 
  multinomial(refLevel = 1), 
  data = acs_itt_concurc2_nona_dat)

X <- make_X_design(
  acs_itt_concurc2_nona_dat, 
  c("agegte60", "ctry"), 
  includeA = F)
Xm <- X[, -1]
sdat <- list(
  N = nrow(acs_itt_concurc2_nona_dat),
  R = 2,
  K = ncol(Xm),
  T = 28,
  time = acs_itt_concurc2_nona_dat$time,
  X = Xm,
  y = as.matrix(acs_itt_concurc2_nona_dat[, c("y0", "y1", "y2")]),
  beta_sd = c(1, 2.5, 1, 1)
)
```

```{r}
#| eval: false
#| code-summary: Fit and save the model
fit <- mlogit_rw$sample(
  data = sdat, 
  seed = 71252,
  chains = 4,
  parallel_chains = parallel::detectCores(),
  iter_sampling = 250, 
  iter_warmup = 250,
  adapt_delta = 0.95)
fit$save_output_files(
  dir = file.path("outputs", "models", "secondary", "7-1-ttr"),
  basename = "concurc2",
  timestamp = FALSE, 
  random = FALSE)
fit$save_object(file.path("outputs", "models", "secondary", "7-1-ttr", "concurc2.rds"))
```

```{r}
#| code-summary: Load the model and summarise draws
fit <- as_cmdstan_fit(
  grep("concurc2-[0-9].csv", 
       list.files(
         file.path("outputs", "models", "secondary", "7-1-ttr"), 
         full.names = T), 
       value = T)
)

drws <- as_draws_rvars(fit$draws())
rownames(drws$beta) <- colnames(sdat$X)
drws$Ccon <- contr.orthonorm(2) %**% drws$beta[1, ]
rownames(drws$Ccon) <- c("Standard", "Intermediate")
drws$Ctrt <- drws$Ccon[-1, ] - drws$Ccon[1, ]

drws$shift <- rvar_apply(sweep(drws$beta[2:4, ], 1, colMeans(sdat$X)[2:4], "*"), 2, rvar_sum)
drws$alpha_shift <- sweep(drws$alpha, 2, drws$shift, "+")

drws$OR <- exp(rbind(
  drws$Ctrt,
  drws$beta[-1, ]
))
rownames(drws$OR) <- c("Intermediate", "Age 60+", "Australia/New Zealand", "Nepal")
colnames(drws$OR) <- c("Recovery", "Death")
```

```{r}
save_tex_table(
  make_odds_ratio_table(drws, format = "latex"),
  "outcomes/secondary/7-1-primary-model-acs-itt-intermediate-summary-table"
)
make_odds_ratio_table(drws)
```

```{r}
#| fig-cap: Baseline hazard (logit) for death and recovery.
p <- plot_baseline_hazard(drws) +
  coord_flip()
ggsave(
  file.path("outputs", "figures", "outcomes", "secondary", "7-1-concurrent-intermediate-baseline-haz.pdf"),
  p, height = 3, width = 6
)
p
```

```{r}
#| fig-cap: |
#|   Intervention specific recovery progression (India, age < 60).
haz <- get_arm_specific_probs(drws, TRUE) %>%
  mutate(intervention = fct_inorder(intervention))
pdat <- haz %>% 
  select(intervention, time, unrecovered = surv, recovered = cprob1, died = cprob2) %>%
  pivot_longer(unrecovered:died, names_to = "event", values_to = "posterior")
obsdat <- acs_itt_concurc2_nona_dat %>%
  # filter(ctry == "IN", agegte60 == 0) %>%
  complete(CAssignment, time, fill = list(y = 0)) %>%
  group_by(intervention = factor(CAssignment, labels = c("Standard", "Intermediate")), time) %>%
  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = "drop") %>%
  group_by(intervention) %>%
  mutate(cy1 = cumsum(y1), 
         recovered = cy1 / n[1],
         cy2 = cumsum(y2),
         died = cy2 / n[1],
         unrecovered = (n[1] - cy1 - cy2) / n[1]) %>%
  ungroup() %>%
  pivot_longer(c(unrecovered, recovered, died), names_to = "event", values_to = "proportion")
p <- ggplot(pdat, aes(time, fill = event, colour = event)) +
  facet_wrap( ~ intervention) +
  geom_rect(aes(xmin = time, 
                xmax = time + 1,
                ymin = quantile(posterior, 0.025), 
                ymax = quantile(posterior, 0.975)),
              alpha = 0.25, colour = NA) +
  geom_step(aes(y = median(posterior))) +
  geom_point(data = obsdat, aes(y = proportion, x = time + 0.5)) +
  scale_fill_viridis_d("Event", option = "B", begin = 0.2, end = 0.8) +
  scale_colour_viridis_d("Event", option = "B", begin = 0.2, end = 0.8) +
  scale_x_continuous("Day", breaks = c(1, 7, 14, 21, 28), limits = c(1, 28)) +
  labs(y = "Proportion")
ggsave(
  file.path(
    "outputs", "figures", "outcomes", "secondary", 
    "7-1-concurrent-intermediate-marginal-ttr.pdf"),
  p, height = 2.5, width = 6
)
p
```

### Standard dose plus aspirin

```{r}
#| tbl-cap: Summary of time to recovery to day 28 by anticoagulation intervention.
save_tex_table(
  make_ttr_summary(acs_itt_concurc3_dat, "latex"),
  file.path("outcomes", "secondary", "7-1-acs-itt-stdaspirin-summary")
)
make_ttr_summary(acs_itt_concurc3_dat)
```

```{r}
#| label: fig-7-1-anticoagulation-acs-itt-stdaspirin
#| fig-cap: |
#|   Progression to recovery by anticoagulation intervention.
p <- acs_itt_concurc3_nona_dat %>%
  complete(CAssignment, time, fill = list(y = 0)) %>%
  group_by(CAssignment, time) %>%
  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = "drop") %>%
  group_by(CAssignment) %>%
  mutate(cy1 = cumsum(y1), 
         cp1 = cy1 / n[1],
         cy2 = cumsum(y2),
         cp2 = cy2 / n[1],
         cpn = (n[1] - cy1 - cy2) / n[1]) %>%
  ungroup() %>%
  mutate(CAssignment = factor(
    CAssignment, 
    levels = c("C1", "C2", "C3", "C4"), 
    labels = str_replace(intervention_labels()$CAssignment[-1], "<br>", " "))) %>%
  select(-y1, -y2, -cy1, -cy2) %>% 
  pivot_longer(cp1:cpn) %>% 
  mutate(name = factor(
    name, 
    levels = c("cp1", "cp2", "cpn"), 
    labels = c("Recovered", "Died", "Not recovered"))) %>%
  ggplot(., aes(time, value, fill = name, colour = name)) + 
  facet_wrap(~CAssignment) + 
  geom_col(width = 1) +
  scale_fill_viridis_d(option = "B", begin = 0.2, end = 0.8) +
  scale_colour_viridis_d(option = "B", begin = 0.2, end = 0.8) +
  scale_x_continuous(breaks = c(1, 7, 14, 21, 28)) +
  labs(x = "Study day", y = "Cumulative proportion", fill = "Status", colour = "Status") +
  theme(panel.grid.minor = element_blank())
path <- file.path("outputs", "figures", "outcomes", "secondary")
ggsave(
  file.path(path, "outcome-7-1-descriptive-acs-itt-stdaspirin.pdf"), 
  p, height = 2.5, width = 6)
p
```

```{r}
# Sanity check frequentist fit with smoothed time
freqfit <-vgam(
  cbind(y0, y1, y2) ~ s(time) + CAssignment + agegte60 + ctry, 
  multinomial(refLevel = 1), 
  data = acs_itt_concurc3_nona_dat)

X <- make_X_design(
  acs_itt_concurc3_nona_dat, 
  c("agegte60", "ctry"), 
  includeA = F)
Xm <- X[, -1]
sdat <- list(
  N = nrow(acs_itt_concurc3_nona_dat),
  R = 2,
  K = ncol(Xm),
  T = 28,
  time = acs_itt_concurc3_nona_dat$time,
  X = Xm,
  y = as.matrix(acs_itt_concurc3_nona_dat[, c("y0", "y1", "y2")]),
  beta_sd = c(1, 1, 2.5, 1)
)
```

```{r}
#| code-summary: Fit and save the model
#| eval: false
fit <- mlogit_rw$sample(
  data = sdat, 
  seed = 12085,
  chains = 4,
  parallel_chains = min(8, parallel::detectCores()),
  iter_sampling = 250, 
  iter_warmup = 250,
  adapt_delta = 0.95
)
# Save model to outputs
fit$save_output_files(
  dir = file.path("outputs", "models", "secondary", "7-1-ttr"),
  basename = "concurc3",
  timestamp = FALSE, 
  random = FALSE)
fit$save_object(file.path("outputs", "models", "secondary", "7-1-ttr", "concurc3.rds"))
```

```{r}
#| code-summary: Load the model and summarise draws
fit <- as_cmdstan_fit(
  grep("concurc3-[0-9].csv", 
       list.files(
         file.path("outputs", "models", "secondary", "7-1-ttr"), 
         full.names = T), 
       value = T)
)

drws <- as_draws_rvars(fit$draws())
rownames(drws$beta) <- colnames(sdat$X)
drws$Ccon <- attr(X, "contrasts")$randC %**% drws$beta[1:2, ]
rownames(drws$Ccon) <- c("Standard", "Intermediate", "Standard plus aspirin")
drws$Ctrt <- drws$Ccon[-1, ] - drws$Ccon[1, ]

drws$shift <- rvar_apply(sweep(drws$beta[3:4, ], 1, colMeans(sdat$X)[3:4], "*"), 2, rvar_sum)
drws$alpha_shift <- sweep(drws$alpha, 2, drws$shift, "+")

drws$OR <- exp(rbind(
  drws$Ctrt,
  drws$beta[-(1:2), ]
))
rownames(drws$OR) <- c("Intermediate", "Standard plus aspirin", "Age 60+", "Australia/New Zealand")
colnames(drws$OR) <- c("Recovery", "Death")
```

```{r}
save_tex_table(
  make_odds_ratio_table(drws, format = "latex"),
  "outcomes/secondary/7-1-primary-model-acs-itt-stdaspirin-summary-table"
)
make_odds_ratio_table(drws)
```

```{r}
p <- plot_baseline_hazard(drws) +
  coord_flip()
ggsave(
  file.path(
    "outputs", "figures", "outcomes", "secondary", 
    "7-1-concurrent-stdaspirin-baseline-haz.pdf"),
  p, height = 3, width = 6
)
p
```

```{r}
#| fig-cap: |
#|   Intervention specific recovery progression (India, age < 60).
haz <- get_arm_specific_probs(drws, TRUE) %>%
  mutate(intervention = fct_inorder(intervention))
pdat <- haz %>% 
  select(intervention, time, unrecovered = surv, recovered = cprob1, died = cprob2) %>%
  pivot_longer(unrecovered:died, names_to = "event", values_to = "posterior")
obsdat <- acs_itt_concurc3_nona_dat %>%
  # filter(ctry == "IN", agegte60 == 0) %>%
  complete(CAssignment, time, fill = list(y = 0)) %>%
  group_by(intervention = 
             factor(CAssignment, 
                    labels = c("Standard", "Intermediate", "Standard plus aspirin")), 
           time) %>%
  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = "drop") %>%
  group_by(intervention) %>%
  mutate(cy1 = cumsum(y1), 
         recovered = cy1 / n[1],
         cy2 = cumsum(y2),
         died = cy2 / n[1],
         unrecovered = (n[1] - cy1 - cy2) / n[1]) %>%
  ungroup() %>%
  pivot_longer(c(unrecovered, recovered, died), names_to = "event", values_to = "proportion")
p <- ggplot(pdat, aes(time, fill = event, colour = event)) +
  facet_wrap( ~ intervention) +
  geom_rect(aes(xmin = time, 
                xmax = time + 1,
                ymin = quantile(posterior, 0.025), 
                ymax = quantile(posterior, 0.975)),
              alpha = 0.25, colour = NA) +
  geom_step(aes(y = median(posterior))) +
  geom_point(data = obsdat, aes(y = proportion, x = time + 0.5)) +
  scale_fill_viridis_d("Event", option = "B", begin = 0.2, end = 0.8) +
  scale_colour_viridis_d("Event", option = "B", begin = 0.2, end = 0.8) +
  scale_x_continuous("Day", breaks = c(1, 7, 14, 21, 28), limits = c(1, 28)) +
  labs(y = "Proportion")
ggsave(
  file.path(
    "outputs", "figures", "outcomes", "secondary", 
    "7-1-concurrent-stdaspirin-marginal-ttr.pdf"),
  p, height = 2.5, width = 6
)
p
```

### Therapeutic dose

```{r}
#| tbl-cap: Summary of time to recovery to day 28 by anticoagulation intervention.
save_tex_table(
  make_ttr_summary(acs_itt_concurc4_dat, "latex"),
  file.path("outcomes", "secondary", "7-1-acs-itt-therapeutic-summary")
)
make_ttr_summary(acs_itt_concurc4_dat)
```

```{r}
#| label: fig-7-1-anticoagulation-acs-itt-therapeutic
#| fig-cap: |
#|   Progression to recovery by anticoagulation intervention, ACS-ITT-therapeutic.
p <- acs_itt_concurc4_nona_dat %>%
  complete(CAssignment, time, fill = list(y = 0)) %>%
  group_by(CAssignment, time) %>%
  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = "drop") %>%
  group_by(CAssignment) %>%
  mutate(cy1 = cumsum(y1), 
         cp1 = cy1 / n[1],
         cy2 = cumsum(y2),
         cp2 = cy2 / n[1],
         cpn = (n[1] - cy1 - cy2) / n[1]) %>%
  ungroup() %>%
  mutate(CAssignment = factor(
    CAssignment, 
    levels = c("C1", "C2", "C3", "C4"), 
    labels = str_replace(intervention_labels()$CAssignment[-1], "<br>", " "))) %>%
  select(-y1, -y2, -cy1, -cy2) %>% 
  pivot_longer(cp1:cpn) %>% 
  mutate(name = factor(
    name, 
    levels = c("cp1", "cp2", "cpn"), 
    labels = c("Recovered", "Died", "Not recovered"))) %>%
  ggplot(., aes(time, value, fill = name, colour = name)) + 
  facet_wrap(~CAssignment) + 
  geom_col(width = 1) +
  scale_fill_viridis_d(option = "B", begin = 0.2, end = 0.8) +
  scale_colour_viridis_d(option = "B", begin = 0.2, end = 0.8) +
  scale_x_continuous(breaks = c(1, 7, 14, 21, 28)) +
  labs(x = "Study day", y = "Cumulative proportion", fill = "Status", colour = "Status") +
  theme(panel.grid.minor = element_blank())
path <- file.path("outputs", "figures", "outcomes", "secondary")
ggsave(
  file.path(path, "outcome-7-1-descriptive-acs-itt-therapeutic.pdf"), 
  p, height = 2.5, width = 6)
p
```

```{r}
# Sanity check frequentist fit with smoothed time
freqfit <-vgam(
  cbind(y0, y1, y2) ~ s(time) + CAssignment + agegte60 + ctry, 
  multinomial(refLevel = 1), 
  data = acs_itt_concurc4_nona_dat)

X <- make_X_design(
  acs_itt_concurc4_nona_dat, 
  c("agegte60", "ctry"), 
  includeA = F)
Xm <- X[, -1]
sdat <- list(
  N = nrow(acs_itt_concurc4_nona_dat),
  R = 2,
  K = ncol(Xm),
  T = 28,
  time = acs_itt_concurc4_nona_dat$time,
  X = Xm,
  y = as.matrix(acs_itt_concurc4_nona_dat[, c("y0", "y1", "y2")]),
  beta_sd = c(1, 1, 2.5, 1, 1)
)
```

```{r}
#| eval: false
#| code-summary: Fit and save the model
fit <- mlogit_rw$sample(
  data = sdat, 
  seed = 81743,
  chains = 4,
  parallel_chains = min(8, parallel::detectCores()),
  iter_sampling = 250, 
  iter_warmup = 250,
  adapt_delta = 0.95
)
# Save model to outputs
fit$save_output_files(
  dir = file.path("outputs", "models", "secondary", "7-1-ttr"),
  basename = "concurc4",
  timestamp = FALSE, 
  random = FALSE)
fit$save_object(file.path("outputs", "models", "secondary", "7-1-ttr", "concurc4.rds"))
```

```{r}
#| code-summary: Load the model and summarise draws
fit <- as_cmdstan_fit(
  grep("concurc4-[0-9].csv", 
       list.files(
         file.path("outputs", "models", "secondary", "7-1-ttr"), 
         full.names = T), 
       value = T)
)

drws <- as_draws_rvars(fit$draws())
rownames(drws$beta) <- colnames(sdat$X)
drws$Ccon <- attr(X, "contrasts")$randC %**% drws$beta[1:2, ]
rownames(drws$Ccon) <- c("Standard", "Intermediate", "Therapeutic")
drws$Ctrt <- drws$Ccon[-1, ] - drws$Ccon[1, ]

drws$shift <- rvar_apply(sweep(drws$beta[3:5, ], 1, colMeans(sdat$X)[3:5], "*"), 2, rvar_sum)
drws$alpha_shift <- sweep(drws$alpha, 2, drws$shift, "+")

drws$OR <- exp(rbind(
  drws$Ctrt,
  drws$beta[-(1:2), ]
))
rownames(drws$OR) <- c("Intermediate", "Therapeutic", "Age 60+", "India", "Australia/New Zealand")
colnames(drws$OR) <- c("Recovery", "Death")
```

```{r}
save_tex_table(
  make_odds_ratio_table(drws, format = "latex"),
  "outcomes/secondary/7-1-primary-model-acs-itt-therapeutic-summary-table"
)
make_odds_ratio_table(drws)
```

```{r}
p <- plot_baseline_hazard(drws) +
  coord_flip()
ggsave(
  file.path(
    "outputs", "figures", "outcomes", "secondary", 
    "7-1-concurrent-therapeutic-baseline-haz.pdf"),
  p, height = 3, width = 6
)
p
```

```{r}
#| fig-cap: |
#|   Intervention specific recovery progression (Nepal, age < 60).
haz <- get_arm_specific_probs(drws, TRUE) %>%
  mutate(intervention = fct_inorder(intervention))
pdat <- haz %>% 
  select(intervention, time, unrecovered = surv, recovered = cprob1, died = cprob2) %>%
  pivot_longer(unrecovered:died, names_to = "event", values_to = "posterior")
obsdat <- acs_itt_concurc4_nona_dat %>%
  # filter(ctry == "NP", agegte60 == 0) %>%
  complete(nesting(StudyPatientID, CAssignment), time = 1:28, fill = list(y = 0)) %>%
  group_by(intervention = 
             factor(CAssignment, 
                    labels = c("Standard", "Intermediate", "Therapeutic")), 
           time) %>%
  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = "drop") %>%
  group_by(intervention) %>%
  mutate(cy1 = cumsum(y1), 
         recovered = cy1 / n[1],
         cy2 = cumsum(y2),
         died = cy2 / n[1],
         unrecovered = (n[1] - cy1 - cy2) / n[1]) %>%
  ungroup() %>%
  pivot_longer(c(unrecovered, recovered, died), names_to = "event", values_to = "proportion")
p <- ggplot(pdat, aes(time, fill = event, colour = event)) +
  facet_wrap( ~ intervention) +
  geom_rect(aes(xmin = time, 
                xmax = time + 1,
                ymin = quantile(posterior, 0.025), 
                ymax = quantile(posterior, 0.975)),
              alpha = 0.25, colour = NA) +
  geom_step(aes(y = median(posterior))) +
  geom_point(data = obsdat, aes(y = proportion, x = time + 0.5)) +
  scale_fill_viridis_d("Event", option = "B", begin = 0.2, end = 0.8) +
  scale_colour_viridis_d("Event", option = "B", begin = 0.2, end = 0.8) +
  scale_x_continuous("Day", breaks = c(1, 7, 14, 21, 28), limits = c(1, 28)) +
  labs(y = "Proportion")
ggsave(
  file.path(
    "outputs", "figures", "outcomes", "secondary", 
    "7-1-concurrent-therapeutic-marginal-ttr.pdf"),
  p, height = 2.5, width = 6
)
p
```


## Sensitivity: Prior - Treatment Coding

## Sanity Check

```{r}
#| eval: false
#| include: false
library(VGAM)

fit0 <- vgam(
  cbind(y0, y1, y2) ~ s(time) + CAssignment, 
  multinomial(refLevel = 1), 
  data = acs_itt_outdat)

fit1 <- vglm(
  cbind(y0, y1, y2) ~ 0 + factor(time) + CAssignment, 
  multinomial(refLevel = 1), 
  data = acs_itt_outdat)

plotvgam(fit0, overlay = T, which.term = "s(time)")

nd <- expand_grid(time = 1:28, CAssignment = c("C1", "C2", "C3", "C4"))

# These are the cause specific hazards, lambda_r(t|x)
pp <- predict(fit1, newdata = nd, type = "response")

plot(pp[seq(1, nrow(pp), 4), 2], 
     median(t(do.call(cbind, apply(drws$alpha, 1, mlogit)))[, 1])[, 1])

ndpp <- bind_cols(nd, pp) %>% 
  group_by(CAssignment) %>%
  mutate(
    haz = y1 + y2,
    surv = cumprod(y0),
    prob1 = y1 * lag(surv, default = 1),
    prob2 = y2 * lag(surv, default = 1),
    cprob1 = cumsum(prob1),
    cprob2 = cumsum(prob2)
  )
ndlng <- ndpp %>%
  pivot_longer(y0:y2)

ndpp <- ndpp %>% 
  group_by(CAssignment) %>%
  mutate(
    haz = y1 + y2,
    surv = cumprod(y0),
    prob1 = y1 * lag(surv, default = 1),
    prob2 = y2 * lag(surv, default = 1)
  )

# Probability of any death within 28 days
ndpp %>% summarise(sum(prob2))
# Probability of any recovery within 28 days
ndpp %>% summarise(sum(prob1))

# Cause specific hazard over time
ggplot(ndlng, aes(time, value, colour = name)) +
  facet_wrap( ~ CAssignment) +
  geom_line() 

ggplot(ndpp, aes(time, surv, colour = CAssignment)) +
  geom_line()

# Cumulative probability of recovery or death
ggplot(ndpp, aes(time, cprob1, colour = CAssignment)) +
  geom_line()
ggplot(ndpp, aes(time, cprob2, colour = CAssignment)) +
  geom_line()
```

