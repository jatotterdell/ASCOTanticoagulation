[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "ASCOT Anticoagulation Analyses",
    "section": "",
    "text": "The following documents pertain to the analyses for the closure of the ASCOT anti-coagulation domain."
  },
  {
    "objectID": "analyses/7-2_who_ordinal_scale.html",
    "href": "analyses/7-2_who_ordinal_scale.html",
    "title": "7-2 WHO 8-point Outcome Scale",
    "section": "",
    "text": "Load packages\nlibrary(tidyverse)\nlibrary(labelled)\nlibrary(kableExtra)\nlibrary(cmdstanr)\nlibrary(posterior)\nlibrary(bayestestR)\nlibrary(bayesplot)\nlibrary(matrixStats)\nlibrary(ggdist)\nlibrary(patchwork)\nlibrary(lubridate)\n\ntheme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank()))\nbayesplot_theme_set(theme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank())))\n\n\n\n\nCode\nlogit <- function(x) log(x) - log(1 - x)\nexpit <- function(x) 1 / (1 + exp(-x))\nordered_logit <- function(x) {\n  c(\n    1 - expit(-x[1]),\n    expit(-x[1:(length(x)-1)]) - expit(-x[2:(length(x))]),\n    expit(-tail(x, 1))\n  )\n}\n\n\n\n\nPrepare dataset\ndevtools::load_all()\nall_dat <- read_all_no_daily()\n\nacs_itt_dat <- all_dat %>% \n  filter_acs_itt() %>%\n  transmute_model_cols_grp_aus_nz()\nacs_itt_nona_dat <- acs_itt_dat %>%\n  filter(!is.na(D28_who))\n\n# Concurrent enrolments for C2\nacs_itt_concurc2_dat <- acs_itt_dat %>%\n  filter_concurrent_intermediate()\nacs_itt_concurc2_nona_dat <- acs_itt_concurc2_dat %>% \n  filter(!is.na(D28_who))\n\n# Concurrent enrolments for C3\nacs_itt_concurc3_dat <- acs_itt_dat %>%\n  filter_concurrent_std_aspirin()\nacs_itt_concurc3_nona_dat <- acs_itt_concurc3_dat %>% \n  filter(!is.na(D28_who))\n\n# Concurrent enrolments for C4\nacs_itt_concurc4_dat <- acs_itt_dat %>%\n  filter_concurrent_therapeutic()\nacs_itt_concurc4_nona_dat <- acs_itt_concurc4_dat %>% \n  filter(!is.na(D28_who))\n\n\n\n\nLoad models\nordmod0 <- cmdstan_model(\n  \"stan/ordinal/logistic_cumulative.stan\") # No epoch or site\nordmod_epoch <- cmdstan_model(\n  \"stan/ordinal/logistic_cumulative_epoch.stan\") # Epoch only\nordmod <- cmdstan_model(\n  \"stan/ordinal/logistic_cumulative_epoch_site.stan\") # Full model\nlogistic <- cmdstan_model(file.path(\"stan\", \"binary\", \"logistic_site_epoch.stan\"))\n\n\n\n\nHelper functions\nmake_summary_table <- function(dat, format = \"html\") {\n  tdat <- dat %>%\n  group_by(CAssignment = factor(CAssignment, \n                                levels = c(\"C1\", \"C2\", \"C3\", \"C4\"),\n                                labels = intervention_labels2()$CAssignment[-1])) %>%\n  summarise(\n    Patients = n(),\n    Known = sum(!is.na(D28_who)),\n    Deaths = sprintf(\"%i (%.0f%%)\", \n                     sum(D28_who == 8, na.rm = TRUE), \n                     100 * mean(D28_who == 8, na.rm = TRUE)),\n    `Hospitalised` = sprintf(\"%i (%.0f%%)\", \n                     sum(D28_who > 2 & D28_who < 8, na.rm = TRUE), \n                     100 * mean(D28_who > 2 & D28_who < 8, na.rm = TRUE)),\n    `WHO, Median (Q1, Q3)` = sprintf(\n      \"%.0f (%.0f, %.0f)\", \n      median(D28_who, na.rm = T), \n      quantile(D28_who, 0.25, na.rm = TRUE), \n      quantile(D28_who, 0.75, na.rm = TRUE))\n  ) %>%\n  bind_rows(\n    dat %>%\n  group_by(CAssignment = \"Overall\") %>%\n  summarise(\n    Patients = n(),\n    Known = sum(!is.na(D28_who)),\n    Deaths = sprintf(\"%i (%.0f%%)\", \n                     sum(D28_who == 8, na.rm = TRUE), \n                     100 * mean(D28_who == 8, na.rm = TRUE)),\n    `Hospitalised` = sprintf(\"%i (%.0f%%)\", \n                     sum(D28_who > 2 & D28_who < 8, na.rm = TRUE), \n                     100 * mean(D28_who > 2 & D28_who < 8, na.rm = TRUE)),\n    `WHO, Median (Q1, Q3)` = sprintf(\n      \"%.0f (%.0f, %.0f)\", \n      median(D28_who, na.rm = T), \n      quantile(D28_who, 0.25, na.rm = TRUE), \n      quantile(D28_who, 0.75, na.rm = TRUE))\n  )\n  ) %>%\n  rename(`Anticoagulation\\nintervention` = CAssignment)\n  kable(\n    tdat,\n    format = format,\n    align = \"lrrrrr\",\n    booktabs = TRUE,\n    linesep = \"\"\n  ) %>%\n    kable_styling(\n      font_size = 9,\n      latex_options = \"HOLD_position\"\n    ) %>%\n    row_spec(nrow(tdat), bold = T)\n}\n\nmake_primary_model_data <- function(\n    dat, \n    vars = NULL,\n    beta_sd_var = NULL,\n    ctr = contr.orthonorm,\n    outcome = \"D28_who\",\n    p_mult = 2) {\n  \n  X <- make_X_design(dat, vars, ctr)\n  attX <- attr(X, \"contrasts\")\n  X <- X[, -1]\n  attr(X, \"contrasts\") <- attX\n  nXtrt <- sum(grepl(\"rand\", colnames(X)))\n  \n  beta_sd <- c(rep(1, nXtrt), beta_sd_var)\n  \n  epoch <- dat$epoch\n  M_epoch <- max(dat$epoch)\n  region <- dat$ctry_num\n  M_region <- max(region)\n  site <- dat$site_num\n  M_site <- max(site)\n  region_by_site <- dat %>% \n    dplyr::count(ctry_num, site_num) %>% \n    pull(ctry_num)\n\n  y_raw <- ordered(dat[[outcome]])\n  y_mod <- as.integer(y_raw)\n  N <- dim(X)[1]\n  K <- dim(X)[2]\n  unique_y <- length(unique(y_mod))\n  list(N = N, K = K, J = unique_y, X = X, \n       y = y_mod, y_raw = y_raw,\n       M_region = M_region,\n       M_site = M_site, site = site,\n       M_epoch = M_epoch, epoch = epoch,\n       region_by_site = region_by_site,\n       p_par = p_mult * rep(1 / unique_y, unique_y),\n       beta_sd = beta_sd)  \n}"
  },
  {
    "objectID": "analyses/7-2_who_ordinal_scale.html#anticoagulation",
    "href": "analyses/7-2_who_ordinal_scale.html#anticoagulation",
    "title": "7-2 WHO 8-point Outcome Scale",
    "section": "Anticoagulation",
    "text": "Anticoagulation\n\n\nSummary of WHO outcome by arm\nsave_tex_table(\n  make_summary_table(acs_itt_dat, \"latex\"), \n  file.path(\"outcomes\", \"secondary\", \"7-2-anticoagulation-summary\"))\nmake_summary_table(acs_itt_dat)\n\n\n\n\n\n \n  \n    Anticoagulation\nintervention \n    Patients \n    Known \n    Deaths \n    Hospitalised \n    WHO, Median (Q1, Q3) \n  \n \n\n  \n    Low-dose \n    610 \n    596 \n    19 (3%) \n    7 (1%) \n    1 (1, 2) \n  \n  \n    Intermediate-dose \n    613 \n    603 \n    15 (2%) \n    5 (1%) \n    1 (1, 2) \n  \n  \n    Low-dose with aspirin \n    283 \n    281 \n    10 (4%) \n    5 (2%) \n    1 (1, 2) \n  \n  \n    Therapeutic-dose \n    50 \n    50 \n    6 (12%) \n    1 (2%) \n    1 (1, 2) \n  \n  \n    Overall \n    1556 \n    1530 \n    50 (3%) \n    18 (1%) \n    1 (1, 2) \n  \n\n\n\nTable 1:  Summary of WHO scale at day 28 by treatment group. \n\n\n\n\nCode\np <- acs_itt_nona_dat %>%\n  dplyr::count(\n    CAssignment = factor(\n      CAssignment, \n      labels = str_replace(intervention_labels()$CAssignment[-1], \"<br>\", \"\\n\")), \n    D28_who = ordered(as.integer(D28_who), levels = 1:8)\n  ) %>%\n  group_by(CAssignment) %>%\n  mutate(p = n / sum(n)) %>%\n  ggplot(., aes(CAssignment, p)) +\n  geom_col(aes(fill = D28_who)) +\n  scale_fill_viridis_d(option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = F)) +\n  labs(fill = \"WHO scale\", y = \"Cumulative proportion\", x = \"Anticoagulation intervention\")\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(pth, \"outcome-7-2-descriptive.pdf\"), p, height = 3, width = 6)\np\n\n\n\n\n\n\n\nCode\nacs_itt_nona_dat %>%\n  dplyr::count(CAssignment, D28_who = factor(as.integer(D28_who))) %>%\n  complete(CAssignment, D28_who, fill = list(n = 0)) %>%\n  group_by(CAssignment) %>%\n  mutate(p = n / sum(n)) %>%\n  ggplot(., aes(D28_who, p)) +\n  facet_wrap( ~ CAssignment) +\n  geom_point() +\n  geom_segment(aes(xend = D28_who, y = 0, yend = p))"
  },
  {
    "objectID": "analyses/7-2_who_ordinal_scale.html#age",
    "href": "analyses/7-2_who_ordinal_scale.html#age",
    "title": "7-2 WHO 8-point Outcome Scale",
    "section": "Age",
    "text": "Age\n\n\nCode\npdat <- all_dat %>%\n  filter_acs_itt() %>%\n  filter(!is.na(D28_who)) %>%\n  dplyr::count(\n    agegrp = cut(AgeAtEntry, c(18, seq(25, 75, 5), 100), include.lowest = T, right = F),\n    who = ordered(D28_who, levels = 1:8), \n    .drop = F) %>%\n  group_by(agegrp) %>%\n  mutate(p = n / sum(n))\npdat2 <- pdat %>%\n  group_by(agegrp) %>%\n  summarise(n = sum(n))\n\np1 <- ggplot(pdat2, aes(agegrp, n)) +\n  geom_col(colour = \"grey40\", fill = \"grey40\") +\n  geom_vline(xintercept = 60, linetype = 2) +\n  labs(y = \"Number of\\nparticipants\",\n       x = \"Age at entry\") +\n  geom_vline(xintercept = 8.5, linetype = 2) +\n  theme(axis.text.x = element_text(hjust = 1, angle = 45))\n\np2 <- ggplot(pdat, aes(agegrp, p)) +\n  geom_col(aes(fill = who)) +\n  labs(x = \"Age\", y = \"Cumulative\\nproportion\") +\n  scale_fill_viridis_d(\"WHO scale\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = F)) +\n  geom_vline(xintercept = 8.5, linetype = 2) +\n  theme(axis.text.x = element_text(hjust = 1, angle = 45)) +\n  theme(legend.key.size = unit(0.5, \"lines\"))\np <- p1 | p2\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-2-age.pdf\"), p, height = 2.5, width = 6)\np\n\n\n\n\n\nFigure 1: Distribution of WHO scale at day 28 by age group"
  },
  {
    "objectID": "analyses/7-2_who_ordinal_scale.html#country",
    "href": "analyses/7-2_who_ordinal_scale.html#country",
    "title": "7-2 WHO 8-point Outcome Scale",
    "section": "Country",
    "text": "Country\n\n\nCode\npdat <- all_dat %>%\n  filter_acs_itt() %>%\n  filter(!is.na(D28_who)) %>%\n  dplyr::count(\n    Country = factor(PT_CountryName, levels = c(\"India\", \"Australia\", \"Nepal\", \"New Zealand\"),\n                     labels = c(\"India\", \"Australia\", \"Nepal\", \"New\\nZealand\")),\n    who = ordered(D28_who, levels = 1:8), \n    .drop = F) %>%\n  group_by(Country) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup()\npdat2 <- pdat %>%\n  group_by(Country) %>%\n  summarise(n = sum(n))\n\np1 <- ggplot(pdat2, aes(Country, n)) +\n  geom_col() +\n    labs(\n      y = \"Number of\\nparticipants\", \n      x = \"Country of enrolment\")\n\np2 <- ggplot(pdat, aes(Country, p)) +\n  geom_col(aes(fill = who)) +\n  labs(x = \"Anticoagulation intervention\", y = \"Cumulative\\nproportion\") +\n  scale_fill_viridis_d(\"WHO scale\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = F)) +\n  theme(legend.key.size = unit(0.5, \"lines\"))\np <- p1 | p2\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-2-country.pdf\"), p, height = 2.5, width = 6)\np\n\n\n\n\n\nFigure 2: Distribution of WHO scale at day 28 by country."
  },
  {
    "objectID": "analyses/7-2_who_ordinal_scale.html#site",
    "href": "analyses/7-2_who_ordinal_scale.html#site",
    "title": "7-2 WHO 8-point Outcome Scale",
    "section": "Site",
    "text": "Site\n\n\nCode\npdat <- all_dat %>%\n  filter_acs_itt() %>%\n  filter(!is.na(D28_who)) %>%\n  dplyr::count(\n    Country = factor(PT_CountryName, levels = c(\"India\", \"Australia\", \"Nepal\", \"New Zealand\"),\n                     labels = c(\"India\", \"Australia\", \"Nepal\", \"New\\nZealand\")),\n    Site = fct_infreq(Location),\n    who = ordered(D28_who, levels = 1:8)) %>%\n  complete(who = ordered(1:8), nesting(Country, Site), fill = list(n = 0)) %>%\n  group_by(Country, Site) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup() %>%\n  mutate(\n    Country = droplevels(Country),\n    Site = droplevels(Site)\n  )\npdat2 <- pdat %>%\n  group_by(Country, Site) %>%\n  summarise(n = sum(n)) %>%\n  ungroup()\np1 <- ggplot(pdat2, aes(Site, n)) +\n  facet_grid( ~ Country, scales = \"free_x\", space = \"free_x\") +\n  geom_col() +\n    labs(\n      y = \"Number of\\nparticipants\", \n      x = \"\") +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        panel.border = element_rect(fill = NA))\np2 <- ggplot(pdat, aes(Site, p)) +\n  facet_grid( ~ Country, scales = \"free_x\", space = \"free_x\") +\n  geom_col(aes(fill = who)) +\n  labs(x = \"Anticoagulation intervention\", y = \"Cumulative\\nproportion\") +\n  scale_fill_viridis_d(\"WHO scale\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = F, ncol = 1)) +\n  theme(axis.text.x = element_text(hjust = 1, angle = 45)) +\n  theme(legend.key.size = unit(0.25, \"lines\"))\np <- p1 / p2 +\n  plot_layout(guides = 'collect')\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-2-country-site.pdf\"), p, height = 4, width = 6.25)\np\n\n\n\n\n\nFigure 3: Distribution of WHO scale by study site"
  },
  {
    "objectID": "analyses/7-2_who_ordinal_scale.html#calendar-time",
    "href": "analyses/7-2_who_ordinal_scale.html#calendar-time",
    "title": "7-2 WHO 8-point Outcome Scale",
    "section": "Calendar Time",
    "text": "Calendar Time\n\n\nCode\npdat <- acs_itt_nona_dat %>%\n  dplyr::count(\n    yr = year(RandDate), mth = month(RandDate),\n    who = ordered(D28_who, levels = 1:8), \n    .drop = F) %>%\n  group_by(yr, mth) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup()\np1 <- pdat %>%\n  group_by(yr, mth) %>%\n  summarise(n = sum(n)) %>%\n  ggplot(., aes(mth, n))  +\n  facet_grid( ~ yr, drop = T, scales = \"free_x\", space = \"free\") +\n    geom_col() +\n    labs(\n      y = \"Number of\\nparticipants\", \n      x = \"Calendar date (month of year)\") +\n  scale_x_continuous(breaks = 1:12)\np2 <- ggplot(pdat, aes(mth, p)) +\n  facet_grid( ~ yr, drop = T, scales = \"free_x\", space = \"free\") +\n  geom_col(aes(fill = who)) +\n  labs(x = \"Calendar date (month of year)\", y = \"Cumulative\\nproportion\") +\n  scale_fill_viridis_d(\"WHO scale\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = F)) +\n  theme(legend.key.size = unit(0.5, \"lines\")) +\n  scale_x_continuous(breaks = 1:12)\np <- p1 | p2\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-2-calendar-time.pdf\"), p, height = 2, width = 6)\np\n\n\n\n\n\nFigure 4: Distribution of WHO scale by calendar time."
  },
  {
    "objectID": "analyses/7-2_who_ordinal_scale.html#sample-cumulative-logits",
    "href": "analyses/7-2_who_ordinal_scale.html#sample-cumulative-logits",
    "title": "7-2 WHO 8-point Outcome Scale",
    "section": "Sample Cumulative Logits",
    "text": "Sample Cumulative Logits\nProportional odds looks reasonable for all logits except 1.\n\n\nPlot sample cumulative logits\ntrt_counts <- acs_itt_nona_dat %>%\n  dplyr::count(CAssignment, D28_who) %>%\n  complete(CAssignment, D28_who, fill = list(n = 0)) %>%\n  group_by(CAssignment) %>%\n  mutate(p = n / sum(n))\ntrt_logit <- trt_counts %>% \n  group_by(CAssignment) %>% \n  mutate(clogit = logit(cumsum(p))) %>%\n  group_by(D28_who) %>%\n  mutate(rel_clogit = clogit - mean(clogit)) %>%\n  filter(D28_who != 28)\n\nggplot(trt_logit, aes(CAssignment, rel_clogit)) +\n  facet_wrap( ~ D28_who) +\n  geom_point() +\n  labs(y = \"Relative (to mean) sample cumulative logit\")\n\n\n\n\n\nInspect sample cumulative logits.\n\n\n\n\nPlot sample cumulative logits\nggplot(trt_logit, aes(D28_who, rel_clogit)) +\n  facet_wrap( ~ CAssignment) +\n  geom_point() +\n  labs(y = \"Relative (to mean) sample cumulative logit\")\n\n\n\n\n\nInspect sample cumulative logits."
  },
  {
    "objectID": "analyses/7-2_who_ordinal_scale.html#primary-model",
    "href": "analyses/7-2_who_ordinal_scale.html#primary-model",
    "title": "7-2 WHO 8-point Outcome Scale",
    "section": "Primary Model",
    "text": "Primary Model\n\n\nFit primary model\nfit_primary_model <- function(dat, ctr = contr.orthonorm, save = FALSE) {\n  mdat <- make_primary_model_data(\n    dat, c(\"inelgc3\", \"agegte60\", \"ctry\"), \n    c(10, 2.5, 1, 1), \n    ctr)\n  snk <- capture.output(\n    mfit <- ordmod$sample(\n      data = mdat,\n      seed = 712508,\n      chains = 8,\n      parallel_chains = 8,\n      iter_warmup = 1000,\n      iter_sampling = 2500,\n      refresh = 0,\n      adapt_delta = 0.98\n  ))\n  if (save) {\n    mfit$save_object(file.path(\"outputs\", \"models\", \"secondary\", \"7-2.rds\"))  \n  }\n  mdrws <- as_draws_rvars(mfit$draws())\n  # Add names\n  epoch_map <- dat %>% dplyr::count(epoch, epoch_lab)\n  site_map <- dat %>% dplyr::count(site_num, site)\n  names(mdrws$beta) <- colnames(mdat$X)\n  names(mdrws$gamma_epoch) <- epoch_map$epoch_lab\n  names(mdrws$gamma_site) <- site_map$site\n  # Convert to treatment log odds ratios\n  mdrws$Acon <- attr(mdat$X, \"contrasts\")$randA %**% mdrws$beta[grepl(\"randA[0-9]\", names(mdrws$beta))]\n  mdrws$Ccon <- attr(mdat$X, \"contrasts\")$randC %**% mdrws$beta[grepl(\"randC[0-9]\", names(mdrws$beta))]\n  mdrws$trtA <- mdrws$Acon[-1] - mdrws$Acon[1]\n  mdrws$trtC <- mdrws$Ccon[-1] - mdrws$Ccon[1]\n  mdrws$compare <- c(\n    \"Intermediate vs low\" = exp(mdrws$trtC[1]),\n    \"Low with aspirin vs low\" = exp(mdrws$trtC[2]),\n    \"Therapeutic vs low\" = exp(mdrws$trtC[3]),\n    \"Intermediate vs low with aspirin\" = exp(mdrws$trtC[1] - mdrws$trtC[2]),\n    \"Intermediate vs therapeutic\" = exp(mdrws$trtC[1] - mdrws$trtC[3]),\n    \"Low with aspirin vs therapeutic\" = exp(mdrws$trtC[2] - mdrws$trtC[3])\n  )\n  mdrws$OR <- c(\n    setNames(exp(mdrws$trtC), \n             c(\"Intermediate\", \"Low with aspirin\", \"Therapeutic\")),\n    \"Ineligible aspirin\" = exp(mdrws$beta[which(grepl(\"inelg\", colnames(mdat$X)))]),\n    \"Age \\u2265 60\" = exp(mdrws$beta[which(grepl(\"age\", colnames(mdat$X)))]),\n    setNames(exp(mdrws$beta[which(grepl(\"ctry\", colnames(mdat$X)))]), \n             c(\"Australia/New Zealand\", \"Nepal\"))\n  )\n  return(list(dat = mdat, fit = mfit, drws = mdrws))\n}\nres <- fit_primary_model(acs_itt_nona_dat, save = TRUE)\n\n\n\n\nOdds ratio summary table\nsave_tex_table(\n  odds_ratio_summary_table(res$drws$OR, \"latex\"),\n  \"outcomes/secondary/7-2-primary-model-acs-itt-summary-table\")\nodds_ratio_summary_table(res$drws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.81 \n    (0.61, 1.07) \n    0.82 (0.12) \n    0.93 \n  \n  \n    Low with aspirin \n    0.76 \n    (0.53, 1.09) \n    0.77 (0.14) \n    0.93 \n  \n  \n    Therapeutic \n    1.53 \n    (0.77, 3.06) \n    1.63 (0.60) \n    0.12 \n  \n  \n    Ineligible aspirin \n    1.72 \n    (0.78, 3.77) \n    1.86 (0.77) \n    0.09 \n  \n  \n    Age ≥ 60 \n    2.47 \n    (1.90, 3.27) \n    2.50 (0.35) \n    0.00 \n  \n  \n    Australia/New Zealand \n    1.37 \n    (0.42, 4.25) \n    1.62 (1.02) \n    0.30 \n  \n  \n    Nepal \n    0.73 \n    (0.23, 2.46) \n    0.88 (0.63) \n    0.71 \n  \n\n\n\nPosterior summaries for model parameters (fixed-effects).\n\n\n\nOdds ratio summary for epoch and site\np <- plot_epoch_site_terms(\n  exp(res$drws$gamma_epoch),\n  exp(res$drws$gamma_site),\n  factor(res$dat$region_by_site, \n         labels = c(\"India\", \"Australia\\nNew Zealand\", \"Nepal\"))\n)\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\", \"7-2-primary-model-epoch-site-terms.pdf\")\nggsave(pth, p, width = 6, height = 4.5)\np\n\n\n\n\n\nSummary of epoch and site posterior odds ratios.\n\n\n\n\n\n\nCode\np <- plot_or_densities(res$drws$compare)\np\n\n\n\n\n\nPosterior densities for treatment comparisons.\n\n\n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nres$fit$summary()\n\n\n# A tibble: 3,173 × 10\n   variable       mean   median      sd     mad       q5      q95  rhat ess_bulk\n   <chr>         <dbl>    <dbl>   <dbl>   <dbl>    <dbl>    <dbl> <dbl>    <dbl>\n 1 lp__       -1.06e+3 -1.06e+3 6.87e+0 6.78e+0 -1.08e+3 -1.05e+3  1.00    4798.\n 2 p0[1]       8.08e-1  8.21e-1 7.83e-2 7.17e-2  6.61e-1  9.11e-1  1.00    4178.\n 3 p0[2]       1.71e-1  1.60e-1 6.72e-2 6.32e-2  8.00e-2  2.97e-1  1.00    4205.\n 4 p0[3]       1.02e-3  7.95e-4 8.47e-4 5.71e-4  2.01e-4  2.56e-3  1.00    7625.\n 5 p0[4]       1.63e-3  1.33e-3 1.17e-3 8.34e-4  4.38e-4  3.84e-3  1.00    6787.\n 6 p0[5]       1.32e-3  1.05e-3 1.01e-3 7.02e-4  3.12e-4  3.17e-3  1.00    6937.\n 7 p0[6]       1.30e-3  1.04e-3 9.73e-4 6.93e-4  3.09e-4  3.16e-3  1.00    7225.\n 8 p0[7]       6.90e-4  5.08e-4 6.36e-4 4.09e-4  9.84e-5  1.91e-3  1.00    9201.\n 9 p0[8]       1.50e-2  1.31e-2 8.53e-3 6.48e-3  5.64e-3  3.10e-2  1.00    4369.\n10 beta_raw[…  5.04e-1  5.05e-1 2.76e-1 2.76e-1  5.16e-2  9.60e-1  1.00   14961.\n# … with 3,163 more rows, and 1 more variable: ess_tail <dbl>\n\n\nCode\nres$fit$diagnostic_summary()\n\n\n$num_divergent\n[1] 1 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.7457517 0.7515987 0.8222353 0.7093861 0.7255039 0.7288769 0.7351114\n[8] 0.7027627\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"alpha\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"gamma_site\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"gamma_epoch\"])\n\n\n\n\n\n\n\n\n\nPosterior Predictive\n\n\nCode\ny_ppc <- res$drws$y_ppc\nppc_dat <- bind_cols(acs_itt_nona_dat, tibble(y_ppc = y_ppc))\n\ngrp_ppc1 <- function(grp) {\n  ppc_dat  %>%\n  group_by(grp = !!grp) %>%\n  summarise(\n    y_1 = mean(D28_who == 1),\n    ypp_1 = rvar_mean(y_ppc == 1),\n    y_2 = mean(D28_who <= 2),\n    ypp_2 = rvar_mean(y_ppc <= 2),\n    y_3 = mean(D28_who <= 3),\n    ypp_3 = rvar_mean(y_ppc <= 3),\n    y_4 = mean(D28_who <= 4),\n    ypp_4 = rvar_mean(y_ppc <= 4),\n    y_5 = mean(D28_who <= 5),\n    ypp_5 = rvar_mean(y_ppc <= 5),\n    y_6 = mean(D28_who <= 6),\n    ypp_6 = rvar_mean(y_ppc <= 6),\n    y_7 = mean(D28_who <= 7),\n    ypp_7 = rvar_mean(y_ppc <= 7),\n    y_8 = mean(D28_who <= 8),\n    ypp_8 = rvar_mean(y_ppc <= 8)\n  ) %>%\n  pivot_longer(y_1:ypp_8, names_to = c(\"response\", \"who\"), names_sep = \"_\", values_to = \"posterior\") %>%\n  mutate(who = as.numeric(who))\n}\n\ngrp_ppc2 <- function(grp) {\n  ppc_dat  %>%\n  group_by(grp = !!grp) %>%\n  summarise(\n    y_1 = mean(D28_who == 1),\n    ypp_1 = rvar_mean(y_ppc == 1),\n    y_2 = mean(D28_who == 2),\n    ypp_2 = rvar_mean(y_ppc == 2),\n    y_3 = mean(D28_who == 3),\n    ypp_3 = rvar_mean(y_ppc == 3),\n    y_4 = mean(D28_who == 4),\n    ypp_4 = rvar_mean(y_ppc == 4),\n    y_5 = mean(D28_who == 5),\n    ypp_5 = rvar_mean(y_ppc == 5),\n    y_6 = mean(D28_who == 6),\n    ypp_6 = rvar_mean(y_ppc == 6),\n    y_7 = mean(D28_who == 7),\n    ypp_7 = rvar_mean(y_ppc == 7),\n    y_8 = mean(D28_who == 8),\n    ypp_8 = rvar_mean(y_ppc == 8)\n  ) %>%\n  pivot_longer(y_1:ypp_8, names_to = c(\"response\", \"who\"), \n               names_sep = \"_\", values_to = \"posterior\") %>%\n  mutate(who = as.numeric(who))\n}\n\nplot_grp_ppc <- function(dat) {\n  ggplot(dat %>% filter(response == \"ypp\"), aes(x = who)) +\n    facet_wrap( ~ grp, nrow = 1) +\n    stat_slabinterval(aes(ydist = posterior))  +\n    geom_point(data = dat %>% filter(response == \"y\"), \n               aes(x = who, y = mean(posterior)),\n               colour = \"red\",\n               shape = 23) +\n    labs(x = \"WHO outcome\", \n         y = \"Probability\")\n}\n\nplot_grp_ppc <- function(dat, lab = \"\", xlab = \"Probability\") {\n  ggplot(dat %>% filter(response == \"ypp\"), aes(y = who)) +\n    facet_wrap( ~ grp, nrow = 1) +\n    stat_slabinterval(aes(xdist = posterior), fatten_point = 1)  +\n    geom_point(data = dat %>% filter(response == \"y\"), \n               aes(y = who, x = mean(posterior)),\n               colour = \"red\",\n               shape = 23) +\n    scale_x_continuous(xlab, breaks = c(0, 0.5),\n                       sec.axis = sec_axis(~ . , name = lab, breaks = NULL, labels = NULL)) +\n    scale_y_continuous(\"WHO\\noutcome\", breaks = c(1,3,5,7)) +\n    theme(strip.text = element_text(size = rel(0.7)),\n          axis.title.x = element_text(size = rel(0.7)),\n          axis.text.x = element_text(size = rel(0.65)),\n          axis.title.y = element_text(size = rel(0.75)),\n          axis.title.x.bottom = element_blank())\n}\n\npp_epoch <- grp_ppc2(sym(\"epoch\")) %>% \n  mutate(grp = fct_inorder(factor(grp)))\npp_C <- grp_ppc2(sym(\"CAssignment\"))\npp_ctry <- grp_ppc2(sym(\"country\"))\npp_site <- grp_ppc2(sym(\"site\")) %>%\n  left_join(ppc_dat %>% dplyr::count(site, country), by = c(\"grp\" = \"site\"))\n\np1 <- plot_grp_ppc(pp_C, \"Anticoagulation\", \"\")\np2 <- plot_grp_ppc(pp_ctry, \"Country\", \"\") \np3 <- plot_grp_ppc(pp_epoch, \"Epoch\", \"\")\np4 <- plot_grp_ppc(pp_site %>% filter(country == \"IN\"), \"Sites India\", \"\")\np5 <- plot_grp_ppc(pp_site %>% filter(country == \"AU\"), \"Sites Australia\", \"\")\np6 <- plot_grp_ppc(pp_site %>% filter(country == \"NP\"), \"Sites Nepal\", \"\")\np7 <- plot_grp_ppc(pp_site %>% filter(country == \"NP\"), \"Sites New Zealand\", \"\")\np <- (p1 | p2) / p3 / p4 / p5 / (p6 | p7)\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\",\n                 \"7-2-primary-model-acs-itt-ppc.pdf\")\nggsave(pth, p, width = 6, height = 5.75)\np"
  },
  {
    "objectID": "analyses/7-2_who_ordinal_scale.html#sensitivity-concurrent-controls",
    "href": "analyses/7-2_who_ordinal_scale.html#sensitivity-concurrent-controls",
    "title": "7-2 WHO 8-point Outcome Scale",
    "section": "Sensitivity: Concurrent controls",
    "text": "Sensitivity: Concurrent controls\n\nIntermediate dose\n\nSet: ACS-ITT-intermediate\nCovariates: anticoagulation intervention, age group, region of enrolment.\n\n\n\nDescriptive summary table\nsave_tex_table(\n  make_summary_table(acs_itt_concurc2_dat, \"latex\"), \n  file.path(\"outcomes\", \"secondary\", \"7-2-anticoagulation-concurrent-intermediate-summary\"))\nmake_summary_table(acs_itt_concurc2_dat)\n\n\n\n\n \n  \n    Anticoagulation\nintervention \n    Patients \n    Known \n    Deaths \n    Hospitalised \n    WHO, Median (Q1, Q3) \n  \n \n\n  \n    Low-dose \n    610 \n    596 \n    19 (3%) \n    7 (1%) \n    1 (1, 2) \n  \n  \n    Intermediate-dose \n    613 \n    603 \n    15 (2%) \n    5 (1%) \n    1 (1, 2) \n  \n  \n    Overall \n    1223 \n    1199 \n    34 (3%) \n    12 (1%) \n    1 (1, 2) \n  \n\n\n\n\n\n\n\nSample distribution\npdat <- acs_itt_concurc2_nona_dat %>%\n  dplyr::count(\n    CAssignment = factor(\n      CAssignment, \n      levels = c(\"C1\", \"C2\"),\n      labels = c(\"Low\", \"Intermediate\")),\n    who = ordered(D28_who, levels = 1:8), \n    .drop = F) %>%\n  group_by(CAssignment) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup()\np <- ggplot(pdat, aes(CAssignment, p)) +\n  geom_col(aes(fill = who), colour = NA) +\n  labs(x = \"Anticoagulation intervention\", y = \"Cumulative proportion\") +\n  scale_fill_viridis_d(\"WHO scale\", option = \"A\", direction = -1) +\n  theme(legend.key.size = unit(0.75, \"lines\"))\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(pth, \"outcome-7-2-descriptive-concurrent-intermediate.pdf\"), p, height = 2.5, width = 4)\np\n\n\n\n\n\nDistribution of WHO outcome scale, ACS-ITT-intermediate.\n\n\n\n\n\n\nFit model\nctr <- contr.orthonorm\nX <- model.matrix( \n  ~ CAssignment + agegte60 + ctry, \n  data = acs_itt_concurc2_nona_dat, \n  contrasts.arg = list(CAssignment = ctr))[, -1]\ny_raw <- ordered(acs_itt_concurc2_nona_dat$D28_who)\ny_mod <- as.integer(y_raw)\nN <- dim(X)[1]\nK <- dim(X)[2]\nunique_y <- length(unique(y_mod))\nmdat <- list(\n  N = N, K = K, J = unique_y, X = X, y = y_mod, y_raw = y_raw,\n  p_par = 2 * rep(1 / unique_y, unique_y),\n  beta_sd = c(1, 2.5, 1, 1)\n)\nsnk <- capture.output(\n  mfit <- ordmod0$sample(\n    data = mdat,\n    seed = 75136,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    refresh = 0\n))\nmdrws <- as_draws_rvars(mfit$draws())\nnames(mdrws$beta) <- colnames(X)\nmdrws$Ccon <- as.vector(ctr(2) %**% mdrws$beta[1])\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\nmdrws$compare <- c(\"Intermediate vs low\" = exp(mdrws$Ctrt[1]))\nmdrws$OR <- c(\"Intermediate\" = exp(mdrws$Ctrt), \n              setNames(exp(mdrws$beta[2:4]), c(\"Age \\u2265 60\", \"Australia/New Zealand\", \"Nepal\")))\n\n\n\n\nPosterior contrast\np <- plot_or_densities(mdrws$compare)\np\n\n\n\n\n\n\n\nOdds ratio summary table\nsave_tex_table(\n  odds_ratio_summary_table(mdrws$OR, \"latex\"),\n  \"outcomes/secondary/7-2-primary-model-acs-itt-concurrent-intermediate-summary-table\")\nodds_ratio_summary_table(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.83 \n    (0.64, 1.08) \n    0.84 (0.11) \n    0.92 \n  \n  \n    Age ≥ 60 \n    2.77 \n    (2.11, 3.65) \n    2.80 (0.39) \n    0.00 \n  \n  \n    Australia/New Zealand \n    2.21 \n    (1.51, 3.23) \n    2.25 (0.44) \n    0.00 \n  \n  \n    Nepal \n    0.56 \n    (0.31, 0.97) \n    0.59 (0.17) \n    0.98 \n  \n\n\n\nPosterior summaries for model parameters.\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary()\n\n\n# A tibble: 24 × 10\n   variable       mean   median      sd     mad       q5      q95  rhat ess_bulk\n   <chr>         <dbl>    <dbl>   <dbl>   <dbl>    <dbl>    <dbl> <dbl>    <dbl>\n 1 lp__       -8.80e+2 -8.80e+2 2.43e+0 2.30e+0 -8.85e+2 -8.77e+2  1.00    8198.\n 2 beta_raw[… -1.29e-1 -1.29e-1 9.33e-2 9.34e-2 -2.83e-1  2.32e-2  1.00   32680.\n 3 beta_raw[…  4.08e-1  4.08e-1 5.53e-2 5.45e-2  3.18e-1  4.99e-1  1.00   21528.\n 4 beta_raw[…  7.94e-1  7.95e-1 1.95e-1 1.94e-1  4.73e-1  1.11e+0  1.00   27136.\n 5 beta_raw[… -5.77e-1 -5.71e-1 2.88e-1 2.86e-1 -1.06e+0 -1.12e-1  1.00   32058.\n 6 p[1]        7.91e-1  7.91e-1 1.45e-2 1.45e-2  7.66e-1  8.14e-1  1.00   19596.\n 7 p[2]        1.84e-1  1.84e-1 1.30e-2 1.30e-2  1.63e-1  2.06e-1  1.00   21477.\n 8 p[3]        1.22e-3  1.05e-3 8.10e-4 7.06e-4  2.47e-4  2.76e-3  1.00   27087.\n 9 p[4]        2.29e-3  2.11e-3 1.13e-3 1.07e-3  8.16e-4  4.42e-3  1.00   27665.\n10 p[5]        1.20e-3  1.03e-3 8.11e-4 7.02e-4  2.43e-4  2.78e-3  1.00   29866.\n# … with 14 more rows, and 1 more variable: ess_tail <dbl>\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.9741940 1.0757049 1.0154633 1.0669753 0.9840496 1.0026432 0.9969708\n[8] 0.9689346\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"alpha\"])\n\n\n\n\n\n\n\n\n\n\nLow-dose with aspirin\n\nSet: ACS-ITT-aspirin\nCovariates: anticoagulation intervention, age group, region of enrolment.\n\n\n\nDescriptive summary table\nsave_tex_table(\n  make_summary_table(acs_itt_concurc3_dat, \"latex\"), \n  file.path(\"outcomes\", \"secondary\", \"7-2-anticoagulation-concurrent-stdaspirin-summary\"))\nmake_summary_table(acs_itt_concurc3_dat)\n\n\n\n\n \n  \n    Anticoagulation\nintervention \n    Patients \n    Known \n    Deaths \n    Hospitalised \n    WHO, Median (Q1, Q3) \n  \n \n\n  \n    Low-dose \n    299 \n    291 \n    11 (4%) \n    5 (2%) \n    1 (1, 2) \n  \n  \n    Intermediate-dose \n    298 \n    293 \n    12 (4%) \n    3 (1%) \n    1 (1, 2) \n  \n  \n    Low-dose with aspirin \n    283 \n    281 \n    10 (4%) \n    5 (2%) \n    1 (1, 2) \n  \n  \n    Overall \n    880 \n    865 \n    33 (4%) \n    13 (2%) \n    1 (1, 2) \n  \n\n\n\n\n\n\n\nSample distribution\npdat <- acs_itt_concurc3_nona_dat %>%\n  dplyr::count(\n    CAssignment = factor(\n      CAssignment, \n      levels = c(\"C1\", \"C2\", \"C3\"),\n      labels = c(\"Low\", \"Intermediate\", \"Low\\nwith aspirin\")),\n    who = ordered(D28_who, levels = 1:8), \n    .drop = F) %>%\n  group_by(CAssignment) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup()\np <- ggplot(pdat, aes(CAssignment, p)) +\n  geom_col(aes(fill = who)) +\n  labs(x = \"Anticoagulation intervention\", y = \"Cumulative proportion\") +\n  scale_fill_viridis_d(\"WHO scale\", option = \"A\", direction = -1) +\n  theme(legend.key.size = unit(0.75, \"lines\"))\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(pth, \"outcome-7-2-descriptive-concurrent-stdaspirin.pdf\"), p, height = 2.5, width = 6)\np\n\n\n\n\n\nDistribution WHO outcome scale, ACS-ITT-aspirin.\n\n\n\n\n\n\nFit model\nctr <- contr.orthonorm\nX <- model.matrix( \n  ~ CAssignment + agegte60 + ctry, \n  data = acs_itt_concurc3_nona_dat, \n  contrasts.arg = list(CAssignment = ctr))[, -1]\ny_raw <- ordered(acs_itt_concurc3_nona_dat$D28_who)\ny_mod <- as.integer(y_raw)\nN <- dim(X)[1]\nK <- dim(X)[2]\nunique_y <- length(unique(y_mod))\nmdat <- list(\n  N = N, K = K, J = unique_y, X = X, y = y_mod, y_raw = y_raw,\n  p_par = 2 * rep(1 / unique_y, unique_y),\n  beta_sd = c(1, 1, 2.5, 1)\n)\nsnk <- capture.output(\n  mfit <- ordmod0$sample(\n    data = mdat,\n    seed = 135356,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    refresh = 0\n))\nmdrws <- as_draws_rvars(mfit$draws())\nnames(mdrws$beta) <- colnames(X)\nmdrws$Ccon <- as.vector(ctr(3) %**% mdrws$beta[1:2])\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\nmdrws$compare <- c(\"Intermediate vs low\" = exp(mdrws$Ctrt[1]),\n                   \"Low with aspirin vs low\" = exp(mdrws$Ctrt[2]),\n                   \"Intermediate vs low with aspirin\" = exp(mdrws$Ctrt[1] - mdrws$Ctrt[2]))\nmdrws$OR <- c(\"Intermediate\" = exp(mdrws$Ctrt[1]),\n              \"Low with aspirin\" = exp(mdrws$Ctrt[2]),\n              setNames(exp(mdrws$beta[3:4]), c(\"Age \\u2265 60\", \"Australia/New Zealand\")))\n\n\n\n\nPosterior contrast\nplot_or_densities(mdrws$compare)\n\n\n\n\n\n\n\nOdds ratio summary table\nsave_tex_table(\n  odds_ratio_summary_table(mdrws$OR, \"latex\"),\n  \"outcomes/secondary/7-2-primary-model-acs-itt-concurrent-stdaspirin-summary-table\")\nodds_ratio_summary_table(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.86 \n    (0.61, 1.22) \n    0.87 (0.16) \n    0.80 \n  \n  \n    Low with aspirin \n    0.73 \n    (0.51, 1.05) \n    0.74 (0.14) \n    0.96 \n  \n  \n    Age ≥ 60 \n    2.10 \n    (1.53, 2.88) \n    2.13 (0.34) \n    0.00 \n  \n  \n    Australia/New Zealand \n    0.95 \n    (0.52, 1.68) \n    0.99 (0.30) \n    0.56 \n  \n\n\n\nPosterior summaries for model parameters.\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary()\n\n\n# A tibble: 24 × 10\n   variable       mean   median      sd     mad       q5      q95  rhat ess_bulk\n   <chr>         <dbl>    <dbl>   <dbl>   <dbl>    <dbl>    <dbl> <dbl>    <dbl>\n 1 lp__       -7.14e+2 -7.13e+2 2.45    2.30    -7.18e+2 -7.10e+2  1.00    7984.\n 2 beta_raw[… -1.17e-1 -1.16e-1 0.131   0.132   -3.33e-1  9.73e-2  1.00   37321.\n 3 beta_raw[…  1.91e-1  1.91e-1 0.126   0.124   -1.81e-2  3.98e-1  1.00   39109.\n 4 beta_raw[…  2.97e-1  2.97e-1 0.0643  0.0639   1.91e-1  4.03e-1  1.00   24622.\n 5 beta_raw[… -5.40e-2 -4.95e-2 0.300   0.297   -5.59e-1  4.26e-1  1.00   34330.\n 6 p[1]        7.43e-1  7.43e-1 0.0178  0.0177   7.14e-1  7.72e-1  1.00   23448.\n 7 p[2]        2.14e-1  2.14e-1 0.0156  0.0154   1.89e-1  2.40e-1  1.00   26429.\n 8 p[3]        2.08e-3  1.78e-3 0.00138 0.00121  4.26e-4  4.79e-3  1.00   31594.\n 9 p[4]        3.89e-3  3.58e-3 0.00189 0.00175  1.39e-3  7.44e-3  1.00   33907.\n10 p[5]        2.97e-3  2.66e-3 0.00167 0.00150  8.59e-4  6.17e-3  1.00   31434.\n# … with 14 more rows, and 1 more variable: ess_tail <dbl>\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.9850497 1.0408767 0.9642583 1.0151688 1.0564695 0.9240525 0.9833757\n[8] 0.9764285\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"alpha\"])\n\n\n\n\n\n\n\n\n\n\nTherapeutic dose\n\nSet: ACS-ITT-therapeutic\nCovariates: anticoagulation intervention, age group, region of enrolment.\n\n\n\nDescriptive summary table\nsave_tex_table(\n  make_summary_table(acs_itt_concurc4_dat, \"latex\"), \n  file.path(\"outcomes\", \"secondary\", \"7-2-anticoagulation-concurrent-therapeutic-summary\"))\nmake_summary_table(acs_itt_concurc4_dat)\n\n\n\n\n \n  \n    Anticoagulation\nintervention \n    Patients \n    Known \n    Deaths \n    Hospitalised \n    WHO, Median (Q1, Q3) \n  \n \n\n  \n    Low-dose \n    79 \n    75 \n    3 (4%) \n    1 (1%) \n    1 (1, 2) \n  \n  \n    Intermediate-dose \n    65 \n    63 \n    1 (2%) \n    1 (2%) \n    1 (1, 2) \n  \n  \n    Therapeutic-dose \n    50 \n    50 \n    6 (12%) \n    1 (2%) \n    1 (1, 2) \n  \n  \n    Overall \n    194 \n    188 \n    10 (5%) \n    3 (2%) \n    1 (1, 2) \n  \n\n\n\n\n\n\n\nSample distribution\npdat <- acs_itt_concurc4_nona_dat %>%\n  dplyr::count(\n    CAssignment = factor(\n      CAssignment, \n      levels = c(\"C1\", \"C2\", \"C4\"),\n      labels = c(\"Low\", \"Intermediate\", \"Therapeutic\")),\n    who = ordered(D28_who, levels = 1:8), \n    .drop = F) %>%\n  group_by(CAssignment) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup()\np <- ggplot(pdat, aes(CAssignment, p)) +\n  geom_col(aes(fill = who)) +\n  labs(x = \"Anticoagulation intervention\", y = \"Cumulative proportion\") +\n  scale_fill_viridis_d(\"WHO scale\", option = \"A\", direction = -1) +\n  theme(legend.key.size = unit(0.75, \"lines\"))\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(pth, \"outcome-7-2-descriptive-concurrent-therapeutic.pdf\"), p, height = 2.5, width = 6)\np\n\n\n\n\n\nDistribution of WHO outcome scale, ACS-ITT-therapeutic.\n\n\n\n\n\n\nFit model\nctr <- contr.orthonorm\nX <- model.matrix( \n  ~ CAssignment + agegte60 + ctry, \n  data = acs_itt_concurc4_nona_dat, \n  contrasts.arg = list(CAssignment = ctr))[, -1]\ny_raw <- ordered(acs_itt_concurc4_nona_dat$D28_who)\ny_mod <- as.integer(y_raw)\nN <- dim(X)[1]\nK <- dim(X)[2]\nunique_y <- length(unique(y_mod))\nmdat <- list(\n  N = N, K = K, J = unique_y, X = X, y = y_mod, y_raw = y_raw,\n  p_par = 2 * rep(1 / unique_y, unique_y),\n  beta_sd = c(1, 1, 2.5, 1, 1)\n)\n\nsnk <- capture.output(\n  mfit <- ordmod0$sample(\n    data = mdat,\n    seed = 49135,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    refresh = 0\n))\nmdrws <- as_draws_rvars(mfit$draws())\nnames(mdrws$beta) <- colnames(X)\nmdrws$Ccon <- as.vector(ctr(3) %**% mdrws$beta[1:2])\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\nmdrws$compare <- c(\"Intermediate vs low\" = exp(mdrws$Ctrt[1]),\n                   \"Therapeutic vs low\" = exp(mdrws$Ctrt[2]),\n                   \"Intermediate vs therapeutic\" = exp(mdrws$Ctrt[1] - mdrws$Ctrt[2]))\nmdrws$OR <- c(\"Intermediate\" = exp(mdrws$Ctrt[1]),\n              \"Therapeutic\" = exp(mdrws$Ctrt[2]),\n              setNames(exp(mdrws$beta[3:5]), c(\"Age \\u2265 60\", \"India\", \"Australia/New Zealand\")))\n\n\n\n\nPosterior contrasts\nplot_or_densities(mdrws$compare)\n\n\n\n\n\n\n\nOdds ratio summary table\nsave_tex_table(\n  odds_ratio_summary_table(mdrws$OR, \"latex\"),\n  \"outcomes/secondary/7-2-primary-model-acs-itt-concurrent-therapeutic-summary-table\")\nodds_ratio_summary_table(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.49 \n    (0.22, 1.03) \n    0.53 (0.21) \n    0.97 \n  \n  \n    Therapeutic \n    1.08 \n    (0.50, 2.32) \n    1.16 (0.47) \n    0.42 \n  \n  \n    Age ≥ 60 \n    3.27 \n    (1.68, 6.45) \n    3.48 (1.24) \n    0.00 \n  \n  \n    India \n    0.99 \n    (0.37, 2.57) \n    1.11 (0.58) \n    0.51 \n  \n  \n    Australia/New Zealand \n    3.87 \n    (2.02, 7.63) \n    4.12 (1.45) \n    0.00 \n  \n\n\n\nPosterior summaries for model parameters.\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary()\n\n\n# A tibble: 22 × 10\n   variable       mean   median      sd     mad       q5      q95  rhat ess_bulk\n   <chr>         <dbl>    <dbl>   <dbl>   <dbl>    <dbl>    <dbl> <dbl>    <dbl>\n 1 lp__       -1.67e+2 -1.67e+2 2.38    2.23    -1.71e+2 -1.64e+2  1.00    8588.\n 2 beta_raw[…  5.59e-1  5.59e-1 0.292   0.290    8.38e-2  1.04e+0  1.00   22664.\n 3 beta_raw[…  2.61e-1  2.61e-1 0.270   0.268   -1.84e-1  7.08e-1  1.00   20274.\n 4 beta_raw[…  4.75e-1  4.74e-1 0.137   0.136    2.52e-1  7.01e-1  1.00   14420.\n 5 beta_raw[… -1.40e-2 -9.69e-3 0.496   0.491   -8.38e-1  7.88e-1  1.00   20324.\n 6 beta_raw[…  1.36e+0  1.35e+0 0.338   0.339    8.08e-1  1.92e+0  1.00   14624.\n 7 p[1]        8.52e-1  8.55e-1 0.0367  0.0359   7.86e-1  9.07e-1  1.00   11710.\n 8 p[2]        1.25e-1  1.23e-1 0.0306  0.0301   7.91e-2  1.80e-1  1.00   12950.\n 9 p[3]        2.39e-3  1.72e-3 0.00228 0.00161  2.02e-4  6.85e-3  1.00   18472.\n10 p[4]        2.25e-3  1.63e-3 0.00211 0.00151  1.86e-4  6.42e-3  1.00   15179.\n# … with 12 more rows, and 1 more variable: ess_tail <dbl>\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.9336335 0.9877803 1.0642128 0.9765569 0.9757024 1.0348876 1.0237602\n[8] 1.0054517\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"alpha\"])"
  },
  {
    "objectID": "analyses/7-2_who_ordinal_scale.html#sensitivity-treatment-contrast-prior",
    "href": "analyses/7-2_who_ordinal_scale.html#sensitivity-treatment-contrast-prior",
    "title": "7-2 WHO 8-point Outcome Scale",
    "section": "Sensitivity: Treatment contrast prior",
    "text": "Sensitivity: Treatment contrast prior\n\n\nFit primary model\nres <- fit_primary_model(acs_itt_nona_dat, contr.treatment, save = FALSE)\n\n\n\n\nOdds ratio summary table\nodds_ratio_summary_table(res$drws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.79 \n    (0.60, 1.05) \n    0.80 (0.12) \n    0.94 \n  \n  \n    Low with aspirin \n    0.75 \n    (0.52, 1.06) \n    0.76 (0.14) \n    0.95 \n  \n  \n    Therapeutic \n    1.45 \n    (0.73, 2.84) \n    1.54 (0.55) \n    0.14 \n  \n  \n    Ineligible aspirin \n    1.71 \n    (0.77, 3.70) \n    1.85 (0.77) \n    0.09 \n  \n  \n    Age ≥ 60 \n    2.48 \n    (1.90, 3.25) \n    2.50 (0.35) \n    0.00 \n  \n  \n    Australia/New Zealand \n    1.41 \n    (0.42, 4.32) \n    1.66 (1.05) \n    0.28 \n  \n  \n    Nepal \n    0.75 \n    (0.23, 2.46) \n    0.90 (0.64) \n    0.70 \n  \n\n\n\nPosterior summaries for model parameters (fixed-effects).\n\n\n\nOdds ratio summary for epoch and site\np <- plot_epoch_site_terms(\n  exp(res$drws$gamma_epoch),\n  exp(res$drws$gamma_site),\n  factor(res$dat$region_by_site, \n         labels = c(\"India\", \"Australia\\nNew Zealand\", \"Nepal\"))\n)\np\n\n\n\n\n\nSummary of epoch and site posterior odds ratios.\n\n\n\n\n\n\nCode\np <- plot_or_densities(res$drws$compare)\np\n\n\n\n\n\nPosterior densities for treatment comparisons."
  },
  {
    "objectID": "analyses/7-3_all_cause_mortality.html",
    "href": "analyses/7-3_all_cause_mortality.html",
    "title": "7-3 All Cause Mortality Day 28",
    "section": "",
    "text": "Load packages\nlibrary(tidyverse)\nlibrary(labelled)\nlibrary(kableExtra)\nlibrary(cmdstanr)\nlibrary(posterior)\nlibrary(bayestestR)\nlibrary(bayesplot)\nlibrary(matrixStats)\nlibrary(lubridate)\nlibrary(patchwork)\nlibrary(ggdist)\n\ntheme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank()))\nbayesplot_theme_set(theme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank())))\ncolor_scheme_set(\"red\")\noptions(digits = 4)\n\n\n\n\nPrepare dataset\ndevtools::load_all()\nall_dat <- read_all_no_daily()\n\n# Anticoagulation set (intention-to-treat, including missing)\nacs_itt_dat <- all_dat %>% \n  filter_acs_itt() %>%\n  transmute_model_cols_grp_aus_nz()\n\n# Anticoagulation set (intention-to-treat, excluding missing)\nacs_itt_nona_dat <- acs_itt_dat %>% \n  filter(!is.na(D28_death))  \n\n# Concurrent enrolments for C2\nacs_itt_concurc2_dat <- acs_itt_dat %>%\n  filter_concurrent_intermediate()\nacs_itt_concurc2_nona_dat <- acs_itt_concurc2_dat %>% \n  filter(!is.na(D28_death))\n\n# Concurrent enrolments for C3\nacs_itt_concurc3_dat <- acs_itt_dat %>%\n  filter_concurrent_std_aspirin()\nacs_itt_concurc3_nona_dat <- acs_itt_concurc3_dat %>% \n  filter(!is.na(D28_death))\n\n# Concurrent enrolments for C4\nacs_itt_concurc4_dat <- acs_itt_dat %>%\n  filter_concurrent_therapeutic()\nacs_itt_concurc4_nona_dat <- acs_itt_concurc4_dat %>% \n  filter(!is.na(D28_death))\n\n\n\n\nLoad the Stan models\nmodel_full <- cmdstan_model(file.path(\"stan\", \"binary\", \"logistic_site_epoch.stan\"))\nmodel_site_only <- cmdstan_model(file.path(\"stan\", \"binary\", \"logistic_site.stan\"))\nmodel_epoch_only <- cmdstan_model(file.path(\"stan\", \"binary\", \"logistic_epoch.stan\")) \nmodel_fixed_only <- cmdstan_model(file.path(\"stan\", \"binary\", \"logistic.stan\"))\n\n\n\n\nHelper functions for this analysis script\nmake_stan_data <- function(\n    dat, \n    vars = NULL, \n    outcome = NULL, \n    beta_sd = NULL, \n    ctr = contr.orthonorm) {\n\n  X <- make_X_design(dat, vars, ctr)\n  nXassign <- sum(grepl(\"rand\", colnames(X))) - 1\n  beta_sd <- c(2.5, rep(1, nXassign), beta_sd)\n\n  y <- dat[[outcome]]\n  N <- dim(X)[1]\n  K <- dim(X)[2]  \n  \n    epoch  <- dat$epoch\n  M_epoch  <- max(dat$epoch)\n    region <- dat[[\"ctry_num\"]]\n  M_region <- max(region)\n    site <- dat[[\"site_num\"]]\n  M_site <- max(site)\n  region_by_site <- region_by_site <- dat %>% \n    dplyr::count(ctry_num, site_num) %>% \n    pull(ctry_num)\n  \n  list(N = N, K = K, X = X, y = y,\n       M_region = M_region, region = region,\n       M_site = M_site, site = site,\n       M_epoch = M_epoch, epoch = epoch,\n       region_by_site = region_by_site,\n       beta_sd = beta_sd)\n}\n\nmake_stan_data_concurrent <- function(\n    dat, \n    vars = NULL, \n    outcome = NULL, \n    beta_sd = NULL, \n    ctr = contr.orthonorm) {\n  \n  X <- make_X_design(dat, vars, ctr, includeA = FALSE)\n  nXassign <- sum(grepl(\"rand\", colnames(X))) - 1\n  beta_sd <- c(2.5, rep(1, nXassign), beta_sd)\n  y <- dat[[outcome]]\n  N <- dim(X)[1]\n  K <- dim(X)[2]  \n  list(N = N, K = K, X = X, y = y, beta_sd = beta_sd)\n}\n\nmake_mortality_table <- function(dat, format = \"html\") {\n  tab <- dat %>%\n    mutate(CAssignment = factor(\n      CAssignment, \n      levels = c(\"C1\", \"C2\", \"C3\", \"C4\"),\n      labels = str_replace(intervention_labels()$CAssignment[-1], \"<br>\", \" \"))) %>%\n    group_by(CAssignment) %>%\n    summarise(\n      Patients = n(),\n      Known = sprintf(\n        \"%i (%.1f)\", sum(!is.na(D28_death)), 100 * mean(!is.na(D28_death))),\n      Missing = sprintf(\n        \"%i (%.1f)\", sum(is.na(D28_death)), 100 * mean(is.na(D28_death))),\n      `Died by day 28` = sprintf(\n        \"%i (%.1f)\", sum(D28_death, na.rm = TRUE), 100 * mean(D28_death, na.rm = TRUE)),\n    ) %>%\n    bind_rows(\n      dat  %>%\n        group_by(CAssignment = \"Overall\") %>%\n        summarise(\n          Patients = n(),\n          Known = sprintf(\n            \"%i (%.1f)\", sum(!is.na(D28_death)), 100 * mean(!is.na(D28_death))),\n          Missing = sprintf(\n            \"%i (%.1f)\", sum(is.na(D28_death)), 100 * mean(is.na(D28_death))),\n          `Died by day 28` = sprintf(\n            \"%i (%.1f)\", sum(D28_death, na.rm = TRUE), 100 * mean(D28_death, na.rm = TRUE)),\n      )\n    ) %>%\n    mutate(CAssignment = fct_inorder(CAssignment)) %>%\n    gather(key, value, -CAssignment, factor_key = T) %>%\n    spread(key, value)\n  colnames(tab)[1] <- \"n (\\\\%)\"\n  if(format == \"latex\") {\n    colnames(tab) <- linebreak(colnames(tab), align = \"c\", linebreaker = \"<br>\")\n  }\n    kable(tab,\n      format = format,\n      align = \"lrrrrr\",\n      escape = FALSE,\n      booktabs = TRUE\n    ) %>%\n    kable_styling(font_size = 10, latex_options = \"HOLD_position\")  %>%\n    row_spec(nrow(tab), bold = TRUE)\n}"
  },
  {
    "objectID": "analyses/7-3_all_cause_mortality.html#anticoagulation",
    "href": "analyses/7-3_all_cause_mortality.html#anticoagulation",
    "title": "7-3 All Cause Mortality Day 28",
    "section": "Anticoagulation",
    "text": "Anticoagulation\n\n\nSummary table\nsave_tex_table(make_mortality_table(\n      all_dat %>%\n      filter_acs_itt(),\n      \"latex\"), \n      \"outcomes/secondary/anticoagulation-summary-mortality\")\nmake_mortality_table(\n    all_dat %>%\n      filter_acs_itt()\n)\n\n\n\n\n \n  \n    n (\\%) \n    Patients \n    Known \n    Missing \n    Died by day 28 \n  \n \n\n  \n    Low dose \n    610 \n    596 (97.7) \n    14 (2.3) \n    19 (3.2) \n  \n  \n    Intermediate dose \n    613 \n    603 (98.4) \n    10 (1.6) \n    15 (2.5) \n  \n  \n    Low dose with aspirin \n    283 \n    281 (99.3) \n    2 (0.7) \n    10 (3.6) \n  \n  \n    Therapeutic dose \n    50 \n    50 (100.0) \n    0 (0.0) \n    6 (12.0) \n  \n  \n    Overall \n    1556 \n    1530 (98.3) \n    26 (1.7) \n    50 (3.3) \n  \n\n\n\nSummary of mortality to day 28 by anticoagulation intervention."
  },
  {
    "objectID": "analyses/7-3_all_cause_mortality.html#age",
    "href": "analyses/7-3_all_cause_mortality.html#age",
    "title": "7-3 All Cause Mortality Day 28",
    "section": "Age",
    "text": "Age\n\n\nRelationship age to outcome\nagedat <- acs_itt_dat %>%\n  dplyr::count(D28_death, AgeAtEntry) %>% \n  spread(D28_death, n, fill = 0) %>% \n  mutate(\n    n = `0` + `1` + `<NA>`,\n    p = `1` / (`1` + `0`))\nagemod <- glm(\n  cbind(`1`, `0`) ~ AgeAtEntry, \n  data = agedat, \n  family = binomial())\nagedat <- agedat %>%\n  mutate(\n    ypred = predict(agemod, newdata = agedat, type = \"response\")\n  )\np1 <- ggplot(agedat, aes(AgeAtEntry, n)) +\n  geom_col(colour = \"grey40\", fill = \"grey40\") +\n  geom_vline(xintercept = 60, linetype = 2) +\n  labs(y = \"Number of\\nparticipants\",\n       x = \"Age at entry\")\np2 <- ggplot(agedat, aes(AgeAtEntry, p)) +\n    geom_point() +\n    geom_vline(xintercept = 60, linetype = 2) +\n    geom_line(aes(y = ypred)) +\n    labs(y = \"Proportion\\ndied by day 28\", x = \"Age at entry\")\np <- p1 | p2\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-3-age.pdf\"), p, height = 2, width = 6)\np\n\n\n\n\n\nFigure 1: Relationship (logistic regression linear in age) between age at entry and the primary outcome."
  },
  {
    "objectID": "analyses/7-3_all_cause_mortality.html#country",
    "href": "analyses/7-3_all_cause_mortality.html#country",
    "title": "7-3 All Cause Mortality Day 28",
    "section": "Country",
    "text": "Country\n\n\nRelationship country to outcome\ntdat <- all_dat %>%\n  filter_acs_itt() %>%\n  dplyr::count(Country = fct_infreq(PT_CountryName), D28_death) %>%\n  group_by(Country) %>%\n  spread(D28_death, n, fill = 0) %>%\n  mutate(\n    n = `1` + `0` + `<NA>`,\n    p_1 = `1` / (`1` + `0`),\n    p_miss = `<NA>` / (`1` + `0` + `<NA>`)\n  )\np1 <- ggplot(tdat, aes(Country, n)) +\n  geom_col() +\n    labs(\n      y = \"Number of\\nparticipants\", \n      x = \"Country of enrolment\")\np2 <- ggplot(tdat, aes(Country, p_1)) +\n  geom_point() +\n    labs(\n      y = \"Proportion\\ndied by day 28\", \n      x = \"Country of enrolment\")  +\n  ylim(0, NA)\np <- p1 | p2\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-3-country.pdf\"), p, height = 2, width = 6)\np\n\n\n\n\n\nFigure 2: Mortality by country."
  },
  {
    "objectID": "analyses/7-3_all_cause_mortality.html#site",
    "href": "analyses/7-3_all_cause_mortality.html#site",
    "title": "7-3 All Cause Mortality Day 28",
    "section": "Site",
    "text": "Site\n\n\nRelationship site to outcome\ntdat <- all_dat %>%\n  filter_acs_itt() %>%\n  dplyr::count(\n    Country_lab = Country,\n    Site_lab = fct_infreq(Location),\n    Country = factor(PT_CountryName, levels = c(\"India\", \"Australia\", \"Nepal\", \"New Zealand\")),\n    Site = PT_LocationName,\n    D28_death) %>%\n  group_by(Country, Site) %>%\n  spread(D28_death, n, fill = 0) %>%\n  mutate(\n    n = `1` + `0` + `<NA>`,\n    p_1 = `1` / (`1` + `0`),\n    p_miss = `<NA>` / (`1` + `0` + `<NA>`)\n  ) %>%\n  ungroup()\n\np1 <- ggplot(tdat, aes(Site_lab, n)) +\n  facet_grid( ~ Country, scales = \"free_x\", space = \"free_x\") +\n  geom_col() +\n    labs(\n      y = \"Number of\\nparticipants\", \n      x = \"\") +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        panel.border = element_rect(fill = NA))\np2 <- ggplot(tdat, aes(Site_lab, p_1)) +\n  facet_grid( ~ Country, scales = \"free_x\", space = \"free_x\") +\n  geom_point() +\n    labs(\n      y = \"Proportion\\ndied by day 28\", \n      x = \"Site of enrolment\") +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        panel.border = element_rect(fill = NA))\np <- p1 / p2\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-3-country-site.pdf\"), p, height = 4, width = 6.25)\np\n\n\n\n\n\nFigure 3: Day 28 mortality by site within country."
  },
  {
    "objectID": "analyses/7-3_all_cause_mortality.html#calendar-time",
    "href": "analyses/7-3_all_cause_mortality.html#calendar-time",
    "title": "7-3 All Cause Mortality Day 28",
    "section": "Calendar Time",
    "text": "Calendar Time\n\n\nRelationship calendar date to outcome\ncaldat <- all_dat %>% \n  filter_acs_itt() %>%\n  dplyr::count(D28_death, yr = year(RandDate), mth = month(RandDate)) %>% \n  spread(D28_death, n, fill = 0) %>% \n  mutate(p = `1` / (`1` + `0`),\n         n = `1` + `0` + `<NA>`)\np1 <- ggplot(caldat, aes(mth, p)) +\n  facet_grid( ~ yr, drop = T, scales = \"free_x\", space = \"free\") +\n    geom_point() +\n    labs(\n      y = \"Proportion\\ndied by day 28\", \n      x = \"Calendar date (month of year)\") +\n  scale_x_continuous(breaks = 1:12) +\n  ylim(0, 0.15)\np2 <- ggplot(caldat, aes(mth, n)) +\n  facet_grid( ~ yr, drop = T, scales = \"free_x\", space = \"free\") +\n    geom_col() +\n    labs(\n      y = \"Number of\\nparticipants\", \n      x = \"Calendar date (month of year)\") +\n  scale_x_continuous(breaks = 1:12)\np <- p2 | p1\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-3-calendar-time.pdf\"), p, height = 2, width = 6)\np\n\n\n\n\n\nFigure 4: Relationship between calendar date and the primary outcome."
  },
  {
    "objectID": "analyses/7-3_all_cause_mortality.html#primary-model",
    "href": "analyses/7-3_all_cause_mortality.html#primary-model",
    "title": "7-3 All Cause Mortality Day 28",
    "section": "Primary model",
    "text": "Primary model\n\n\nData and sampling\nseed <- 59579\nmdat <- make_stan_data(\n    dat = acs_itt_nona_dat, \n    vars    = c(\"inelgc3\", \"agegte60\", \"ctry\"),\n    outcome = \"D28_death\",\n    beta_sd = c(10, 2.5, 1, 1))\nsnk <- capture.output(\n  mfit <- model_full$sample(\n    data = mdat,\n    seed = seed,\n    refresh = 0,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    chains = 8,\n    parallel_chains = 8,\n    adapt_delta = 0.99\n))\nmfit$save_object(file.path(\"outputs\", \"models\", \"secondary\", \"7-3.rds\"))\nmdrws <- as_draws_rvars(mfit$draws())\nnames(mdrws$beta) <- colnames(mdat$X)\nnames(mdrws$gamma_epoch) <- acs_itt_nona_dat %>% dplyr::count(epoch, epoch_lab) %>% pull(epoch_lab)\nnames(mdrws$gamma_site) <- acs_itt_nona_dat %>% dplyr::count(site_num, site) %>% pull(site)\nsite_facet <- factor(mdat$region_by_site, labels = c(\"India\", \"Australia\\nNew Zealand\", \"Nepal\"))\n\nmdrws$Acon <- attr(mdat$X, \"contrasts\")$randA %**% mdrws$beta[grepl(\"randA[0-9]\", names(mdrws$beta))]\nmdrws$Ccon <- attr(mdat$X, \"contrasts\")$randC %**% mdrws$beta[grepl(\"randC[0-9]\", names(mdrws$beta))]\nmdrws$Atrt <- mdrws$Acon[-1] - mdrws$Acon[1]\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\nmdrws$compare <- c(\n  \"Intermediate vs low\" = exp(mdrws$Ctrt[1]),\n  \"Low with aspirin vs low\" = exp(mdrws$Ctrt[2]),\n  \"Therapeutic vs low\" = exp(mdrws$Ctrt[3]),\n  \"Intermediate vs low with aspirin\" = exp(mdrws$Ctrt[1] - mdrws$Ctrt[2]),\n  \"Intermediate vs therapeutic\" = exp(mdrws$Ctrt[1] - mdrws$Ctrt[3]),\n  \"Low with aspirin vs therapeutic\" = exp(mdrws$Ctrt[2] - mdrws$Ctrt[3])\n)\nmdrws$OR <- c(\n  setNames(exp(mdrws$Ctrt), c(\"Intermediate\", \"Low with aspirin\", \"Therapeutic\")),\n  setNames(exp(mdrws$beta[7:8]), c(\"Ineligible aspirin\", \"Age \\u2265 60\")),\n  setNames(exp(mdrws$beta[9:10]), c(\"Australia/New Zealand\", \"Nepal\"))\n)\n\n\n\n\nOdds ratio summary table\nsave_tex_table(\n  odds_ratio_summary_table(mdrws$OR, \"latex\"),\n  \"outcomes/secondary/7-3-primary-model-acs-itt-summary-table\")\nodds_ratio_summary_table(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.84 \n    (0.42, 1.70) \n    0.89 (0.33) \n    0.69 \n  \n  \n    Low with aspirin \n    0.82 \n    (0.35, 1.84) \n    0.89 (0.39) \n    0.69 \n  \n  \n    Therapeutic \n    3.17 \n    (0.96, 10.05) \n    3.77 (2.43) \n    0.03 \n  \n  \n    Ineligible aspirin \n    4.73 \n    (1.23, 16.96) \n    5.82 (4.21) \n    0.01 \n  \n  \n    Age ≥ 60 \n    2.08 \n    (1.12, 3.86) \n    2.19 (0.72) \n    0.01 \n  \n  \n    Australia/New Zealand \n    0.62 \n    (0.13, 2.75) \n    0.82 (0.73) \n    0.73 \n  \n  \n    Nepal \n    2.85 \n    (0.57, 11.08) \n    3.61 (2.87) \n    0.09 \n  \n\n\n\n\n\n\n\nEpoch and site terms\np <- plot_epoch_site_terms(\n  exp(mdrws$gamma_epoch), \n  exp(mdrws$gamma_site), \n  site_facet\n)\npth <- file.path(\n  \"outputs\", \"figures\", \"outcomes\", \"secondary\", \"7-3-primary-model-epoch-site-terms.pdf\")\nggsave(pth, p, width = 6, height = 4.5)\np\n\n\n\n\n\n\n\nCode\np <- plot_or_densities(mdrws$compare)\np\n\n\n\n\n\nPosterior densities for treatment comparisons.\n\n\n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary(variables = c(\"beta\", \"gamma_site\", \"gamma_epoch\"))\n\n\n# A tibble: 48 × 10\n   variable    mean  median    sd   mad     q5     q95  rhat ess_bulk ess_tail\n   <chr>      <dbl>   <dbl> <dbl> <dbl>  <dbl>   <dbl> <dbl>    <dbl>    <dbl>\n 1 beta[1]  -4.73   -4.68   0.765 0.754 -6.05  -3.56    1.00   11020.   13326.\n 2 beta[2]   0.975   0.977  0.483 0.482  0.189  1.78    1.00   24918.   15667.\n 3 beta[3]  -0.222  -0.220  0.282 0.281 -0.689  0.239   1.00   26301.   16533.\n 4 beta[4]  -0.499  -0.501  0.330 0.326 -1.04   0.0440  1.00   24973.   16489.\n 5 beta[5]  -0.999  -1.00   0.828 0.822 -2.37   0.364   1.00   26126.   15510.\n 6 beta[6]  -0.0637 -0.0680 0.845 0.854 -1.43   1.31    1.00   31265.   15003.\n 7 beta[7]   1.54    1.55   0.664 0.663  0.449  2.61    1.00   27291.   15723.\n 8 beta[8]   0.733   0.734  0.318 0.318  0.211  1.26    1.00   28048.   15306.\n 9 beta[9]  -0.498  -0.485  0.792 0.802 -1.81   0.786   1.00   21930.   15612.\n10 beta[10]  1.02    1.05   0.748 0.719 -0.265  2.20    1.00   15008.   13871.\n# … with 38 more rows\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.7989 0.8661 0.8909 0.8373 0.8476 0.8309 0.8887 0.8998\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"gamma_site\"])\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"gamma_epoch\"])\n\n\n\n\n\nCode\nmcmc_trace(mdrws[c(\"tau_site\", \"tau_epoch\")])\n\n\n\n\n\n\n\n\n\nPosterior predictive\n\n\nCode\ny_ppc <- mdrws$y_ppc\nppc_dat <- bind_cols(acs_itt_nona_dat, tibble(y_ppc = y_ppc))\n\ngrp_ppc <- function(grp) {\n  ppc_dat %>%\n    group_by(grp = !!grp) %>%\n    summarise(\n      mean_y = mean(D28_death),\n      rvar_mean_y_ppc = rvar_mean(y_ppc)\n    )\n}\nplot_grp_ppc <- function(dat, lab = \"\") {\n  dat %>%\n    ggplot(aes(y = grp, xdist = rvar_mean_y_ppc)) +\n    stat_interval(size = 2) +\n    geom_point(aes(x = mean_y, y = 1:nrow(dat)), colour = \"red\", shape = 23) +\n    labs(\n      x = \"Posterior predictive\\nproportion\", \n      y = lab)  \n}\n\nppc_C <- grp_ppc(sym(\"CAssignment\"))\nppc_ctry <- grp_ppc(sym(\"country\"))\nppc_epoch <- grp_ppc(sym(\"epoch\"))\nppc_site <- ppc_dat %>%\n  group_by(Country = country, grp = site_raw) %>%\n  summarise(\n    mean_y = mean(D28_death),\n    rvar_mean_y_ppc = rvar_mean(y_ppc)\n  )\n\np1 <- plot_grp_ppc(ppc_C, \"Anticoagulation\\nintervention\") + labs(x = \"\")\np2 <- plot_grp_ppc(ppc_ctry, \"Country\") + labs(x = \"\")\np3 <- plot_grp_ppc(ppc_epoch, \"Epoch\") + labs(x = \"\")\np4 <- plot_grp_ppc(ppc_site %>% filter(Country == \"IN\"), \"Sites\\nIndia\")  + labs(x = \"\")\np5 <- plot_grp_ppc(ppc_site %>% filter(Country == \"AU\"), \"Sites\\nAustralia\") + labs(x = \"\")\np6 <- plot_grp_ppc(ppc_site %>% filter(Country == \"NP\"), \"Sites\\nNepal\")\np7 <- plot_grp_ppc(ppc_site %>% filter(Country == \"NZ\"), \"Sites\\nNZ\")\np <- ((p3 | p1 / p2) / \n        ( (p4 | p5) / (p6 | p7) + \n            plot_layout(heights = c(3, 1)) ) ) +\n  plot_layout(heights = c(1, 1.5), guides = \"collect\")\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\",\n                 \"7-3-primary-model-acs-itt-ppc.pdf\")\nggsave(pth, p, width = 6, height = 5.5)\np\n\n\n\n\n\nPosterior predictive distribution versus observed proportion (red diamond)."
  },
  {
    "objectID": "analyses/7-3_all_cause_mortality.html#sensitivity-reduced-model-no-site-terms",
    "href": "analyses/7-3_all_cause_mortality.html#sensitivity-reduced-model-no-site-terms",
    "title": "7-3 All Cause Mortality Day 28",
    "section": "Sensitivity: Reduced model (no site terms)",
    "text": "Sensitivity: Reduced model (no site terms)\nThe primary model is re-fit without the hierarchical site terms.\n\n\nFit model\nmdat <- make_stan_data(\n  acs_itt_nona_dat,\n  c(\"inelgc3\", \"agegte60\", \"ctry\"),\n  \"D28_death\",\n  c(10, 2.5, 1, 1)\n)\nsnk <- capture.output(\n  mfit <- model_epoch_only$sample(\n    data = mdat,\n    seed = 14646,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    refresh = 0,\n    adapt_delta = 0.99\n))\nmdrws <- as_draws_rvars(mfit$draws(c(\"beta\", \"gamma_epoch\", \"tau_epoch\")))\nnames(mdrws$beta) <- colnames(mdat$X)\nepoch_map <- acs_itt_nona_dat %>% dplyr::count(epoch, epoch_lab)\nnames(mdrws$gamma_epoch) <- epoch_map$epoch_lab\nmdrws$Ccon <- attr(mdat$X, \"contrasts\")$randC %**% mdrws$beta[2:4]\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\nmdrws$OR <- c(\n  setNames(exp(mdrws$Ctrt), c(\"Intermediate\", \"Low with aspirin\", \"Therapeutic\")),\n  setNames(exp(mdrws$beta[-(1:6)]), c(\"Ineligible aspirin\", \"Age \\u2265 60\", \"Australia/New Zealand\", \"Nepal\"))\n)\n\n\n\n\nOdds ratio summary\nodds_ratio_summary_table(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.83 \n    (0.42, 1.61) \n    0.88 (0.31) \n    0.71 \n  \n  \n    Low with aspirin \n    0.84 \n    (0.38, 1.83) \n    0.91 (0.37) \n    0.67 \n  \n  \n    Therapeutic \n    3.39 \n    (1.04, 10.68) \n    4.04 (2.61) \n    0.02 \n  \n  \n    Ineligible aspirin \n    2.86 \n    (0.85, 8.26) \n    3.30 (1.97) \n    0.05 \n  \n  \n    Age ≥ 60 \n    2.32 \n    (1.28, 4.25) \n    2.44 (0.76) \n    0.00 \n  \n  \n    Australia/New Zealand \n    0.76 \n    (0.16, 3.05) \n    0.97 (0.78) \n    0.65 \n  \n  \n    Nepal \n    4.56 \n    (1.55, 13.75) \n    5.34 (3.29) \n    0.00 \n  \n\n\n\nOdds ratio summary table for no epoch model.\n\n\n\nCode\nplot_epoch_terms(exp(mdrws$gamma_epoch))\n\n\n\n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary(variables = c(\"beta\", \"gamma_epoch\", \"tau_epoch\"))\n\n\n# A tibble: 23 × 10\n   variable    mean  median    sd   mad      q5     q95  rhat ess_bulk ess_tail\n   <chr>      <dbl>   <dbl> <dbl> <dbl>   <dbl>   <dbl> <dbl>    <dbl>    <dbl>\n 1 beta[1]  -5.01   -4.97   0.663 0.652 -6.16   -3.99    1.00   14715.   12970.\n 2 beta[2]   1.01    1.00   0.478 0.478  0.224   1.78    1.00   20283.   15713.\n 3 beta[3]  -0.246  -0.246  0.274 0.274 -0.701   0.201   1.00   22550.   15654.\n 4 beta[4]  -0.548  -0.547  0.326 0.330 -1.08   -0.0154  1.00   19992.   15215.\n 5 beta[5]  -0.936  -0.932  0.811 0.803 -2.30    0.386   1.00   25416.   16103.\n 6 beta[6]  -0.0529 -0.0600 0.856 0.852 -1.45    1.37    1.00   26701.   13969.\n 7 beta[7]   1.03    1.05   0.585 0.581  0.0344  1.96    1.00   25791.   13258.\n 8 beta[8]   0.844   0.843  0.303 0.303  0.349   1.34    1.00   27646.   15597.\n 9 beta[9]  -0.306  -0.278  0.756 0.753 -1.59    0.900   1.00   24776.   15176.\n10 beta[10]  1.52    1.52   0.557 0.553  0.602   2.43    1.00   15983.   14684.\n# … with 13 more rows\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.8841 0.9230 0.8853 0.8829 0.9267 0.8939 0.8181 0.8834\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"gamma_epoch\"])\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"tau_epoch\"])"
  },
  {
    "objectID": "analyses/7-3_all_cause_mortality.html#sensitivity-reduced-model-no-epoch-terms",
    "href": "analyses/7-3_all_cause_mortality.html#sensitivity-reduced-model-no-epoch-terms",
    "title": "7-3 All Cause Mortality Day 28",
    "section": "Sensitivity: Reduced model (no epoch terms)",
    "text": "Sensitivity: Reduced model (no epoch terms)\nThe primary model is re-fit without the epoch terms.\n\n\nFit model\nmdat <- make_stan_data(\n  acs_itt_nona_dat,\n  c(\"inelgc3\", \"agegte60\", \"ctry\"),\n  \"D28_death\",\n  c(10, 2.5, 1, 1)\n)\nsnk <- capture.output(\n  mfit <- model_site_only$sample(\n    data = mdat,\n    seed = 123513,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    refresh = 0,\n    adapt_delta = 0.99\n))\n\nmdrws <- as_draws_rvars(mfit$draws(c(\"beta\", \"gamma_site\", \"tau_site\")))\nsite_map <- acs_itt_nona_dat %>% dplyr::count(site_num, site)\nsite_facet <-   factor(mdat$region_by_site, labels = c(\"India\", \"Australia\\nNew Zealand\", \"Nepal\"))\nnames(mdrws$beta) <- colnames(mdat$X)\nnames(mdrws$gamma_site) <- site_map$site\nmdrws$Ccon <- attr(mdat$X, \"contrasts\")$randC %**% mdrws$beta[2:4]\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\nmdrws$OR <- c(\n  setNames(exp(mdrws$Ctrt), c(\"Intermediate\", \"Low with aspirin\", \"Therapeutic\")),\n  setNames(exp(mdrws$beta[-(1:6)]), c(\"Ineligible aspirin\", \"Age \\u2265 60\", \"Australia/New Zealand\", \"Nepal\"))\n)\n\n\n\n\nOdds ratio summary\nodds_ratio_summary_table(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.84 \n    (0.42, 1.67) \n    0.89 (0.33) \n    0.69 \n  \n  \n    Low with aspirin \n    0.88 \n    (0.39, 1.95) \n    0.96 (0.41) \n    0.62 \n  \n  \n    Therapeutic \n    2.93 \n    (0.90, 9.11) \n    3.46 (2.22) \n    0.04 \n  \n  \n    Ineligible aspirin \n    5.42 \n    (1.37, 19.17) \n    6.63 (4.78) \n    0.01 \n  \n  \n    Age ≥ 60 \n    1.97 \n    (1.07, 3.65) \n    2.07 (0.67) \n    0.01 \n  \n  \n    Australia/New Zealand \n    0.59 \n    (0.12, 2.64) \n    0.80 (0.71) \n    0.75 \n  \n  \n    Nepal \n    2.28 \n    (0.57, 7.75) \n    2.78 (2.03) \n    0.11 \n  \n\n\n\nOdds ratio summary table for no epoch model.\n\n\n\nCode\nplot_site_terms(exp(mdrws$gamma_site), site_facet)\n\n\n\n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary(variables = c(\"beta\", \"gamma_site\", \"tau_site\"))\n\n\n# A tibble: 39 × 10\n   variable    mean  median    sd   mad      q5     q95  rhat ess_bulk ess_tail\n   <chr>      <dbl>   <dbl> <dbl> <dbl>   <dbl>   <dbl> <dbl>    <dbl>    <dbl>\n 1 beta[1]  -4.07   -4.05   0.519 0.504 -4.95   -3.26    1.00    8867.   12171.\n 2 beta[2]   0.859   0.858  0.471 0.467  0.0896  1.63    1.00   22633.   14901.\n 3 beta[3]  -0.221  -0.218  0.281 0.278 -0.685   0.240   1.00   26235.   16195.\n 4 beta[4]  -0.505  -0.503  0.326 0.322 -1.05    0.0311  1.00   24775.   15954.\n 5 beta[5]  -1.04   -1.04   0.834 0.841 -2.41    0.323   1.00   25838.   16057.\n 6 beta[6]  -0.0811 -0.0795 0.849 0.844 -1.47    1.30    1.00   30912.   13477.\n 7 beta[7]   1.67    1.69   0.667 0.654  0.568   2.75    1.00   23886.   15322.\n 8 beta[8]   0.679   0.679  0.313 0.314  0.162   1.20    1.00   29941.   14381.\n 9 beta[9]  -0.531  -0.521  0.790 0.786 -1.85    0.752   1.00   22361.   15767.\n10 beta[10]  0.807   0.826  0.666 0.650 -0.323   1.86    1.00   13402.   14508.\n# … with 29 more rows\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.9495 0.8738 0.9165 0.8951 0.9422 0.8839 0.9512 0.8555\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"gamma_site\"])\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"tau_site\"])"
  },
  {
    "objectID": "analyses/7-3_all_cause_mortality.html#sensitivity-reduced-model-no-site-or-epoch",
    "href": "analyses/7-3_all_cause_mortality.html#sensitivity-reduced-model-no-site-or-epoch",
    "title": "7-3 All Cause Mortality Day 28",
    "section": "Sensitivity: Reduced model (no site or epoch)",
    "text": "Sensitivity: Reduced model (no site or epoch)\nThe primary model is re-fit without the site and epoch terms.\n\n\nFit reduced model (no site or epoch)\nmdat <- make_stan_data(\n  acs_itt_nona_dat,\n  c(\"inelgc3\", \"agegte60\", \"ctry\"),\n  \"D28_death\",\n  c(10, 2.5, 1, 1)\n)\nsnk <- capture.output(\n  mfit <- model_fixed_only$sample(\n    data = mdat,\n    seed = 12415,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    refresh = 0,\n    adapt_delta = 0.99\n))\nmdrws <- as_draws_rvars(mfit$draws(c(\"beta\")))\nnames(mdrws$beta) <- colnames(mdat$X)\nmdrws$Ccon <- attr(mdat$X, \"contrasts\")$randC %**% mdrws$beta[2:4]\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\nmdrws$OR <- c(\n  setNames(exp(mdrws$Ctrt), c(\"Intermediate\", \"Low with aspirin\", \"Therapeutic\")),\n  setNames(exp(mdrws$beta[-(1:6)]), c(\"Ineligible aspirin\", \"Age \\u2265 60\", \"Australia/New Zealand\", \"Nepal\"))\n)\n\n\n\n\nOdds ratio summary\nodds_ratio_summary_table(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.81 \n    (0.41, 1.58) \n    0.86 (0.30) \n    0.73 \n  \n  \n    Low with aspirin \n    1.26 \n    (0.57, 2.68) \n    1.35 (0.55) \n    0.28 \n  \n  \n    Therapeutic \n    2.58 \n    (0.84, 7.33) \n    2.96 (1.73) \n    0.05 \n  \n  \n    Ineligible aspirin \n    4.20 \n    (1.28, 11.39) \n    4.75 (2.67) \n    0.01 \n  \n  \n    Age ≥ 60 \n    2.36 \n    (1.30, 4.19) \n    2.46 (0.76) \n    0.00 \n  \n  \n    Australia/New Zealand \n    0.57 \n    (0.13, 2.18) \n    0.72 (0.55) \n    0.79 \n  \n  \n    Nepal \n    1.97 \n    (0.81, 4.39) \n    2.13 (0.93) \n    0.06 \n  \n\n\n\nOdds ratio summary table for no epoch model.\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary(variables = c(\"beta\"))\n\n\n# A tibble: 10 × 10\n   variable    mean  median    sd   mad      q5    q95  rhat ess_bulk ess_tail\n   <chr>      <dbl>   <dbl> <dbl> <dbl>   <dbl>  <dbl> <dbl>    <dbl>    <dbl>\n 1 beta[1]  -3.65   -3.65   0.257 0.252 -4.08   -3.23   1.00   11510.   13122.\n 2 beta[2]   0.522   0.524  0.443 0.442 -0.215   1.24   1.00   13728.   15091.\n 3 beta[3]  -0.274  -0.273  0.267 0.264 -0.711   0.167  1.00   16229.   13075.\n 4 beta[4]  -0.631  -0.631  0.313 0.312 -1.14   -0.115  1.00   15687.   14173.\n 5 beta[5]  -1.12   -1.11   0.794 0.783 -2.44    0.188  1.00   17669.   15548.\n 6 beta[6]  -0.0715 -0.0679 0.831 0.815 -1.44    1.28   1.00   21121.   14415.\n 7 beta[7]   1.41    1.43   0.559 0.552  0.451   2.28   1.00   18010.   14037.\n 8 beta[8]   0.855   0.858  0.301 0.303  0.360   1.34   1.00   16662.   14081.\n 9 beta[9]  -0.580  -0.566  0.725 0.729 -1.80    0.576  1.00   18319.   14119.\n10 beta[10]  0.665   0.680  0.432 0.429 -0.0621  1.36   1.00   14109.   14057.\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.9655 1.0383 0.9775 1.0953 1.0490 0.9577 1.0132 1.0193\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])"
  },
  {
    "objectID": "analyses/7-3_all_cause_mortality.html#sensitivity-concurrent-controls",
    "href": "analyses/7-3_all_cause_mortality.html#sensitivity-concurrent-controls",
    "title": "7-3 All Cause Mortality Day 28",
    "section": "Sensitivity: Concurrent Controls",
    "text": "Sensitivity: Concurrent Controls\nA sensitivity analysis is performed on the reduced concurrent control analysis sets for each intervention.\n\nIntermediate\n\nSet: ACS-ITT-intermediate\nCovariates: anticoagulation intervention, age group, region of enrolment.\n\n\n\nOverview of outcome\nsave_tex_table(\n  make_mortality_table(acs_itt_concurc2_dat, \"latex\"),\n  \"outcomes/secondary/7-3-anticoagulation-concurrent-intermediate-summary\")\nmake_mortality_table(acs_itt_concurc2_dat)\n\n\n\n\n \n  \n    n (\\%) \n    Patients \n    Known \n    Missing \n    Died by day 28 \n  \n \n\n  \n    Low dose \n    610 \n    596 (97.7) \n    14 (2.3) \n    19 (3.2) \n  \n  \n    Intermediate dose \n    613 \n    603 (98.4) \n    10 (1.6) \n    15 (2.5) \n  \n  \n    Overall \n    1223 \n    1199 (98.0) \n    24 (2.0) \n    34 (2.8) \n  \n\n\n\nSummary of outcome for intermediate dose concurrent enrolments.\n\n\n\nFit model\nmdat <- make_stan_data_concurrent(\n  acs_itt_concurc2_nona_dat,\n  c(\"agegte60\", \"ctry\"),\n  \"D28_death\",\n  c(2.5, 1, 1)\n)\nsnk <- capture.output(\n  mfit <- model_fixed_only$sample(\n    data = mdat,\n    seed = 38135,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    refresh = 0,\n    adapt_delta = 0.95\n))\nmdrws <- as_draws_rvars(mfit$draws(c(\"beta\")))\nnames(mdrws$beta) <- colnames(mdat$X)\nmdrws$Ccon <- attr(mdat$X, \"contrasts\")$randC %**% mdrws$beta[2]\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\nmdrws$compare <- c(\"Intermediate vs low\" = exp(mdrws$Ctrt[1]))\nmdrws$OR <- c(\n  setNames(exp(mdrws$Ctrt), c(\"Intermediate\")),\n  setNames(exp(mdrws$beta[-(1:2)]), c(\"Age \\u2265 60\", \"Australia/New Zealand\", \"Nepal\"))\n)\n\n\n\n\nOdds ratio summary\nsave_tex_table(\n  odds_ratio_summary_table(mdrws$OR, \"latex\"),\n  \"outcomes/secondary/7-3-primary-model-acs-itt-concurrent-intermediate-summary-table\")\nodds_ratio_summary_table(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.78 \n    (0.39, 1.54) \n    0.83 (0.29) \n    0.76 \n  \n  \n    Age ≥ 60 \n    2.84 \n    (1.44, 5.62) \n    3.01 (1.08) \n    0.00 \n  \n  \n    Australia/New Zealand \n    0.46 \n    (0.12, 1.41) \n    0.54 (0.34) \n    0.91 \n  \n  \n    Nepal \n    1.31 \n    (0.46, 3.22) \n    1.45 (0.72) \n    0.30 \n  \n\n\n\nOdds ratio summary table for model.\n\n\n\nPosterior contrast\np <- plot_or_densities(mdrws$compare)\np\n\n\n\n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary(variables = c(\"beta\"))\n\n\n# A tibble: 5 × 10\n  variable   mean median    sd   mad     q5    q95  rhat ess_bulk ess_tail\n  <chr>     <dbl>  <dbl> <dbl> <dbl>  <dbl>  <dbl> <dbl>    <dbl>    <dbl>\n1 beta[1]  -3.95  -3.94  0.258 0.256 -4.39  -3.54   1.00   11239.   11056.\n2 beta[2]  -0.175 -0.173 0.246 0.246 -0.582  0.226  1.00   18118.   13824.\n3 beta[3]   1.04   1.04  0.346 0.344  0.473  1.61   1.00   12024.   11313.\n4 beta[4]  -0.804 -0.766 0.633 0.625 -1.89   0.169  1.00   17707.   12582.\n5 beta[5]   0.250  0.269 0.497 0.490 -0.601  1.04   1.00   16895.   13100.\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.9724 1.0293 1.0048 0.9900 1.0677 1.0275 1.0277 1.0140\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])\n\n\n\n\n\n\n\n\n\n\nLow-dose with aspirin\n\nSet: ACS-ITT-aspirin\nCovariates: anticoagulation intervention, age group, region of enrolment.\n\n\n\nOverview of outcome\nsave_tex_table(\n  make_mortality_table(acs_itt_concurc3_dat, \"latex\"),\n  \"outcomes/secondary/7-3-anticoagulation-concurrent-stdaspirin-summary\")\nmake_mortality_table(acs_itt_concurc3_dat)\n\n\n\n\n \n  \n    n (\\%) \n    Patients \n    Known \n    Missing \n    Died by day 28 \n  \n \n\n  \n    Low dose \n    299 \n    291 (97.3) \n    8 (2.7) \n    11 (3.8) \n  \n  \n    Intermediate dose \n    298 \n    293 (98.3) \n    5 (1.7) \n    12 (4.1) \n  \n  \n    Low dose with aspirin \n    283 \n    281 (99.3) \n    2 (0.7) \n    10 (3.6) \n  \n  \n    Overall \n    880 \n    865 (98.3) \n    15 (1.7) \n    33 (3.8) \n  \n\n\n\nSummary of outcome for low-dose with aspirin concurrent enrolments.\n\n\n\nFit model\nmdat <- make_stan_data_concurrent(\n  acs_itt_concurc3_nona_dat,\n  c(\"agegte60\", \"ctry\"),\n  \"D28_death\",\n  c(2.5, 1)\n)\nsnk <- capture.output(\n  mfit <- model_fixed_only$sample(\n    data = mdat,\n    seed = 13578,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    refresh = 0\n))\nmdrws <- as_draws_rvars(mfit$draws(c(\"beta\")))\nnames(mdrws$beta) <- colnames(mdat$X)\nmdrws$Ccon <- attr(mdat$X, \"contrasts\")$randC %**% mdrws$beta[2:3]\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\nmdrws$compare <- c(\"Intermediate vs low\" = exp(mdrws$Ctrt[1]),\n                   \"Low with aspirin vs low\" = exp(mdrws$Ctrt[2]),\n                   \"Intermediate vs low with aspirin\" = exp(mdrws$Ctrt[1] - mdrws$Ctrt[2]))\nmdrws$OR <- c(\n  setNames(exp(mdrws$Ctrt), c(\"Intermediate\", \"Low with aspirin\")),\n  setNames(exp(mdrws$beta[-(1:3)]), c(\"Age \\u2265 60\", \"Australia/New Zealand\"))\n)\n\n\n\n\nOdds ratio summary\nsave_tex_table(\n  odds_ratio_summary_table(mdrws$OR, \"latex\"),\n  \"outcomes/secondary/7-3-primary-model-acs-itt-concurrent-stdaspirin-summary-table\")\nodds_ratio_summary_table(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    1.09 \n    (0.48, 2.48) \n    1.19 (0.53) \n    0.42 \n  \n  \n    Low with aspirin \n    0.89 \n    (0.38, 2.07) \n    0.97 (0.44) \n    0.61 \n  \n  \n    Age ≥ 60 \n    2.45 \n    (1.22, 4.87) \n    2.60 (0.95) \n    0.01 \n  \n  \n    Australia/New Zealand \n    0.41 \n    (0.08, 1.58) \n    0.52 (0.40) \n    0.89 \n  \n\n\n\nOdds ratio summary table for model.\n\n\n\nPosterior contrast\np <- plot_or_densities(mdrws$compare)\np\n\n\n\n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary(variables = c(\"beta\"))\n\n\n# A tibble: 5 × 10\n  variable    mean  median    sd   mad     q5    q95  rhat ess_bulk ess_tail\n  <chr>      <dbl>   <dbl> <dbl> <dbl>  <dbl>  <dbl> <dbl>    <dbl>    <dbl>\n1 beta[1]  -3.57   -3.56   0.246 0.244 -3.99  -3.18   1.00   16232.   14278.\n2 beta[2]  -0.148  -0.145  0.301 0.301 -0.649  0.338  1.00   22800.   14161.\n3 beta[3]   0.0127  0.0187 0.300 0.299 -0.493  0.495  1.00   22693.   13702.\n4 beta[4]   0.894   0.895  0.355 0.355  0.311  1.47   1.00   16812.   14811.\n5 beta[5]  -0.913  -0.881  0.752 0.746 -2.21   0.269  1.00   22255.   13232.\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 1.097 1.026 1.149 1.007 1.063 1.109 1.036 1.038\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])\n\n\n\n\n\n\n\n\n\n\nTherapeutic\n\nSet: ACS-ITT-therapeutic\nCovariates: anticoagulation intervention, age group, region of enrolment.\n\n\n\nOverview of outcome\nsave_tex_table(\n  make_mortality_table(acs_itt_concurc4_dat, \"latex\"),\n  \"outcomes/secondary/7-3-anticoagulation-concurrent-therapeutic-summary\")\nmake_mortality_table(acs_itt_concurc4_dat)\n\n\n\n\n \n  \n    n (\\%) \n    Patients \n    Known \n    Missing \n    Died by day 28 \n  \n \n\n  \n    Low dose \n    79 \n    75 (94.9) \n    4 (5.1) \n    3 (4.0) \n  \n  \n    Intermediate dose \n    65 \n    63 (96.9) \n    2 (3.1) \n    1 (1.6) \n  \n  \n    Therapeutic dose \n    50 \n    50 (100.0) \n    0 (0.0) \n    6 (12.0) \n  \n  \n    Overall \n    194 \n    188 (96.9) \n    6 (3.1) \n    10 (5.3) \n  \n\n\n\nSummary of outcome for therapeutic dose concurrent enrolments.\n\n\n\nFit model\nmdat <- make_stan_data_concurrent(\n  acs_itt_concurc4_nona_dat,\n  c(\"agegte60\", \"ctry\"),\n  \"D28_death\",\n  c(2.5, 1, 1)\n)\nsnk <- capture.output(\n  mfit <- model_fixed_only$sample(\n    data = mdat,\n    seed = 13578,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    refresh = 0\n))\nmdrws <- as_draws_rvars(mfit$draws(c(\"beta\")))\nnames(mdrws$beta) <- colnames(mdat$X)\nmdrws$Ccon <- attr(mdat$X, \"contrasts\")$randC %**% mdrws$beta[2:3]\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\nmdrws$compare <- c(\"Intermediate vs low\" = exp(mdrws$Ctrt[1]),\n                   \"Therapeutic vs low\" = exp(mdrws$Ctrt[2]),\n                   \"Intermediate vs therapeutic\" = exp(mdrws$Ctrt[1] - mdrws$Ctrt[2]))\nmdrws$OR <- c(\n  setNames(exp(mdrws$Ctrt), c(\"Intermediate\", \"Therapeutic\")),\n  setNames(exp(mdrws$beta[-(1:3)]), c(\"Age \\u2265 60\", \"India\", \"Australia/New Zealand\"))\n)\n\n\n\n\nOdds ratio summary\nsave_tex_table(\n  odds_ratio_summary_table(mdrws$OR, \"latex\"),\n  \"outcomes/secondary/7-3-primary-model-acs-itt-concurrent-therapeutic-summary-table\")\nodds_ratio_summary_table(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.66 \n    (0.13, 3.11) \n    0.91 (0.86) \n    0.69 \n  \n  \n    Therapeutic \n    2.64 \n    (0.70, 10.68) \n    3.38 (2.75) \n    0.07 \n  \n  \n    Age ≥ 60 \n    2.80 \n    (0.78, 11.41) \n    3.60 (3.05) \n    0.06 \n  \n  \n    India \n    0.42 \n    (0.08, 1.81) \n    0.55 (0.46) \n    0.87 \n  \n  \n    Australia/New Zealand \n    0.28 \n    (0.06, 1.02) \n    0.35 (0.26) \n    0.97 \n  \n\n\n\nOdds ratio summary table for model.\n\n\n\nPosterior contrast\np <- plot_or_densities(mdrws$compare)\np\n\n\n\n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary(variables = c(\"beta\"))\n\n\n# A tibble: 6 × 10\n  variable   mean median    sd   mad      q5    q95  rhat ess_bulk ess_tail\n  <chr>     <dbl>  <dbl> <dbl> <dbl>   <dbl>  <dbl> <dbl>    <dbl>    <dbl>\n1 beta[1]  -3.33  -3.29  0.566 0.551 -4.32   -2.47   1.00   12097.   10881.\n2 beta[2]   0.986  0.969 0.555 0.543  0.0946  1.93   1.00   18013.   14124.\n3 beta[3]  -0.228 -0.220 0.526 0.520 -1.10    0.622  1.00   19625.   14656.\n4 beta[4]   1.04   1.03  0.676 0.660 -0.0390  2.17   1.00   12790.   10806.\n5 beta[5]  -0.885 -0.861 0.784 0.779 -2.22    0.362  1.00   20168.   13677.\n6 beta[6]  -1.29  -1.26  0.711 0.711 -2.50   -0.179  1.00   20226.   13969.\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 1.0004 1.0536 1.0274 1.0999 1.0111 0.9799 1.0311 0.9898\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])"
  },
  {
    "objectID": "analyses/7-4_days_alive_hospital_free.html",
    "href": "analyses/7-4_days_alive_hospital_free.html",
    "title": "7-4 Days alive and free of hospital by day 28",
    "section": "",
    "text": "Load packages\nlibrary(tidyverse)\nlibrary(labelled)\nlibrary(kableExtra)\nlibrary(cmdstanr)\nlibrary(posterior)\nlibrary(bayestestR)\nlibrary(bayesplot)\nlibrary(matrixStats)\nlibrary(plotly)\nlibrary(lubridate)\nlibrary(ggdist)\nlibrary(patchwork)\n\ntheme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank()))\nbayesplot_theme_set(theme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank())))\n\ncolor_scheme_set(\"red\")\noptions(digits = 4)\n\n\n\n\nPrepare dataset\ndevtools::load_all()\nall_dat <- read_all_no_daily()\n\nacs_itt_dat <- all_dat %>% \n  filter_acs_itt() %>%\n  transmute_model_cols_grp_aus_nz()\nacs_itt_nona_dat <- acs_itt_dat %>% \n  filter(!is.na(out_dafh))\n\n# Concurrent enrolments for C2\nacs_itt_concurc2_dat <- acs_itt_dat %>%\n  filter_concurrent_intermediate()\nacs_itt_concurc2_nona_dat <- acs_itt_concurc2_dat %>% \n  filter(!is.na(out_dafh))\n\n# Concurrent enrolments for C3\nacs_itt_concurc3_dat <- acs_itt_dat %>%\n  filter_concurrent_std_aspirin()\nacs_itt_concurc3_nona_dat <- acs_itt_concurc3_dat %>% \n  filter(!is.na(out_dafh))\n\n# Concurrent enrolments for C4\nacs_itt_concurc4_dat <- acs_itt_dat %>%\n  filter_concurrent_therapeutic()\nacs_itt_concurc4_nona_dat <- acs_itt_concurc4_dat %>% \n  filter(!is.na(out_dafh))\n\n\n\n\nLoad models\nordmod0 <- cmdstan_model(\"stan/ordinal/logistic_cumulative.stan\") # No epoch or site\nordmod_epoch <- cmdstan_model(\"stan/ordinal/logistic_cumulative_epoch.stan\") # Epoch only\nordmod <- cmdstan_model(\"stan/ordinal/logistic_cumulative_epoch_site.stan\") # Full model\n\n\n\n\nFunctions\nmake_summary_table <- function(dat, format = \"html\") {\n  tdat <- dat %>%\n  group_by(CAssignment = factor(CAssignment, \n                                levels = c(\"C1\", \"C2\", \"C3\", \"C4\"),\n                                labels = intervention_labels2()$CAssignment[-1])) %>%\n  summarise(\n    Patients = n(),\n    Known = sum(!is.na(out_dafh)),\n    Deaths = sprintf(\n      \"%i (%.0f%%)\", sum(D28_death, na.rm = TRUE), 100 * mean(D28_death, na.rm = TRUE)),\n    `DAFH, Median (Q1, Q3)` = sprintf(\n      \"%.0f (%.0f, %.0f)\", \n      median(out_dafh, na.rm = T), \n      quantile(out_dafh, 0.25, na.rm = TRUE), \n      quantile(out_dafh, 0.75, na.rm = TRUE))\n  ) %>%\n  bind_rows(\n    dat %>%\n  group_by(CAssignment = \"Overall\") %>%\n  summarise(\n    Patients = n(),\n    Known = sum(!is.na(out_dafh)),\n    Deaths = sprintf(\n      \"%i (%.0f%%)\", sum(D28_death, na.rm = TRUE), 100 * mean(D28_death, na.rm = TRUE)),\n    `DAFH, Median (Q1, Q3)` = sprintf(\n      \"%.0f (%.0f, %.0f)\", \n      median(out_dafh, na.rm = T), \n      quantile(out_dafh, 0.25, na.rm = TRUE), \n      quantile(out_dafh, 0.75, na.rm = TRUE))\n  )\n  ) %>%\n  rename(`Anticoagulation\\nintervention` = CAssignment)\n  kable(\n    tdat,\n    format = format,\n    align = \"lrrrr\",\n    booktabs = TRUE,\n    linesep = \"\"\n  ) %>%\n    kable_styling(\n      font_size = 9,\n      latex_options = \"HOLD_position\"\n    ) %>%\n    row_spec(nrow(tdat), bold = T)\n}\n\n\nmake_primary_model_data <- function(\n    dat, \n    vars = NULL,\n    beta_sd_var = NULL,\n    ctr = contr.orthonorm,\n    p_mult = 2) {\n  \n  X <- make_X_design(dat, vars, ctr)\n  attX <- attr(X, \"contrasts\")\n  X <- X[, -1]\n  attr(X, \"contrasts\") <- attX\n  nXtrt <- sum(grepl(\"rand\", colnames(X)))\n  \n  beta_sd <- c(rep(1, nXtrt), beta_sd_var)\n  \n  epoch <- dat$epoch\n  M_epoch <- max(dat$epoch)\n  region <- dat$ctry_num\n  M_region <- max(region)\n  site <- dat$site_num\n  M_site <- max(site)\n  region_by_site <- dat %>% \n    dplyr::count(ctry_num, site_num) %>% \n    pull(ctry_num)\n\n  y_raw <- ordered(dat$out_dafh)\n  y_mod <- as.integer(y_raw)\n  N <- dim(X)[1]\n  K <- dim(X)[2]\n  unique_y <- length(unique(y_mod))\n  list(N = N, K = K, J = unique_y, X = X, y = y_mod, y_raw = y_raw,\n       M_region = M_region,\n       M_site = M_site, site = site,\n       M_epoch = M_epoch, epoch = epoch,\n       region_by_site = region_by_site,\n       p_par = p_mult * rep(1 / unique_y, unique_y),\n       beta_sd = beta_sd)  \n}\n\n\nfit_primary_model <- function(\n    dat, \n    ctr = contr.orthonorm,\n    save = FALSE\n  ) {\n  \n  mdat <- make_primary_model_data(\n    dat, c(\"inelgc3\", \"agegte60\", \"ctry\"), c(10, 2.5, 1, 1), ctr)\n  snk <- capture.output(\n    mfit <- ordmod$sample(\n      data = mdat,\n      seed = 813508,\n      chains = 8,\n      parallel_chains = min(8, parallel::detectCores()),\n      iter_warmup = 1000,\n      iter_sampling = 2500,\n      refresh = 0,\n      adapt_delta = 0.98\n  ))\n  if (save) {\n    mfit$save_object(file.path(\"outputs\", \"models\", \"secondary\", \"7-4.rds\"))  \n  }\n  mdrws <- as_draws_rvars(mfit$draws())\n  \n  # Add names\n  epoch_map <- dat %>% dplyr::count(epoch, epoch_lab)\n  site_map <- dat %>% dplyr::count(site_num, site)\n  names(mdrws$beta) <- colnames(mdat$X)\n  names(mdrws$gamma_epoch) <- epoch_map$epoch_lab\n  names(mdrws$gamma_site) <- site_map$site\n  \n  # Convert to treatment log odds ratios\n  mdrws$Acon <- attr(mdat$X, \"contrasts\")$randA %**% mdrws$beta[grepl(\"randA[0-9]\", names(mdrws$beta))]\n  mdrws$Ccon <- attr(mdat$X, \"contrasts\")$randC %**% mdrws$beta[grepl(\"randC[0-9]\", names(mdrws$beta))]\n  mdrws$trtA <- mdrws$Acon[-1] - mdrws$Acon[1]\n  mdrws$trtC <- mdrws$Ccon[-1] - mdrws$Ccon[1]\n  \n  mdrws$compare <- c(\n    \"Intermediate vs low\" = exp(mdrws$trtC[1]),\n    \"Low with aspirin vs low\" = exp(mdrws$trtC[2]),\n    \"Therapeutic vs low\" = exp(mdrws$trtC[3]),\n    \"Intermediate vs low with aspirin\" = exp(mdrws$trtC[1] - mdrws$trtC[2]),\n    \"Intermediate vs therapeutic\" = exp(mdrws$trtC[1] - mdrws$trtC[3]),\n    \"Low with aspirin vs therapeutic\" = exp(mdrws$trtC[2] - mdrws$trtC[3])\n  )\n  mdrws$OR <- c(\n    setNames(exp(mdrws$trtC), c(\"Intermediate\", \"Low with aspirin\", \"Therapeutic\")),\n    \"Ineligible aspirin\" = exp(mdrws$beta[which(grepl(\"inelg\", colnames(mdat$X)))]),\n    \"Age \\u2265 60\" = exp(mdrws$beta[which(grepl(\"age\", colnames(mdat$X)))]),\n    setNames(exp(mdrws$beta[which(grepl(\"ctry\", colnames(mdat$X)))]), c(\"AU/NZ\", \"NP\"))\n  )\n  return(list(dat = mdat, fit = mfit, drws = mdrws))\n}"
  },
  {
    "objectID": "analyses/7-4_days_alive_hospital_free.html#overall",
    "href": "analyses/7-4_days_alive_hospital_free.html#overall",
    "title": "7-4 Days alive and free of hospital by day 28",
    "section": "Overall",
    "text": "Overall\nAs a cross check, Figure 1 plots the number of days hospitalised (as reported in D28_OutcomeTotalDaysHospitalised) against the day of discharge from the index admission.\n\n\nCompare D28_OutcomeTotalDaysHospitalised to days hospitalised per dischage date.\npdat <- acs_itt_dat %>%\n  filter(D28_death != 1) %>%\n  dplyr::count(D28_day = pmin(28, D28_OutcomeTotalDaysHospitalised), DIS_day = pmin(28, DIS_day))\nggplot(pdat, aes(D28_day, DIS_day)) +\n  geom_point(aes(size = n), shape = 21) +\n  geom_abline() +\n  scale_x_continuous(\"Number of days hospitalised (D28_OutcomeTotalDaysHospitalised)\",\n                     breaks = seq(0, 30, 2)) +\n  scale_y_continuous(\"Day of discharge from index admission\",\n                     breaks = seq(0, 30, 2)) +\n  labs(size = \"Count\")\n\n\n\n\n\nFigure 1: Number of days hospitalised against day of discharge from index admission.\n\n\n\n\nThe overall distribution of days alive and free of hospital (DAFH) are reported in Figure 2 for all participants in the ACS-ITT set.\n\n\n\nOverall distribution of DAFH\npdat <- acs_itt_nona_dat %>%\n  dplyr::count(dafh = ordered(out_dafh, levels = 0:27), .drop = F) %>%\n  mutate(p = n / sum(n))\np <- ggplot(pdat, aes(dafh, p)) +\n  geom_col() +\n  labs(\n    x = \"Days alive and free of hospital\", \n    y = \"Proportion\"\n  )\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"outcome-7-4-dist-overall.pdf\"), p, height = 2.5, width = 6)\np\n\n\n\n\n\n(a) ACS-ITT\n\n\n\nFigure 2: Distribution of days alive and free of hospital.\n\n\n\n\nSummary of DAFH outcome by arm\nsave_tex_table(\n  make_summary_table(acs_itt_dat, \"latex\"), \n  file.path(\"outcomes\", \"secondary\", \"7-4-anticoagulation-summary\"))\nmake_summary_table(acs_itt_dat)\n\n\n\n\n\n \n  \n    Anticoagulation\nintervention \n    Patients \n    Known \n    Deaths \n    DAFH, Median (Q1, Q3) \n  \n \n\n  \n    Low-dose \n    610 \n    596 \n    19 (3%) \n    23 (21, 24) \n  \n  \n    Intermediate-dose \n    613 \n    603 \n    15 (2%) \n    23 (21, 24) \n  \n  \n    Low-dose with aspirin \n    283 \n    280 \n    10 (4%) \n    22 (20, 24) \n  \n  \n    Therapeutic-dose \n    50 \n    50 \n    6 (12%) \n    22 (19, 24) \n  \n  \n    Overall \n    1556 \n    1529 \n    50 (3%) \n    23 (21, 24) \n  \n\n\n\nTable 1:  Summary of days alive and free of hospital to day 28 by treatment group."
  },
  {
    "objectID": "analyses/7-4_days_alive_hospital_free.html#age",
    "href": "analyses/7-4_days_alive_hospital_free.html#age",
    "title": "7-4 Days alive and free of hospital by day 28",
    "section": "Age",
    "text": "Age\n\n\nDAFH by age\npdat <- acs_itt_nona_dat %>%\n  dplyr::count(\n    agegrp = cut(AgeAtEntry, c(18, seq(25, 75, 5), 100), include.lowest = T, right = F),\n    dafh = fct_rev(ordered(out_dafh, levels = 0:27)), \n    .drop = F) %>%\n  group_by(agegrp) %>%\n  mutate(p = n / sum(n))\npdat2 <- pdat %>%\n  group_by(agegrp) %>%\n  summarise(n = sum(n))\np1 <- ggplot(pdat2, aes(agegrp, n)) +\n  geom_col(colour = \"grey40\", fill = \"grey40\") +\n  geom_vline(xintercept = 60, linetype = 2) +\n  labs(y = \"Number of\\nparticipants\",\n       x = \"Age at entry\") +\n  geom_vline(xintercept = 8.5, linetype = 2) +\n  theme(axis.text.x = element_text(hjust = 1, angle = 45))\np2 <- ggplot(pdat, aes(agegrp, p)) +\n  geom_col(aes(fill = dafh)) +\n  labs(x = \"Age\", y = \"Cumulative\\nproportion\") +\n  scale_fill_viridis_d(\"DAFH\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE)) +\n  geom_vline(xintercept = 8.5, linetype = 2) +\n  theme(axis.text.x = element_text(hjust = 1, angle = 45)) +\n  theme(legend.key.size = unit(0.25, \"lines\"))\np <- p1 | p2\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-4-age.pdf\"), p, height = 2.5, width = 6)\np\n\n\n\n\n\nFigure 3: Distribution of days alive and free of hospital by age group"
  },
  {
    "objectID": "analyses/7-4_days_alive_hospital_free.html#country",
    "href": "analyses/7-4_days_alive_hospital_free.html#country",
    "title": "7-4 Days alive and free of hospital by day 28",
    "section": "Country",
    "text": "Country\n\n\nDAFH by country\npdat <- acs_itt_nona_dat %>%\n  dplyr::count(\n    country,\n    dafh = ordered(out_dafh, levels = 0:27), \n    .drop = F) %>%\n  group_by(country) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup()\npdat2 <- pdat %>%\n  group_by(country) %>%\n  summarise(n = sum(n))\n\np1 <- ggplot(pdat2, aes(country, n)) +\n  geom_col() +\n    labs(\n      y = \"Number of\\nparticipants\", \n      x = \"Country of enrolment\")\n\np2 <- ggplot(pdat, aes(country, p)) +\n  geom_col(aes(fill = fct_rev(dafh))) +\n  labs(x = \"Anticoagulation intervention\", y = \"Cumulative\\nproportion\") +\n  scale_fill_viridis_d(\"DAFH\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE)) +\n  theme(legend.key.size = unit(0.25, \"lines\"))\np <- p1 | p2\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-4-country.pdf\"), p, height = 2.5, width = 6)\np\n\n\n\n\n\nFigure 4: Distribution of days alive and free of hospital by country."
  },
  {
    "objectID": "analyses/7-4_days_alive_hospital_free.html#site",
    "href": "analyses/7-4_days_alive_hospital_free.html#site",
    "title": "7-4 Days alive and free of hospital by day 28",
    "section": "Site",
    "text": "Site\n\n\nDAFH by site\npdat <- all_dat %>%\n  filter_acs_itt() %>%\n  filter(!is.na(out_dafh)) %>%\n  dplyr::count(\n    Country = factor(PT_CountryName, levels = c(\"India\", \"Australia\", \"Nepal\", \"New Zealand\"),\n                     labels = c(\"India\", \"Australia\", \"Nepal\", \"New\\nZealand\")),\n    Site = fct_infreq(Location),\n    dafh = ordered(out_dafh, levels = 0:27)) %>%\n  complete(dafh = ordered(0:27), nesting(Country, Site), fill = list(n = 0)) %>%\n  group_by(Country, Site) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup() %>%\n  mutate(\n    Country = droplevels(Country),\n    Site = droplevels(Site)\n  )\npdat2 <- pdat %>%\n  group_by(Country, Site) %>%\n  summarise(n = sum(n)) %>%\n  ungroup()\np1 <- ggplot(pdat2, aes(Site, n)) +\n  facet_grid( ~ Country, scales = \"free_x\", space = \"free_x\") +\n  geom_col() +\n    labs(\n      y = \"Number of\\nparticipants\", \n      x = \"\") +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        panel.border = element_rect(fill = NA))\np2 <- ggplot(pdat, aes(Site, p)) +\n  facet_grid( ~ Country, scales = \"free_x\", space = \"free_x\") +\n  geom_col(aes(fill = fct_rev(dafh))) +\n  labs(x = \"Anticoagulation intervention\", y = \"Cumulative\\nproportion\") +\n  scale_fill_viridis_d(\"DAFH\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE, ncol = 1)) +\n  theme(axis.text.x = element_text(hjust = 1, angle = 45)) +\n  theme(legend.key.size = unit(0.25, \"lines\"))\np <- p1 / p2 +\n  plot_layout(guides = 'collect')\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-4-country-site.pdf\"), p, height = 4, width = 6.25)\np\n\n\n\n\n\nFigure 5: Distribution of days alive and free of hospital by study site"
  },
  {
    "objectID": "analyses/7-4_days_alive_hospital_free.html#calendar-time",
    "href": "analyses/7-4_days_alive_hospital_free.html#calendar-time",
    "title": "7-4 Days alive and free of hospital by day 28",
    "section": "Calendar Time",
    "text": "Calendar Time\n\n\nDAFH by calendar date\npdat <- acs_itt_nona_dat %>%\n  dplyr::count(\n    yr = year(RandDate), mth = month(RandDate),\n    dafh = ordered(out_dafh, levels = 0:27), \n    .drop = F) %>%\n  group_by(yr, mth) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup()\np1 <- pdat %>%\n  group_by(yr, mth) %>%\n  summarise(n = sum(n)) %>%\n  ggplot(., aes(mth, n))  +\n  facet_grid( ~ yr, drop = T, scales = \"free_x\", space = \"free\") +\n    geom_col() +\n    labs(\n      y = \"Number of\\nparticipants\", \n      x = \"Calendar date (month of year)\") +\n  scale_x_continuous(breaks = 1:12)\np2 <- ggplot(pdat, aes(mth, p)) +\n  facet_grid( ~ yr, drop = T, scales = \"free_x\", space = \"free\") +\n  geom_col(aes(fill = fct_rev(dafh))) +\n  labs(x = \"Calendar date (month of year)\", y = \"Cumulative\\nproportion\") +\n  scale_fill_viridis_d(\"DAFH\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE)) +\n  theme(legend.key.size = unit(0.25, \"lines\")) +\n  scale_x_continuous(breaks = 1:12)\np <- p1 | p2\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-4-calendar-time.pdf\"), p, height = 2, width = 6)\np\n\n\n\n\n\nFigure 6: Distribution of days alive and free of hospital by calendar time."
  },
  {
    "objectID": "analyses/7-4_days_alive_hospital_free.html#anti-coagulation",
    "href": "analyses/7-4_days_alive_hospital_free.html#anti-coagulation",
    "title": "7-4 Days alive and free of hospital by day 28",
    "section": "Anti-coagulation",
    "text": "Anti-coagulation\n\n\nDAFH by intervention\npdat <- acs_itt_nona_dat %>%\n  dplyr::count(\n    CAssignment = factor(CAssignment, labels = str_replace(intervention_labels()$CAssignment[-1], \"<br>\", \"\\n\")),\n    dafh = ordered(out_dafh, levels = 0:27), \n    .drop = F) %>%\n  group_by(CAssignment) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup()\np <- ggplot(pdat, aes(CAssignment, p)) +\n  geom_col(aes(fill = fct_rev(dafh))) +\n  labs(x = \"Anticoagulation intervention\", y = \"Cumulative proportion\") +\n  scale_fill_viridis_d(\"Days alive and\\nfree of hospital\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE)) +\n  theme(legend.key.size = unit(0.75, \"lines\"))\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(pth, \"outcome-7-4-descriptive.pdf\"), p, height = 3, width = 6)\np\n\n\n\n\n\nFigure 7: Distribution of days alive and free of hospital by anti-coagulation intervention.\n\n\n\n\n\n\nDAFH by intervention\np <- ggplot(pdat, aes(dafh, cp)) +\n  geom_step(aes(colour = CAssignment, group = CAssignment)) +\n  labs(x = \"Days alive and free of hospital\", y = \"Cumulative proportion\") +\n  scale_colour_viridis_d(\n    \"Days alive and\\nfree of hospital\", option = \"A\", begin = 0, end = 0.8) +\n  guides(fill = guide_legend(reverse = TRUE))\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(pth, \"outcome-7-4-descriptive2.pdf\"), p, height = 3, width = 6)\np\n\n\n\n\n\nFigure 8: Cumulative distribution of days alive and free of hospital by anti-coagulation intervention."
  },
  {
    "objectID": "analyses/7-4_days_alive_hospital_free.html#sample-cumulative-logits",
    "href": "analyses/7-4_days_alive_hospital_free.html#sample-cumulative-logits",
    "title": "7-4 Days alive and free of hospital by day 28",
    "section": "Sample Cumulative Logits",
    "text": "Sample Cumulative Logits\nSome evidence of a shift from proportional odds at higher values of DAFH.\n\n\nPlot sample cumulative logits\ntrt_counts <- acs_itt_nona_dat %>%\n  dplyr::count(CAssignment, out_dafh) %>%\n  complete(CAssignment, out_dafh, fill = list(n = 0)) %>%\n  group_by(CAssignment) %>%\n  mutate(p = n / sum(n))\ntrt_logit <- trt_counts %>% \n  group_by(CAssignment) %>% \n  mutate(clogit = logit(cumsum(p))) %>%\n  group_by(out_dafh) %>%\n  mutate(rel_clogit = clogit - mean(clogit)) %>%\n  filter(out_dafh != 27)\n\nggplot(trt_logit, aes(CAssignment, rel_clogit)) +\n  facet_wrap( ~ out_dafh) +\n  geom_point() +\n  labs(y = \"Relative (to mean) sample cumulative logit\")\n\n\n\n\n\nInspect sample cumulative logits.\n\n\n\n\nPlot sample cumulative logits\nggplot(trt_logit, aes(out_dafh, rel_clogit)) +\n  facet_wrap( ~ CAssignment) +\n  geom_point() +\n  labs(y = \"Relative (to mean) sample cumulative logit\")\n\n\n\n\n\nInspect sample cumulative logits."
  },
  {
    "objectID": "analyses/7-4_days_alive_hospital_free.html#primary-model",
    "href": "analyses/7-4_days_alive_hospital_free.html#primary-model",
    "title": "7-4 Days alive and free of hospital by day 28",
    "section": "Primary Model",
    "text": "Primary Model\n\n\nFit primary model\nres <- fit_primary_model(acs_itt_nona_dat, save = TRUE)\n\n\n\n\nOdds ratio summary table\nsave_tex_table(\n  odds_ratio_summary_table_rev(res$drws$OR, \"latex\"),\n  \"outcomes/secondary/7-4-primary-model-acs-itt-summary-table\")\nodds_ratio_summary_table_rev(res$drws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR > 1) \n  \n \n\n  \n    Intermediate \n    1.14 \n    (0.94, 1.39) \n    1.15 (0.12) \n    0.90 \n  \n  \n    Low with aspirin \n    1.05 \n    (0.80, 1.39) \n    1.06 (0.15) \n    0.65 \n  \n  \n    Therapeutic \n    0.74 \n    (0.41, 1.35) \n    0.77 (0.24) \n    0.16 \n  \n  \n    Ineligible aspirin \n    1.08 \n    (0.56, 2.05) \n    1.14 (0.39) \n    0.59 \n  \n  \n    Age ≥ 60 \n    0.58 \n    (0.47, 0.71) \n    0.59 (0.06) \n    0.00 \n  \n  \n    AU/NZ \n    0.75 \n    (0.33, 1.73) \n    0.82 (0.37) \n    0.25 \n  \n  \n    NP \n    0.68 \n    (0.23, 2.62) \n    0.86 (0.72) \n    0.26 \n  \n\n\n\nPosterior summaries for model parameters (fixed-effects).\n\n\n\nOdds ratio summary for epoch and site\np <- plot_epoch_site_terms(\n  exp(res$drws$gamma_epoch),\n  exp(res$drws$gamma_site),\n  factor(res$dat$region_by_site, \n         labels = c(\"India\", \"Australia\\nNew Zealand\", \"Nepal\"))\n)\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\", \"7-4-primary-model-epoch-site-terms.pdf\")\nggsave(pth, p, width = 6, height = 4.5)\np\n\n\n\n\n\nSummary of epoch and site posterior odds ratios.\n\n\n\n\n\n\nPosterior contrasts\nplot_or_densities(res$drws$compare)\n\n\n\n\n\nSummaries on comparisons.\n\n\n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nres$fit$summary(\n  c(\"alpha\", \"beta\", \"gamma_epoch\", \"gamma_site\", \"tau_epoch\", \"tau_site\")) %>%\n  print(n = Inf)\n\n\n# A tibble: 76 × 10\n   variable    mean   median    sd   mad      q5     q95  rhat ess_bulk ess_tail\n   <chr>      <dbl>    <dbl> <dbl> <dbl>   <dbl>   <dbl> <dbl>    <dbl>    <dbl>\n 1 alpha[1] -4.03   -4.03    0.306 0.301 -4.52   -3.52    1.00    2367.    4074.\n 2 alpha[2] -4.01   -4.02    0.306 0.302 -4.50   -3.50    1.00    2355.    4075.\n 3 alpha[3] -4.00   -4.00    0.306 0.302 -4.48   -3.49    1.00    2351.    4140.\n 4 alpha[4] -3.98   -3.98    0.305 0.302 -4.47   -3.47    1.00    2347.    4113.\n 5 alpha[5] -3.90   -3.90    0.304 0.299 -4.38   -3.39    1.00    2310.    4173.\n 6 alpha[6] -3.88   -3.89    0.304 0.300 -4.37   -3.38    1.00    2302.    4129.\n 7 alpha[7] -3.81   -3.81    0.302 0.297 -4.29   -3.31    1.00    2275.    4082.\n 8 alpha[8] -3.75   -3.76    0.301 0.297 -4.24   -3.25    1.00    2260.    4008.\n 9 alpha[9] -3.66   -3.67    0.300 0.294 -4.14   -3.16    1.00    2220.    3986.\n10 alpha[1… -3.64   -3.64    0.299 0.293 -4.11   -3.14    1.00    2209.    3928.\n11 alpha[1… -3.52   -3.53    0.297 0.293 -3.99   -3.03    1.00    2175.    3924.\n12 alpha[1… -3.48   -3.48    0.296 0.292 -3.95   -2.98    1.00    2163.    3860.\n13 alpha[1… -3.43   -3.44    0.296 0.290 -3.91   -2.94    1.00    2148.    3810.\n14 alpha[1… -3.35   -3.36    0.294 0.290 -3.82   -2.86    1.00    2125.    3791.\n15 alpha[1… -3.13   -3.14    0.292 0.287 -3.59   -2.64    1.00    2111.    3711.\n16 alpha[1… -2.99   -2.99    0.290 0.285 -3.45   -2.50    1.00    2083.    3672.\n17 alpha[1… -2.83   -2.83    0.289 0.283 -3.28   -2.34    1.00    2065.    3703.\n18 alpha[1… -2.50   -2.50    0.286 0.278 -2.95   -2.02    1.00    2047.    3776.\n19 alpha[1… -2.05   -2.06    0.284 0.276 -2.50   -1.57    1.00    2050.    3709.\n20 alpha[2… -1.50   -1.51    0.282 0.277 -1.95   -1.03    1.00    2034.    3704.\n21 alpha[2… -0.781  -0.787   0.280 0.274 -1.23   -0.310   1.00    2034.    3735.\n22 alpha[2…  0.231   0.226   0.280 0.275 -0.213   0.701   1.00    2060.    3742.\n23 alpha[2…  1.14    1.14    0.283 0.275  0.695   1.62    1.00    2085.    3745.\n24 alpha[2…  2.76    2.75    0.300 0.295  2.28    3.26    1.00    2315.    4362.\n25 alpha[2…  5.30    5.27    0.502 0.494  4.51    6.16    1.00    5648.    9034.\n26 beta[1]  -0.259  -0.258   0.233 0.236 -0.639   0.124   1.00   14764.   15129.\n27 beta[2]   0.0348  0.0351  0.111 0.110 -0.147   0.218   1.00   13839.   14787.\n28 beta[3]   0.202   0.203   0.136 0.135 -0.0212  0.425   1.00   11940.   13893.\n29 beta[4]  -0.174  -0.173   0.405 0.405 -0.838   0.485   1.00   15857.   14629.\n30 beta[5]  -0.105  -0.104   0.243 0.244 -0.505   0.295   1.00   28996.   15863.\n31 beta[6]   0.0750  0.0760  0.334 0.337 -0.476   0.617   1.00   29688.   16193.\n32 beta[7]  -0.541  -0.541   0.105 0.105 -0.715  -0.371   1.00   22612.   14452.\n33 beta[8]  -0.286  -0.294   0.423 0.423 -0.971   0.415   1.00    6844.   10122.\n34 beta[9]  -0.350  -0.383   0.612 0.570 -1.29    0.693   1.00    9772.   12454.\n35 gamma_e…  0       0       0     0      0       0      NA         NA       NA \n36 gamma_e… -0.218  -0.216   0.209 0.203 -0.565   0.122   1.00   13141.   14932.\n37 gamma_e… -0.386  -0.384   0.216 0.212 -0.744  -0.0325  1.00   12306.   15291.\n38 gamma_e… -0.202  -0.203   0.209 0.209 -0.543   0.143   1.00   12854.   15539.\n39 gamma_e… -0.339  -0.339   0.196 0.196 -0.661  -0.0193  1.00   12483.   15628.\n40 gamma_e… -0.537  -0.536   0.207 0.205 -0.884  -0.200   1.00   12284.   16486.\n41 gamma_e… -0.614  -0.614   0.215 0.214 -0.968  -0.263   1.00   11700.   14932.\n42 gamma_e… -0.699  -0.698   0.209 0.207 -1.04   -0.355   1.00   11636.   14836.\n43 gamma_e… -1.38   -1.38    0.224 0.224 -1.75   -1.01    1.00   10313.   15333.\n44 gamma_e… -1.56   -1.56    0.224 0.225 -1.93   -1.19    1.00   10098.   14636.\n45 gamma_e… -0.969  -0.972   0.245 0.247 -1.37   -0.564   1.00   12096.   16271.\n46 gamma_e… -0.728  -0.728   0.309 0.307 -1.24   -0.216   1.00   14522.   16103.\n47 gamma_s… -0.434  -0.441   0.287 0.277 -0.894   0.0465  1.00    4269.    6968.\n48 gamma_s…  0.0703  0.0620  0.272 0.262 -0.358   0.525   1.00    3606.    5699.\n49 gamma_s… -0.310  -0.310   0.392 0.379 -0.958   0.327   1.00    9072.   11499.\n50 gamma_s… -0.198  -0.205   0.271 0.258 -0.628   0.263   1.00    3452.    6273.\n51 gamma_s…  0.192   0.181   0.243 0.231 -0.188   0.604   1.00    2602.    4698.\n52 gamma_s… -0.818  -0.817   0.305 0.301 -1.32   -0.316   1.00    5343.    8908.\n53 gamma_s…  1.19    1.18    0.274 0.263  0.765   1.66    1.00    3186.    5573.\n54 gamma_s…  0.462   0.454   0.317 0.308 -0.0379  1.00    1.00    5139.    7986.\n55 gamma_s…  0.723   0.710   0.273 0.262  0.297   1.19    1.00    3645.    5908.\n56 gamma_s… -0.450  -0.454   0.324 0.315 -0.976   0.0874  1.00    5700.    8779.\n57 gamma_s…  0.592   0.582   0.300 0.292  0.119   1.10    1.00    4694.    6890.\n58 gamma_s… -0.252  -0.135   0.392 0.258 -1.03    0.192   1.00   14816.   16811.\n59 gamma_s…  0.0525  0.0180  0.285 0.196 -0.385   0.568   1.00   24551.   17235.\n60 gamma_s…  0.0174  0.00269 0.321 0.206 -0.497   0.574   1.00   26417.   16806.\n61 gamma_s…  0.0408  0.0139  0.297 0.199 -0.421   0.562   1.00   27477.   17553.\n62 gamma_s… -0.135  -0.0593  0.333 0.215 -0.770   0.308   1.00   20678.   16621.\n63 gamma_s…  0.166   0.0908  0.309 0.217 -0.230   0.769   1.00   18778.   17195.\n64 gamma_s… -0.120  -0.0539  0.324 0.214 -0.731   0.326   1.00   22194.   17162.\n65 gamma_s…  0.0885  0.0325  0.347 0.211 -0.402   0.730   1.00   22614.   16515.\n66 gamma_s… -0.187  -0.0929  0.349 0.231 -0.865   0.244   1.00   18447.   17081.\n67 gamma_s…  0.0976  0.0376  0.322 0.206 -0.356   0.699   1.00   25117.   17831.\n68 gamma_s…  0.150   0.0604  0.367 0.228 -0.324   0.868   1.00   20749.   16890.\n69 gamma_s…  0.106   0.0613  0.249 0.188 -0.251   0.559   1.00   20773.   18295.\n70 gamma_s… -0.0677 -0.0249  0.314 0.207 -0.639   0.409   1.00   23874.   17451.\n71 gamma_s… -0.739  -0.683   0.623 0.564 -1.85    0.165   1.00   10772.   12214.\n72 gamma_s…  0.405   0.407   0.615 0.533 -0.626   1.41    1.00   12780.   13080.\n73 tau_epo…  0.408   0.390   0.124 0.110  0.245   0.635   1.00    7665.   11712.\n74 tau_sit…  0.710   0.679   0.193 0.170  0.459   1.07    1.00    5315.    9463.\n75 tau_sit…  0.316   0.276   0.229 0.229  0.0271  0.749   1.00    7860.    8643.\n76 tau_sit…  1.03    0.884   0.649 0.476  0.338   2.23    1.00   10934.   10619.\n\n\nCode\nres$fit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.8161 0.8034 0.7978 0.8037 0.7995 0.7954 0.8154 0.8189\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"alpha\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"gamma_site\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"gamma_epoch\"])\n\n\n\n\n\n\n\n\n\nPosterior Predictive\n\n\nCode\ny_raw <- as.integer(levels(res$dat$y_raw))\ny_ppc <- res$drws$y_ppc\ny_ppc_raw <- rfun(\\(x) y_raw[x])(y_ppc)\nppc_dat <- bind_cols(acs_itt_nona_dat, tibble(y_ppc = y_ppc_raw)) %>%\n  mutate(CAssignment = factor(\n    CAssignment, \n    levels = names(intervention_labels_short_break()$CAssignment),\n    labels = intervention_labels_short_break()$CAssignment))\n\ngrp_ppc <- function(grp, d = 0:27) {\n  ppc_dat %>%\n    group_by(grp = {{grp}}) %>%\n    summarise(\n      y_lteq = map_dbl(d, ~ mean(out_dafh <= .x)),\n      ypp_lteq = map(d, ~ rvar_mean(y_ppc <= .x)),\n      y_eq = map_dbl(d, ~ mean(out_dafh == .x)),\n      ypp_eq = map(d, ~ rvar_mean(y_ppc == .x))\n    ) %>%\n    unnest(c(ypp_lteq, ypp_eq)) %>%\n    mutate(days = d) %>%\n    ungroup() %>%\n    pivot_longer(\n      y_lteq:ypp_eq, \n      names_to = c(\"response\", \"event\"),\n      names_sep = \"_\",\n      values_to = \"posterior\")\n}\n\nplot_grp_ppc <- function(dat, lab = \"\", xlab = \"Probability\") {\n  ggplot(dat %>% \n           filter(response == \"ypp\", event == \"eq\"), \n         aes(y = days)) +\n    facet_wrap( ~ grp, nrow = 1, scales = \"free_x\") +\n    stat_slabinterval(aes(xdist = posterior), fatten_point = 1)  +\n    geom_point(data = dat %>% filter(response == \"y\", event == \"eq\"), \n               aes(y = days, x = mean(posterior)),\n               colour = \"red\",\n               shape = 23) +\n    scale_x_continuous(\n      xlab, breaks = c(0, 0.3, 0.6),\n      sec.axis = sec_axis(\n        ~ . , name = lab, breaks = NULL, labels = NULL)) +\n    scale_y_continuous(\"Days\") +\n    theme(strip.text = element_text(size = rel(0.7)),\n          axis.title.x = element_text(size = rel(0.7)),\n          axis.text.x = element_text(size = rel(0.65)),\n          axis.title.y = element_text(size = rel(0.75)),\n          axis.title.x.bottom = element_blank())\n}\n\npp_C <- grp_ppc(CAssignment)\npp_ctry <- grp_ppc(country)\npp_epoch <- grp_ppc(epoch)\npp_site <- grp_ppc(site) %>%\n  left_join(ppc_dat %>% dplyr::count(site, country), \n            by = c(\"grp\" = \"site\"))\n\np1 <- plot_grp_ppc(pp_C, \"Anticoagulation\", \"\")\np2 <- plot_grp_ppc(pp_ctry, \"Country\", \"\") \np3 <- plot_grp_ppc(pp_epoch, \"Epoch\", \"\")\np4 <- plot_grp_ppc(\n  pp_site %>% filter(country == \"IN\"), \"Sites India\", \"\")\np5 <- plot_grp_ppc(\n  pp_site %>% filter(country == \"AU\"), \"Sites Australia\", \"\")\np6 <- plot_grp_ppc(\n  pp_site %>% filter(country == \"NP\"), \"Sites Nepal\", \"\")\np7 <- plot_grp_ppc(\n  pp_site %>% filter(country == \"NP\"), \"Sites New Zealand\", \"\")\n\ng1 <- (p1 | p2) / p3\ng2 <- p4 / p5 / (p6 | p7)\n\npth1 <- file.path(\n  \"outputs\", \"figures\", \"outcomes\", \"secondary\",\n  \"7-4-primary-model-acs-itt-ppc1.pdf\")\npth2 <- file.path(\n  \"outputs\", \"figures\", \"outcomes\", \"secondary\",\n  \"7-4-primary-model-acs-itt-ppc2.pdf\")\n\nggsave(pth1, g1, width = 6, height = 5, device = cairo_pdf)\nggsave(pth2, g2, width = 6, height = 6, device = cairo_pdf)\n\ng1\n\n\n\n\n\nCode\ng2"
  },
  {
    "objectID": "analyses/7-4_days_alive_hospital_free.html#sensitivity-reduced-model-no-site-term",
    "href": "analyses/7-4_days_alive_hospital_free.html#sensitivity-reduced-model-no-site-term",
    "title": "7-4 Days alive and free of hospital by day 28",
    "section": "Sensitivity: Reduced Model (No site term)",
    "text": "Sensitivity: Reduced Model (No site term)\nThe model is re-fit without site terms, but retaining the epoch terms.\n\n\nFit reduced model without site term\nfit_no_site_model <- function(dat) {\n  mdat <- make_primary_model_data(dat, c(\"inelgc3\", \"agegte60\", \"ctry\"), c(10, 2.5, 1, 1))\n  snk <- capture.output(\n    mfit <- ordmod_epoch$sample(\n      data = mdat,\n      seed = 813508,\n      chains = 8,\n      parallel_chains = 8,\n      iter_warmup = 1000,\n      iter_sampling = 2500,\n      refresh = 0,\n      adapt_delta = 0.98\n  ))\n  mdrws <- as_draws_rvars(mfit$draws())\n  \n  # Add names\n  epoch_map <- dat %>% dplyr::count(epoch, epoch_lab)\n  names(mdrws$beta) <- colnames(mdat$X)\n  names(mdrws$gamma_epoch) <- epoch_map$epoch_lab\n  \n  # Convert to treatment log odds ratios\n  mdrws$Acon <- attr(mdat$X, \"contrasts\")$randA %**% mdrws$beta[grepl(\"randA[0-9]\", names(mdrws$beta))]\n  mdrws$Ccon <- attr(mdat$X, \"contrasts\")$randC %**% mdrws$beta[grepl(\"randC[0-9]\", names(mdrws$beta))]\n  mdrws$trtA <- mdrws$Acon[-1] - mdrws$Acon[1]\n  mdrws$trtC <- mdrws$Ccon[-1] - mdrws$Ccon[1]\n  \n  mdrws$OR <- c(\n    setNames(exp(mdrws$trtC), c(\"Intermediate\", \"Low with aspirin\", \"Therapeutic\")),\n    \"Ineligible aspirin\" = exp(mdrws$beta[which(grepl(\"inelg\", colnames(mdat$X)))]),\n    \"Age \\u2265 60\" = exp(mdrws$beta[which(grepl(\"age\", colnames(mdat$X)))]),\n    setNames(exp(mdrws$beta[which(grepl(\"ctry\", colnames(mdat$X)))]), c(\"AU/NZ\", \"NP\"))\n  )\n  \n  return(list(dat = mdat, fit = mfit, drws = mdrws))\n}\nres <- fit_no_site_model(acs_itt_nona_dat)\n\n\n\n\nOdds ratio summary\nodds_ratio_summary_table_rev(res$drws$OR)\n\n\n\n\nEpoch and site terms\np <- plot_epoch_terms(exp(res$drws$gamma_epoch))\np"
  },
  {
    "objectID": "analyses/7-4_days_alive_hospital_free.html#sensitivity-treatment-coding",
    "href": "analyses/7-4_days_alive_hospital_free.html#sensitivity-treatment-coding",
    "title": "7-4 Days alive and free of hospital by day 28",
    "section": "Sensitivity: Treatment coding",
    "text": "Sensitivity: Treatment coding\nThe model is re-fit with priors specified on the treatment contrasts rather than the orthonormal contrasts.\n\n\nFit primary model using treatment contrasts\nres <- fit_primary_model(acs_itt_nona_dat, ctr = contr.treatment, save = FALSE)\n\n\n\n\nOdds ratio table\nodds_ratio_summary_table_rev(res$drws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR > 1) \n  \n \n\n  \n    Intermediate \n    1.15 \n    (0.95, 1.40) \n    1.15 (0.12) \n    0.92 \n  \n  \n    Low with aspirin \n    1.06 \n    (0.81, 1.41) \n    1.07 (0.15) \n    0.67 \n  \n  \n    Therapeutic \n    0.76 \n    (0.42, 1.37) \n    0.79 (0.25) \n    0.18 \n  \n  \n    Ineligible aspirin \n    1.08 \n    (0.56, 2.08) \n    1.14 (0.39) \n    0.59 \n  \n  \n    Age ≥ 60 \n    0.58 \n    (0.47, 0.72) \n    0.59 (0.06) \n    0.00 \n  \n  \n    AU/NZ \n    0.76 \n    (0.33, 1.76) \n    0.83 (0.38) \n    0.25 \n  \n  \n    NP \n    0.68 \n    (0.22, 2.55) \n    0.86 (0.70) \n    0.26 \n  \n\n\n\nPosterior summaries for model parameters.\n\n\n\nEpoch and site terms\np <- plot_epoch_site_terms(\n  exp(res$drws$gamma_epoch),\n  exp(res$drws$gamma_site),\n  factor(res$dat$region_by_site, \n         labels = c(\"India\", \"Australia\\nNew Zealand\", \"Nepal\"))\n)\np\n\n\n\n\n\nPosterior summaries for epoch and site terms under treatment coding for interventions."
  },
  {
    "objectID": "analyses/7-4_days_alive_hospital_free.html#sensitivity-concurrent-controls",
    "href": "analyses/7-4_days_alive_hospital_free.html#sensitivity-concurrent-controls",
    "title": "7-4 Days alive and free of hospital by day 28",
    "section": "Sensitivity: Concurrent controls",
    "text": "Sensitivity: Concurrent controls\nThree separate analyses are conducted based on concurrent randomisations as was done for the primary outcome. For these models, the epoch term has been removed.\n\nIntermediate dose\nIn the following analyses, the set is restricted to participants who were randomised to either low-dose or intermediate-dose.\n\nSet: ACS-ITT-intermediate\nCovariates: anticoagulation intervention, age group, region of enrolment.\n\n\n\nDescriptive summary table\nsave_tex_table(\n  make_summary_table(acs_itt_concurc2_dat, \"latex\"), \n  file.path(\"outcomes\", \"secondary\", \"7-4-anticoagulation-concurrent-intermediate-summary\"))\nmake_summary_table(acs_itt_concurc2_dat)\n\n\n\n\n \n  \n    Anticoagulation\nintervention \n    Patients \n    Known \n    Deaths \n    DAFH, Median (Q1, Q3) \n  \n \n\n  \n    Low-dose \n    610 \n    596 \n    19 (3%) \n    23 (21, 24) \n  \n  \n    Intermediate-dose \n    613 \n    603 \n    15 (2%) \n    23 (21, 24) \n  \n  \n    Overall \n    1223 \n    1199 \n    34 (3%) \n    23 (21, 24) \n  \n\n\n\n\n\n\n\nFit model\nfit_acs_itt_intermediate <- function(fit = TRUE) {\n  ctr <- contr.orthonorm\n  X <- model.matrix( \n    ~ CAssignment + agegte60 + ctry, \n    data = acs_itt_concurc2_nona_dat, \n    contrasts.arg = list(CAssignment = ctr))[, -1]\n  y_raw <- ordered(acs_itt_concurc2_nona_dat$out_dafh)\n  y_mod <- as.integer(y_raw)\n  N <- dim(X)[1]\n  K <- dim(X)[2]\n  unique_y <- length(unique(y_mod))\n  mdat <- list(\n    N = N, K = K, J = unique_y, X = X, y = y_mod, y_raw = y_raw,\n    p_par = 2 * rep(1 / unique_y, unique_y),\n    beta_sd = c(1, 2.5, 1, 1)\n  )\n  if (fit) {\n    snk <- capture.output(\n    mfit <- ordmod0$sample(\n      data = mdat,\n      seed = 75136,\n      chains = 8,\n      parallel_chains = min(8, parallel::detectCores()),\n      iter_warmup = 1000,\n      iter_sampling = 2500,\n      refresh = 0\n    ))\n    mfit$save_object(file.path(\"outputs\", \"models\", \"secondary\", \"7-4-dafh\", \"acs-itt-intermediate.rds\"))\n  } else {\n    mft <- readRDS(file.path(\"outputs\", \"models\", \"secondary\", \"7-4-dafh\", \"acs-itt-intermediate.rds\"))\n  }\n\n  mdrws <- as_draws_rvars(mfit$draws())\n  names(mdrws$beta) <- colnames(X)\n  mdrws$Ccon <- as.vector(ctr(2) %**% mdrws$beta[1])\n  mdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\n  mdrws$compare <- c(\"Intermediate vs low\" = exp(mdrws$Ctrt[1]))\n  mdrws$OR <- c(\n    \"Intermediate\" = exp(mdrws$Ctrt), \n    setNames(exp(mdrws$beta[2:4]), c(\"Age \\u2265 60\", \"Australia/New Zealand\", \"Nepal\"))) \n  return(list(dat = mdat, fit = mfit, drws = mdrws))\n}\n\nres <- fit_acs_itt_intermediate(TRUE)\nmdat <- res$dat\nmfit <- res$fit\nmdrws <- res$drws\n\n\n\n\nSample distribution\npdat <- acs_itt_concurc2_nona_dat %>%\n  dplyr::count(\n    CAssignment = factor(\n      CAssignment, \n      levels = c(\"C1\", \"C2\"),\n      labels = c(\"Low\", \"Intermediate\")),\n    dafh = ordered(out_dafh, levels = 0:27), \n    .drop = F) %>%\n  group_by(CAssignment) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup()\np <- ggplot(pdat, aes(CAssignment, p)) +\n  geom_col(aes(fill = fct_rev(dafh)), colour = NA) +\n  labs(x = \"Anticoagulation intervention\", y = \"Cumulative proportion\") +\n  scale_fill_viridis_d(\"Days alive and\\nfree of hospital\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE, ncol = 3)) +\n  theme(legend.key.size = unit(0.75, \"lines\"))\np\n\n\n\n\n\nDistribution of days alive and free of hospital by anti-coagulation intervention in subset.\n\n\n\n\nSample distribution\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(pth, \"outcome-7-4-descriptive-concurrent-intermediate.pdf\"), p, height = 2.5, width = 4)\n\n\n\n\nPosterior contrast\np <- plot_or_densities(mdrws$compare) +\n  # geom_segment(aes(x = 1, xend = Inf, y = 1 - 0.1, yend = 1 - 0.1),\n  #              arrow = arrow(length = unit(0.5, \"lines\"))) +\n  geom_text(aes(x = 1, y = 1 - 0.1, label = sprintf(\"Pr(OR > 1) = %.2f\", Pr(RV > 1))), hjust = 0, nudge_x = 0.01,\n            family = \"Palatino\") +\n  scale_x_log10(breaks = c(0.8, 0.9, 1, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6)) +\n  labs(y = \"Comparison\")\np\n\n\n\n\n\n\n\nOdds ratio summary table\nodds_ratio_summary_table_rev(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR > 1) \n  \n \n\n  \n    Intermediate \n    1.17 \n    (0.95, 1.42) \n    1.17 (0.12) \n    0.93 \n  \n  \n    Age ≥ 60 \n    0.51 \n    (0.41, 0.64) \n    0.52 (0.06) \n    0.00 \n  \n  \n    Australia/New Zealand \n    0.61 \n    (0.43, 0.87) \n    0.62 (0.11) \n    0.00 \n  \n  \n    Nepal \n    0.60 \n    (0.40, 0.91) \n    0.61 (0.13) \n    0.01 \n  \n\n\n\nPosterior summaries for model parameters.\n\nOdds ratio summary table\nsave_tex_table(\n  odds_ratio_summary_table_rev(mdrws$OR, \"latex\"),\n  \"outcomes/secondary/7-4-primary-model-acs-itt-concurrent-intermediate-summary-table\")\n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary(c(\"beta\"))\n\n\n# A tibble: 4 × 10\n  variable   mean median     sd    mad      q5    q95  rhat ess_bulk ess_tail\n  <chr>     <dbl>  <dbl>  <dbl>  <dbl>   <dbl>  <dbl> <dbl>    <dbl>    <dbl>\n1 beta[1]   0.108  0.108 0.0724 0.0732 -0.0113  0.227  1.00   23232.   15548.\n2 beta[2]  -0.666 -0.667 0.116  0.117  -0.858  -0.479  1.00   15313.   14791.\n3 beta[3]  -0.487 -0.488 0.177  0.175  -0.778  -0.193  1.00   21270.   15933.\n4 beta[4]  -0.509 -0.511 0.210  0.211  -0.850  -0.158  1.00   21021.   15504.\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.9410 0.9585 0.9558 0.9978 0.9629 1.0617 0.9636 1.0391\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"alpha\"])\n\n\n\n\n\n\n\n\n\n\nLow-dose with aspirin\n\nSet: ACS-ITT-aspirin\nCovariates: anticoagulation intervention, age group, region of enrolment.\n\n\n\nDescriptive summary table\nsave_tex_table(\n  make_summary_table(acs_itt_concurc3_dat, \"latex\"), \n  file.path(\"outcomes\", \"secondary\", \"7-4-anticoagulation-concurrent-stdaspirin-summary\"))\nmake_summary_table(acs_itt_concurc3_dat)\n\n\n\n\n \n  \n    Anticoagulation\nintervention \n    Patients \n    Known \n    Deaths \n    DAFH, Median (Q1, Q3) \n  \n \n\n  \n    Low-dose \n    299 \n    291 \n    11 (4%) \n    22 (20, 24) \n  \n  \n    Intermediate-dose \n    298 \n    293 \n    12 (4%) \n    22 (21, 24) \n  \n  \n    Low-dose with aspirin \n    283 \n    280 \n    10 (4%) \n    22 (20, 24) \n  \n  \n    Overall \n    880 \n    864 \n    33 (4%) \n    22 (20, 24) \n  \n\n\n\n\n\n\n\nFit model\nctr <- contr.orthonorm\nX <- model.matrix( \n  ~ CAssignment + agegte60 + ctry, \n  data = acs_itt_concurc3_nona_dat, \n  contrasts.arg = list(CAssignment = ctr))[, -1]\ny_raw <- ordered(acs_itt_concurc3_nona_dat$out_dafh)\ny_mod <- as.integer(y_raw)\nN <- dim(X)[1]\nK <- dim(X)[2]\nunique_y <- length(unique(y_mod))\nmdat <- list(\n  N = N, K = K, J = unique_y, X = X, y = y_mod, y_raw = y_raw,\n  p_par = 2 * rep(1 / unique_y, unique_y),\n  beta_sd = c(1, 1, 2.5, 1)\n)\n\nsnk <- capture.output(\n  mfit <- ordmod0$sample(\n    data = mdat,\n    seed = 135356,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    refresh = 0\n))\nmdrws <- as_draws_rvars(mfit$draws())\nnames(mdrws$beta) <- colnames(X)\n\nmdrws$Ccon <- as.vector(ctr(3) %**% mdrws$beta[1:2])\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\n\nmdrws$compare <- c(\"Intermediate vs low\" = exp(mdrws$Ctrt[1]),\n                   \"Low with aspirin vs low\" = exp(mdrws$Ctrt[2]),\n                   \"Intermediate vs low with aspirin\" = exp(mdrws$Ctrt[1] - mdrws$Ctrt[2]))\n\nmdrws$OR <- c(\"Intermediate\" = exp(mdrws$Ctrt[1]),\n              \"Low with aspirin\" = exp(mdrws$Ctrt[2]),\n              setNames(exp(mdrws$beta[3:4]), c(\"Age \\u2265 60\", \"Australia/New Zealand\")))\n\n\n\n\nSample distribution\npdat <- acs_itt_concurc3_nona_dat %>%\n  dplyr::count(\n    CAssignment = factor(\n      CAssignment, \n      levels = c(\"C1\", \"C2\", \"C3\"),\n      labels = c(\"Low\", \"Intermediate\", \"Low\\nwith aspirin\")),\n    dafh = ordered(out_dafh, levels = 0:27), \n    .drop = F) %>%\n  group_by(CAssignment) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup()\np <- ggplot(pdat, aes(CAssignment, p)) +\n  geom_col(aes(fill = fct_rev(dafh))) +\n  labs(x = \"Anticoagulation intervention\", y = \"Cumulative proportion\") +\n  scale_fill_viridis_d(\"Days alive and\\nfree of hospital\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE, ncol = 3)) +\n  theme(legend.key.size = unit(0.75, \"lines\"))\np\n\n\n\n\n\nDistribution of days alive and free of hospital by anti-coagulation intervention in subset.\n\n\n\n\nSample distribution\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(pth, \"outcome-7-4-descriptive-concurrent-stdaspirin.pdf\"), p, height = 2.5, width = 6)\n\n\n\n\nPosterior contrast\nplot_or_densities(mdrws$compare)\n\n\n\n\n\n\n\nOdds ratio summary table\nodds_ratio_summary_table_rev(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR > 1) \n  \n \n\n  \n    Intermediate \n    1.30 \n    (0.98, 1.72) \n    1.32 (0.19) \n    0.97 \n  \n  \n    Low with aspirin \n    1.12 \n    (0.84, 1.49) \n    1.13 (0.17) \n    0.78 \n  \n  \n    Age ≥ 60 \n    0.57 \n    (0.44, 0.74) \n    0.57 (0.08) \n    0.00 \n  \n  \n    Australia/New Zealand \n    0.97 \n    (0.60, 1.57) \n    1.00 (0.25) \n    0.45 \n  \n\n\n\nPosterior summaries for model parameters.\n\nOdds ratio summary table\nsave_tex_table(\n  odds_ratio_summary_table_rev(mdrws$OR, \"latex\"),\n  \"outcomes/secondary/7-4-primary-model-acs-itt-concurrent-stdaspirin-summary-table\")\n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary(c(\"beta\"))\n\n\n# A tibble: 4 × 10\n  variable    mean  median    sd   mad     q5     q95  rhat ess_bulk ess_tail\n  <chr>      <dbl>   <dbl> <dbl> <dbl>  <dbl>   <dbl> <dbl>    <dbl>    <dbl>\n1 beta[1]  -0.106  -0.105  0.104 0.104 -0.278  0.0644  1.00   24930.   15085.\n2 beta[2]  -0.154  -0.155  0.101 0.100 -0.321  0.0129  1.00   26625.   15578.\n3 beta[3]  -0.569  -0.569  0.136 0.139 -0.792 -0.344   1.00   17703.   15810.\n4 beta[4]  -0.0354 -0.0349 0.248 0.248 -0.439  0.372   1.00   23944.   15070.\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 1.0212 1.0008 1.0335 0.9707 1.0682 1.0523 1.0225 1.0058\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"alpha\"])\n\n\n\n\n\n\n\n\n\n\nTherapeutic dose\n\nSet: ACS-ITT-therapeutic\nCovariates: anticoagulation intervention, age group, region of enrolment.\n\n\n\nDescriptive summary table\nsave_tex_table(\n  make_summary_table(acs_itt_concurc4_dat, \"latex\"), \n  file.path(\"outcomes\", \"secondary\", \"7-4-anticoagulation-concurrent-therapeutic-summary\"))\nmake_summary_table(acs_itt_concurc4_dat)\n\n\n\n\n \n  \n    Anticoagulation\nintervention \n    Patients \n    Known \n    Deaths \n    DAFH, Median (Q1, Q3) \n  \n \n\n  \n    Low-dose \n    79 \n    75 \n    3 (4%) \n    22 (20, 24) \n  \n  \n    Intermediate-dose \n    65 \n    63 \n    1 (2%) \n    22 (20, 24) \n  \n  \n    Therapeutic-dose \n    50 \n    50 \n    6 (12%) \n    22 (19, 24) \n  \n  \n    Overall \n    194 \n    188 \n    10 (5%) \n    22 (19, 24) \n  \n\n\n\n\n\n\n\nFit model\nctr <- contr.orthonorm\nX <- model.matrix( \n  ~ CAssignment + agegte60 + ctry, \n  data = acs_itt_concurc4_nona_dat, \n  contrasts.arg = list(CAssignment = ctr))[, -1]\ny_raw <- ordered(acs_itt_concurc4_nona_dat$out_dafh)\ny_mod <- as.integer(y_raw)\nN <- dim(X)[1]\nK <- dim(X)[2]\nunique_y <- length(unique(y_mod))\nmdat <- list(\n  N = N, K = K, J = unique_y, X = X, y = y_mod, y_raw = y_raw,\n  p_par = 2 * rep(1 / unique_y, unique_y),\n  beta_sd = c(1, 1, 2.5, 1, 1)\n)\n\nsnk <- capture.output(\n  mfit <- ordmod0$sample(\n    data = mdat,\n    seed = 49135,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    refresh = 0\n))\nmdrws <- as_draws_rvars(mfit$draws())\nnames(mdrws$beta) <- colnames(X)\n\nmdrws$Ccon <- as.vector(ctr(3) %**% mdrws$beta[1:2])\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\n\nmdrws$compare <- c(\"Intermediate vs low\" = exp(mdrws$Ctrt[1]),\n                   \"Therapeutic vs low\" = exp(mdrws$Ctrt[2]),\n                   \"Intermediate vs therapeutic\" = exp(mdrws$Ctrt[1] - mdrws$Ctrt[2]))\n\nmdrws$OR <- c(\"Intermediate\" = exp(mdrws$Ctrt[1]),\n              \"Therapeutic\" = exp(mdrws$Ctrt[2]),\n              setNames(exp(mdrws$beta[3:5]), c(\"Age \\u2265 60\", \"India\", \"Australia/New Zealand\")))\n\n\n\n\nSample distribution\npdat <- acs_itt_concurc4_nona_dat %>%\n  dplyr::count(\n    CAssignment = factor(\n      CAssignment, \n      levels = c(\"C1\", \"C2\", \"C4\"),\n      labels = c(\"low\", \"Intermediate\", \"Therapeutic\")),\n    dafh = ordered(out_dafh, levels = 0:27), \n    .drop = F) %>%\n  group_by(CAssignment) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup()\np <- ggplot(pdat, aes(CAssignment, p)) +\n  geom_col(aes(fill = fct_rev(dafh))) +\n  labs(x = \"Anticoagulation intervention\", y = \"Cumulative proportion\") +\n  scale_fill_viridis_d(\"Days alive and\\nfree of hospital\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE, ncol = 3)) +\n  theme(legend.key.size = unit(0.75, \"lines\"))\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(pth, \"outcome-7-4-descriptive-concurrent-therapeutic.pdf\"), p, height = 2.5, width = 6)\np\n\n\n\n\n\nDistribution of days alive and free of hospital by anti-coagulation intervention in subset.\n\n\n\n\n\n\nPosterior contrasts\nplot_or_densities(mdrws$compare)\n\n\n\n\n\n\n\nOdds ratio summary table\nsave_tex_table(\n  odds_ratio_summary_table_rev(mdrws$OR, \"latex\"),\n  \"outcomes/secondary/7-4-primary-model-acs-itt-concurrent-therapeutic-summary-table\")\nodds_ratio_summary_table_rev(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR > 1) \n  \n \n\n  \n    Intermediate \n    1.17 \n    (0.65, 2.11) \n    1.22 (0.38) \n    0.70 \n  \n  \n    Therapeutic \n    0.85 \n    (0.46, 1.58) \n    0.90 (0.29) \n    0.31 \n  \n  \n    Age ≥ 60 \n    0.44 \n    (0.25, 0.75) \n    0.46 (0.13) \n    0.00 \n  \n  \n    India \n    1.60 \n    (0.74, 3.52) \n    1.73 (0.72) \n    0.88 \n  \n  \n    Australia/New Zealand \n    1.30 \n    (0.75, 2.25) \n    1.35 (0.39) \n    0.82 \n  \n\n\n\nPosterior summaries for model parameters.\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary(c(\"beta\"))\n\n\n# A tibble: 5 × 10\n  variable      mean    median    sd   mad     q5    q95  rhat ess_bulk ess_tail\n  <chr>        <dbl>     <dbl> <dbl> <dbl>  <dbl>  <dbl> <dbl>    <dbl>    <dbl>\n1 beta[1]  -0.222    -0.222    0.234 0.234 -0.609  0.162  1.00   23418.   15560.\n2 beta[2]   0.000513  0.000222 0.213 0.212 -0.352  0.349  1.00   19752.   14656.\n3 beta[3]  -0.820    -0.818    0.276 0.276 -1.28  -0.374  1.00   14620.   15492.\n4 beta[4]   0.471     0.467    0.398 0.398 -0.182  1.13   1.00   18809.   14749.\n5 beta[5]   0.260     0.259    0.282 0.280 -0.202  0.722  1.00   16305.   15958.\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.9602 0.9842 0.9251 0.9629 1.0004 0.9787 0.9783 0.9464\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"alpha\"])"
  },
  {
    "objectID": "analyses/7-5_days_alive_ventilation_free.html",
    "href": "analyses/7-5_days_alive_ventilation_free.html",
    "title": "7-5 Days alive and free of invasive or non-invasive ventilation",
    "section": "",
    "text": "Load packages\nlibrary(tidyverse)\nlibrary(labelled)\nlibrary(kableExtra)\nlibrary(cmdstanr)\nlibrary(posterior)\nlibrary(bayestestR)\nlibrary(bayesplot)\nlibrary(matrixStats)\nlibrary(plotly)\nlibrary(lubridate)\nlibrary(ggdist)\nlibrary(patchwork)\n\ntheme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank()))\nbayesplot_theme_set(theme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank())))\n\ncolor_scheme_set(\"red\")\noptions(digits = 4)\n\n\n\n\nPrepare dataset\ndevtools::load_all()\nall_dat <- read_all_no_daily()\nall_dat_daily <- read_all_daily()\n\nacs_itt_dat <- all_dat %>% \n  filter_acs_itt() %>%\n  transmute_model_cols_grp_aus_nz()\nacs_itt_nona_dat <- acs_itt_dat %>% \n  filter(!is.na(out_dafv))\n\n# Concurrent enrolments for C2\nacs_itt_concurc2_dat <- acs_itt_dat %>%\n  filter_concurrent_intermediate()\nacs_itt_concurc2_nona_dat <- acs_itt_concurc2_dat %>% \n  filter(!is.na(out_dafv))\n\n# Concurrent enrolments for C3\nacs_itt_concurc3_dat <- acs_itt_dat %>%\n  filter_concurrent_std_aspirin()\nacs_itt_concurc3_nona_dat <- acs_itt_concurc3_dat %>% \n  filter(!is.na(out_dafv))\n\n# Concurrent enrolments for C4\nacs_itt_concurc4_dat <- acs_itt_dat %>%\n  filter_concurrent_therapeutic()\nacs_itt_concurc4_nona_dat <- acs_itt_concurc4_dat %>% \n  filter(!is.na(out_dafv))\n\n\n\n\nLoad models\nordmod0 <- cmdstan_model(\n  \"stan/ordinal/logistic_cumulative.stan\") # No epoch or site\nordmod_epoch <- cmdstan_model(\n  \"stan/ordinal/logistic_cumulative_epoch.stan\") # Epoch only\nordmod <- cmdstan_model(\n  \"stan/ordinal/logistic_cumulative_epoch_site.stan\") # Full model\n\n\n\n\nCode\nmake_summary_table <- function(dat, format = \"html\") {\n  tdat <- dat %>%\n    group_by(CAssignment = factor(\n      CAssignment, \n      levels = c(\"C1\", \"C2\", \"C3\", \"C4\"),\n      labels = intervention_labels2()$CAssignment[-1])) %>%\n    summarise(\n      Patients = n(),\n      Known = sum(!is.na(out_dafv)),\n      Deaths = sprintf(\"%i (%.0f%%)\", sum(D28_death, na.rm = TRUE), 100 * mean(D28_death, na.rm = TRUE)),\n      `Any ventilation` = sprintf(\"%i (%.0f%%)\", \n                                  sum(D28_OutcomeDaysFreeOfVentilation < 28, na.rm = TRUE),\n                                  100 * mean(D28_OutcomeDaysFreeOfVentilation < 28, na.rm = TRUE)),\n      `DAFV, Median (Q1, Q3)` = sprintf(\n        \"%.0f (%.0f, %.0f)\", \n        median(out_dafv, na.rm = T), \n        quantile(out_dafv, 0.25, na.rm = TRUE), \n        quantile(out_dafv, 0.75, na.rm = TRUE))\n    ) %>%\n    bind_rows(\n      dat %>%\n    group_by(CAssignment = \"Overall\") %>%\n    summarise(\n      Patients = n(),\n      Known = sum(!is.na(out_dafv)),\n      Deaths = sprintf(\"%i (%.0f%%)\", sum(D28_death, na.rm = TRUE), 100 * mean(D28_death, na.rm = TRUE)),\n      `Any ventilation` = sprintf(\"%i (%.0f%%)\", \n                              sum(D28_OutcomeDaysFreeOfVentilation < 28, na.rm = TRUE),\n                              100 * mean(D28_OutcomeDaysFreeOfVentilation < 28, na.rm = TRUE)),\n      `DAFV, Median (Q1, Q3)` = sprintf(\n        \"%.0f (%.0f, %.0f)\", \n        median(out_dafv, na.rm = T), \n        quantile(out_dafv, 0.25, na.rm = TRUE), \n        quantile(out_dafv, 0.75, na.rm = TRUE))\n    )\n    ) %>%\n    rename(`Anticoagulation\\nintervention` = CAssignment)\n  kable(\n    tdat,\n    format = format,\n    align = \"lrrrrr\",\n    booktabs = TRUE,\n    linesep = \"\"\n  ) %>%\n    kable_styling(\n      font_size = 9,\n      latex_options = \"HOLD_position\"\n    ) %>%\n    row_spec(nrow(tdat), bold = T)\n}\n\n\nmake_primary_model_data <- function(\n    dat, \n    vars = NULL,\n    beta_sd_var = NULL,\n    ctr = contr.orthonorm,\n    p_mult = 2) {\n  \n  X <- make_X_design(dat, vars, ctr)\n  attX <- attr(X, \"contrasts\")\n  X <- X[, -1]\n  attr(X, \"contrasts\") <- attX\n  nXtrt <- sum(grepl(\"rand\", colnames(X)))\n  \n  beta_sd <- c(rep(1, nXtrt), beta_sd_var)\n  \n  epoch <- dat$epoch\n  M_epoch <- max(dat$epoch)\n  region <- dat$ctry_num\n  M_region <- max(region)\n  site <- dat$site_num\n  M_site <- max(site)\n  region_by_site <- dat %>% \n    dplyr::count(ctry_num, site_num) %>% \n    pull(ctry_num)\n\n  y_raw <- ordered(dat$out_dafv)\n  y_mod <- as.integer(y_raw)\n  N <- dim(X)[1]\n  K <- dim(X)[2]\n  unique_y <- length(unique(y_mod))\n  list(N = N, K = K, J = unique_y, X = X, y = y_mod, y_raw = y_raw,\n       M_region = M_region,\n       M_site = M_site, site = site,\n       M_epoch = M_epoch, epoch = epoch,\n       region_by_site = region_by_site,\n       p_par = p_mult * rep(1 / unique_y, unique_y),\n       beta_sd = beta_sd)  \n}\n\n\n\n\nThis outcome was defined as the number of days alive and free of positive pressure ventilation (invasive or non-invasive) to 28 days. All patients dying within 28 days will be assigned zero free days.\nThe outcome is calculated for a patient as:\n\nmissing, if day 28 mortality is unknown (D28_PatientStatus) or if the patient was known to have been alive at day 28 but number of days requiring ventilation (D28_OutcomeDaysFreeOfVentilation) is unknown\n0 if they died by day 28 (D28_PatientStatus)\nmin(28, D28_OutcomeDaysFreeOfVentilation) otherwise\n\n\n\n\n\n\nThe overall distribution of days alive and free of ventilation (DAFV) are reported in Figure 1 for all participants in the ACS-ITT set.\nThere were few participants who required any ventilation during hospital who did not die (DAFV of 0),\n\n\n\nCode\npdat <- acs_itt_dat %>%\n  dplyr::count(dafv = addNA(ordered(out_dafv, levels = 0:28)), .drop = F) %>%\n  mutate(p = n / sum(n))\nggplot(pdat, aes(dafv, p)) +\n  geom_col() +\n  labs(\n    x = \"Days alive and free of ventilation\", \n    y = \"Proportion\"\n  )\n\n\n\n\n\n(a) ACS-ITT\n\n\n\nFigure 1: Distribution of days alive and free of hospital.\n\n\n\n\nCode\nsave_tex_table(\n  make_summary_table(acs_itt_dat, \"latex\"), \n  file.path(\"outcomes\", \"secondary\", \"7-5-anticoagulation-summary\"))\nmake_summary_table(acs_itt_dat)\n\n\n\n\n \n  \n    Anticoagulation\nintervention \n    Patients \n    Known \n    Deaths \n    Any ventilation \n    DAFV, Median (Q1, Q3) \n  \n \n\n  \n    Low-dose \n    610 \n    596 \n    19 (3%) \n    34 (6%) \n    28 (28, 28) \n  \n  \n    Intermediate-dose \n    613 \n    603 \n    15 (2%) \n    23 (4%) \n    28 (28, 28) \n  \n  \n    Low-dose with aspirin \n    283 \n    281 \n    10 (4%) \n    18 (6%) \n    28 (28, 28) \n  \n  \n    Therapeutic-dose \n    50 \n    50 \n    6 (12%) \n    7 (14%) \n    28 (28, 28) \n  \n  \n    Overall \n    1556 \n    1530 \n    50 (3%) \n    82 (5%) \n    28 (28, 28) \n  \n\n\n\nSummaty of DAFV.\n\n\n\n\n\n\nCode\npdat <- acs_itt_nona_dat %>%\n  dplyr::count(\n    CAssignment = factor(CAssignment, labels = str_replace(intervention_labels()$CAssignment[-1], \"<br>\", \"\\n\")),\n    dafv = ordered(out_dafv, levels = 0:28), \n    .drop = F) %>%\n  group_by(CAssignment) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup()\np <- ggplot(pdat, aes(CAssignment, p)) +\n  geom_col(aes(fill = fct_rev(dafv))) +\n  labs(x = \"Anticoagulation intervention\", y = \"Cumulative proportion\") +\n  scale_fill_viridis_d(\"Days alive and\\nfree of ventilation\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE)) +\n  theme(legend.key.size = unit(0.75, \"lines\"))\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(pth, \"outcome-7-5-descriptive.pdf\"), p, height = 3, width = 6)\np\n\n\n\n\n\nFigure 2: Distribution of days alive and free of hospital by anti-coagulation intervention.\n\n\n\n\n\n\n\n\n\nDAFV by age\npdat <- acs_itt_nona_dat %>%\n  dplyr::count(\n    agegrp = cut(AgeAtEntry, c(18, seq(25, 75, 5), 100), include.lowest = T, right = F),\n    dafv = fct_rev(ordered(out_dafv, levels = 0:28)), \n    .drop = F) %>%\n  group_by(agegrp) %>%\n  mutate(p = n / sum(n))\npdat2 <- pdat %>%\n  group_by(agegrp) %>%\n  summarise(n = sum(n))\np1 <- ggplot(pdat2, aes(agegrp, n)) +\n  geom_col(colour = \"grey40\", fill = \"grey40\") +\n  geom_vline(xintercept = 60, linetype = 2) +\n  labs(y = \"Number of\\nparticipants\",\n       x = \"Age at entry\") +\n  geom_vline(xintercept = 8.5, linetype = 2) +\n  theme(axis.text.x = element_text(hjust = 1, angle = 45))\np2 <- ggplot(pdat, aes(agegrp, p)) +\n  geom_col(aes(fill = dafv)) +\n  labs(x = \"Age\", y = \"Cumulative\\nproportion\") +\n  scale_fill_viridis_d(\"DAFV\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE)) +\n  geom_vline(xintercept = 8.5, linetype = 2) +\n  theme(axis.text.x = element_text(hjust = 1, angle = 45)) +\n  theme(legend.key.size = unit(0.25, \"lines\"))\np <- p1 | p2\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-5-age.pdf\"), p, height = 2.5, width = 6)\np\n\n\n\n\n\nFigure 3: Distribution of days alive and free of ventilation by age group\n\n\n\n\n\n\n\n\n\nDAFV by country\npdat <- acs_itt_nona_dat %>%\n  dplyr::count(\n    country,\n    dafv = ordered(out_dafv, levels = 0:28), \n    .drop = F) %>%\n  group_by(country) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup()\npdat2 <- pdat %>%\n  group_by(country) %>%\n  summarise(n = sum(n))\n\np1 <- ggplot(pdat2, aes(country, n)) +\n  geom_col() +\n    labs(\n      y = \"Number of\\nparticipants\", \n      x = \"Country of enrolment\")\n\np2 <- ggplot(pdat, aes(country, p)) +\n  geom_col(aes(fill = fct_rev(dafv))) +\n  labs(x = \"Anticoagulation intervention\", y = \"Cumulative\\nproportion\") +\n  scale_fill_viridis_d(\"DAFV\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE)) +\n  theme(legend.key.size = unit(0.25, \"lines\"))\np <- p1 | p2\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-5-country.pdf\"), p, height = 2.5, width = 6)\np\n\n\n\n\n\nFigure 4: Distribution of days alive and free of ventilation by country.\n\n\n\n\n\n\n\n\n\nDAFV by site\npdat <- all_dat %>%\n  filter_acs_itt() %>%\n  filter(!is.na(out_dafv)) %>%\n  dplyr::count(\n    Country = factor(PT_CountryName, levels = c(\"India\", \"Australia\", \"Nepal\", \"New Zealand\"),\n                     labels = c(\"India\", \"Australia\", \"Nepal\", \"New\\nZealand\")),\n    Site = fct_infreq(Location),\n    dafv = ordered(out_dafv, levels = 0:28)) %>%\n  complete(dafv = ordered(0:28), nesting(Country, Site), fill = list(n = 0)) %>%\n  group_by(Country, Site) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup() %>%\n  mutate(\n    Country = droplevels(Country),\n    Site = droplevels(Site)\n  )\npdat2 <- pdat %>%\n  group_by(Country, Site) %>%\n  summarise(n = sum(n)) %>%\n  ungroup()\np1 <- ggplot(pdat2, aes(Site, n)) +\n  facet_grid( ~ Country, scales = \"free_x\", space = \"free_x\") +\n  geom_col() +\n    labs(\n      y = \"Number of\\nparticipants\", \n      x = \"\") +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        panel.border = element_rect(fill = NA))\np2 <- ggplot(pdat, aes(Site, p)) +\n  facet_grid( ~ Country, scales = \"free_x\", space = \"free_x\") +\n  geom_col(aes(fill = fct_rev(dafv))) +\n  labs(x = \"Anticoagulation intervention\", y = \"Cumulative\\nproportion\") +\n  scale_fill_viridis_d(\"DAFV\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE, ncol = 1)) +\n  theme(axis.text.x = element_text(hjust = 1, angle = 45)) +\n  theme(legend.key.size = unit(0.25, \"lines\"))\np <- p1 / p2 +\n  plot_layout(guides = 'collect')\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-5-country-site.pdf\"), p, height = 4, width = 6.25)\np\n\n\n\n\n\nFigure 5: Distribution of days alive and free of ventilation by study site\n\n\n\n\n\n\n\n\n\nDAFV by calendar date\npdat <- acs_itt_nona_dat %>%\n  dplyr::count(\n    yr = year(RandDate), mth = month(RandDate),\n    dafv = ordered(out_dafv, levels = 0:28), \n    .drop = F) %>%\n  group_by(yr, mth) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup()\np1 <- pdat %>%\n  group_by(yr, mth) %>%\n  summarise(n = sum(n)) %>%\n  ggplot(., aes(mth, n))  +\n  facet_grid( ~ yr, drop = T, scales = \"free_x\", space = \"free\") +\n    geom_col() +\n    labs(\n      y = \"Number of\\nparticipants\", \n      x = \"Calendar date (month of year)\") +\n  scale_x_continuous(breaks = 1:12)\np2 <- ggplot(pdat, aes(mth, p)) +\n  facet_grid( ~ yr, drop = T, scales = \"free_x\", space = \"free\") +\n  geom_col(aes(fill = fct_rev(dafv))) +\n  labs(x = \"Calendar date (month of year)\", y = \"Cumulative\\nproportion\") +\n  scale_fill_viridis_d(\"DAFV\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE)) +\n  theme(legend.key.size = unit(0.25, \"lines\")) +\n  scale_x_continuous(breaks = 1:12)\np <- p1 | p2\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-5-calendar-time.pdf\"), p, height = 2, width = 6)\np\n\n\n\n\n\nFigure 6: Distribution of days alive and free of ventilation by calendar time.\n\n\n\n\n\n\n\n\n\nPlot sample cumulative logits\ntrt_counts <- acs_itt_nona_dat %>%\n  dplyr::count(CAssignment, out_dafv) %>%\n  complete(CAssignment, out_dafv, fill = list(n = 0)) %>%\n  group_by(CAssignment) %>%\n  mutate(p = n / sum(n))\ntrt_logit <- trt_counts %>% \n  group_by(CAssignment) %>% \n  mutate(clogit = logit(cumsum(p))) %>%\n  group_by(out_dafv) %>%\n  mutate(rel_clogit = clogit - mean(clogit)) %>%\n  filter(out_dafv != 28)\n\nggplot(trt_logit, aes(CAssignment, rel_clogit)) +\n  facet_wrap( ~ out_dafv) +\n  geom_point() +\n  labs(y = \"Relative (to mean) sample cumulative logit\")\n\n\n\n\n\nInspect sample cumulative logits.\n\n\n\n\nPlot sample cumulative logits\nggplot(trt_logit, aes(out_dafv, rel_clogit)) +\n  facet_wrap( ~ CAssignment) +\n  geom_point() +\n  labs(y = \"Relative (to mean) sample cumulative logit\")\n\n\n\n\n\nInspect sample cumulative logits.\n\n\n\n\n\n\n\n\nThe primary analysis uses the ACS-ITT set, so all participants have been randomised to the anticoagulation domain and some participants may have been randomised to the antiviral domain.\n\n\n\n\nFit primary model\nfit_primary_model <- function(dat, ctr = contr.orthonorm, save = FALSE) {\n  mdat <- make_primary_model_data(\n    dat, c(\"inelgc3\", \"agegte60\", \"ctry\"), \n    c(10, 2.5, 1, 1), \n    ctr)\n  snk <- capture.output(\n  mfit <- ordmod$sample(\n    data = mdat,\n    seed = 3510392,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    refresh = 0,\n    adapt_delta = 0.98\n  )) \n  if (save) {\n    mfit$save_object(file.path(\"outputs\", \"models\", \"secondary\", \"7-5.rds\"))    \n  }\n  mdrws <- as_draws_rvars(mfit$draws())\n  # Add names\n  epoch_map <- dat %>% dplyr::count(epoch, epoch_lab)\n  site_map <- dat %>% dplyr::count(site_num, site)\n  names(mdrws$beta) <- colnames(mdat$X)\n  names(mdrws$gamma_epoch) <- epoch_map$epoch_lab\n  names(mdrws$gamma_site) <- site_map$site\n  # Convert to treatment log odds ratios\n  mdrws$Acon <- attr(mdat$X, \"contrasts\")$randA %**% mdrws$beta[grepl(\"randA[0-9]\", names(mdrws$beta))]\n  mdrws$Ccon <- attr(mdat$X, \"contrasts\")$randC %**% mdrws$beta[grepl(\"randC[0-9]\", names(mdrws$beta))]\n  mdrws$trtA <- mdrws$Acon[-1] - mdrws$Acon[1]\n  mdrws$trtC <- mdrws$Ccon[-1] - mdrws$Ccon[1]\n  mdrws$compare <- c(\n    \"Intermediate vs low\" = exp(mdrws$trtC[1]),\n    \"Low with aspirin vs low\" = exp(mdrws$trtC[2]),\n    \"Therapeutic vs low\" = exp(mdrws$trtC[3]),\n    \"Intermediate vs low with aspirin\" = exp(mdrws$trtC[1] - mdrws$trtC[2]),\n    \"Intermediate vs therapeutic\" = exp(mdrws$trtC[1] - mdrws$trtC[3]),\n    \"Low with aspirin vs therapeutic\" = exp(mdrws$trtC[2] - mdrws$trtC[3])\n  )\n  mdrws$OR <- c(\n    setNames(exp(mdrws$trtC), c(\"Intermediate\", \"Low with aspirin\", \"Therapeutic\")),\n    \"Ineligible aspirin\" = exp(mdrws$beta[which(grepl(\"inelg\", colnames(mdat$X)))]),\n    \"Age \\u2265 60\" = exp(mdrws$beta[which(grepl(\"age\", colnames(mdat$X)))]),\n    setNames(exp(mdrws$beta[which(grepl(\"ctry\", colnames(mdat$X)))]), c(\"AU/NZ\", \"NP\"))\n  )\n  return(list(dat = mdat, fit = mfit, drws = mdrws))\n}\nres <- fit_primary_model(acs_itt_nona_dat, save = TRUE)\n\n\n\n\nOdds ratio summary table\nsave_tex_table(\n  odds_ratio_summary_table_rev(res$drws$OR, \"latex\"),\n  \"outcomes/secondary/7-5-primary-model-acs-itt-summary-table\")\nodds_ratio_summary_table_rev(res$drws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR > 1) \n  \n \n\n  \n    Intermediate \n    1.40 \n    (0.81, 2.45) \n    1.46 (0.42) \n    0.88 \n  \n  \n    Low with aspirin \n    1.16 \n    (0.62, 2.19) \n    1.22 (0.41) \n    0.68 \n  \n  \n    Therapeutic \n    0.41 \n    (0.15, 1.15) \n    0.47 (0.27) \n    0.05 \n  \n  \n    Ineligible aspirin \n    0.29 \n    (0.09, 1.08) \n    0.37 (0.28) \n    0.03 \n  \n  \n    Age ≥ 60 \n    0.50 \n    (0.31, 0.83) \n    0.52 (0.13) \n    0.00 \n  \n  \n    AU/NZ \n    1.10 \n    (0.27, 4.92) \n    1.47 (1.28) \n    0.55 \n  \n  \n    NP \n    0.56 \n    (0.15, 2.32) \n    0.74 (0.68) \n    0.20 \n  \n\n\n\nPosterior summaries for model parameters (fixed-effects).\n\n\n\nOdds ratio summary for epoch and site\np <- plot_epoch_site_terms(\n  exp(res$drws$gamma_epoch),\n  exp(res$drws$gamma_site),\n  factor(res$dat$region_by_site, \n         labels = c(\"India\", \"Australia\\nNew Zealand\", \"Nepal\"))\n)\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\", \"7-5-primary-model-epoch-site-terms.pdf\")\nggsave(pth, p, width = 6, height = 4.5)\np\n\n\n\n\n\nSummary of epoch and site posterior odds ratios.\n\n\n\n\n\n\nCode\np <- plot_or_densities(res$drws$compare)\np\n\n\n\n\n\nPosterior densities for treatment comparisons.\n\n\n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nres$fit$summary(c(\"alpha\", \"beta\", \"gamma_site\", \"gamma_epoch\", \"tau_site\", \"tau_epoch\")) %>%\n  print(n = Inf)\n\n\n# A tibble: 68 × 10\n   variable            mean   median    sd   mad      q5     q95  rhat ess_bulk\n   <chr>              <dbl>    <dbl> <dbl> <dbl>   <dbl>   <dbl> <dbl>    <dbl>\n 1 alpha[1]        -4.37    -4.36    0.704 0.682 -5.55   -3.23    1.00    2883.\n 2 alpha[2]        -4.32    -4.32    0.704 0.684 -5.50   -3.18    1.00    2869.\n 3 alpha[3]        -4.30    -4.29    0.704 0.682 -5.48   -3.16    1.00    2858.\n 4 alpha[4]        -4.28    -4.27    0.704 0.682 -5.46   -3.14    1.00    2850.\n 5 alpha[5]        -4.26    -4.25    0.703 0.679 -5.43   -3.11    1.00    2842.\n 6 alpha[6]        -4.23    -4.23    0.703 0.679 -5.41   -3.10    1.00    2840.\n 7 alpha[7]        -4.19    -4.19    0.702 0.678 -5.37   -3.06    1.00    2832.\n 8 alpha[8]        -4.17    -4.17    0.702 0.677 -5.35   -3.03    1.00    2823.\n 9 alpha[9]        -4.13    -4.13    0.702 0.679 -5.30   -3.00    1.00    2812.\n10 alpha[10]       -4.10    -4.09    0.701 0.677 -5.27   -2.97    1.00    2809.\n11 alpha[11]       -4.08    -4.07    0.701 0.677 -5.24   -2.95    1.00    2805.\n12 alpha[12]       -4.06    -4.05    0.701 0.678 -5.22   -2.93    1.00    2800.\n13 alpha[13]       -4.02    -4.01    0.701 0.678 -5.19   -2.89    1.00    2793.\n14 alpha[14]       -3.99    -3.98    0.700 0.677 -5.16   -2.86    1.00    2782.\n15 alpha[15]       -3.94    -3.93    0.700 0.676 -5.11   -2.81    1.00    2778.\n16 alpha[16]       -3.86    -3.85    0.699 0.674 -5.03   -2.74    1.00    2780.\n17 alpha[17]       -3.81    -3.80    0.699 0.673 -4.97   -2.68    1.00    2771.\n18 beta[1]         -0.753   -0.758   0.420 0.426 -1.44   -0.0600  1.00   18460.\n19 beta[2]          0.118    0.117   0.226 0.228 -0.251   0.493   1.00   20145.\n20 beta[3]          0.555    0.553   0.279 0.281  0.0984  1.02    1.00   18259.\n21 beta[4]         -0.121   -0.115   0.694 0.688 -1.28    1.00    1.00   16789.\n22 beta[5]          0.893    0.882   0.530 0.526  0.0392  1.79    1.00   23035.\n23 beta[6]         -1.21    -1.23    0.633 0.630 -2.22   -0.134   1.00   24360.\n24 beta[7]         -0.691   -0.692   0.255 0.254 -1.10   -0.269   1.00   19969.\n25 beta[8]          0.112    0.0971  0.732 0.729 -1.07    1.35    1.00   10389.\n26 beta[9]         -0.560   -0.578   0.692 0.676 -1.67    0.594   1.00    6683.\n27 gamma_site[1]    2.07     1.82    1.50  1.27   0.139   4.83    1.00    8903.\n28 gamma_site[2]    2.25     2.00    1.51  1.27   0.331   4.96    1.00    7889.\n29 gamma_site[3]    1.48     1.25    1.54  1.31  -0.534   4.26    1.00   10176.\n30 gamma_site[4]   -1.06    -1.08    0.601 0.572 -2.02   -0.0458  1.00    4793.\n31 gamma_site[5]   -0.0208  -0.0425  0.596 0.565 -0.956   0.996   1.00    4206.\n32 gamma_site[6]   -1.61    -1.62    0.626 0.610 -2.63   -0.582   1.00    5828.\n33 gamma_site[7]    2.27     2.02    1.52  1.27   0.346   5.06    1.00    8546.\n34 gamma_site[8]   -0.440   -0.450   0.692 0.666 -1.56    0.707   1.00    6550.\n35 gamma_site[9]    1.47     1.40    0.848 0.808  0.221   2.97    1.00    7327.\n36 gamma_site[10]   1.98     1.74    1.50  1.28   0.0214  4.74    1.00    8735.\n37 gamma_site[11]  -0.387   -0.400   0.657 0.628 -1.43    0.716   1.00    5897.\n38 gamma_site[12]  -0.569   -0.435   1.03  0.890 -2.41    0.933   1.00   16270.\n39 gamma_site[13]   0.627    0.406   1.18  0.866 -0.898   2.78    1.00   19907.\n40 gamma_site[14]  -1.05    -0.906   1.04  1.05  -2.94    0.361   1.00   11400.\n41 gamma_site[15]   0.534    0.333   1.21  0.884 -1.09    2.70    1.00   19995.\n42 gamma_site[16]  -0.989   -0.875   0.988 1.02  -2.78    0.369   1.00   11863.\n43 gamma_site[17]  -0.976   -0.894   0.887 0.905 -2.57    0.253   1.00   11363.\n44 gamma_site[18]   0.425    0.232   1.21  0.900 -1.23    2.61    1.00   21990.\n45 gamma_site[19]   0.336    0.166   1.22  0.906 -1.39    2.49    1.00   21820.\n46 gamma_site[20]  -0.587   -0.459   1.03  0.892 -2.44    0.902   1.00   16073.\n47 gamma_site[21]   0.438    0.246   1.22  0.901 -1.24    2.63    1.00   22541.\n48 gamma_site[22]   0.502    0.294   1.23  0.903 -1.15    2.71    1.00   21711.\n49 gamma_site[23]   1.15     0.938   1.15  1.00  -0.233   3.29    1.00   14574.\n50 gamma_site[24]   0.625    0.409   1.18  0.872 -0.924   2.80    1.00   18145.\n51 gamma_site[25]  -0.270   -0.126   0.579 0.359 -1.39    0.454   1.00   11367.\n52 gamma_site[26]  -0.00143  0.00867 0.557 0.335 -0.965   0.859   1.00   15002.\n53 gamma_epoch[1]   0        0       0     0      0       0      NA         NA \n54 gamma_epoch[2]  -0.229   -0.169   0.402 0.332 -0.969   0.338   1.00   10447.\n55 gamma_epoch[3]  -0.333   -0.268   0.478 0.427 -1.20    0.345   1.00    8933.\n56 gamma_epoch[4]  -0.266   -0.224   0.464 0.415 -1.08    0.445   1.00    9924.\n57 gamma_epoch[5]  -0.545   -0.474   0.561 0.551 -1.58    0.231   1.00    7721.\n58 gamma_epoch[6]  -0.373   -0.325   0.554 0.507 -1.33    0.469   1.00   10405.\n59 gamma_epoch[7]  -0.480   -0.430   0.569 0.550 -1.48    0.357   1.00    8708.\n60 gamma_epoch[8]  -0.567   -0.515   0.577 0.564 -1.58    0.283   1.00    8024.\n61 gamma_epoch[9]  -0.795   -0.751   0.608 0.617 -1.86    0.0821  1.00    6530.\n62 gamma_epoch[10] -1.08    -1.05    0.680 0.698 -2.26   -0.0280  1.00    5706.\n63 gamma_epoch[11] -0.595   -0.550   0.616 0.616 -1.66    0.328   1.00    7632.\n64 gamma_epoch[12] -0.307   -0.281   0.645 0.586 -1.40    0.741   1.00   10145.\n65 tau_site[1]      1.83     1.68    0.733 0.603  0.937   3.22    1.00    5368.\n66 tau_site[2]      1.20     1.12    0.680 0.616  0.231   2.42    1.00    6674.\n67 tau_site[3]      0.647    0.483   0.619 0.454  0.0438  1.80    1.00   11241.\n68 tau_epoch        0.439    0.412   0.237 0.224  0.0916  0.863   1.00    5973.\n# … with 1 more variable: ess_tail <dbl>\n\n\nCode\nres$fit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.7775 0.7944 0.7418 0.8248 0.7489 0.7897 0.8120 0.7979\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"alpha\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"gamma_site\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"gamma_epoch\"])\n\n\n\n\n\n\n\n\n\n\n\n\nCode\ny_raw <- as.integer(levels(res$dat$y_raw))\ny_ppc <- res$drws$y_ppc\ny_ppc_raw <- rfun(\\(x) y_raw[x])(y_ppc)\nppc_dat <- bind_cols(acs_itt_nona_dat, tibble(y_ppc = y_ppc_raw)) %>%\n  mutate(CAssignment = factor(\n    CAssignment, \n    levels = names(intervention_labels_short_break()$CAssignment),\n    labels = intervention_labels_short_break()$CAssignment))\n\ngrp_ppc <- function(grp, d = 0:28) {\n  ppc_dat %>%\n    group_by(grp = {{grp}}) %>%\n    summarise(\n      y_lteq = map_dbl(d, ~ mean(out_dafv <= .x)),\n      ypp_lteq = map(d, ~ rvar_mean(y_ppc <= .x)),\n      y_eq = map_dbl(d, ~ mean(out_dafv == .x)),\n      ypp_eq = map(d, ~ rvar_mean(y_ppc == .x))\n    ) %>%\n    unnest(c(ypp_lteq, ypp_eq)) %>%\n    mutate(days = d) %>%\n    ungroup() %>%\n    pivot_longer(\n      y_lteq:ypp_eq, \n      names_to = c(\"response\", \"event\"),\n      names_sep = \"_\",\n      values_to = \"posterior\")\n}\n\nplot_grp_ppc <- function(dat, lab = \"\", xlab = \"Probability\") {\n  ggplot(dat %>% \n           filter(response == \"ypp\", event == \"eq\"), \n         aes(y = days)) +\n    facet_wrap( ~ grp, nrow = 1, scales = \"free_x\") +\n    stat_slabinterval(aes(xdist = posterior), fatten_point = 1)  +\n    geom_point(data = dat %>% filter(response == \"y\", event == \"eq\"), \n               aes(y = days, x = mean(posterior)),\n               colour = \"red\",\n               shape = 23) +\n    scale_x_continuous(\n      xlab, breaks = c(0, 0.3, 0.6),\n      sec.axis = sec_axis(\n        ~ . , name = lab, breaks = NULL, labels = NULL)) +\n    scale_y_continuous(\"Days\") +\n    theme(strip.text = element_text(size = rel(0.7)),\n          axis.title.x = element_text(size = rel(0.7)),\n          axis.text.x = element_text(size = rel(0.65)),\n          axis.title.y = element_text(size = rel(0.75)),\n          axis.title.x.bottom = element_blank())\n}\n\npp_C <- grp_ppc(CAssignment)\npp_ctry <- grp_ppc(country)\npp_epoch <- grp_ppc(epoch)\npp_site <- grp_ppc(site) %>%\n  left_join(ppc_dat %>% dplyr::count(site, country), \n            by = c(\"grp\" = \"site\"))\n\np1 <- plot_grp_ppc(pp_C, \"Anticoagulation\", \"\")\np2 <- plot_grp_ppc(pp_ctry, \"Country\", \"\") \np3 <- plot_grp_ppc(pp_epoch, \"Epoch\", \"\")\np4 <- plot_grp_ppc(\n  pp_site %>% filter(country == \"IN\"), \"Sites India\", \"\")\np5 <- plot_grp_ppc(\n  pp_site %>% filter(country == \"AU\"), \"Sites Australia\", \"\")\np6 <- plot_grp_ppc(\n  pp_site %>% filter(country == \"NP\"), \"Sites Nepal\", \"\")\np7 <- plot_grp_ppc(\n  pp_site %>% filter(country == \"NP\"), \"Sites New Zealand\", \"\")\n\ng1 <- (p1 | p2) / p3\ng2 <- p4 / p5 / (p6 | p7)\n\npth1 <- file.path(\n  \"outputs\", \"figures\", \"outcomes\", \"secondary\",\n  \"7-5-primary-model-acs-itt-ppc1.pdf\")\npth2 <- file.path(\n  \"outputs\", \"figures\", \"outcomes\", \"secondary\",\n  \"7-5-primary-model-acs-itt-ppc2.pdf\")\n\nggsave(pth1, g1, width = 6, height = 5, device = cairo_pdf)\nggsave(pth2, g2, width = 6, height = 6, device = cairo_pdf)\n\ng1\n\n\n\n\n\nCode\ng2\n\n\n\n\n\n\n\n\n\nThree separate analyses are conducted based on concurrent randomisations as was done for the primary outcome. For these models, the epoch term has been removed.\n\n\n\n\nDescriptive summary table\nsave_tex_table(\n  make_summary_table(acs_itt_concurc2_dat, \"latex\"), \n  file.path(\"outcomes\", \"secondary\", \"7-5-anticoagulation-concurrent-intermediate-summary\"))\nmake_summary_table(acs_itt_concurc2_dat)\n\n\n\n\n \n  \n    Anticoagulation\nintervention \n    Patients \n    Known \n    Deaths \n    Any ventilation \n    DAFV, Median (Q1, Q3) \n  \n \n\n  \n    Low-dose \n    610 \n    596 \n    19 (3%) \n    34 (6%) \n    28 (28, 28) \n  \n  \n    Intermediate-dose \n    613 \n    603 \n    15 (2%) \n    23 (4%) \n    28 (28, 28) \n  \n  \n    Overall \n    1223 \n    1199 \n    34 (3%) \n    57 (5%) \n    28 (28, 28) \n  \n\n\n\n\n\n\n\nFit model\nctr <- contr.orthonorm\nX <- model.matrix( \n  ~ CAssignment + agegte60 + ctry, \n  data = acs_itt_concurc2_nona_dat, \n  contrasts.arg = list(CAssignment = ctr))[, -1]\ny_raw <- ordered(acs_itt_concurc2_nona_dat$out_dafv)\ny_mod <- as.integer(y_raw)\nN <- dim(X)[1]\nK <- dim(X)[2]\nunique_y <- length(unique(y_mod))\nmdat <- list(\n  N = N, K = K, J = unique_y, X = X, y = y_mod, y_raw = y_raw,\n  p_par = 2 * rep(1 / unique_y, unique_y),\n  beta_sd = c(1, 2.5, 1, 1)\n)\nsnk <- capture.output(\n  mfit <- ordmod0$sample(\n    data = mdat,\n    seed = 75136,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    refresh = 0\n))\nmdrws <- as_draws_rvars(mfit$draws())\nnames(mdrws$beta) <- colnames(X)\nmdrws$Ccon <- as.vector(ctr(2) %**% mdrws$beta[1])\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\nmdrws$compare <- c(\"Intermediate vs low\" = exp(mdrws$Ctrt[1]))\nmdrws$OR <- c(\"Intermediate\" = exp(mdrws$Ctrt), \n              setNames(exp(mdrws$beta[2:4]), c(\"Age \\u2265 60\", \"Australia/New Zealand\", \"Nepal\")))\n\n\n\n\nSample distribution\npdat <- acs_itt_concurc2_nona_dat %>%\n  dplyr::count(\n    CAssignment = factor(\n      CAssignment, \n      levels = c(\"C1\", \"C2\"),\n      labels = c(\"Low\", \"Intermediate\")),\n    dafv = ordered(out_dafv, levels = 0:28), \n    .drop = F) %>%\n  group_by(CAssignment) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup()\np <- ggplot(pdat, aes(CAssignment, p)) +\n  geom_col(aes(fill = fct_rev(dafv)), colour = NA) +\n  labs(x = \"Anticoagulation intervention\", y = \"Cumulative proportion\") +\n  scale_fill_viridis_d(\"Days alive and\\nfree of ventilation\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE, ncol = 3)) +\n  theme(legend.key.size = unit(0.75, \"lines\"))\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(pth, \"outcome-7-5-descriptive-concurrent-intermediate.pdf\"), p, height = 2.5, width = 4)\np\n\n\n\n\n\nDistribution of days alive and free of hospital by anti-coagulation intervention in subset.\n\n\n\n\n\n\nPosterior contrast\np <- plot_or_densities(mdrws$compare) +\n  geom_text(aes(x = 1, y = 1 - 0.1, \n                label = sprintf(\"Pr(OR > 1) = %.2f\", Pr(RV > 1))), \n            hjust = 0, nudge_x = 0.01, family = \"Palatino\") +\n  scale_x_log10(breaks = c(0.8, 0.9, 1, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6)) +\n  labs(y = \"Comparison\")\np\n\n\n\n\n\n\n\nOdds ratio summary table\nsave_tex_table(\n  odds_ratio_summary_table_rev(mdrws$OR, \"latex\"),\n  \"outcomes/secondary/7-5-primary-model-acs-itt-concurrent-intermediate-summary-table\")\nodds_ratio_summary_table_rev(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR > 1) \n  \n \n\n  \n    Intermediate \n    1.51 \n    (0.91, 2.59) \n    1.57 (0.43) \n    0.94 \n  \n  \n    Age ≥ 60 \n    0.43 \n    (0.25, 0.74) \n    0.44 (0.13) \n    0.00 \n  \n  \n    Australia/New Zealand \n    0.73 \n    (0.36, 1.62) \n    0.80 (0.33) \n    0.21 \n  \n  \n    Nepal \n    0.92 \n    (0.40, 2.44) \n    1.05 (0.54) \n    0.43 \n  \n\n\n\nPosterior summaries for model parameters.\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary()\n\n\n# A tibble: 40 × 10\n   variable       mean   median      sd     mad       q5      q95  rhat ess_bulk\n   <chr>         <dbl>    <dbl>   <dbl>   <dbl>    <dbl>    <dbl> <dbl>    <dbl>\n 1 lp__       -3.78e+2 -3.78e+2 3.29e+0 3.22e+0 -3.84e+2 -3.73e+2  1.00    8006.\n 2 beta_raw[…  2.94e-1  2.92e-1 1.90e-1 1.88e-1 -1.79e-2  6.09e-1  1.00   23243.\n 3 beta_raw[… -3.40e-1 -3.42e-1 1.11e-1 1.11e-1 -5.23e-1 -1.58e-1  1.00   15990.\n 4 beta_raw[… -3.00e-1 -3.12e-1 3.84e-1 3.84e-1 -9.12e-1  3.55e-1  1.00   20207.\n 5 beta_raw[… -6.35e-2 -8.54e-2 4.57e-1 4.47e-1 -7.87e-1  7.28e-1  1.00   21016.\n 6 p[1]        1.95e-2  1.92e-2 4.30e-3 4.25e-3  1.31e-2  2.71e-2  1.00   16213.\n 7 p[2]        6.52e-4  4.69e-4 6.23e-4 4.59e-4  4.28e-5  1.89e-3  1.00   16237.\n 8 p[3]        6.58e-4  4.65e-4 6.39e-4 4.57e-4  4.56e-5  1.94e-3  1.00   18456.\n 9 p[4]        6.49e-4  4.63e-4 6.25e-4 4.48e-4  4.29e-5  1.89e-3  1.00   14798.\n10 p[5]        6.56e-4  4.75e-4 6.24e-4 4.57e-4  4.78e-5  1.87e-3  1.00   17414.\n# … with 30 more rows, and 1 more variable: ess_tail <dbl>\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.9209 1.0093 1.0153 0.9283 0.9173 1.0053 0.9836 0.9998\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"alpha\"])\n\n\n\n\n\n\n\n\n\n\n\n\n\nDescriptive summary table\nsave_tex_table(\n  make_summary_table(acs_itt_concurc3_dat, \"latex\"), \n  file.path(\"outcomes\", \"secondary\", \"7-5-anticoagulation-concurrent-stdaspirin-summary\"))\nmake_summary_table(acs_itt_concurc3_dat)\n\n\n\n\n \n  \n    Anticoagulation\nintervention \n    Patients \n    Known \n    Deaths \n    Any ventilation \n    DAFV, Median (Q1, Q3) \n  \n \n\n  \n    Low-dose \n    299 \n    291 \n    11 (4%) \n    20 (7%) \n    28 (28, 28) \n  \n  \n    Intermediate-dose \n    298 \n    293 \n    12 (4%) \n    15 (5%) \n    28 (28, 28) \n  \n  \n    Low-dose with aspirin \n    283 \n    281 \n    10 (4%) \n    18 (6%) \n    28 (28, 28) \n  \n  \n    Overall \n    880 \n    865 \n    33 (4%) \n    53 (6%) \n    28 (28, 28) \n  \n\n\n\n\n\n\n\nFit model\nctr <- contr.orthonorm\nX <- model.matrix( \n  ~ CAssignment + agegte60 + ctry, \n  data = acs_itt_concurc3_nona_dat, \n  contrasts.arg = list(CAssignment = ctr))[, -1]\ny_raw <- ordered(acs_itt_concurc3_nona_dat$out_dafv)\ny_mod <- as.integer(y_raw)\nN <- dim(X)[1]\nK <- dim(X)[2]\nunique_y <- length(unique(y_mod))\nmdat <- list(\n  N = N, K = K, J = unique_y, X = X, y = y_mod, y_raw = y_raw,\n  p_par = 2 * rep(1 / unique_y, unique_y),\n  beta_sd = c(1, 1, 2.5, 1)\n)\nsnk <- capture.output(\n  mfit <- ordmod0$sample(\n    data = mdat,\n    seed = 135356,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    refresh = 0\n))\nmdrws <- as_draws_rvars(mfit$draws())\nnames(mdrws$beta) <- colnames(X)\nmdrws$Ccon <- as.vector(ctr(3) %**% mdrws$beta[1:2])\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\nmdrws$compare <- c(\"Intermediate vs low\" = exp(mdrws$Ctrt[1]),\n                   \"Low with aspirin vs low\" = exp(mdrws$Ctrt[2]),\n                   \"Intermediate vs low with aspirin\" = exp(mdrws$Ctrt[1] - mdrws$Ctrt[2]))\nmdrws$OR <- c(\"Intermediate\" = exp(mdrws$Ctrt[1]),\n              \"Low with aspirin\" = exp(mdrws$Ctrt[2]),\n              setNames(exp(mdrws$beta[3:4]), c(\"Age \\u2265 60\", \"Australia/New Zealand\")))\n\n\n\n\nSample distribution\npdat <- acs_itt_concurc3_nona_dat %>%\n  dplyr::count(\n    CAssignment = factor(\n      CAssignment, \n      levels = c(\"C1\", \"C2\", \"C3\"),\n      labels = c(\"Low\", \"Intermediate\", \"Low\\nwith aspirin\")),\n    dafv = ordered(out_dafv, levels = 0:28), \n    .drop = F) %>%\n  group_by(CAssignment) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup()\np <- ggplot(pdat, aes(CAssignment, p)) +\n  geom_col(aes(fill = fct_rev(dafv))) +\n  labs(x = \"Anticoagulation intervention\", y = \"Cumulative proportion\") +\n  scale_fill_viridis_d(\"Days alive and\\nfree of ventilation\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE, ncol = 3)) +\n  theme(legend.key.size = unit(0.75, \"lines\"))\np\n\n\n\n\n\nDistribution of days alive and free of ventilation by anti-coagulation intervention in subset.\n\n\n\n\nSample distribution\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(pth, \"outcome-7-5-descriptive-concurrent-stdaspirin.pdf\"), p, height = 2.5, width = 6)\n\n\n\n\nPosterior contrast\nplot_or_densities(mdrws$compare)\n\n\n\n\n\n\n\nOdds ratio summary table\nsave_tex_table(\n  odds_ratio_summary_table_rev(mdrws$OR, \"latex\"),\n  \"outcomes/secondary/7-5-primary-model-acs-itt-concurrent-stdaspirin-summary-table\")\nodds_ratio_summary_table_rev(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR > 1) \n  \n \n\n  \n    Intermediate \n    1.32 \n    (0.68, 2.61) \n    1.40 (0.50) \n    0.79 \n  \n  \n    Low with aspirin \n    1.13 \n    (0.60, 2.19) \n    1.20 (0.41) \n    0.65 \n  \n  \n    Age ≥ 60 \n    0.51 \n    (0.29, 0.89) \n    0.53 (0.16) \n    0.01 \n  \n  \n    Australia/New Zealand \n    3.15 \n    (0.90, 14.44) \n    4.28 (3.96) \n    0.96 \n  \n\n\n\nPosterior summaries for model parameters.\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary()\n\n\n# A tibble: 38 × 10\n   variable       mean   median      sd     mad       q5      q95  rhat ess_bulk\n   <chr>         <dbl>    <dbl>   <dbl>   <dbl>    <dbl>    <dbl> <dbl>    <dbl>\n 1 lp__       -3.30e+2 -3.30e+2 3.19    3.10e+0 -3.36e+2 -3.25e+2  1.00    7709.\n 2 beta_raw[… -1.05e-1 -1.03e-1 0.247   2.43e-1 -5.18e-1  3.00e-1  1.00   21184.\n 3 beta_raw[… -1.65e-1 -1.67e-1 0.235   2.36e-1 -5.53e-1  2.25e-1  1.00   23187.\n 4 beta_raw[… -2.70e-1 -2.71e-1 0.115   1.15e-1 -4.57e-1 -8.10e-2  1.00   15091.\n 5 beta_raw[…  1.18e+0  1.15e+0 0.710   7.06e-1  8.24e-2  2.42e+0  1.00   19514.\n 6 p[1]        3.19e-2  3.14e-2 0.00662 6.52e-3  2.18e-2  4.34e-2  1.00   16106.\n 7 p[2]        2.02e-3  1.72e-3 0.00139 1.19e-3  3.96e-4  4.72e-3  1.00   20516.\n 8 p[3]        1.08e-3  7.76e-4 0.00103 7.48e-4  7.35e-5  3.15e-3  1.00   17492.\n 9 p[4]        1.08e-3  7.71e-4 0.00103 7.55e-4  7.38e-5  3.10e-3  1.00   16262.\n10 p[5]        1.08e-3  7.81e-4 0.00101 7.52e-4  7.52e-5  3.10e-3  1.00   15436.\n# … with 28 more rows, and 1 more variable: ess_tail <dbl>\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.9718 0.9143 0.9957 0.9689 0.9794 0.9462 1.0284 0.9763\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"alpha\"])\n\n\n\n\n\n\n\n\n\n\n\n\n\nDescriptive summary table\nsave_tex_table(\n  make_summary_table(acs_itt_concurc4_dat, \"latex\"), \n  file.path(\"outcomes\", \"secondary\", \"7-5-anticoagulation-concurrent-therapeutic-summary\"))\nmake_summary_table(acs_itt_concurc4_dat)\n\n\n\n\n \n  \n    Anticoagulation\nintervention \n    Patients \n    Known \n    Deaths \n    Any ventilation \n    DAFV, Median (Q1, Q3) \n  \n \n\n  \n    Low-dose \n    79 \n    75 \n    3 (4%) \n    6 (8%) \n    28 (28, 28) \n  \n  \n    Intermediate-dose \n    65 \n    63 \n    1 (2%) \n    3 (5%) \n    28 (28, 28) \n  \n  \n    Therapeutic-dose \n    50 \n    50 \n    6 (12%) \n    7 (14%) \n    28 (28, 28) \n  \n  \n    Overall \n    194 \n    188 \n    10 (5%) \n    16 (8%) \n    28 (28, 28) \n  \n\n\n\n\n\n\n\nFit model\nctr <- contr.orthonorm\nX <- model.matrix( \n  ~ CAssignment + agegte60 + ctry, \n  data = acs_itt_concurc4_nona_dat, \n  contrasts.arg = list(CAssignment = ctr))[, -1]\ny_raw <- ordered(acs_itt_concurc4_nona_dat$out_dafv)\ny_mod <- as.integer(y_raw)\nN <- dim(X)[1]\nK <- dim(X)[2]\nunique_y <- length(unique(y_mod))\nmdat <- list(\n  N = N, K = K, J = unique_y, X = X, y = y_mod, y_raw = y_raw,\n  p_par = 2 * rep(1 / unique_y, unique_y),\n  beta_sd = c(1, 1, 2.5, 1, 1)\n)\n\nsnk <- capture.output(\n  mfit <- ordmod0$sample(\n    data = mdat,\n    seed = 49135,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    refresh = 0\n))\nmdrws <- as_draws_rvars(mfit$draws())\nnames(mdrws$beta) <- colnames(X)\nmdrws$Ccon <- as.vector(ctr(3) %**% mdrws$beta[1:2])\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\nmdrws$compare <- c(\"Intermediate vs low\" = exp(mdrws$Ctrt[1]),\n                   \"Therapeutic vs low\" = exp(mdrws$Ctrt[2]),\n                   \"Intermediate vs therapeutic\" = exp(mdrws$Ctrt[1] - mdrws$Ctrt[2]))\nmdrws$OR <- c(\"Intermediate\" = exp(mdrws$Ctrt[1]),\n              \"Therapeutic\" = exp(mdrws$Ctrt[2]),\n              setNames(exp(mdrws$beta[3:5]), c(\"Age \\u2265 60\", \"India\", \"Australia/New Zealand\")))\n\n\n\n\nSample distribution\npdat <- acs_itt_concurc4_nona_dat %>%\n  dplyr::count(\n    CAssignment = factor(\n      CAssignment, \n      levels = c(\"C1\", \"C2\", \"C4\"),\n      labels = c(\"Low\", \"Intermediate\", \"Therapeutic\")),\n    dafv = ordered(out_dafv, levels = 0:28), \n    .drop = F) %>%\n  group_by(CAssignment) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(cp = cumsum(p)) %>%\n  ungroup()\np <- ggplot(pdat, aes(CAssignment, p)) +\n  geom_col(aes(fill = fct_rev(dafv))) +\n  labs(x = \"Anticoagulation intervention\", y = \"Cumulative proportion\") +\n  scale_fill_viridis_d(\"Days alive and\\nfree of ventilation\", option = \"A\", direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE, ncol = 3)) +\n  theme(legend.key.size = unit(0.75, \"lines\"))\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(pth, \"outcome-7-5-descriptive-concurrent-therapeutic.pdf\"), p, height = 2.5, width = 6)\np\n\n\n\n\n\nDistribution of days alive and free of ventilation by anti-coagulation intervention in subset.\n\n\n\n\n\n\nPosterior contrasts\nplot_or_densities(mdrws$compare)\n\n\n\n\n\n\n\nOdds ratio summary table\nsave_tex_table(\n  odds_ratio_summary_table_rev(mdrws$OR, \"latex\"),\n  \"outcomes/secondary/7-5-primary-model-acs-itt-concurrent-therapeutic-summary-table\")\nodds_ratio_summary_table_rev(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR > 1) \n  \n \n\n  \n    Intermediate \n    1.46 \n    (0.44, 5.22) \n    1.81 (1.32) \n    0.73 \n  \n  \n    Therapeutic \n    0.57 \n    (0.19, 1.71) \n    0.67 (0.41) \n    0.16 \n  \n  \n    Age ≥ 60 \n    0.58 \n    (0.21, 1.61) \n    0.67 (0.37) \n    0.15 \n  \n  \n    India \n    2.63 \n    (0.67, 12.56) \n    3.64 (3.39) \n    0.91 \n  \n  \n    Australia/New Zealand \n    1.13 \n    (0.44, 3.04) \n    1.28 (0.70) \n    0.59 \n  \n\n\n\nPosterior summaries for model parameters.\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary()\n\n\n# A tibble: 24 × 10\n   variable       mean   median      sd     mad       q5      q95  rhat ess_bulk\n   <chr>         <dbl>    <dbl>   <dbl>   <dbl>    <dbl>    <dbl> <dbl>    <dbl>\n 1 lp__       -9.86e+1 -9.83e+1 2.47    2.35    -1.03e+2 -95.2     1.00    8006.\n 2 beta_raw[… -6.67e-1 -6.60e-1 0.440   0.432   -1.41e+0   0.0417  1.00   20799.\n 3 beta_raw[…  6.76e-2  6.60e-2 0.410   0.408   -6.00e-1   0.747   1.00   21069.\n 4 beta_raw[… -2.14e-1 -2.15e-1 0.205   0.205   -5.52e-1   0.122   1.00   13273.\n 5 beta_raw[…  9.97e-1  9.66e-1 0.751   0.753   -1.96e-1   2.27    1.00   22147.\n 6 beta_raw[…  1.26e-1  1.19e-1 0.494   0.489   -6.73e-1   0.946   1.00   16862.\n 7 p[1]        4.45e-2  4.13e-2 0.0193  0.0177   1.90e-2   0.0804  1.00   11411.\n 8 p[2]        5.75e-3  4.20e-3 0.00543 0.00390  4.74e-4   0.0165  1.00   18867.\n 9 p[3]        5.81e-3  4.22e-3 0.00550 0.00397  4.50e-4   0.0165  1.00   15823.\n10 p[4]        5.75e-3  4.14e-3 0.00540 0.00390  4.75e-4   0.0164  1.00   15543.\n# … with 14 more rows, and 1 more variable: ess_tail <dbl>\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 1.0069 1.0749 0.9556 0.9180 0.9832 0.9993 1.0429 0.9973\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"alpha\"])"
  },
  {
    "objectID": "analyses/7-6_shortness_of_breath.html",
    "href": "analyses/7-6_shortness_of_breath.html",
    "title": "7-6 Shortness of breath",
    "section": "",
    "text": "Load packages\nlibrary(tidyverse)\nlibrary(labelled)\nlibrary(kableExtra)\nlibrary(cmdstanr)\nlibrary(posterior)\nlibrary(bayestestR)\nlibrary(bayesplot)\nlibrary(matrixStats)\nlibrary(patchwork)\nlibrary(lubridate)\nlibrary(ggdist)\n\ntheme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank()))\nbayesplot_theme_set(theme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank())))\n\ncolor_scheme_set(\"red\")\noptions(digits = 4)\n\n\n\n\nPrepare dataset\ndevtools::load_all()\nall_dat <- read_all_no_daily()\n\n# Anticoagulation set (intention-to-treat, including missing)\nacs_itt_dat <- all_dat %>% \n  filter_acs_itt() %>%\n  transmute_model_cols_grp_aus_nz()\n\n# Anticoagulation set (intention-to-treat, excluding missing)\nacs_itt_nona_dat <- acs_itt_dat %>% \n  filter(!is.na(out_sob))  \n\n# Concurrent enrolments for C2\nacs_itt_concurc2_dat <- acs_itt_dat %>%\n  filter_concurrent_intermediate()\nacs_itt_concurc2_nona_dat <- acs_itt_concurc2_dat %>% \n  filter(!is.na(out_sob))\n\n# Concurrent enrolments for C3\nacs_itt_concurc3_dat <- acs_itt_dat %>%\n  filter_concurrent_std_aspirin()\nacs_itt_concurc3_nona_dat <- acs_itt_concurc3_dat %>% \n  filter(!is.na(out_sob))\n\n# Concurrent enrolments for C4\nacs_itt_concurc4_dat <- acs_itt_dat %>%\n  filter_concurrent_therapeutic()\nacs_itt_concurc4_nona_dat <- acs_itt_concurc4_dat %>% \n  filter(!is.na(out_sob))\n\n\n\n\nLoad the Stan models\nmodel_full <- cmdstan_model(file.path(\"stan\", \"binary\", \"logistic_site_epoch.stan\"))\nmodel_site_only <- cmdstan_model(file.path(\"stan\", \"binary\", \"logistic_site.stan\"))\nmodel_epoch_only <- cmdstan_model(file.path(\"stan\", \"binary\", \"logistic_epoch.stan\")) \nmodel_fixed_only <- cmdstan_model(file.path(\"stan\", \"binary\", \"logistic.stan\"))\n\n\n\n\nHelper functions\nmake_summary_table <- function(dat, format = \"html\") {\n  tab <- dat %>%\n    mutate(CAssignment = factor(\n      CAssignment, \n      levels = c(\"C1\", \"C2\", \"C3\", \"C4\"),\n      labels = str_replace(intervention_labels()$CAssignment[-1], \"<br>\", \" \"))) %>%\n    group_by(CAssignment) %>%\n    summarise(\n      Patients = n(),\n      Known = sprintf(\n        \"%i (%.1f)\", sum(!is.na(out_sob)), 100 * mean(!is.na(out_sob))),\n      Missing = sprintf(\n        \"%i (%.1f)\", sum(is.na(out_sob)), 100 * mean(is.na(out_sob))),\n      `Shortness of breath day 28` = sprintf(\n        \"%i (%.1f)\", sum(out_sob, na.rm = TRUE), 100 * mean(out_sob, na.rm = TRUE)),\n    ) %>%\n    bind_rows(\n      dat  %>%\n        group_by(CAssignment = \"Overall\") %>%\n        summarise(\n          Patients = n(),\n          Known = sprintf(\n            \"%i (%.1f)\", sum(!is.na(out_sob)), 100 * mean(!is.na(out_sob))),\n          Missing = sprintf(\n            \"%i (%.1f)\", sum(is.na(out_sob)), 100 * mean(is.na(out_sob))),\n          `Shortness of breath day 28` = sprintf(\n            \"%i (%.1f)\", sum(out_sob, na.rm = TRUE), 100 * mean(out_sob, na.rm = TRUE)),\n      )\n    ) %>%\n    mutate(CAssignment = fct_inorder(CAssignment)) %>%\n    gather(key, value, -CAssignment, factor_key = T) %>%\n    spread(key, value)\n  colnames(tab)[1] <- \"n (\\\\%)\"\n  if(format == \"latex\") {\n    colnames(tab) <- linebreak(colnames(tab), align = \"c\", linebreaker = \"<br>\")\n  }\n    kable(tab,\n      format = format,\n      align = \"lrrrrr\",\n      escape = FALSE,\n      booktabs = TRUE\n    ) %>%\n    kable_styling(font_size = 10, latex_options = \"HOLD_position\")  %>%\n    row_spec(nrow(tab), bold = TRUE)\n}\n\nmake_stan_data <- function(\n    dat, \n    vars = NULL, \n    outcome = NULL, \n    beta_sd = NULL, \n    ctr = contr.orthonorm) {\n\n  X <- make_X_design(dat, vars, ctr)\n  nXassign <- sum(grepl(\"rand\", colnames(X))) - 1\n  beta_sd <- c(2.5, rep(1, nXassign), beta_sd)\n\n  y <- dat[[outcome]]\n  N <- dim(X)[1]\n  K <- dim(X)[2]  \n  \n    epoch  <- dat$epoch\n  M_epoch  <- max(dat$epoch)\n    region <- dat[[\"ctry_num\"]]\n  M_region <- max(region)\n    site <- dat[[\"site_num\"]]\n  M_site <- max(site)\n  region_by_site <- region_by_site <- dat %>% \n    dplyr::count(ctry_num, site_num) %>% \n    pull(ctry_num)\n  \n  list(N = N, K = K, X = X, y = y,\n       M_region = M_region, region = region,\n       M_site = M_site, site = site,\n       M_epoch = M_epoch, epoch = epoch,\n       region_by_site = region_by_site,\n       beta_sd = beta_sd)\n}\n\nmake_stan_data_concurrent <- function(\n    dat, \n    vars = NULL, \n    outcome = NULL, \n    beta_sd = NULL, \n    ctr = contr.orthonorm) {\n  \n  X <- make_X_design(dat, vars, ctr, includeA = FALSE)\n  nXassign <- sum(grepl(\"rand\", colnames(X))) - 1\n  beta_sd <- c(2.5, rep(1, nXassign), beta_sd)\n  y <- dat[[outcome]]\n  N <- dim(X)[1]\n  K <- dim(X)[2]  \n  list(N = N, K = K, X = X, y = y, beta_sd = beta_sd)\n}"
  },
  {
    "objectID": "analyses/7-6_shortness_of_breath.html#anticoagulation",
    "href": "analyses/7-6_shortness_of_breath.html#anticoagulation",
    "title": "7-6 Shortness of breath",
    "section": "Anticoagulation",
    "text": "Anticoagulation\n\n\nAnticoagulation\nsave_tex_table(\n  make_summary_table(acs_itt_dat, \"latex\"),\n  \"outcomes/secondary/7-6-anticoagulation-summary\")\nmake_summary_table(acs_itt_dat)\n\n\n\n\n\n \n  \n    n (\\%) \n    Patients \n    Known \n    Missing \n    Shortness of breath day 28 \n  \n \n\n  \n    Low dose \n    610 \n    577 (94.6) \n    33 (5.4) \n    115 (19.9) \n  \n  \n    Intermediate dose \n    613 \n    584 (95.3) \n    29 (4.7) \n    110 (18.8) \n  \n  \n    Low dose with aspirin \n    283 \n    271 (95.8) \n    12 (4.2) \n    59 (21.8) \n  \n  \n    Therapeutic dose \n    50 \n    44 (88.0) \n    6 (12.0) \n    11 (25.0) \n  \n  \n    Overall \n    1556 \n    1476 (94.9) \n    80 (5.1) \n    295 (20.0) \n  \n\n\n\nTable 1:  Summary of outcome by anticoagulation intervention."
  },
  {
    "objectID": "analyses/7-6_shortness_of_breath.html#age",
    "href": "analyses/7-6_shortness_of_breath.html#age",
    "title": "7-6 Shortness of breath",
    "section": "Age",
    "text": "Age\n\n\nRelationship age to shortness of breath\nagedat <- acs_itt_dat %>%\n  dplyr::count(out_sob, AgeAtEntry) %>% \n  spread(out_sob, n, fill = 0) %>% \n  mutate(\n    n = `0` + `1` + `<NA>`,\n    p = `1` / (`1` + `0`))\nagemod <- glm(\n  cbind(`1`, `0`) ~ AgeAtEntry, \n  data = agedat, \n  family = binomial())\nagedat <- agedat %>%\n  mutate(\n    ypred = predict(agemod, newdata = agedat, type = \"response\")\n  )\np1 <- ggplot(agedat, aes(AgeAtEntry, n)) +\n  geom_col(colour = \"grey40\", fill = \"grey40\") +\n  geom_vline(xintercept = 60, linetype = 2) +\n  labs(y = \"Number of\\nparticipants\",\n       x = \"Age at entry\")\np2 <- ggplot(agedat, aes(AgeAtEntry, p)) +\n    geom_point() +\n    geom_vline(xintercept = 60, linetype = 2) +\n    geom_line(aes(y = ypred)) +\n    labs(y = \"Proportion\\nshortness of breath\\nday 28\", x = \"Age at entry\")\np <- p1 | p2\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-6-age.pdf\"), p, height = 2, width = 6)\np\n\n\n\n\n\nFigure 1: Relationship (logistic regression linear in age) between age at entry and shortness of breath at day 28."
  },
  {
    "objectID": "analyses/7-6_shortness_of_breath.html#country",
    "href": "analyses/7-6_shortness_of_breath.html#country",
    "title": "7-6 Shortness of breath",
    "section": "Country",
    "text": "Country\n\n\nRelationship country to outcome\ntdat <- acs_itt_dat %>%\n  dplyr::count(Country = factor(\n    country, \n    levels = c(\"IN\", \"AU\", \"NP\", \"NZ\"),\n    labels = c(\"India\", \"Australia\", \"Nepal\", \"New\\nZealand\")), out_sob) %>%\n  group_by(Country) %>%\n  spread(out_sob, n, fill = 0) %>%\n  mutate(\n    n = `1` + `0` + `<NA>`,\n    p_1 = `1` / (`1` + `0`),\n    p_miss = `<NA>` / (`1` + `0` + `<NA>`)\n  )\np1 <- ggplot(tdat, aes(Country, n)) +\n  geom_col() +\n    labs(\n      y = \"Number of\\nparticipants\", \n      x = \"Country of enrolment\")\np2 <- ggplot(tdat, aes(Country, p_1)) +\n  geom_point() +\n    labs(\n      y = \"Proportion\\nshortness of breath\\nday 28\", \n      x = \"Country of enrolment\")  +\n  ylim(0, NA)\np <- p1 | p2\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-6-country.pdf\"), p, height = 2, width = 6)\np\n\n\n\n\n\nFigure 2: Shortness of breath by country."
  },
  {
    "objectID": "analyses/7-6_shortness_of_breath.html#site",
    "href": "analyses/7-6_shortness_of_breath.html#site",
    "title": "7-6 Shortness of breath",
    "section": "Site",
    "text": "Site\n\n\nRelationship site to outcome\ntdat <- all_dat %>%\n  filter_acs_itt() %>%\n  dplyr::count(\n    Country_lab = Country,\n    Site_lab = fct_infreq(Location),\n    Country = factor(PT_CountryName, levels = c(\"India\", \"Australia\", \"Nepal\", \"New Zealand\")),\n    Site = PT_LocationName,\n    out_sob) %>%\n  group_by(Country, Site) %>%\n  spread(out_sob, n, fill = 0) %>%\n  mutate(\n    n = `1` + `0` + `<NA>`,\n    p_1 = `1` / (`1` + `0`),\n    p_miss = `<NA>` / (`1` + `0` + `<NA>`)\n  ) %>%\n  ungroup()\n\np1 <- ggplot(tdat, aes(Site_lab, n)) +\n  facet_grid( ~ Country, scales = \"free_x\", space = \"free_x\") +\n  geom_col() +\n    labs(\n      y = \"Number of\\nparticipants\", \n      x = \"\") +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        panel.border = element_rect(fill = NA))\np2 <- ggplot(tdat, aes(Site_lab, p_1)) +\n  facet_grid( ~ Country, scales = \"free_x\", space = \"free_x\") +\n  geom_point() +\n    labs(\n      y = \"Proportion\\nshortness of breath\\nday 28\", \n      x = \"Site of enrolment\") +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        panel.border = element_rect(fill = NA))\np <- p1 / p2\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-6-country-site.pdf\"), p, height = 4, width = 6.25)\np\n\n\n\n\n\nFigure 3: Shortness of breath at day 28 by site within country."
  },
  {
    "objectID": "analyses/7-6_shortness_of_breath.html#calendar-time",
    "href": "analyses/7-6_shortness_of_breath.html#calendar-time",
    "title": "7-6 Shortness of breath",
    "section": "Calendar Time",
    "text": "Calendar Time\n\n\nRelationship calendar date to outcome\ncaldat <- all_dat %>% \n  filter_acs_itt() %>%\n  dplyr::count(out_sob, yr = year(RandDate), mth = month(RandDate)) %>% \n  spread(out_sob, n, fill = 0) %>% \n  mutate(p = `1` / (`1` + `0`),\n         n = `1` + `0` + `<NA>`)\np1 <- ggplot(caldat, aes(mth, p)) +\n  facet_grid( ~ yr, drop = T, scales = \"free_x\", space = \"free\") +\n    geom_point() +\n    labs(\n      y = \"Proportion\\nshortness of breath\\nday 28\", \n      x = \"Calendar date (month of year)\") +\n  scale_x_continuous(breaks = 1:12) +\n  ylim(0, NA)\np2 <- ggplot(caldat, aes(mth, n)) +\n  facet_grid( ~ yr, drop = T, scales = \"free_x\", space = \"free\") +\n    geom_col() +\n    labs(\n      y = \"Number of\\nparticipants\", \n      x = \"Calendar date (month of year)\") +\n  scale_x_continuous(breaks = 1:12)\np <- p2 | p1\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-6-calendar-time.pdf\"), p, height = 2, width = 6)\np\n\n\n\n\n\nFigure 4: Relationship between calendar date and the primary outcome."
  },
  {
    "objectID": "analyses/7-6_shortness_of_breath.html#primary-model",
    "href": "analyses/7-6_shortness_of_breath.html#primary-model",
    "title": "7-6 Shortness of breath",
    "section": "Primary model",
    "text": "Primary model\n\n\nData and sampling\nseed <- 36127\nmdat <- make_stan_data(\n    dat = acs_itt_nona_dat, \n    vars    = c(\"inelgc3\", \"agegte60\", \"ctry\"),\n    outcome = \"out_sob\",\n    beta_sd = c(10, 2.5, 1, 1))\nsnk <- capture.output(\n  mfit <- model_full$sample(\n    data = mdat,\n    seed = seed,\n    refresh = 0,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    chains = 8,\n    parallel_chains = 8,\n    adapt_delta = 0.95\n))\nmfit$save_object(file.path(\"outputs\", \"models\", \"secondary\", \"7-6.rds\"))\nmdrws <- as_draws_rvars(mfit$draws())\nnames(mdrws$beta) <- colnames(mdat$X)\nnames(mdrws$gamma_epoch) <- acs_itt_nona_dat %>% dplyr::count(epoch, epoch_lab) %>% pull(epoch_lab)\nnames(mdrws$gamma_site) <- acs_itt_nona_dat %>% dplyr::count(site_num, site) %>% pull(site)\nsite_facet <- factor(mdat$region_by_site, labels = c(\"India\", \"Australia\\nNew Zealand\", \"Nepal\"))\n\nmdrws$Acon <- attr(mdat$X, \"contrasts\")$randA %**% mdrws$beta[grepl(\"randA[0-9]\", names(mdrws$beta))]\nmdrws$Ccon <- attr(mdat$X, \"contrasts\")$randC %**% mdrws$beta[grepl(\"randC[0-9]\", names(mdrws$beta))]\nmdrws$Atrt <- mdrws$Acon[-1] - mdrws$Acon[1]\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\nmdrws$compare <- c(\n  \"Intermediate vs low\" = exp(mdrws$Ctrt[1]),\n  \"Low with aspirin vs low\" = exp(mdrws$Ctrt[2]),\n  \"Therapeutic vs low\" = exp(mdrws$Ctrt[3]),\n  \"Intermediate vs low with aspirin\" = exp(mdrws$Ctrt[1] - mdrws$Ctrt[2]),\n  \"Intermediate vs therapeutic\" = exp(mdrws$Ctrt[1] - mdrws$Ctrt[3]),\n  \"Low with aspirin vs therapeutic\" = exp(mdrws$Ctrt[2] - mdrws$Ctrt[3])\n)\nmdrws$OR <- c(\n  setNames(exp(mdrws$Ctrt), c(\"Intermediate\", \"Low with aspirin\", \"Therapeutic\")),\n  setNames(exp(mdrws$beta[7:8]), c(\"Ineligible aspirin\", \"Age \\u2265 60\")),\n  setNames(exp(mdrws$beta[9:10]), c(\"Australia/New Zealand\", \"Nepal\"))\n)\n\n\n\n\nOdds ratio summary table\nsave_tex_table(\n  odds_ratio_summary_table(mdrws$OR, \"latex\"),\n  \"outcomes/secondary/7-6-primary-model-acs-itt-summary-table\")\nodds_ratio_summary_table(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.77 \n    (0.55, 1.09) \n    0.79 (0.14) \n    0.93 \n  \n  \n    Low with aspirin \n    1.19 \n    (0.77, 1.84) \n    1.22 (0.28) \n    0.22 \n  \n  \n    Therapeutic \n    0.93 \n    (0.35, 2.30) \n    1.02 (0.50) \n    0.57 \n  \n  \n    Ineligible aspirin \n    1.19 \n    (0.40, 3.31) \n    1.36 (0.77) \n    0.38 \n  \n  \n    Age ≥ 60 \n    2.09 \n    (1.48, 2.94) \n    2.12 (0.37) \n    0.00 \n  \n  \n    Australia/New Zealand \n    2.32 \n    (0.59, 8.49) \n    2.89 (2.20) \n    0.11 \n  \n  \n    Nepal \n    0.52 \n    (0.13, 2.52) \n    0.72 (0.71) \n    0.81 \n  \n\n\n\nPosterior summaries for model parameters (fixed-effects).\n\n\n\nOdds ratio summary for epoch and site\np <- plot_epoch_site_terms(\n  exp(mdrws$gamma_epoch),\n  exp(mdrws$gamma_site),\n  site_facet\n)\npth <- file.path(\n  \"outputs\", \"figures\", \"outcomes\", \"secondary\", \n  \"7-6-acs-itt-epoch-site-terms.pdf\")\nggsave(pth, p, width = 6, height = 4.5)\np\n\n\n\n\n\nSummary of epoch and site posterior odds ratios.\n\n\n\n\n\n\nCode\np <- plot_or_densities(mdrws$compare)\np\n\n\n\n\n\nPosterior densities for treatment comparisons.\n\n\n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary(variables = c(\"beta\", \"gamma_site\", \"gamma_epoch\"))\n\n\n# A tibble: 48 × 10\n   variable    mean  median    sd   mad      q5     q95  rhat ess_bulk ess_tail\n   <chr>      <dbl>   <dbl> <dbl> <dbl>   <dbl>   <dbl> <dbl>    <dbl>    <dbl>\n 1 beta[1]  -2.01   -2.02   0.611 0.597 -3.00   -0.996   1.00    4875.    8480.\n 2 beta[2]  -0.176  -0.170  0.362 0.356 -0.781   0.418   1.00   14046.   14904.\n 3 beta[3]   0.0482  0.0470 0.179 0.177 -0.243   0.345   1.00   14419.   15222.\n 4 beta[4]  -0.250  -0.251  0.213 0.215 -0.598   0.0984  1.00   13703.   15137.\n 5 beta[5]   0.920   0.913  0.539 0.535  0.0405  1.82    1.00   15505.   13871.\n 6 beta[6]  -0.129  -0.126  0.320 0.320 -0.659   0.389   1.00   25602.   15513.\n 7 beta[7]   0.163   0.172  0.541 0.538 -0.743   1.04    1.00   27357.   15176.\n 8 beta[8]   0.736   0.736  0.175 0.176  0.448   1.03    1.00   26772.   14401.\n 9 beta[9]   0.833   0.842  0.681 0.673 -0.313   1.93    1.00    7899.   11493.\n10 beta[10] -0.631  -0.655  0.749 0.720 -1.82    0.652   1.00   10033.   12915.\n# … with 38 more rows\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 2 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.8071 0.8333 0.7741 0.8229 0.7515 0.7539 0.7825 0.7153\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"gamma_site\"])\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"gamma_epoch\"])\n\n\n\n\n\nCode\nmcmc_trace(mdrws[c(\"tau_site\", \"tau_epoch\")])\n\n\n\n\n\n\n\n\n\nPosterior predictive\n\n\nCode\ny_ppc <- mdrws$y_ppc\nppc_dat <- bind_cols(acs_itt_nona_dat, tibble(y_ppc = y_ppc))\n\ngrp_ppc <- function(grp) {\n  ppc_dat %>%\n    group_by(grp = !!grp) %>%\n    summarise(\n      mean_y = mean(out_sob),\n      rvar_mean_y_ppc = rvar_mean(y_ppc)\n    )\n}\nplot_grp_ppc <- function(dat, lab = \"\") {\n  dat %>%\n    ggplot(aes(y = grp, xdist = rvar_mean_y_ppc)) +\n    stat_interval(size = 2) +\n    geom_point(aes(x = mean_y, y = 1:nrow(dat)), colour = \"red\", shape = 23) +\n    labs(\n      x = \"Posterior predictive\\nproportion\", \n      y = lab)  \n}\n\nppc_C <- grp_ppc(sym(\"CAssignment\"))\nppc_ctry <- grp_ppc(sym(\"country\"))\nppc_epoch <- grp_ppc(sym(\"epoch\"))\nppc_site <- ppc_dat %>%\n  group_by(Country = country, grp = site_raw) %>%\n  summarise(\n    mean_y = mean(out_sob),\n    rvar_mean_y_ppc = rvar_mean(y_ppc)\n  )\n\np1 <- plot_grp_ppc(ppc_C, \"Anticoagulation\\nintervention\") + labs(x = \"\")\np2 <- plot_grp_ppc(ppc_ctry, \"Country\") + labs(x = \"\")\np3 <- plot_grp_ppc(ppc_epoch, \"Epoch\") + labs(x = \"\")\np4 <- plot_grp_ppc(ppc_site %>% filter(Country == \"IN\"), \"Sites\\nIndia\")  + labs(x = \"\")\np5 <- plot_grp_ppc(ppc_site %>% filter(Country == \"AU\"), \"Sites\\nAustralia\") + labs(x = \"\")\np6 <- plot_grp_ppc(ppc_site %>% filter(Country == \"NP\"), \"Sites\\nNepal\")\np7 <- plot_grp_ppc(ppc_site %>% filter(Country == \"NZ\"), \"Sites\\nNZ\")\np <- ((p3 | p1 / p2) / \n        ( (p4 | p5) / (p6 | p7) + \n            plot_layout(heights = c(3, 1)) ) ) +\n  plot_layout(heights = c(1, 1.5), guides = \"collect\")\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\",\n                 \"7-6-primary-model-acs-itt-ppc.pdf\")\nggsave(pth, p, width = 6, height = 5.5)\np\n\n\n\n\n\nPosterior predictive distribution versus observed proportion (red diamond)."
  },
  {
    "objectID": "analyses/7-6_shortness_of_breath.html#sensitivity-concurrent-controls",
    "href": "analyses/7-6_shortness_of_breath.html#sensitivity-concurrent-controls",
    "title": "7-6 Shortness of breath",
    "section": "Sensitivity: Concurrent Controls",
    "text": "Sensitivity: Concurrent Controls\nA sensitivity analysis is performed on the reduced concurrent control analysis sets for each intervention.\n\nIntermediate\n\n\nOverview of outcome\nsave_tex_table(\n  make_summary_table(acs_itt_concurc2_dat, \"latex\"),\n  \"outcomes/secondary/7-6-anticoagulation-concurrent-intermediate-summary\")\nmake_summary_table(acs_itt_concurc2_dat)\n\n\n\n\n \n  \n    n (\\%) \n    Patients \n    Known \n    Missing \n    Shortness of breath day 28 \n  \n \n\n  \n    Low dose \n    610 \n    577 (94.6) \n    33 (5.4) \n    115 (19.9) \n  \n  \n    Intermediate dose \n    613 \n    584 (95.3) \n    29 (4.7) \n    110 (18.8) \n  \n  \n    Overall \n    1223 \n    1161 (94.9) \n    62 (5.1) \n    225 (19.4) \n  \n\n\n\nSummary of outcome for intermediate dose concurrent enrolments.\n\n\n\nFit model\nmdat <- make_stan_data_concurrent(\n  acs_itt_concurc2_nona_dat,\n  c(\"agegte60\", \"ctry\"),\n  \"out_sob\",\n  c(2.5, 1, 1)\n)\nsnk <- capture.output(\n  mfit <- model_fixed_only$sample(\n    data = mdat,\n    seed = 38135,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    refresh = 0\n))\nmdrws <- as_draws_rvars(mfit$draws(c(\"beta\")))\nnames(mdrws$beta) <- colnames(mdat$X)\nmdrws$Ccon <- attr(mdat$X, \"contrasts\")$randC %**% mdrws$beta[2]\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\nmdrws$compare <- c(\"Intermediate vs low\" = exp(mdrws$Ctrt[1]))\nmdrws$OR <- c(\n  setNames(exp(mdrws$Ctrt), c(\"Intermediate\")),\n  setNames(exp(mdrws$beta[-(1:2)]), c(\"Age \\u2265 60\", \"Australia/New Zealand\", \"Nepal\"))\n)\n\n\n\n\nOdds ratio summary\nsave_tex_table(\n  odds_ratio_summary_table(mdrws$OR, \"latex\"),\n  \"outcomes/secondary/7-6-primary-model-acs-itt-concurrent-intermediate-summary-table\")\nodds_ratio_summary_table(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.91 \n    (0.67, 1.23) \n    0.92 (0.14) \n    0.74 \n  \n  \n    Age ≥ 60 \n    1.64 \n    (1.19, 2.24) \n    1.66 (0.27) \n    0.00 \n  \n  \n    Australia/New Zealand \n    3.91 \n    (2.62, 5.82) \n    4.00 (0.82) \n    0.00 \n  \n  \n    Nepal \n    0.47 \n    (0.22, 0.92) \n    0.50 (0.18) \n    0.99 \n  \n\n\n\nOdds ratio summary table for model.\n\n\n\nPosterior contrast\np <- plot_or_densities(mdrws$compare)\np\n\n\n\n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary()\n\n\n# A tibble: 11 × 10\n   variable         mean   median     sd    mad       q5      q95  rhat ess_bulk\n   <chr>           <dbl>    <dbl>  <dbl>  <dbl>    <dbl>    <dbl> <dbl>    <dbl>\n 1 lp__        -550.     -5.49e+2 1.57   1.38   -5.53e+2 -548.     1.00    9385.\n 2 beta_raw[1]   -0.689  -6.88e-1 0.0401 0.0403 -7.55e-1   -0.623  1.00   17830.\n 3 beta_raw[2]   -0.0687 -6.95e-2 0.107  0.107  -2.44e-1    0.107  1.00   23339.\n 4 beta_raw[3]    0.198   1.99e-1 0.0645 0.0648  9.05e-2    0.303  1.00   19354.\n 5 beta_raw[4]    1.37    1.36e+0 0.203  0.199   1.03e+0    1.70   1.00   21689.\n 6 beta_raw[5]   -0.758  -7.46e-1 0.364  0.359  -1.38e+0   -0.182  1.00   25118.\n 7 beta[1]       -1.72   -1.72e+0 0.100  0.101  -1.89e+0   -1.56   1.00   17830.\n 8 beta[2]       -0.0687 -6.95e-2 0.107  0.107  -2.44e-1    0.107  1.00   23339.\n 9 beta[3]        0.495   4.96e-1 0.161  0.162   2.26e-1    0.756  1.00   19354.\n10 beta[4]        1.37    1.36e+0 0.203  0.199   1.03e+0    1.70   1.00   21689.\n11 beta[5]       -0.758  -7.46e-1 0.364  0.359  -1.38e+0   -0.182  1.00   25118.\n# … with 1 more variable: ess_tail <dbl>\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 1.049 1.023 1.036 1.120 1.035 1.026 1.071 1.012\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])\n\n\n\n\n\n\n\n\n\n\nLow-dose with aspirin\n\n\nOverview of outcome\nsave_tex_table(\n  make_summary_table(acs_itt_concurc3_dat, \"latex\"),\n  \"outcomes/secondary/7-6-anticoagulation-concurrent-stdaspirin-summary\")\nmake_summary_table(acs_itt_concurc3_dat)\n\n\n\n\n \n  \n    n (\\%) \n    Patients \n    Known \n    Missing \n    Shortness of breath day 28 \n  \n \n\n  \n    Low dose \n    299 \n    280 (93.6) \n    19 (6.4) \n    55 (19.6) \n  \n  \n    Intermediate dose \n    298 \n    280 (94.0) \n    18 (6.0) \n    52 (18.6) \n  \n  \n    Low dose with aspirin \n    283 \n    271 (95.8) \n    12 (4.2) \n    59 (21.8) \n  \n  \n    Overall \n    880 \n    831 (94.4) \n    49 (5.6) \n    166 (20.0) \n  \n\n\n\nSummary of outcome for low-dose with aspirin concurrent enrolments.\n\n\n\nFit model\nmdat <- make_stan_data_concurrent(\n  acs_itt_concurc3_nona_dat,\n  c(\"agegte60\", \"ctry\"),\n  \"out_sob\",\n  c(2.5, 1)\n)\nsnk <- capture.output(\n  mfit <- model_fixed_only$sample(\n    data = mdat,\n    seed = 13578,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    refresh = 0\n))\nmdrws <- as_draws_rvars(mfit$draws(c(\"beta\")))\nnames(mdrws$beta) <- colnames(mdat$X)\nmdrws$Ccon <- attr(mdat$X, \"contrasts\")$randC %**% mdrws$beta[2:3]\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\nmdrws$compare <- c(\"Intermediate vs low\" = exp(mdrws$Ctrt[1]),\n                   \"Low with aspirin vs low\" = exp(mdrws$Ctrt[2]),\n                   \"Intermediate vs low with aspirin\" = exp(mdrws$Ctrt[1] - mdrws$Ctrt[2]))\nmdrws$OR <- c(\n  setNames(exp(mdrws$Ctrt), c(\"Intermediate\", \"Low with aspirin\")),\n  setNames(exp(mdrws$beta[-(1:3)]), c(\"Age \\u2265 60\", \"Australia/New Zealand\"))\n)\n\n\n\n\nOdds ratio summary\nsave_tex_table(\n  odds_ratio_summary_table(mdrws$OR, \"latex\"),\n  \"outcomes/secondary/7-6-primary-model-acs-itt-concurrent-stdaspirin-summary-table\")\nodds_ratio_summary_table(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.96 \n    (0.64, 1.46) \n    0.99 (0.21) \n    0.57 \n  \n  \n    Low with aspirin \n    1.17 \n    (0.78, 1.77) \n    1.20 (0.26) \n    0.22 \n  \n  \n    Age ≥ 60 \n    1.54 \n    (1.05, 2.23) \n    1.56 (0.30) \n    0.01 \n  \n  \n    Australia/New Zealand \n    2.17 \n    (1.17, 3.91) \n    2.26 (0.70) \n    0.01 \n  \n\n\n\nOdds ratio summary table for model.\n\n\n\nPosterior contrast\np <- plot_or_densities(mdrws$compare)\np\n\n\n\n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary()\n\n\n# A tibble: 11 × 10\n   variable         mean   median     sd    mad       q5      q95  rhat ess_bulk\n   <chr>           <dbl>    <dbl>  <dbl>  <dbl>    <dbl>    <dbl> <dbl>    <dbl>\n 1 lp__        -417.     -4.17e+2 1.58   1.42   -4.20e+2 -415.     1.00    9210.\n 2 beta_raw[1]   -0.631  -6.30e-1 0.0447 0.0450 -7.05e-1   -0.558  1.00   16753.\n 3 beta_raw[2]    0.140   1.42e-1 0.150  0.151  -1.08e-1    0.386  1.00   22687.\n 4 beta_raw[3]   -0.0510 -4.97e-2 0.150  0.152  -2.99e-1    0.195  1.00   21260.\n 5 beta_raw[4]    0.170   1.71e-1 0.0770 0.0764  4.16e-2    0.296  1.00   18995.\n 6 beta_raw[5]    0.768   7.74e-1 0.307  0.303   2.55e-1    1.27   1.00   19666.\n 7 beta[1]       -1.58   -1.57e+0 0.112  0.112  -1.76e+0   -1.39   1.00   16753.\n 8 beta[2]        0.140   1.42e-1 0.150  0.151  -1.08e-1    0.386  1.00   22687.\n 9 beta[3]       -0.0510 -4.97e-2 0.150  0.152  -2.99e-1    0.195  1.00   21260.\n10 beta[4]        0.426   4.29e-1 0.193  0.191   1.04e-1    0.740  1.00   18995.\n11 beta[5]        0.768   7.74e-1 0.307  0.303   2.55e-1    1.27   1.00   19666.\n# … with 1 more variable: ess_tail <dbl>\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 1.127 1.112 1.099 1.106 1.162 1.131 1.058 1.078\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])\n\n\n\n\n\n\n\n\n\n\nTherapeutic\n\n\nOverview of outcome\nsave_tex_table(\n  make_summary_table(acs_itt_concurc4_dat, \"latex\"),\n  \"outcomes/secondary/7-6-anticoagulation-concurrent-therapeutic-summary\")\nmake_summary_table(acs_itt_concurc4_dat)\n\n\n\n\n \n  \n    n (\\%) \n    Patients \n    Known \n    Missing \n    Shortness of breath day 28 \n  \n \n\n  \n    Low dose \n    79 \n    72 (91.1) \n    7 (8.9) \n    18 (25.0) \n  \n  \n    Intermediate dose \n    65 \n    61 (93.8) \n    4 (6.2) \n    13 (21.3) \n  \n  \n    Therapeutic dose \n    50 \n    44 (88.0) \n    6 (12.0) \n    11 (25.0) \n  \n  \n    Overall \n    194 \n    177 (91.2) \n    17 (8.8) \n    42 (23.7) \n  \n\n\n\nSummary of outcome for therapeutic dose concurrent enrolments.\n\n\n\nFit model\nmdat <- make_stan_data_concurrent(\n  acs_itt_concurc4_nona_dat,\n  c(\"agegte60\", \"ctry\"),\n  \"out_sob\",\n  c(2.5, 1, 1)\n)\nsnk <- capture.output(\n  mfit <- model_fixed_only$sample(\n    data = mdat,\n    seed = 13578,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    refresh = 0\n))\nmdrws <- as_draws_rvars(mfit$draws(c(\"beta\")))\nnames(mdrws$beta) <- colnames(mdat$X)\nmdrws$Ccon <- attr(mdat$X, \"contrasts\")$randC %**% mdrws$beta[2:3]\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\nmdrws$compare <- c(\"Intermediate vs low\" = exp(mdrws$Ctrt[1]),\n                   \"Therapeutic vs low\" = exp(mdrws$Ctrt[2]),\n                   \"Intermediate vs therapeutic\" = exp(mdrws$Ctrt[1] - mdrws$Ctrt[2]))\nmdrws$OR <- c(\n  setNames(exp(mdrws$Ctrt), c(\"Intermediate\", \"Therapeutic\")),\n  setNames(exp(mdrws$beta[-(1:3)]), c(\"Age \\u2265 60\", \"India\", \"Australia/New Zealand\"))\n)\n\n\n\n\nOdds ratio summary\nsave_tex_table(\n  odds_ratio_summary_table(mdrws$OR, \"latex\"),\n  \"outcomes/secondary/7-6-primary-model-acs-itt-concurrent-therapeutic-summary-table\")\nodds_ratio_summary_table(mdrws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.46 \n    (0.18, 1.13) \n    0.51 (0.25) \n    0.95 \n  \n  \n    Therapeutic \n    0.66 \n    (0.25, 1.68) \n    0.74 (0.38) \n    0.80 \n  \n  \n    Age ≥ 60 \n    1.89 \n    (0.84, 4.34) \n    2.07 (0.93) \n    0.06 \n  \n  \n    India \n    1.25 \n    (0.36, 4.03) \n    1.49 (0.96) \n    0.36 \n  \n  \n    Australia/New Zealand \n    12.28 \n    (5.66, 28.30) \n    13.51 (5.93) \n    0.00 \n  \n\n\n\nOdds ratio summary table for model.\n\n\n\nPosterior contrast\np <- plot_or_densities(mdrws$compare)\np\n\n\n\n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nmfit$summary()\n\n\n# A tibble: 13 × 10\n   variable    mean  median    sd   mad       q5     q95  rhat ess_bulk ess_tail\n   <chr>      <dbl>   <dbl> <dbl> <dbl>    <dbl>   <dbl> <dbl>    <dbl>    <dbl>\n 1 lp__     -83.2   -82.9   1.76  1.60  -86.6    -81.0    1.00    9745.   12606.\n 2 beta_ra…  -1.03   -1.03  0.149 0.148  -1.29    -0.797  1.00   10110.   11479.\n 3 beta_ra…   0.256   0.259 0.355 0.358  -0.333    0.838  1.00   19380.   14705.\n 4 beta_ra…   0.490   0.488 0.332 0.327  -0.0542   1.05   1.00   17811.   14955.\n 5 beta_ra…   0.256   0.255 0.168 0.169  -0.0197   0.533  1.00   13647.   12806.\n 6 beta_ra…   0.214   0.225 0.615 0.616  -0.809    1.21   1.00   16860.   14995.\n 7 beta_ra…   2.52    2.51  0.409 0.408   1.86     3.20   1.00   12324.   12874.\n 8 beta[1]   -2.58   -2.57  0.373 0.371  -3.22    -1.99   1.00   10110.   11479.\n 9 beta[2]    0.256   0.259 0.355 0.358  -0.333    0.838  1.00   19380.   14705.\n10 beta[3]    0.490   0.488 0.332 0.327  -0.0542   1.05   1.00   17811.   14955.\n11 beta[4]    0.640   0.638 0.420 0.422  -0.0493   1.33   1.00   13647.   12806.\n12 beta[5]    0.214   0.225 0.615 0.616  -0.809    1.21   1.00   16860.   14995.\n13 beta[6]    2.52    2.51  0.409 0.408   1.86     3.20   1.00   12324.   12874.\n\n\nCode\nmfit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 1.026 1.017 1.050 1.108 1.078 1.017 1.064 1.034\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(mdrws[\"beta\"])"
  },
  {
    "objectID": "analyses/7-7_breathlessness_scale.html",
    "href": "analyses/7-7_breathlessness_scale.html",
    "title": "7-7 mMRC Breathlessness scale",
    "section": "",
    "text": "Load packages\nlibrary(tidyverse)\nlibrary(labelled)\nlibrary(kableExtra)\nlibrary(cmdstanr)\nlibrary(posterior)\nlibrary(bayestestR)\nlibrary(bayesplot)\nlibrary(matrixStats)\nlibrary(ggdist)\nlibrary(patchwork)\nlibrary(lubridate)\n\ntheme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank()))\nbayesplot_theme_set(theme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank())))\n\n\n\n\nPrepare dataset\ndevtools::load_all()\nall_dat <- read_all_no_daily()\n\nbreath_labels <-c(\"Only breathless with strenuous exercise\",\n                  \"Short of breath when hurrying on level ground or walking up a slight hill\",\n                  \"Walks slower than most people of the same age because of breathlessness on level\",\n                  \"Stops for breath after walking about 100 metres or after a few minutes on level ground\",\n                  \"Too breathless to leave the house, or breathless when dressing or undressing\")\n\nbreath_labels_short <-c(\"Only breathless with strenuous exercise\",\n                     \"Short of breath up a slight hill\",\n                     \"Walks slower than most people of the same age\",\n                     \"Stops for breath after walking about 100 metres\",\n                     \"Too breathless to leave the house\")\n\nacs_itt_dat <- all_dat %>% \n  filter_acs_itt() %>%\n  transmute_model_cols_grp_aus_nz() %>%\n  mutate(\n    out_mmrc_lab = fct_explicit_na(\n      factor(out_mmrc_scale, \n             levels = c(1:5, 0),\n             labels = c(breath_labels_short, \"Not asked\"))))\nacs_itt_nona_dat <- all_dat %>% \n  filter_acs_itt()  %>%\n  filter(!is.na(out_mmrc_scale), out_mmrc_scale != 0) %>%\n  transmute_model_cols_grp_aus_nz() %>%\n  mutate(out_mmrc_lab = fct_explicit_na(\n  factor(out_mmrc_scale, \n         levels = c(1:5, 0),\n         labels = c(breath_labels_short, \"Not asked\"))))\nacs_itt_nona2_dat <- all_dat %>% \n  filter_acs_itt()  %>%\n  filter(!is.na(out_mmrc_scale)) %>%\n  transmute_model_cols_grp_aus_nz() %>%\n  mutate(out_mmrc_lab = fct_explicit_na(\n  factor(out_mmrc_scale, \n         levels = c(1:5, 0),\n         labels = c(breath_labels_short, \"Not asked\")))) %>%\n  mutate(out_mmrc_scale = out_mmrc_scale + 1)\n\n# Concurrent enrolments for C2\nacs_itt_concurc2_dat <- acs_itt_dat %>%\n  filter_concurrent_intermediate()\nacs_itt_concurc2_nona_dat <- acs_itt_concurc2_dat %>% \n  filter(!is.na(out_mmrc_scale), out_mmrc_scale != 0)\n\n# Concurrent enrolments for C3\nacs_itt_concurc3_dat <- acs_itt_dat %>%\n  filter_concurrent_std_aspirin()\nacs_itt_concurc3_nona_dat <- acs_itt_concurc3_dat %>% \n  filter(!is.na(out_mmrc_scale), out_mmrc_scale != 0)\n\n# Concurrent enrolments for C4\nacs_itt_concurc4_dat <- acs_itt_dat %>%\n  filter_concurrent_therapeutic()\nacs_itt_concurc4_nona_dat <- acs_itt_concurc4_dat %>% \n  filter(!is.na(out_mmrc_scale), out_mmrc_scale != 0)\n\n\n\n\nCompiles stan models.\nseed <- 59579\nmodel_tx           <- cmdstan_model(file.path(\"stan\", \"ordinal\", \"logistic_cumulative.stan\"))\nmodel_site         <- cmdstan_model(file.path(\"stan\", \"ordinal\", \"logistic_cumulative_site.stan\"))\nmodel_region_epoch <- cmdstan_model(file.path(\"stan\", \"ordinal\", \"logistic_cumulative_epoch.stan\"))\nmodel_site_epoch   <- cmdstan_model(file.path(\"stan\", \"ordinal\", \"logistic_cumulative_epoch_site.stan\"))\n\n\n\n\nHelper functions\n# Makes stan data for ordinal outcome.\nmake_stan_data <- function(dat, vars, outcome, beta_sd_var, ctr = contr.orthonorm, p_mult = 2) {\n  \n  X <- make_X_design(dat, vars, ctr)\n  attX <- attr(X, \"contrasts\")\n  X <- X[, -1]\n  attr(X, \"contrasts\") <- attX\n  nXtrt <- sum(grepl(\"rand\", colnames(X)))\n  beta_sd <- c(rep(1, nXtrt), beta_sd_var)\n  \n  y <- as.integer(dat[[outcome]])\n  N <- dim(X)[1]\n  K <- dim(X)[2]  \n  J <- max(y)\n  \n  epoch <- dat[[\"epoch\"]]\n  M_epoch <- max(dat[[\"epoch\"]])\n  region <- as.integer(dat[[\"ctry\"]])\n  M_region <- max(region)\n  site <- dat[[\"site_num\"]]\n  M_site <- length(levels(dat[[\"site\"]]))\n  region_by_site <- dat %>% \n    dplyr::count(ctry_num, site_num) %>% \n    pull(ctry_num)\n  \n  list(\n    N = N, K = K, X = X, y = y, J = J, p_par = rep(p_mult, J),\n    M_region = M_region, region = region,\n    M_site = M_site, site = site,\n    M_epoch = M_epoch, epoch = epoch, \n    region_by_site = region_by_site,\n    beta_sd = beta_sd)\n}\n\n# Wrapper to run stan\nrun_stan <- function(model, data, ...) {\n  model[[\"sample\"]](data = data,\n                    seed = seed,\n                    refresh = 0,\n                    iter_sampling = 2500,\n                    chains = 8,\n                    parallel_chains = min(8, parallel::detectCores()),\n                    ...\n  )\n}\n\n\nThe mMRC Breathlessness Scale was only asked of participants who reported that they had been “experiencing shortness of breath that is worse than or new since before they got COVID” (D28_BreathSinceGettingCovid == Yes). Therefore, the outcome as analysed is conditional on a patient having worse breathlessness than before.\nGiven that a patient who is not experiencing worse shortness of breath, may have still been experiencing some shortness of breath before they got COVID, it does not make sense to assign these participants to a score of 0 on the scale.\nThis means that most of the data is missing, as only about ~ 20% of participants responded “Yes” to experiencing worse shortness of breath. One option is to augment the scale and threat it as a measure of “worsening” of shortness of breath, where a “No” to D28_BreathSinceGettingCovid is taken as a score of -1, and for a “Yes”, the score is taken as that reported for D28_BreathScale."
  },
  {
    "objectID": "analyses/7-7_breathlessness_scale.html#descriptive",
    "href": "analyses/7-7_breathlessness_scale.html#descriptive",
    "title": "7-7 mMRC Breathlessness scale",
    "section": "Descriptive",
    "text": "Descriptive\n\n\nSummarise the ordinal component\ndescriptive_table <- acs_itt_dat %>% \n  dplyr::count(CAssignment, out_mmrc_lab) %>%\n  spread(CAssignment, n, fill = 0) %>%\n  mutate(\n    Overall = C1 + C2 + C3 + C4,\n    across(C1:Overall, ~ sprintf(\"%i (%.0f)\", .x, 100 * .x / sum(.x)))\n  ) %>%\n  rename(\n    Low = C1,\n    Intermediate = C2,\n    `Low\\nwith aspirin` = C3,\n    Therapeutic = C4\n  )\n\ntab <- kable(\n  descriptive_table,\n  format = \"latex\",\n  booktabs = TRUE,\n  escape = F,\n  col.names = linebreak(c(\"mMRC breathlessness scale (day 28)\", names(descriptive_table)[-1]), align = \"c\"),\n  caption = \"Secondary endpoint breakdown - mMRC breathlessness scale (day 28).\",\n  align = \"lrrrrr\") %>%\n  kable_styling(font_size = 9, latex_options = \"HOLD_position\")\nsave_tex_table(tab, \"outcomes/secondary/7-7_mmrc_scale_descriptive\")\n\nkable(\n  descriptive_table,\n  col.names = c(\"mMRC breathlessness scale (day 28)\", names(descriptive_table)[-1]),\n  caption = \"Secondary endpoint breakdown - mMRC breathlessness scale (day 28).\",\n  align = \"lrrrrr\") %>%\n  kable_styling(font_size = 11) %>%\n  collapse_rows(1, valign = \"top\", latex_hline = 'custom', custom_latex_hline = 1)\n\n\n\n\n\n \n  \n    mMRC breathlessness scale (day 28) \n    Low \n    Intermediate \n    Low\nwith aspirin \n    Therapeutic \n    Overall \n  \n \n\n  \n    Only breathless with strenuous exercise \n    40 (7) \n    50 (8) \n    26 (9) \n    2 (4) \n    118 (8) \n  \n  \n    Short of breath up a slight hill \n    47 (8) \n    39 (6) \n    16 (6) \n    4 (8) \n    106 (7) \n  \n  \n    Walks slower than most people of the same age \n    12 (2) \n    11 (2) \n    15 (5) \n    3 (6) \n    41 (3) \n  \n  \n    Stops for breath after walking about 100 metres \n    14 (2) \n    8 (1) \n    1 (0) \n    2 (4) \n    25 (2) \n  \n  \n    Too breathless to leave the house \n    2 (0) \n    2 (0) \n    1 (0) \n    0 (0) \n    5 (0) \n  \n  \n    Not asked \n    462 (76) \n    474 (77) \n    212 (75) \n    33 (66) \n    1181 (76) \n  \n  \n    (Missing) \n    33 (5) \n    29 (5) \n    12 (4) \n    6 (12) \n    80 (5) \n  \n\n\n\nSecondary endpoint breakdown - mMRC breathlessness scale (day 28).\n\n\n\nGraph the sample cumulative logits\nacs_itt_nona_dat %>% \n  group_by(CAssignment, out_mmrc_lab) %>%\n  summarise(n = n()) %>%\n  mutate(p = n/sum(n)) %>%\n  select(-n) %>%\n  spread(CAssignment, p, fill = 0) %>%\n  mutate(across(C1:C4, ~ logit(cumsum(.x )))) %>%\n  mutate(across(C2:C4, ~ .x/C1),\n         across(C2:C4, ~ ifelse(.x == Inf, NA, .x))) %>% \n  select(-C1) %>%\n  mutate(across(C2:C4, ~ .x/(mean(.x, na.rm = TRUE)))) %>%\n  gather(\"id\", \"value\", 2:4) %>%\n  rename(Treatment = id, `Cumulative odds ratio` = value) %>%\n  ggplot(., aes(reorder(out_mmrc_lab, desc(out_mmrc_lab)), `Cumulative odds ratio`, group = Treatment, col=Treatment)) + \n  geom_line() + geom_point() +  \n  coord_flip() + \n  xlab(\"\") + ylab(\"Mean centred cumulative odds ratio\") + \n  labs(caption = \"Note: cumulative odds for highest category do not exist.\") +\n  theme(plot.caption = element_text(hjust = 0))"
  },
  {
    "objectID": "analyses/7-7_breathlessness_scale.html#analyses",
    "href": "analyses/7-7_breathlessness_scale.html#analyses",
    "title": "7-7 mMRC Breathlessness scale",
    "section": "Analyses",
    "text": "Analyses\n\nPrimary Model\n\n\nCode\nfit_primary_model <- function(dat, ctr = contr.orthonorm) {\n  \n  mdat <- make_stan_data(\n    dat = dat,\n    vars = c(\"inelgc3\", \"agegte60\", \"ctry\"),\n    outcome = \"out_mmrc_scale\",\n    beta_sd_var = c(10, 2.5, 1, 1),\n    ctr = ctr)\n  mfit <- run_stan(model_site_epoch, mdat, adapt_delta = 0.99)\n  mdrws <- as_draws_rvars(\n    mfit$draws(c(\"alpha\", \"beta\", \"gamma_site\", \"gamma_epoch\", \n                 \"tau_site\", \"tau_epoch\", \"y_ppc\")))\n  \n  # Add names\n  epoch_map <- dat %>% dplyr::count(epoch, epoch_lab)\n  site_map <- dat %>% dplyr::count(site_num, site)\n  names(mdrws$beta) <- colnames(mdat$X)\n  names(mdrws$gamma_epoch) <- epoch_map$epoch_lab\n  names(mdrws$gamma_site) <- site_map$site\n  # Convert to treatment log odds ratios\n  mdrws$Acon <- attr(mdat$X, \"contrasts\")$randA %**% \n    mdrws$beta[grepl(\"randA[0-9]\", names(mdrws$beta))]\n  mdrws$Ccon <- attr(mdat$X, \"contrasts\")$randC %**% \n    mdrws$beta[grepl(\"randC[0-9]\", names(mdrws$beta))]\n  mdrws$trtA <- mdrws$Acon[-1] - mdrws$Acon[1]\n  mdrws$trtC <- mdrws$Ccon[-1] - mdrws$Ccon[1]\n    mdrws$compare <- c(\n    \"Intermediate vs low\" = exp(mdrws$trtC[1]),\n    \"Low with aspirin vs low\" = exp(mdrws$trtC[2]),\n    \"Therapeutic vs low\" = exp(mdrws$trtC[3]),\n    \"Intermediate vs low with aspirin\" = exp(mdrws$trtC[1] - mdrws$trtC[2]),\n    \"Intermediate vs therapeutic\" = exp(mdrws$trtC[1] - mdrws$trtC[3]),\n    \"Low with aspirin vs therapeutic\" = exp(mdrws$trtC[2] - mdrws$trtC[3])\n  )\n  mdrws$OR <- c(\n    setNames(exp(mdrws$trtC), c(\"Intermediate\", \"Low with aspirin\", \"Therapeutic\")),\n    \"Ineligible aspirin\" = exp(mdrws$beta[which(grepl(\"inelg\", colnames(mdat$X)))]),\n    \"Age \\u2265 60\" = exp(mdrws$beta[which(grepl(\"age\", colnames(mdat$X)))]),\n    setNames(exp(mdrws$beta[which(grepl(\"ctry\", colnames(mdat$X)))]), c(\"Australia/New Zealand\", \"Nepal\"))\n  )\n  return(list(dat = mdat, fit = mfit, drws = mdrws))\n}\nres <- fit_primary_model(acs_itt_nona_dat)\n\n\nRunning MCMC with 8 chains, at most 4 in parallel...\n\nChain 3 finished in 31.7 seconds.\nChain 4 finished in 36.9 seconds.\nChain 2 finished in 37.5 seconds.\nChain 1 finished in 55.4 seconds.\nChain 5 finished in 37.0 seconds.\nChain 6 finished in 34.2 seconds.\nChain 7 finished in 36.5 seconds.\nChain 8 finished in 26.3 seconds.\n\nAll 8 chains finished successfully.\nMean chain execution time: 36.9 seconds.\nTotal execution time: 81.9 seconds.\n\n\n\n\nOdds ratio summary table\nsave_tex_table(\n  odds_ratio_summary_table(res$drws$OR, \"latex\"),\n  \"outcomes/secondary/7-7-primary-model-acs-itt-summary-table\")\nodds_ratio_summary_table(res$drws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.71 \n    (0.42, 1.19) \n    0.73 (0.20) \n    0.91 \n  \n  \n    Low with aspirin \n    1.09 \n    (0.57, 2.11) \n    1.16 (0.40) \n    0.40 \n  \n  \n    Therapeutic \n    0.73 \n    (0.24, 2.25) \n    0.86 (0.54) \n    0.71 \n  \n  \n    Ineligible aspirin \n    1.02 \n    (0.24, 4.02) \n    1.30 (1.06) \n    0.49 \n  \n  \n    Age ≥ 60 \n    1.47 \n    (0.92, 2.39) \n    1.52 (0.38) \n    0.05 \n  \n  \n    Australia/New Zealand \n    2.65 \n    (0.72, 9.65) \n    3.30 (2.44) \n    0.07 \n  \n  \n    Nepal \n    1.36 \n    (0.31, 5.39) \n    1.73 (1.39) \n    0.33 \n  \n\n\n\nPosterior summaries for model parameters (fixed-effects).\n\n\n\nOdds ratio summary for epoch and site\np <- plot_epoch_site_terms(\n  exp(res$drws$gamma_epoch),\n  exp(res$drws$gamma_site),\n  factor(res$dat$region_by_site, \n         labels = c(\"India\", \"Australia\\nNew Zealand\", \"Nepal\"))\n)\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\", \"7-7-primary-model-epoch-site-terms.pdf\")\nggsave(pth, p, width = 6, height = 4.5)\np\n\n\n\n\n\nSummary of epoch and site posterior odds ratios.\n\n\n\n\n\n\nPosterior contrasts\nplot_or_densities(res$drws$compare)\n\n\n\n\n\nSummaries on comparisons.\n\n\n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nres$fit$summary(\n  c(\"alpha\", \"beta\", \"gamma_epoch\", \"gamma_site\", \"tau_epoch\", \"tau_site\")) %>%\n  print(n = Inf)\n\n\n# A tibble: 49 × 10\n   variable    mean   median    sd   mad      q5     q95  rhat ess_bulk ess_tail\n   <chr>      <dbl>    <dbl> <dbl> <dbl>   <dbl>   <dbl> <dbl>    <dbl>    <dbl>\n 1 alpha[1] -1.22   -1.20    0.545 0.546 -2.15   -0.364   1.00    5886.   10130.\n 2 alpha[2]  0.684   0.702   0.518 0.516 -0.192   1.51    1.00    6215.    9621.\n 3 alpha[3]  1.89    1.90    0.524 0.524  1.00    2.72    1.00    6534.    9351.\n 4 alpha[4]  3.78    3.78    0.630 0.626  2.75    4.82    1.00    8907.   10770.\n 5 beta[1]  -0.277  -0.274   0.450 0.449 -1.01    0.463   1.00   20000.   16228.\n 6 beta[2]   0.165   0.168   0.240 0.238 -0.233   0.559   1.00   19871.   16514.\n 7 beta[3]  -0.201  -0.200   0.283 0.279 -0.671   0.262   1.00   19261.   16214.\n 8 beta[4]  -0.0243 -0.0217  0.591 0.593 -0.997   0.940   1.00   17148.   15573.\n 9 beta[5]  -0.230  -0.232   0.352 0.346 -0.803   0.352   1.00   30619.   14840.\n10 beta[6]   0.0115  0.0186  0.715 0.712 -1.18    1.18    1.00   27768.   14554.\n11 beta[7]   0.389   0.387   0.245 0.247 -0.0106  0.790   1.00   25196.   15800.\n12 beta[8]   0.974   0.976   0.662 0.659 -0.112   2.06    1.00   10977.   13902.\n13 beta[9]   0.290   0.309   0.728 0.716 -0.921   1.46    1.00   16183.   15573.\n14 gamma_e…  0       0       0     0      0       0      NA         NA       NA \n15 gamma_e… -0.464  -0.390   0.458 0.447 -1.31    0.123   1.00    9834.   15473.\n16 gamma_e… -0.281  -0.246   0.399 0.371 -0.980   0.325   1.00   21588.   17766.\n17 gamma_e… -0.281  -0.257   0.383 0.373 -0.936   0.310   1.00   24347.   18918.\n18 gamma_e… -0.485  -0.462   0.395 0.404 -1.17    0.106   1.00   14804.   17567.\n19 gamma_e… -0.483  -0.467   0.402 0.412 -1.17    0.129   1.00   17112.   17749.\n20 gamma_e… -0.759  -0.751   0.494 0.516 -1.60    0.0128  1.00    9162.   11513.\n21 gamma_e… -0.461  -0.434   0.495 0.500 -1.31    0.296   1.00   16814.   17627.\n22 gamma_e…  0.216   0.162   0.541 0.510 -0.594   1.18    1.00   13969.   17636.\n23 gamma_e… -0.153  -0.134   0.559 0.518 -1.09    0.767   1.00   22398.   17128.\n24 gamma_e…  0.0324  0.0185  0.607 0.555 -0.953   1.04    1.00   23053.   17252.\n25 gamma_e…  0.604   0.529   0.763 0.764 -0.502   1.97    1.00   11801.   17257.\n26 gamma_s…  0.310   0.304   0.862 0.787 -1.10    1.72    1.00   25415.   15464.\n27 gamma_s… -1.06   -0.925   1.04  0.992 -2.95    0.380   1.00   11432.   15154.\n28 gamma_s… -0.749  -0.690   0.602 0.607 -1.83    0.122   1.00    6934.   12443.\n29 gamma_s… -1.36   -1.33    0.575 0.575 -2.36   -0.480   1.00    5777.    8271.\n30 gamma_s… -1.24   -1.14    0.966 0.951 -3.00    0.122   1.00    7798.   12175.\n31 gamma_s… -0.350  -0.269   0.659 0.628 -1.53    0.601   1.00    7595.   12725.\n32 gamma_s…  0.794   0.788   0.731 0.714 -0.365   2.00    1.00   22565.   16235.\n33 gamma_s… -0.704  -0.655   0.621 0.617 -1.80    0.225   1.00    7548.   11961.\n34 gamma_s… -1.31   -1.24    0.762 0.755 -2.69   -0.191   1.00    6093.    8733.\n35 gamma_s…  0.264   0.164   0.567 0.432 -0.522   1.32    1.00   21786.   16875.\n36 gamma_s…  0.316   0.205   0.561 0.434 -0.431   1.36    1.00   18856.   17331.\n37 gamma_s…  0.0162  0.00804 0.443 0.351 -0.718   0.759   1.00   27900.   18058.\n38 gamma_s… -0.680  -0.608   0.570 0.613 -1.72    0.0546  1.00    9809.   14781.\n39 gamma_s…  0.232   0.137   0.557 0.419 -0.554   1.27    1.00   22608.   15459.\n40 gamma_s…  0.0372  0.0123  0.529 0.407 -0.817   0.943   1.00   30749.   17226.\n41 gamma_s… -0.144  -0.0852  0.493 0.387 -1.02    0.607   1.00   25319.   17713.\n42 gamma_s…  0.146   0.0885  0.463 0.365 -0.554   0.979   1.00   25679.   17529.\n43 gamma_s…  0.283   0.194   0.511 0.410 -0.418   1.23    1.00   19122.   17463.\n44 gamma_s… -0.248  -0.115   0.752 0.501 -1.63    0.836   1.00   22973.   15803.\n45 gamma_s…  0.419   0.239   0.726 0.518 -0.498   1.83    1.00   16239.   15813.\n46 tau_epo…  0.541   0.511   0.303 0.295  0.0985  1.09    1.00    4655.    4910.\n47 tau_sit…  1.19    1.10    0.549 0.489  0.470   2.20    1.00    4650.    6914.\n48 tau_sit…  0.584   0.543   0.358 0.341  0.0781  1.23    1.00    6853.    7623.\n49 tau_sit…  0.830   0.667   0.715 0.583  0.0600  2.14    1.00   13159.    9737.\n\n\nCode\nres$fit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.7070099 0.6354631 0.6956543 0.6526245 0.6458634 0.7212142 0.6525408\n[8] 0.6727358\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"alpha\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"gamma_site\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"gamma_epoch\"])\n\n\n\n\n\n\n\n\n\nPosterior Predictive\n\n\nCode\ny_ppc <- res$drws$y_ppc\nppc_dat <- bind_cols(acs_itt_nona_dat, tibble(y_ppc = y_ppc)) %>%\n  mutate(CAssignment = factor(\n    CAssignment, \n    levels = names(intervention_labels_short_break()$CAssignment),\n    labels = intervention_labels_short_break()$CAssignment))\n\n\nplot_grp_ppc <- function(dat, lab = \"\", xlab = \"Probability\") {\n  ggplot(dat %>% \n           filter(response == \"ypp\", event == \"eq\"), \n         aes(y = out)) +\n    facet_wrap( ~ grp, nrow = 1, scales = \"free_x\") +\n    stat_pointinterval(aes(xdist = posterior), fatten_point = 1)  +\n    geom_point(data = dat %>% filter(response == \"y\", event == \"eq\"), \n               aes(y = out, x = mean(posterior)),\n               colour = \"red\",\n               shape = 23) +\n    scale_x_continuous(\n      xlab, breaks = c(0, 0.3, 0.6),\n      sec.axis = sec_axis(\n        ~ . , name = lab, breaks = NULL, labels = NULL)) +\n    scale_y_continuous(\"mMRC scale\") +\n    theme(strip.text = element_text(size = rel(0.7)),\n          axis.title.x = element_text(size = rel(0.7)),\n          axis.text.x = element_text(size = rel(0.65)),\n          axis.title.y = element_text(size = rel(0.75)),\n          axis.title.x.bottom = element_blank())\n}\n\npp_C <- ordinal_grp_ppc(out_mmrc_scale, CAssignment, 1:5)\npp_ctry <- ordinal_grp_ppc(out_mmrc_scale, country, 1:5)\npp_epoch <- ordinal_grp_ppc(out_mmrc_scale, epoch, 1:5)\npp_site <- ordinal_grp_ppc(out_mmrc_scale, site, 1:5) %>%\n  left_join(ppc_dat %>% dplyr::count(site, country), \n            by = c(\"grp\" = \"site\"))\n\np1 <- plot_grp_ppc(pp_C, \"Anticoagulation\", \"\")\np2 <- plot_grp_ppc(pp_ctry, \"Country\", \"\") \np3 <- plot_grp_ppc(pp_epoch, \"Epoch\", \"\")\np4 <- plot_grp_ppc(\n  pp_site %>% filter(country == \"IN\"), \"Sites India\", \"\")\np5 <- plot_grp_ppc(\n  pp_site %>% filter(country == \"AU\"), \"Sites Australia\", \"\")\np6 <- plot_grp_ppc(\n  pp_site %>% filter(country == \"NP\"), \"Sites Nepal\", \"\")\np7 <- plot_grp_ppc(\n  pp_site %>% filter(country == \"NP\"), \"Sites New Zealand\", \"\")\n\np <- (p1 | p2) / p3 / p4 / p5 / (p6 | p7)\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\",\n                 \"7-7-primary-model-acs-itt-ppc.pdf\")\nggsave(pth, p, width = 6, height = 5.75)\np\n\n\n\n\n\n\n\n\nSensitivity: Treatment Coding\n\n\nCode\nres <- fit_primary_model(acs_itt_nona_dat, contr.treatment)\n\n\nRunning MCMC with 8 chains, at most 4 in parallel...\n\nChain 1 finished in 30.9 seconds.\nChain 2 finished in 35.1 seconds.\nChain 3 finished in 35.4 seconds.\nChain 4 finished in 36.7 seconds.\nChain 8 finished in 28.0 seconds.\nChain 5 finished in 35.6 seconds.\nChain 7 finished in 43.8 seconds.\nChain 6 finished in 48.0 seconds.\n\nAll 8 chains finished successfully.\nMean chain execution time: 36.7 seconds.\nTotal execution time: 83.3 seconds.\n\n\n\n\nCode\nodds_ratio_summary_table(res$drws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.67 \n    (0.40, 1.09) \n    0.69 (0.18) \n    0.95 \n  \n  \n    Low with aspirin \n    1.01 \n    (0.53, 1.94) \n    1.07 (0.37) \n    0.48 \n  \n  \n    Therapeutic \n    0.60 \n    (0.21, 1.77) \n    0.70 (0.42) \n    0.82 \n  \n  \n    Ineligible aspirin \n    0.99 \n    (0.24, 3.97) \n    1.27 (1.03) \n    0.51 \n  \n  \n    Age ≥ 60 \n    1.51 \n    (0.94, 2.45) \n    1.55 (0.38) \n    0.05 \n  \n  \n    Australia/New Zealand \n    2.86 \n    (0.78, 10.40) \n    3.54 (2.60) \n    0.06 \n  \n  \n    Nepal \n    1.38 \n    (0.31, 5.39) \n    1.76 (1.42) \n    0.33 \n  \n\n\n\n\n\n\n\nSensitivity: Reduced Models\n\n\nFull design model plus site\ndat_full <- make_stan_data(\n  dat = acs_itt_nona_dat,\n  vars    = c(\"inelgc3\", \"agegte60\", \"ctry\"),\n  outcome = \"out_mmrc_scale\",\n  beta_sd = c(10, 2.5, 1, 1))\nstan_region <- run_stan(model_site, dat_full)\n\n\nRunning MCMC with 8 chains, at most 4 in parallel...\n\nChain 1 finished in 10.3 seconds.\nChain 3 finished in 10.2 seconds.\nChain 2 finished in 10.5 seconds.\nChain 4 finished in 10.3 seconds.\nChain 5 finished in 9.8 seconds.\nChain 6 finished in 9.9 seconds.\nChain 7 finished in 9.9 seconds.\nChain 8 finished in 10.2 seconds.\n\nAll 8 chains finished successfully.\nMean chain execution time: 10.1 seconds.\nTotal execution time: 21.2 seconds.\n\n\nFull design model plus site\nstan_region$cmdstan_diagnose()\n\n\nProcessing csv files: /tmp/RtmpzZ6cBH/logistic_cumulative_site-202207111652-1-16c0f5.csv, /tmp/RtmpzZ6cBH/logistic_cumulative_site-202207111652-2-16c0f5.csv, /tmp/RtmpzZ6cBH/logistic_cumulative_site-202207111652-3-16c0f5.csv, /tmp/RtmpzZ6cBH/logistic_cumulative_site-202207111652-4-16c0f5.csv, /tmp/RtmpzZ6cBH/logistic_cumulative_site-202207111652-5-16c0f5.csv, /tmp/RtmpzZ6cBH/logistic_cumulative_site-202207111652-6-16c0f5.csv, /tmp/RtmpzZ6cBH/logistic_cumulative_site-202207111652-7-16c0f5.csv, /tmp/RtmpzZ6cBH/logistic_cumulative_site-202207111652-8-16c0f5.csv\n\nChecking sampler transitions treedepth.\nTreedepth satisfactory for all transitions.\n\nChecking sampler transitions for divergences.\nNo divergent transitions found.\n\nChecking E-BFMI - sampler transitions HMC potential energy.\nE-BFMI satisfactory.\n\nEffective sample size satisfactory.\n\nSplit R-hat values satisfactory all parameters.\n\nProcessing complete, no problems detected.\n\n\nFull design model plus site\nstan_region$summary(variables = c(\"p0\", \"alpha\", \"beta\"))\n\n\n# A tibble: 18 × 10\n   variable    mean  median     sd    mad       q5     q95  rhat ess_bulk\n   <chr>      <dbl>   <dbl>  <dbl>  <dbl>    <dbl>   <dbl> <dbl>    <dbl>\n 1 p0[1]     0.284   0.280  0.0941 0.100   0.137    0.445   1.00    5046.\n 2 p0[2]     0.412   0.414  0.0403 0.0386  0.344    0.474   1.00   14470.\n 3 p0[3]     0.181   0.176  0.0528 0.0550  0.104    0.277   1.00    5714.\n 4 p0[4]     0.101   0.0916 0.0445 0.0385  0.0465   0.185   1.00    5919.\n 5 p0[5]     0.0227  0.0191 0.0145 0.0107  0.00731  0.0499  1.00    8196.\n 6 alpha[1] -0.979  -0.947  0.497  0.501  -1.84    -0.219   1.00    5046.\n 7 alpha[2]  0.867   0.897  0.479  0.485   0.0380   1.60    1.00    5107.\n 8 alpha[3]  2.05    2.07   0.485  0.488   1.21     2.80    1.00    5682.\n 9 alpha[4]  3.93    3.94   0.600  0.598   2.95     4.91    1.00    8196.\n10 beta[1]  -0.105  -0.105  0.431  0.435  -0.820    0.600   1.00   20515.\n11 beta[2]   0.186   0.184  0.239  0.241  -0.204    0.581   1.00   20139.\n12 beta[3]  -0.184  -0.183  0.279  0.279  -0.642    0.275   1.00   20183.\n13 beta[4]  -0.0266 -0.0202 0.585  0.573  -1.00     0.932   1.00   17537.\n14 beta[5]  -0.211  -0.212  0.351  0.348  -0.782    0.370   1.00   33946.\n15 beta[6]   0.0938  0.102  0.687  0.679  -1.05     1.21    1.00   32214.\n16 beta[7]   0.430   0.431  0.240  0.237   0.0343   0.824   1.00   30574.\n17 beta[8]   0.793   0.799  0.646  0.645  -0.267    1.85    1.00    9995.\n18 beta[9]   0.259   0.268  0.731  0.727  -0.952    1.43    1.00   15576.\n# … with 1 more variable: ess_tail <dbl>\n\n\n\n\nExpanded Outcome\n\n\nCode\nres <- fit_primary_model(acs_itt_nona2_dat)\n\n\nRunning MCMC with 8 chains, at most 4 in parallel...\n\nChain 4 finished in 136.8 seconds.\nChain 2 finished in 141.5 seconds.\nChain 3 finished in 147.4 seconds.\nChain 1 finished in 162.6 seconds.\nChain 5 finished in 145.9 seconds.\nChain 8 finished in 121.3 seconds.\nChain 7 finished in 141.7 seconds.\nChain 6 finished in 189.7 seconds.\n\nAll 8 chains finished successfully.\nMean chain execution time: 148.4 seconds.\nTotal execution time: 331.5 seconds.\n\n\n\n\nCode\nodds_ratio_summary_table(res$drws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.74 \n    (0.53, 1.02) \n    0.75 (0.13) \n    0.97 \n  \n  \n    Low with aspirin \n    1.15 \n    (0.76, 1.73) \n    1.18 (0.25) \n    0.25 \n  \n  \n    Therapeutic \n    0.92 \n    (0.39, 2.11) \n    1.00 (0.45) \n    0.58 \n  \n  \n    Ineligible aspirin \n    1.21 \n    (0.45, 2.99) \n    1.34 (0.67) \n    0.35 \n  \n  \n    Age ≥ 60 \n    1.93 \n    (1.41, 2.64) \n    1.95 (0.31) \n    0.00 \n  \n  \n    Australia/New Zealand \n    0.67 \n    (0.18, 2.55) \n    0.85 (0.65) \n    0.72 \n  \n  \n    Nepal \n    0.29 \n    (0.05, 2.43) \n    0.52 (0.75) \n    0.87 \n  \n\n\n\n\n\n\n\nCode\nplot_or_densities(res$drws$compare)\n\n\n\n\n\n\n\nCode\nres <- fit_primary_model(acs_itt_nona2_dat, contr.treatment)\n\n\nRunning MCMC with 8 chains, at most 4 in parallel...\n\nChain 2 finished in 150.4 seconds.\nChain 4 finished in 151.8 seconds.\nChain 3 finished in 167.9 seconds.\nChain 1 finished in 175.7 seconds.\nChain 5 finished in 127.6 seconds.\nChain 8 finished in 125.1 seconds.\nChain 7 finished in 139.1 seconds.\nChain 6 finished in 159.4 seconds.\n\nAll 8 chains finished successfully.\nMean chain execution time: 149.6 seconds.\nTotal execution time: 311.8 seconds.\n\n\n\n\nCode\nodds_ratio_summary_table(res$drws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.70 \n    (0.50, 0.96) \n    0.71 (0.12) \n    0.99 \n  \n  \n    Low with aspirin \n    1.08 \n    (0.72, 1.61) \n    1.11 (0.23) \n    0.35 \n  \n  \n    Therapeutic \n    0.76 \n    (0.32, 1.72) \n    0.82 (0.36) \n    0.75 \n  \n  \n    Ineligible aspirin \n    1.19 \n    (0.44, 2.97) \n    1.32 (0.66) \n    0.36 \n  \n  \n    Age ≥ 60 \n    1.94 \n    (1.42, 2.66) \n    1.97 (0.31) \n    0.00 \n  \n  \n    Australia/New Zealand \n    0.73 \n    (0.19, 2.68) \n    0.91 (0.68) \n    0.68 \n  \n  \n    Nepal \n    0.29 \n    (0.05, 2.35) \n    0.52 (0.79) \n    0.88 \n  \n\n\n\n\n\n\n\nCode\nplot_or_densities(res$drws$compare)"
  },
  {
    "objectID": "analyses/7-8_eq_5d_5l.html",
    "href": "analyses/7-8_eq_5d_5l.html",
    "title": "7-8 EQ-5D-5L",
    "section": "",
    "text": "Load packages\nlibrary(tidyverse)\nlibrary(labelled)\nlibrary(kableExtra)\nlibrary(cmdstanr)\nlibrary(posterior)\nlibrary(bayestestR)\nlibrary(bayesplot)\nlibrary(matrixStats)\nlibrary(ggdist)\nlibrary(patchwork)\nlibrary(lubridate)\nlibrary(eq5d)\n\ntheme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank()))\nbayesplot_theme_set(theme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank())))\n\n\n\n\nPrepare dataset\ndevtools::load_all()\nall_dat <- read_all_no_daily()\n\nacs_itt_dat <- all_dat %>% \n  filter_acs_itt() %>%\n  transmute_model_cols_grp_aus_nz() %>%\n  left_join(\n    all_dat %>% select(StudyPatientID, starts_with(\"D28_EQ\")),\n    by = \"StudyPatientID\")"
  },
  {
    "objectID": "analyses/7-8_eq_5d_5l.html#descriptive",
    "href": "analyses/7-8_eq_5d_5l.html#descriptive",
    "title": "7-8 EQ-5D-5L",
    "section": "Descriptive",
    "text": "Descriptive\n\n\nDerive states\neq5d <- acs_itt_dat %>% select(CAssignment, starts_with(\"D28_EQ\"), D28_death) %>%\n  mutate(state = paste0(D28_EQMobility, \n                           D28_EQPersonalCare,\n                           D28_EQUsualActivities,\n                           D28_EQPainDiscomfort,\n                           D28_EQAnxietyDepression))\n\n# Table the states against day 28 death.\n# Looks like 00000 are dead at day 28 (or NA, i.e. lost to followup)\n# Looks like NANANANANA are genuinely missing (all alive), keep but seperate out of tables. \nwith(eq5d, table(D28_death, state, useNA = \"always\"))\n\n\n         state\nD28_death 00000 11111 11112 11113 11121 11122 11131 11132 11133 11141 11211\n     0        0   733    35     1   111    15     4     2     2     1    29\n     1       50     0     0     0     0     0     0     0     0     0     0\n     <NA>    26     0     0     0     0     0     0     0     0     0     0\n         state\nD28_death 11212 11213 11214 11221 11222 11231 11232 11311 11312 11322 12111\n     0       23     2     1    60    12     2     1     2     1     1     7\n     1        0     0     0     0     0     0     0     0     0     0     0\n     <NA>     0     0     0     0     0     0     0     0     0     0     0\n         state\nD28_death 12112 12121 12122 12131 12211 12221 12222 12223 12232 12324 21111\n     0        3    10     1     1     3     6     2     1     1     1    41\n     1        0     0     0     0     0     0     0     0     0     0     0\n     <NA>     0     0     0     0     0     0     0     0     0     0     0\n         state\nD28_death 21112 21114 21121 21122 21131 21211 21212 21213 21221 21222 21223\n     0        4     1    41     5     7    27     4     1    26     5     2\n     1        0     0     0     0     0     0     0     0     0     0     0\n     <NA>     0     0     0     0     0     0     0     0     0     0     0\n         state\nD28_death 21224 21231 21232 21241 21321 21323 21332 21334 22111 22112 22121\n     0        1     8     2     1     3     1     1     1     5     1     4\n     1        0     0     0     0     0     0     0     0     0     0     0\n     <NA>     0     0     0     0     0     0     0     0     0     0     0\n         state\nD28_death 22122 22131 22132 22211 22212 22214 22221 22222 22223 22231 22232\n     0        2     1     2    51     2     1    18    19     3     3    12\n     1        0     0     0     0     0     0     0     0     0     0     0\n     <NA>     0     0     0     0     0     0     0     0     0     0     0\n         state\nD28_death 22321 22322 22331 22332 22333 23222 23224 23232 23243 23311 23332\n     0        6     1     2     2     1     2     1     2     1     1     1\n     1        0     0     0     0     0     0     0     0     0     0     0\n     <NA>     0     0     0     0     0     0     0     0     0     0     0\n         state\nD28_death 23344 23442 31112 31221 31222 31231 31312 31313 31332 31333 31432\n     0        1     1     1     2     2     1     2     1     3     1     1\n     1        0     0     0     0     0     0     0     0     0     0     0\n     <NA>     0     0     0     0     0     0     0     0     0     0     0\n         state\nD28_death 32111 32211 32212 32221 32222 32223 32231 32232 32233 32234 32311\n     0        1     3     1     2     5     1     1     1     2     1     1\n     1        0     0     0     0     0     0     0     0     0     0     0\n     <NA>     0     0     0     0     0     0     0     0     0     0     0\n         state\nD28_death 32312 32313 32323 32332 32333 32344 33221 33312 33314 33321 33322\n     0        1     1     1     4     2     1     1     1     1     1     2\n     1        0     0     0     0     0     0     0     0     0     0     0\n     <NA>     0     0     0     0     0     0     0     0     0     0     0\n         state\nD28_death 33323 33344 33443 33543 34432 35411 41112 41211 42321 42331 43243\n     0        1     1     1     1     1     1     1     1     1     1     1\n     1        0     0     0     0     0     0     0     0     0     0     0\n     <NA>     0     0     0     0     0     0     0     0     0     0     0\n         state\nD28_death 43322 43342 43532 44331 44443 44444 45333 45514 45543 54554 55533\n     0        1     1     1     1     1     1     1     1     1     1     1\n     1        0     0     0     0     0     0     0     0     0     0     0\n     <NA>     0     0     0     0     0     0     0     0     0     0     0\n         state\nD28_death 55555 NANANANANA <NA>\n     0        2          5    0\n     1        0          0    0\n     <NA>     0          0    0\n\n\nDerive states\neq5d <- eq5d %>%  \n  filter(state != \"00000\") %>%\n  mutate(state = ifelse(state == \"NANANANANA\", NA, state))\n\n\n\n\nDerive counts\nmissing <- eq5d %>% \n     group_by(CAssignment) %>% \n     summarise(missing_state = paste0(sum(is.na(state)), \" (\", round(sum(is.na(state))/n()*100, 2), \"%)\")) \n\ncounts <- with(eq5d, table(state, CAssignment))\nnms    <- colnames(counts)\ncounts <- lapply(colnames(counts), function(x) counts[,x])\nnames(counts) <- nms \n\ncounts <- lapply(counts, function(x) x[order(-x, names(x))])\ncounts <- lapply(counts, function(x) x[x>0])\ncounts <- lapply(counts, function(x) cbind(names(x),\n                                           x,\n                                           round(x/sum(x)*100,1), \n                                           cumsum(x), \n                                           round(cumsum(x/sum(x))*100,1))[c(1:10,length(x)),])\ncounts  <- lapply(counts, function(x) rbind(x[1:10,], c(\"...\", \"\", \"\", \"\", \"\"), x[11,]))\ncounts <- do.call(rbind, counts) %>% as_tibble() \n\nmake_table <- function(format = \"html\", fn = NULL)\n{\nout <- counts %>% kable(format = format, digits = 2, booktabs = TRUE, linesep = \"\", align = \"lrrrrr\", longtable = TRUE,\n                        col.names = c(\"Health state\", \"n\", \"%\", \"n\", \"%\"),\n                        caption = \"Prevelance of 10 most frequent, and worst, reported EQ-5D-5L profiles by treatment (day 28).\") %>%\n  kable_styling(latex_options = \"HOLD_position\", font_size = 12) %>%\n  group_rows(paste0(\"Standard, missing = \",   missing[[\"missing_state\"]][missing[[\"CAssignment\"]] == \"C1\"]), 1, 12) %>%\n  group_rows(paste0(\"Intermediate, missing = \",   missing[[\"missing_state\"]][missing[[\"CAssignment\"]] == \"C2\"]), 13, 24) %>%\n  group_rows(paste0(\"Standard plus aspirin, missing = \",   missing[[\"missing_state\"]][missing[[\"CAssignment\"]] == \"C3\"]), 25, 36) %>%\n  group_rows(paste0(\"Therapeutic, missing = \",   missing[[\"missing_state\"]][missing[[\"CAssignment\"]] == \"C4\"]), 37, 48) %>%\n  add_header_above(c(\" \" = 1, \"Frequency\" = 2, \"Cumulative frequency\" = 2))\n\nout <- counts %>% \n  kable(\n    format = format, \n    digits = 2, \n    booktabs = TRUE, \n    linesep = \"\", \n    align = \"lrrrrr\", \n    longtable = TRUE,\n    col.names = c(\"Health state\", \"n\", \"%\", \"n\", \"%\"),\n    caption = \"Prevelance of 10 most frequent, and worst, reported EQ-5D-5L profiles by treatment (day 28).\") %>%\n  kable_styling(latex_options = \"HOLD_position\", font_size = 9) %>%\n  group_rows(\"Standard\", 1, 12) %>%\n  group_rows(\"Intermediate\", 13, 24) %>%\n  group_rows(\"Standard plus aspirin\", 25, 36) %>%\n  group_rows(\"Therapeutic\", 37, 48) %>%\n  add_header_above(c(\" \" = 1, \"Frequency\" = 2, \"Cumulative\" = 2))\n  if (!is.null(fn) & format == \"latex\") {\n      out\n      save_tex_table(out, fn)\n  } else {\n      return(out)\n  }\n}\nmake_table()  %>% \n  kable_styling()\n\n\n\n\n\n \n\n\nFrequency\nCumulative\n\n  \n    Health state \n    n \n    % \n    n \n    % \n  \n \n\n  Standard\n\n    11111 \n    279 \n    48.4 \n    279 \n    48.4 \n  \n  \n    11121 \n    36 \n    6.2 \n    315 \n    54.7 \n  \n  \n    11221 \n    22 \n    3.8 \n    337 \n    58.5 \n  \n  \n    22211 \n    18 \n    3.1 \n    355 \n    61.6 \n  \n  \n    11112 \n    17 \n    3 \n    372 \n    64.6 \n  \n  \n    21111 \n    16 \n    2.8 \n    388 \n    67.4 \n  \n  \n    11211 \n    15 \n    2.6 \n    403 \n    70 \n  \n  \n    21121 \n    15 \n    2.6 \n    418 \n    72.6 \n  \n  \n    21221 \n    14 \n    2.4 \n    432 \n    75 \n  \n  \n    21211 \n    13 \n    2.3 \n    445 \n    77.3 \n  \n  \n    ... \n     \n     \n     \n     \n  \n  \n    55533 \n    1 \n    0.2 \n    576 \n    100 \n  \n  Intermediate\n\n    11111 \n    304 \n    52.1 \n    304 \n    52.1 \n  \n  \n    11121 \n    47 \n    8 \n    351 \n    60.1 \n  \n  \n    11221 \n    24 \n    4.1 \n    375 \n    64.2 \n  \n  \n    22211 \n    20 \n    3.4 \n    395 \n    67.6 \n  \n  \n    21121 \n    17 \n    2.9 \n    412 \n    70.5 \n  \n  \n    21111 \n    11 \n    1.9 \n    423 \n    72.4 \n  \n  \n    21211 \n    11 \n    1.9 \n    434 \n    74.3 \n  \n  \n    11112 \n    9 \n    1.5 \n    443 \n    75.9 \n  \n  \n    11211 \n    9 \n    1.5 \n    452 \n    77.4 \n  \n  \n    11212 \n    9 \n    1.5 \n    461 \n    78.9 \n  \n  \n    ... \n     \n     \n     \n     \n  \n  \n    55555 \n    1 \n    0.2 \n    584 \n    100 \n  \n  Standard plus aspirin\n\n    11111 \n    126 \n    46.5 \n    126 \n    46.5 \n  \n  \n    11121 \n    27 \n    10 \n    153 \n    56.5 \n  \n  \n    11221 \n    13 \n    4.8 \n    166 \n    61.3 \n  \n  \n    21111 \n    11 \n    4.1 \n    177 \n    65.3 \n  \n  \n    22211 \n    11 \n    4.1 \n    188 \n    69.4 \n  \n  \n    21121 \n    9 \n    3.3 \n    197 \n    72.7 \n  \n  \n    11112 \n    8 \n    3 \n    205 \n    75.6 \n  \n  \n    22221 \n    5 \n    1.8 \n    210 \n    77.5 \n  \n  \n    11211 \n    4 \n    1.5 \n    214 \n    79 \n  \n  \n    21221 \n    4 \n    1.5 \n    218 \n    80.4 \n  \n  \n    ... \n     \n     \n     \n     \n  \n  \n    55555 \n    1 \n    0.4 \n    271 \n    100 \n  \n  Therapeutic\n\n    11111 \n    24 \n    54.5 \n    24 \n    54.5 \n  \n  \n    21111 \n    3 \n    6.8 \n    27 \n    61.4 \n  \n  \n    22211 \n    2 \n    4.5 \n    29 \n    65.9 \n  \n  \n    22232 \n    2 \n    4.5 \n    31 \n    70.5 \n  \n  \n    11112 \n    1 \n    2.3 \n    32 \n    72.7 \n  \n  \n    11121 \n    1 \n    2.3 \n    33 \n    75 \n  \n  \n    11211 \n    1 \n    2.3 \n    34 \n    77.3 \n  \n  \n    11213 \n    1 \n    2.3 \n    35 \n    79.5 \n  \n  \n    11221 \n    1 \n    2.3 \n    36 \n    81.8 \n  \n  \n    21213 \n    1 \n    2.3 \n    37 \n    84.1 \n  \n  \n    ... \n     \n     \n     \n     \n  \n  \n    32223 \n    1 \n    2.3 \n    44 \n    100 \n  \n\n\n\nPrevelance of 10 most frequent, and worst, reported EQ-5D-5L profiles by treatment (day 28).\n\nDerive counts\nmake_table(format = \"latex\", fn = \"outcomes/secondary/7-8_eq5d5l_counts\")"
  },
  {
    "objectID": "analyses/8-0_anticoagulation_specific_secondary.html",
    "href": "analyses/8-0_anticoagulation_specific_secondary.html",
    "title": "8-0 Domain-specific secondary outcomes",
    "section": "",
    "text": "Load packages\nlibrary(tidyverse)\nlibrary(labelled)\nlibrary(kableExtra)\nlibrary(cmdstanr)\nlibrary(posterior)\nlibrary(bayestestR)\nlibrary(bayesplot)\nlibrary(matrixStats)\nlibrary(plotly)\nlibrary(lubridate)\nlibrary(ggdist)\nlibrary(patchwork)\n\ntheme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank()))\nbayesplot_theme_set(theme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank())))\n\ncolor_scheme_set(\"red\")\noptions(digits = 4)\n\n\n\n\nCode\nlogistic_mod <- cmdstan_model(\"stan/logistic_bernoulli.stan\")\nprimary_mod2 <- cmdstan_model(\"stan/primary_logistic_model_site_epoch2.stan\")\nprimary_mod3 <- cmdstan_model(\"stan/primary_logistic_model_site_epoch3.stan\")\n\n\n\n\nPrepare dataset\ndevtools::load_all()\nall_dat <- read_all_no_daily()\nall_dat_daily <- read_all_daily()\n\ndaily_events <- all_dat_daily %>%\n  filter_acs_itt() %>%\n  group_by(StudyPatientID) %>%\n  summarise(\n    dd_mb = as.numeric(any(DD_AE_C_MajorBleedingISTH == \"Yes\")),\n    dd_hit = as.numeric(any(DD_AE_C_HeparinHIT == \"Yes\"))\n  )\n\nacs_itt_dat <- all_dat %>% \n  filter_acs_itt() %>%\n  left_join(daily_events, by = \"StudyPatientID\") %>%\n  mutate(\n    # 8.0 death\n    out_dth = D28_death,\n    # 8.2 deep vein thrombosis\n    out_dvt = case_when(\n      D28_ABEventNone == \"Yes\" ~ 0,\n      D28_ABEventUnknown == \"Yes\" ~ NA_real_,\n      D28_ABDeepVein == \"Yes\" ~ 1,\n      TRUE ~ 0\n    ),\n    # 8.3 - pulmonary embolism\n    out_pe = case_when(\n      D28_ABEventNone == \"Yes\" ~ 0,\n      D28_ABEventUnknown == \"Yes\" ~ NA_real_,\n      D28_ABPulmonaryEmbolism == \"Yes\" ~ 1,\n      TRUE ~ 0\n    ),\n    # 8.4 - acute myocardial infarction\n    out_ami = case_when(\n      D28_ABEventNone == \"Yes\" ~ 0,\n      D28_ABEventUnknown == \"Yes\" ~ NA_real_,\n      D28_ABAcuteMyocardinalInfarction == \"Yes\" ~ 1,\n      TRUE ~ 0\n    ),\n    # 8.5 - ischemic cerebrovascular event\n    out_ice = case_when(\n      D28_ABEventNone == \"Yes\" ~ 0,\n      D28_ABEventUnknown == \"Yes\" ~ NA_real_,\n      D28_ABIschemicCerebrovascularEvent == \"Yes\" ~ 1,\n      TRUE ~ 0\n    ),\n    # 8.10 - other confirmed thrombotic event\n    out_ote = case_when(\n      D28_ABEventNone == \"Yes\" ~ 0,\n      D28_ABEventUnknown == \"Yes\" ~ NA_real_,\n      D28_ABOtherThromboEvent == \"Yes\" ~ 1,\n      TRUE ~ 0\n    ),\n    # Any thrombotic event\n    out_ate = case_when(\n      out_dvt == 1 | out_pe == 1 | out_ami == 1  | out_ice == 1 | out_ote == 1 ~ 1,\n      is.na(out_dvt) | is.na(out_pe) | is.na(out_ami) | is.na(out_ice) | is.na(out_ote) ~ NA_real_,\n      out_dvt == 0 & out_pe == 0 & out_ami == 0  & out_ice == 0 & out_ote == 0 ~ 0\n    ),\n    # 8.1 - any thrombotic event or death\n    out_ated = case_when(\n      out_dth == 1 | out_dvt == 1 | out_pe == 1 | out_ami == 1  | out_ice == 1 | out_ote == 1 ~ 1,\n      is.na(out_dth) | is.na(out_dvt) | is.na(out_pe) | is.na(out_ami) | is.na(out_ice) | is.na(out_ote) ~ NA_real_,\n      out_dth == 0 & out_dvt == 0 & out_pe == 0 & out_ami == 0  & out_ice == 0 & out_ote == 0 ~ 0\n    ),\n    # 8.7 - major bleeding\n    out_mb = case_when(\n      dd_mb == 1 ~ 1, # from daily data\n      D28_AECNone == \"Yes\" ~ 0,\n      D28_AECMajorBleeding == \"No\" ~ 0,\n      D28_AECMajorBleeding == \"Yes\" ~ 1,\n      D28_AECUnknown == \"Yes\" ~ NA_real_,\n      TRUE ~ 0 \n    ),\n    # 8.8 - non-major bleeding\n    out_nmb = case_when(\n      D28_ABNonMajorBleeding == \"Yes\" ~ 1,\n      D28_ABNonMajorBleeding == \"No\" ~ 0,\n      D28_ABNonMajorBleeding == \"Unknown\" ~ NA_real_\n    ),\n    # 8.6 - any clinically relevant bleeding\n    out_crb = case_when(\n      out_mb == 1 | out_nmb == 1 ~ 1,\n      is.na(out_mb) | is.na(out_nmb) ~ NA_real_,\n      out_mb == 0 & out_nmb == 0 ~ 0\n    ),\n    # 8.9 - heparin-induced thrombocytopenia\n    out_hit = case_when(\n      dd_hit == 1 ~ 1, # from daily data\n      D28_AECNone == \"Yes\" ~ 0,\n      D28_AECUnknown == \"Yes\" ~ NA_real_,\n      D28_AECHIT == \"Yes\" ~ 1,\n      TRUE ~ 0 \n    )\n  )\n\n\n\n\nCode\nacs_itt_dat %>% dplyr::count(out_dvt, D28_ABDeepVein, D28_ABEventNone, D28_ABEventUnknown)\n\n\n# A tibble: 4 × 5\n  out_dvt D28_ABDeepVein D28_ABEventNone D28_ABEventUnknown     n\n    <dbl> <chr>          <chr>           <chr>              <int>\n1       0 <NA>           Yes             <NA>                1511\n2       0 <NA>           <NA>            <NA>                   5\n3       1 Yes            <NA>            <NA>                   1\n4      NA <NA>           <NA>            Yes                   39\n\n\nCode\nacs_itt_dat %>% dplyr::count(out_pe, D28_ABPulmonaryEmbolism, D28_ABEventNone, D28_ABEventUnknown)\n\n\n# A tibble: 4 × 5\n  out_pe D28_ABPulmonaryEmbolism D28_ABEventNone D28_ABEventUnknown     n\n   <dbl> <chr>                   <chr>           <chr>              <int>\n1      0 <NA>                    Yes             <NA>                1511\n2      0 <NA>                    <NA>            <NA>                   4\n3      1 Yes                     <NA>            <NA>                   2\n4     NA <NA>                    <NA>            Yes                   39\n\n\nCode\nacs_itt_dat %>% dplyr::count(out_ami, D28_ABAcuteMyocardinalInfarction, D28_ABEventNone, D28_ABEventUnknown)\n\n\n# A tibble: 4 × 5\n  out_ami D28_ABAcuteMyocardinalInfarcti… D28_ABEventNone D28_ABEventUnkn…     n\n    <dbl> <chr>                           <chr>           <chr>            <int>\n1       0 <NA>                            Yes             <NA>              1511\n2       0 <NA>                            <NA>            <NA>                 4\n3       1 Yes                             <NA>            <NA>                 2\n4      NA <NA>                            <NA>            Yes                 39\n\n\nCode\nacs_itt_dat %>% dplyr::count(out_ice, D28_ABIschemicCerebrovascularEvent, D28_ABEventNone, D28_ABEventUnknown)\n\n\n# A tibble: 3 × 5\n  out_ice D28_ABIschemicCerebrovascularE… D28_ABEventNone D28_ABEventUnkn…     n\n    <dbl> <chr>                           <chr>           <chr>            <int>\n1       0 <NA>                            Yes             <NA>              1511\n2       0 <NA>                            <NA>            <NA>                 6\n3      NA <NA>                            <NA>            Yes                 39\n\n\nCode\nacs_itt_dat %>% dplyr::count(out_ote, D28_ABOtherThromboEvent, D28_ABEventNone, D28_ABEventUnknown)\n\n\n# A tibble: 4 × 5\n  out_ote D28_ABOtherThromboEvent D28_ABEventNone D28_ABEventUnknown     n\n    <dbl> <chr>                   <chr>           <chr>              <int>\n1       0 <NA>                    Yes             <NA>                1511\n2       0 <NA>                    <NA>            <NA>                   5\n3       1 Yes                     <NA>            <NA>                   1\n4      NA <NA>                    <NA>            Yes                   39\n\n\nCode\nacs_itt_dat %>% dplyr::count(out_ated, out_dth, out_dvt, out_pe, out_ami, out_ice, out_ote)\n\n\n# A tibble: 11 × 8\n   out_ated out_dth out_dvt out_pe out_ami out_ice out_ote     n\n      <dbl>   <int>   <dbl>  <dbl>   <dbl>   <dbl>   <dbl> <int>\n 1        0       0       0      0       0       0       0  1465\n 2        1       0       0      0       0       0       1     1\n 3        1       0       0      0       1       0       0     1\n 4        1       0       0      1       0       0       0     2\n 5        1       0       1      0       0       0       0     1\n 6        1       1       0      0       0       0       0    43\n 7        1       1       0      0       1       0       0     1\n 8        1       1      NA     NA      NA      NA      NA     6\n 9       NA       0      NA     NA      NA      NA      NA    10\n10       NA      NA       0      0       0       0       0     3\n11       NA      NA      NA     NA      NA      NA      NA    23\n\n\nCode\nacs_itt_dat %>% dplyr::count(D28_AECHIT, D28_AECMajorBleeding, D28_AECNone, D28_AECUnknown)\n\n\n# A tibble: 3 × 5\n  D28_AECHIT D28_AECMajorBleeding D28_AECNone D28_AECUnknown     n\n  <chr>      <chr>                <chr>       <chr>          <int>\n1 <NA>       No                   Yes         <NA>            1512\n2 <NA>       No                   <NA>        Yes               43\n3 <NA>       Yes                  <NA>        <NA>               1\n\n\nCode\nacs_itt_dat %>% dplyr::count(out_mb, D28_AECMajorBleeding, D28_AECNone, D28_AECUnknown)\n\n\n# A tibble: 5 × 5\n  out_mb D28_AECMajorBleeding D28_AECNone D28_AECUnknown     n\n   <dbl> <chr>                <chr>       <chr>          <int>\n1      0 No                   Yes         <NA>            1508\n2      0 No                   <NA>        Yes               42\n3      1 No                   Yes         <NA>               4\n4      1 No                   <NA>        Yes                1\n5      1 Yes                  <NA>        <NA>               1\n\n\nCode\nacs_itt_dat %>% dplyr::count(out_nmb, D28_ABNonMajorBleeding)\n\n\n# A tibble: 3 × 3\n  out_nmb D28_ABNonMajorBleeding     n\n    <dbl> <chr>                  <int>\n1       0 No                      1513\n2       1 Yes                        8\n3      NA Unknown                   35\n\n\nCode\nacs_itt_dat %>% dplyr::count(out_crb, out_mb, out_nmb)\n\n\n# A tibble: 6 × 4\n  out_crb out_mb out_nmb     n\n    <dbl>  <dbl>   <dbl> <int>\n1       0      0       0  1510\n2       1      0       1     6\n3       1      1       0     3\n4       1      1       1     2\n5       1      1      NA     1\n6      NA      0      NA    34\n\n\nCode\nacs_itt_dat %>% dplyr::count(out_hit, D28_AECHIT, D28_AECNone, D28_AECUnknown)\n\n\n# A tibble: 4 × 5\n  out_hit D28_AECHIT D28_AECNone D28_AECUnknown     n\n    <dbl> <chr>      <chr>       <chr>          <int>\n1       0 <NA>       Yes         <NA>            1511\n2       0 <NA>       <NA>        <NA>               1\n3       1 <NA>       Yes         <NA>               1\n4      NA <NA>       <NA>        Yes               43"
  },
  {
    "objectID": "analyses/8-0_anticoagulation_specific_secondary.html#anticoagulation",
    "href": "analyses/8-0_anticoagulation_specific_secondary.html#anticoagulation",
    "title": "8-0 Domain-specific secondary outcomes",
    "section": "Anticoagulation",
    "text": "Anticoagulation\nThe following table describes the anticoagulation domain-specific outcomes by anticoagulation intervention.\n\n\nCode\ngtab <- acs_itt_dat %>%\n  select(CAssignment, out_dth, \n         out_ated, out_ate, out_dvt, out_pe, out_ami, out_ice, out_ote, \n         out_crb, out_mb, out_nmb, out_hit) %>%\n  group_by(CAssignment) %>%\n  summarise(\n    Randomised_ = n(),\n    `Mortality_Died by day 28` = sprintf(\"%i (%.0f)\", sum(out_dth, na.rm = TRUE), 100 * mean(out_dth, na.rm = TRUE)),\n    `Mortality_Unknown` = sprintf(\"%i (%.0f)\", sum(is.na(out_dth)), 100 * mean(is.na(out_dth))),\n    `Thrombotic events_Unknown` = \n        sprintf(\"%i (%.0f)\", sum(is.na(out_dvt)), 100 * mean(is.na(out_dvt))),\n    `Thrombotic events_Deep vein thrombosis` = \n      sprintf(\"%i (%.0f)\", sum(out_dvt, na.rm = TRUE), 100 * mean(out_dvt, na.rm = TRUE)),\n    `Thrombotic events_Pulmonary embolus` = \n      sprintf(\"%i (%.0f)\", sum(out_pe, na.rm = TRUE), 100 * mean(out_pe, na.rm = TRUE)),\n    `Thrombotic events_Acute myocardial infarction` = \n      sprintf(\"%i (%.0f)\", sum(out_ami, na.rm = TRUE), 100 * mean(out_ami, na.rm = TRUE)),\n    `Thrombotic events_Ischemic cerebrovascular event` = \n      sprintf(\"%i (%.0f)\", sum(out_ice, na.rm = TRUE), 100 * mean(out_ice, na.rm = TRUE)),\n    `Thrombotic events_Other confirmed thrombotic event` = \n      sprintf(\"%i (%.0f)\", sum(out_ote, na.rm = TRUE), 100 * mean(out_ote, na.rm = TRUE)),\n    `Thrombotic events_Any thrombotic event` = \n      sprintf(\"%i (%.0f)\", sum(out_ate, na.rm = TRUE), 100 * mean(out_ate, na.rm = TRUE)),\n    `Thrombotic events_Any thrombotic event or death` = \n      sprintf(\"%i (%.0f)\", sum(out_ated, na.rm = TRUE), 100 * mean(out_ated, na.rm = TRUE)),\n    `Bleeding_Unknown` = \n      sprintf(\"%i (%.0f)\", sum(is.na(out_crb)), 100 * mean(is.na(out_crb))),\n    `Bleeding_Major bleeding (as defined by ISTH)` = \n      sprintf(\"%i (%.0f)\", sum(out_mb, na.rm = TRUE), 100 * mean(out_mb, na.rm = TRUE)),\n    `Bleeding_Clinically relevant non-major bleeding` = \n      sprintf(\"%i (%.0f)\", sum(out_nmb, na.rm = TRUE), 100 * mean(out_nmb, na.rm = TRUE)),\n    `Bleeding_Any clinically relevant bleeding` = \n      sprintf(\"%i (%.0f)\", sum(out_crb, na.rm = TRUE), 100 * mean(out_crb, na.rm = TRUE)),\n    `Bleeding_Heparin-induced thrombocytopenia` = \n      sprintf(\"%i (%.0f)\", sum(out_hit, na.rm = TRUE), 100 * mean(out_hit, na.rm = TRUE)),\n  ) %>%\n  gather(key, value, -CAssignment, factor_key = TRUE) %>%\n  spread(CAssignment, value) %>%\n  separate(key, c(\"Type\", \"Outcome\"), sep = \"_\")\ncolnames(gtab)[-(1:2)] <- paste0(intervention_labels()$CAssignment[-1], \"<br>(n = \", gtab[1, -(1:2)], \")\")\ngtab <- gtab[-1, ]\n\notab <- acs_itt_dat %>%\n  select(CAssignment, out_dth, \n         out_ated, out_ate, out_dvt, out_pe, out_ami, out_ice, out_ote, \n         out_crb, out_mb, out_nmb, out_hit) %>%\n  group_by(CAssignment = \"Overall\") %>%\n  summarise(\n    Randomised_ = n(),\n    `Mortality_Died by day 28` = sprintf(\"%i (%.0f)\", sum(out_dth, na.rm = TRUE), 100 * mean(out_dth, na.rm = TRUE)),\n    `Mortality_Unknown` = sprintf(\"%i (%.0f)\", sum(is.na(out_dth)), 100 * mean(is.na(out_dth))),\n    `Thrombotic events_Unknown` = \n        sprintf(\"%i (%.0f)\", sum(is.na(out_dvt)), 100 * mean(is.na(out_dvt))),\n    `Thrombotic events_Deep vein thrombosis` = \n      sprintf(\"%i (%.0f)\", sum(out_dvt, na.rm = TRUE), 100 * mean(out_dvt, na.rm = TRUE)),\n    `Thrombotic events_Pulmonary embolus` = \n      sprintf(\"%i (%.0f)\", sum(out_pe, na.rm = TRUE), 100 * mean(out_pe, na.rm = TRUE)),\n    `Thrombotic events_Acute myocardial infarction` = \n      sprintf(\"%i (%.0f)\", sum(out_ami, na.rm = TRUE), 100 * mean(out_ami, na.rm = TRUE)),\n    `Thrombotic events_Ischemic cerebrovascular event` = \n      sprintf(\"%i (%.0f)\", sum(out_ice, na.rm = TRUE), 100 * mean(out_ice, na.rm = TRUE)),\n    `Thrombotic events_Other confirmed thrombotic event` = \n      sprintf(\"%i (%.0f)\", sum(out_ote, na.rm = TRUE), 100 * mean(out_ote, na.rm = TRUE)),\n    `Thrombotic events_Any thrombotic event` = \n      sprintf(\"%i (%.0f)\", sum(out_ate, na.rm = TRUE), 100 * mean(out_ate, na.rm = TRUE)),\n    `Thrombotic events_Any thrombotic event or death` = \n      sprintf(\"%i (%.0f)\", sum(out_ated, na.rm = TRUE), 100 * mean(out_ated, na.rm = TRUE)),\n    `Bleeding_Unknown` = \n      sprintf(\"%i (%.0f)\", sum(is.na(out_crb)), 100 * mean(is.na(out_crb))),\n    `Bleeding_Major bleeding (as defined by ISTH)` = \n      sprintf(\"%i (%.0f)\", sum(out_mb, na.rm = TRUE), 100 * mean(out_mb, na.rm = TRUE)),\n    `Bleeding_Clinically relevant non-major bleeding` = \n      sprintf(\"%i (%.0f)\", sum(out_nmb, na.rm = TRUE), 100 * mean(out_nmb, na.rm = TRUE)),\n    `Bleeding_Any clinically relevant bleeding` = \n      sprintf(\"%i (%.0f)\", sum(out_crb, na.rm = TRUE), 100 * mean(out_crb, na.rm = TRUE)),\n    `Bleeding_Heparin-induced thrombocytopenia` = \n      sprintf(\"%i (%.0f)\", sum(out_hit, na.rm = TRUE), 100 * mean(out_hit, na.rm = TRUE)),\n  ) %>%\n  gather(key, value, -CAssignment, factor_key = TRUE) %>%\n  spread(CAssignment, value) %>%\n  separate(key, c(\"Type\", \"Outcome\"), sep = \"_\")\ncolnames(otab)[-(1:2)] <- paste0(\"Overall<br>(n = \", otab[1, -(1:2)], \")\")\notab <- otab[-1, ]\n\ntab <- left_join(gtab, otab, by = c(\"Type\", \"Outcome\"))\ncolnames(tab)[2] <- \"Outcome, n (\\\\%)\"\n\nkable(\n  tab[, -1],\n  booktabs = TRUE,\n  align = \"lrrrrr\",\n  escape = F\n) %>%\n  kable_styling(\n    latex_options = \"HOLD_position\"\n  ) %>%\n  pack_rows(\"Mortality\", 1, 2) %>%\n  pack_rows(\"Thrombotic events\", 3, 10) %>%\n  pack_rows(\"Bleeding\", 11, 15)\n\n\n\n\n \n  \n    Outcome, n (\\%) \n    Lowdose(n = 610) \n    Intermediatedose(n = 613) \n    Low dosewith aspirin(n = 283) \n    Therapeuticdose(n = 50) \n    Overall(n = 1556) \n  \n \n\n  Mortality\n\n    Died by day 28 \n    19 (3) \n    15 (2) \n    10 (4) \n    6 (12) \n    50 (3) \n  \n  \n    Unknown \n    14 (2) \n    10 (2) \n    2 (1) \n    0 (0) \n    26 (2) \n  \n  Thrombotic events\n\n    Unknown \n    18 (3) \n    14 (2) \n    5 (2) \n    2 (4) \n    39 (3) \n  \n  \n    Deep vein thrombosis \n    1 (0) \n    0 (0) \n    0 (0) \n    0 (0) \n    1 (0) \n  \n  \n    Pulmonary embolus \n    0 (0) \n    1 (0) \n    1 (0) \n    0 (0) \n    2 (0) \n  \n  \n    Acute myocardial infarction \n    1 (0) \n    1 (0) \n    0 (0) \n    0 (0) \n    2 (0) \n  \n  \n    Ischemic cerebrovascular event \n    0 (0) \n    0 (0) \n    0 (0) \n    0 (0) \n    0 (0) \n  \n  \n    Other confirmed thrombotic event \n    1 (0) \n    0 (0) \n    0 (0) \n    0 (0) \n    1 (0) \n  \n  \n    Any thrombotic event \n    3 (1) \n    2 (0) \n    1 (0) \n    0 (0) \n    6 (0) \n  \n  \n    Any thrombotic event or death \n    21 (4) \n    17 (3) \n    11 (4) \n    6 (12) \n    55 (4) \n  \n  Bleeding\n\n    Unknown \n    15 (2) \n    13 (2) \n    4 (1) \n    2 (4) \n    34 (2) \n  \n  \n    Major bleeding (as defined by ISTH) \n    1 (0) \n    2 (0) \n    3 (1) \n    0 (0) \n    6 (0) \n  \n  \n    Clinically relevant non-major bleeding \n    2 (0) \n    2 (0) \n    2 (1) \n    2 (4) \n    8 (1) \n  \n  \n    Any clinically relevant bleeding \n    3 (1) \n    4 (1) \n    3 (1) \n    2 (4) \n    12 (1) \n  \n  \n    Heparin-induced thrombocytopenia \n    0 (0) \n    1 (0) \n    0 (0) \n    0 (0) \n    1 (0) \n  \n\n\n\n\n\n\n\nCode\ncolnames(tab) <- linebreak(colnames(tab), align = \"c\", linebreaker = \"<br>\")\nout <- kable(\n  tab[, -1],\n  format = \"latex\",\n  booktabs = TRUE,\n  align = \"lrrrrrr\",\n  escape = FALSE\n) %>%\n  kable_styling(\n    font_size = 9,\n    latex_options = \"HOLD_position\"\n  ) %>%\n  pack_rows(\"Mortality\", 1, 2) %>%\n  pack_rows(\"Thrombotic events\", 3, 10) %>%\n  pack_rows(\"Bleeding\", 11, 15)\nsave_tex_table(out, file.path(\"outcomes\", \"secondary\", \"8-0-anticoagulation-specific-summary\"))"
  },
  {
    "objectID": "analyses/8-0_anticoagulation_specific_secondary.html#primary-model",
    "href": "analyses/8-0_anticoagulation_specific_secondary.html#primary-model",
    "title": "8-0 Domain-specific secondary outcomes",
    "section": "Primary Model",
    "text": "Primary Model\n\n\nCode\nacs_itt_nona_dat <- acs_itt_dat %>%\n  filter(!is.na(out_ated)) %>%\n  transmute_model_cols_grp_aus_nz() %>%\n  left_join(acs_itt_dat %>% \n              select(StudyPatientID, out_ated), \n            by = \"StudyPatientID\")\n\nctr <- contr.orthonorm\nX <- make_X_design(acs_itt_nona_dat, c(\"inelgc3\", \"agegte60\", \"ctry\"), ctr)\nnXassign <- sum(grepl(\"rand\", colnames(X))) - 1\nepoch  <- acs_itt_nona_dat$epoch\nM_epoch  <- max(acs_itt_nona_dat$epoch)\nregion <- acs_itt_nona_dat[[\"ctry_num\"]]\nM_region <- max(region)\nsite <- acs_itt_nona_dat[[\"site_num\"]]\nM_site <- max(site)\nregion_by_site <- region_by_site <- acs_itt_nona_dat %>% \n  dplyr::count(ctry_num, site_num) %>% \n  pull(ctry_num)\nepoch_map <- acs_itt_nona_dat %>% dplyr::count(epoch, epoch_lab)\nsite_map <- acs_itt_nona_dat %>% dplyr::count(site_num, site)\n\nmdat <- list(N = nrow(X), K = ncol(X), X = X, y = acs_itt_nona_dat$out_ated,\n       M_region = M_region, M_site = M_site, site = site,\n       M_epoch = M_epoch, epoch = epoch,\n       region_by_site = region_by_site,\n       beta_sd = c(2.5, rep(1, nXassign), 10, 2.5, rep(1, 2)))\n\nsnk <- capture.output(\n  mfit <- primary_mod2$sample(\n    data = mdat,\n    seed = 28497,\n    refresh = 0,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    chains = 8,\n    parallel_chains = 8,\n    adapt_delta = 0.98\n))\ndrws <- as_draws_rvars(mfit$draws(c(\"beta\", \"gamma_epoch\", \"gamma_site\", \"tau_epoch\", \"tau_site\")))\n\nnames(drws$beta) <- colnames(X)\nnames(drws$gamma_epoch) <- epoch_map$epoch_lab\nnames(drws$gamma_site) <- site_map$site\n\ndrws$Acon <- attr(X, \"contrasts\")$randA %**% drws$beta[6]\ndrws$Ccon <- attr(X, \"contrasts\")$randC %**% drws$beta[2:4]\ndrws$Atrt <- drws$Acon[-1] - drws$Acon[1]\ndrws$Ctrt <- drws$Ccon[-1] - drws$Ccon[1]\n\ndrws$treat <- (transform_coding(cbind(1, contr.orthonorm(4)), cbind(1, contr.treatment(4))) %**%\n  drws$beta[1:4])[2:4]\n\ndrws$OR <- exp(c(\n  drws$treat, \n  drws$beta[7], \n  drws$beta[8], \n  drws$beta[9:10]))\nnames(drws$OR) <- c(\n  \"Intermediate\", \"Low with aspirin\", \"Therapeutic\", \n  \"Ineligible aspirin\", \"Age \\u2265 60\", \n  \"Australia/NZ\", \"Nepal\")\n\n\n\n\nCode\nsave_tex_table(\n  odds_ratio_summary_table(drws$OR, \"latex\"),\n  \"outcomes/secondary/8-1-primary-model-acs-itt-summary-table\")\nodds_ratio_summary_table(drws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.85 \n    (0.44, 1.65) \n    0.90 (0.31) \n    0.68 \n  \n  \n    Low with aspirin \n    0.87 \n    (0.39, 1.90) \n    0.94 (0.39) \n    0.64 \n  \n  \n    Therapeutic \n    2.47 \n    (0.82, 7.47) \n    2.91 (1.84) \n    0.06 \n  \n  \n    Ineligible aspirin \n    4.66 \n    (1.18, 15.91) \n    5.65 (3.94) \n    0.01 \n  \n  \n    Age ≥ 60 \n    2.06 \n    (1.14, 3.75) \n    2.15 (0.66) \n    0.01 \n  \n  \n    Australia/NZ \n    0.96 \n    (0.22, 3.94) \n    1.25 (1.03) \n    0.52 \n  \n  \n    Nepal \n    2.51 \n    (0.56, 9.18) \n    3.11 (2.41) \n    0.10 \n  \n\n\n\n\n\n\n\nCode\nepoch_rvs <- exp(drws$gamma_epoch)\nsite_rvs <- exp(drws$gamma_site)\nfacets <- factor(mdat$region_by_site, labels = c(\"India\", \"Australia/NZ\", \"Nepal\"))\np <- plot_epoch_site_terms(epoch_rvs, site_rvs, facets)\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\", \"8-1-primary-model-epoch-site-terms.pdf\")\nggsave(pth, p, width = 6, height = 4.5)\np\n\n\n\n\n\n\nPrior Sensitivity\nThe analysis is repeated using treatment coding rather than the orthonormal coding. Due to the change in prior, the is a slight shift in the estimated treatment effects, however this does not alter the result of weak evidence for any difference.\n\n\nCode\nctr <- contr.treatment\nX <- make_X_design(acs_itt_nona_dat, c(\"inelgc3\", \"agegte60\", \"ctry\"), ctr)\nnXassign <- sum(grepl(\"rand\", colnames(X))) - 1\nepoch  <- acs_itt_nona_dat$epoch\nM_epoch  <- max(acs_itt_nona_dat$epoch)\nregion <- acs_itt_nona_dat[[\"ctry_num\"]]\nM_region <- max(region)\nsite <- acs_itt_nona_dat[[\"site_num\"]]\nM_site <- max(site)\nregion_by_site <- region_by_site <- acs_itt_nona_dat %>% \n  dplyr::count(ctry_num, site_num) %>% \n  pull(ctry_num)\nepoch_map <- acs_itt_nona_dat %>% dplyr::count(epoch, epoch_lab)\nsite_map <- acs_itt_nona_dat %>% dplyr::count(site_num, site)\n\nmdat <- list(N = nrow(X), K = ncol(X), X = X, y = acs_itt_nona_dat$out_ated,\n       M_region = M_region, M_site = M_site, site = site,\n       M_epoch = M_epoch, epoch = epoch,\n       region_by_site = region_by_site,\n       beta_sd = c(2.5, rep(1, nXassign), 10, 2.5, rep(1, 2)))\n\nsnk <- capture.output(\n  mfit <- primary_mod2$sample(\n    data = mdat,\n    seed = 28497,\n    refresh = 0,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    chains = 8,\n    parallel_chains = 8,\n    adapt_delta = 0.98\n))\ndrws <- as_draws_rvars(mfit$draws(c(\"beta\", \"gamma_epoch\", \"gamma_site\", \"tau_epoch\", \"tau_site\")))\n\nnames(drws$beta) <- colnames(X)\nnames(drws$gamma_epoch) <- epoch_map$epoch_lab\nnames(drws$gamma_site) <- site_map$site\n\ndrws$OR <- exp(c(rvar(0), drws$beta[2:4], rvar(0), drws$beta[7], rvar(0), drws$beta[8], rvar(0), drws$beta[9:10]))\nnames(drws$OR) <- c(\n  \"Standard (ref)\", \"Intermediate\", \"Standard plus aspirin\", \"Therapeutic\", \n  \"Age < 60 (ref)\", \"Age 60+\", \"Eligible aspirin (ref)\", \"Ineligible aspirin\", \n  \"India (ref)\", \"Australia/NZ\", \"Nepal\")\n\n\n\n\nCode\nodds_ratio_summary_table(drws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Standard (ref) \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Intermediate \n    0.81 \n    (0.42, 1.51) \n    0.85 (0.28) \n    0.75 \n  \n  \n    Standard plus aspirin \n    0.81 \n    (0.38, 1.70) \n    0.87 (0.34) \n    0.70 \n  \n  \n    Therapeutic \n    2.23 \n    (0.75, 6.35) \n    2.57 (1.48) \n    0.07 \n  \n  \n    Age < 60 (ref) \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Age 60+ \n    4.62 \n    (1.20, 15.95) \n    5.61 (3.96) \n    0.01 \n  \n  \n    Eligible aspirin (ref) \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Ineligible aspirin \n    2.06 \n    (1.13, 3.78) \n    2.16 (0.68) \n    0.01 \n  \n  \n    India (ref) \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Australia/NZ \n    0.91 \n    (0.20, 3.77) \n    1.18 (0.99) \n    0.55 \n  \n  \n    Nepal \n    2.53 \n    (0.59, 9.03) \n    3.12 (2.32) \n    0.10 \n  \n\n\n\n\n\n\n\nCode\nepoch_rvs <- exp(drws$gamma_epoch)\nsite_rvs <- exp(drws$gamma_site)\nfacets <- factor(mdat$region_by_site, labels = c(\"India\", \"Australia/NZ\", \"Nepal\"))\np <- plot_epoch_site_terms(epoch_rvs, site_rvs, facets)\np"
  },
  {
    "objectID": "analyses/primary_outcome.html",
    "href": "analyses/primary_outcome.html",
    "title": "Primary Outcome",
    "section": "",
    "text": "Load packages\nlibrary(tidyverse)\nlibrary(labelled)\nlibrary(kableExtra)\nlibrary(cmdstanr)\nlibrary(posterior)\nlibrary(bayestestR)\nlibrary(bayesplot)\nlibrary(matrixStats)\nlibrary(plotly)\nlibrary(lubridate)\nlibrary(ggdist)\nlibrary(patchwork)\n\ntheme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank()))\nbayesplot_theme_set(theme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank())))\ncolor_scheme_set(\"red\")\noptions(digits = 4)\n\n\n\n\nPrepare datasets\ndevtools::load_all()\n# Raw data\nall_dat <- read_all_no_daily()\nall_dat_daily <- read_all_daily()\n\n# FAS-ITT\nfas_itt_dat <- all_dat %>% \n  filter_fas_itt() %>%\n  transmute_model_cols_grp_aus_nz()\n# FAS-ITT excluding missing values\nfas_itt_nona_dat <- fas_itt_dat %>% \n  filter(!is.na(PO))\n\n# ACS-ITT\nacs_itt_dat <- all_dat %>% \n  filter_acs_itt() %>%\n  transmute_model_cols_grp_aus_nz()\n# ACS-ITT excluding missing values\nacs_itt_nona_dat <- acs_itt_dat %>% \n  filter(!is.na(PO))\n# ACS-ITT worst case\nacs_itt_wc_dat <- acs_itt_dat %>%\n  mutate(PO = if_else(is.na(PO) | PO == 1, 1, 0))\n# ACS-ITT best case\nacs_itt_bc_dat <- acs_itt_dat %>%\n  mutate(PO = if_else(is.na(PO) | PO == 0, 0, 1))\n\n# ACS-PP - exclude participants not per-protocol\npp <- read_per_protocol_list()\nall_pp <- all_dat %>% left_join(pp, by = \"StudyPatientID\")\nacs_pp_dat <- all_pp %>%\n  filter_acs_itt() %>%\n  filter(is.na(Reason)) %>%\n  transmute_model_cols_grp_aus_nz()\nacs_pp_nona_dat <- acs_pp_dat %>%\n  filter(!is.na(PO))\n\n# Concurrent enrolments for C2\nacs_itt_concurc2_dat <- acs_itt_dat %>%\n  filter_concurrent_intermediate()\nacs_itt_concurc2_nona_dat <- acs_itt_concurc2_dat %>% \n  filter(!is.na(PO))\n# Concurrent enrolments for C3\nacs_itt_concurc3_dat <- acs_itt_dat %>%\n  filter_concurrent_std_aspirin()\nacs_itt_concurc3_nona_dat <- acs_itt_concurc3_dat %>% \n  filter(!is.na(PO))\n# Concurrent enrolments for C4\nacs_itt_concurc4_dat <- acs_itt_dat %>%\n  filter_concurrent_therapeutic()\nacs_itt_concurc4_nona_dat <- acs_itt_concurc4_dat %>% \n  filter(!is.na(PO))\n\n\n\n\nLoad models\nlogistic_mod <- cmdstan_model(\"stan/binary/logistic.stan\")\nlogistic_site_mod <- cmdstan_model(\"stan/binary/logistic_site.stan\")\nlogistic_epoch_mod <- cmdstan_model(\"stan/binary/logistic_epoch.stan\")\nlogistic_site_epoch_llik <- cmdstan_model(\"stan/binary/logistic_site_epoch_loglik.stan\")\nlogistic_site_epoch_llik_int <- cmdstan_model(\"stan/subgroup/logistic_site_epoch_loglik_shrinkage.stan\")\nprimary_mod <- cmdstan_model(\"stan/binary/logistic_site_epoch.stan\")\n\n\n\n\nHelper functions\nmake_stan_data <- function(\n    dat, \n    vars, \n    outcome, \n    beta_sd = c(2.5, rep(1, nXassign), 2.5, 10),\n    ctr = contr.orthonorm) \n{\n  X <- model.matrix(\n     as.formula(paste(\"~\", paste(vars, collapse = \" + \"))),\n    data = dat,\n    contrast = list(\n      AAssignment = ctr,\n      CAssignment = ctr)\n  )\n  nXassign <- sum(grepl(\"Assignment\", colnames(X)))\n\n  y <- dat[[outcome]]\n  N <- dim(X)[1]\n  K <- dim(X)[2]  \n    epoch  <- dat$epoch\n  M_epoch  <- max(dat$epoch)\n    region <- dat[[\"ctry_num\"]]\n  M_region <- max(region)\n    site <- dat[[\"site_num\"]]\n  M_site <- max(site)\n  region_by_site <- region_by_site <- dat %>% \n    dplyr::count(ctry_num, site_num) %>% \n    pull(ctry_num)\n  \n  list(N = N, K = K, X = X, y = y,\n       M_region = M_region, region = region,\n       M_site = M_site, site = site,\n       M_epoch = M_epoch, epoch = epoch,\n       region_by_site = region_by_site,\n       beta_sd = beta_sd)\n}\n\n\n# Always includes the assigned interventions\nmake_primary_model_data <- function(\n    dat, \n    vars = c(\"inelgc3\", \"agegte60\", \"ctry\"),\n    beta_sd_var = c(10, 2.5, 1, 1),\n    ctr = contr.orthonorm) {\n  \n  # Domain specific intercept as in interims\n  XA <- make_domA_design(dat, ctr)\n  # Domain specific intercept as in interims\n  XC <- make_domC_design(dat, ctr)\n  if (any(XC[, 1] != 1)) {\n    add_intercept = TRUE\n  } else {\n    add_intercept = FALSE\n  }\n  \n  if (!is.null(vars)) {\n    Xother <- model.matrix(\n     as.formula(paste(\" ~ \", paste(vars, collapse = \" + \"))),\n     data = dat\n    ) [, -1]\n  } else {\n    Xother <- NULL\n  }\n  \n  X <- cbind(XC, XA, Xother)\n  if(add_intercept) {\n    X <- cbind(randPlatform = 1, X)\n  }\n  nXtrt <- sum(grepl(\"rand\", colnames(X))) - 1\n  \n  epoch  <- dat[[\"epoch\"]]\n  M_epoch  <- max(epoch)\n  region <- dat[[\"ctry_num\"]]\n  M_region <- max(region)\n  site <- dat[[\"site_num\"]]\n  M_site <- max(site)\n  region_by_site <- region_by_site <- dat %>% \n    dplyr::count(ctry_num, site_num) %>% \n    pull(ctry_num)\n  \n  y <- dat[[\"PO\"]]\n  N <- dim(X)[1]\n  K <- dim(X)[2]\n  beta_sd <- c(2.5, rep(1, nXtrt), beta_sd_var)\n  out <- list(\n    N = N, K = K, X = X, y = y,\n    M_region = M_region, region = region,\n    M_site = M_site, site = site,\n    M_epoch = M_epoch, epoch = epoch,\n    region_by_site = region_by_site,\n    beta_sd = beta_sd,\n    ctrC = attr(XC, \"contrasts\")[[1]],\n    ctrA = attr(XA, \"contrasts\")[[1]]\n  )\n  return(out)\n}\n\n\nfit_primary_model <- function(\n    dat,\n    model = primary_mod,\n    vars = NULL,\n    beta_sd_var = NULL,\n    ctr = contr.orthonorm,\n    seed = 32915,\n    ...\n) {\n  mdat <- make_primary_model_data(\n    dat,\n    vars,\n    beta_sd_var,\n    ctr\n  )\n  snk <- capture.output(\n    mfit <- model[[\"sample\"]](\n      data = mdat,\n      seed = seed,\n      refresh = 0,\n      iter_warmup = 1000,\n      iter_sampling = 2500,\n      chains = 8,\n      parallel_chains = min(8, parallel::detectCores()),\n      ...\n  ))\n  mpars <- mfit$metadata()$model_params\n  keep <- mpars[!grepl(\"(_raw|epsilon_)\", mpars)]\n  mdrws <- as_draws_rvars(mfit$draws(keep))\n  names(mdrws$beta) <- colnames(mdat$X)\n  \n  if(any(grepl(\"site\", keep))) {\n    site_map <- dat %>% dplyr::count(site_num, site)  \n    names(mdrws$gamma_site) <- site_map$site\n  }\n  if(any(grepl(\"epoch\", keep))) {\n    epoch_map <- dat %>% dplyr::count(epoch, epoch_lab)  \n    names(mdrws$gamma_epoch) <- epoch_map$epoch_lab\n  }\n  # Transformed samples\n  Ca <- mdat$ctrA\n  Cc <- mdat$ctrC\n  # Get constrained parameters from contrast transformation\n  mdrws$Acon <- Ca %**% mdrws$beta[grepl(\"randA[0-9]\", names(mdrws$beta))]\n  mdrws$Ccon <- as.vector(Cc %**% mdrws$beta[grepl(\"randC[0-9]\", names(mdrws$beta))])\n  names(mdrws$Ccon) <- rownames(Cc)\n  # Get treatment effect in case of non treatment-coding\n  mdrws$Atrt <- mdrws$Acon[-1] - mdrws$Acon[1]\n  mdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\n  # Get odds ratios\n  mdrws$OR <- exp(mdrws$Ctrt)\n  mdrws$OR <- c(mdrws$OR, exp(mdrws$beta[!grepl(\"(Intercept|rand)\", names(mdrws$beta))]))\n  return(list(dat = mdat, fit = mfit, drws = mdrws))\n}\n\n\nmake_po_table <- function(dat, format = \"html\") {\n  tab <- dat %>%\n    mutate(CAssignment = factor(\n      CAssignment, \n      levels = c(\"C1\", \"C2\", \"C3\", \"C4\"), \n      labels = intervention_labels()$CAssignment[-1])\n    ) %>%\n    group_by(CAssignment) %>%\n    summarise(\n      Randomised = n(),\n      `Outcome missing` = sprintf(\"%i (%.1f)\", sum(is.na(PO)), 100 * mean(is.na(PO))),\n      `Outcome observed` = sprintf(\"%i (%.1f)\", sum(!is.na(PO)), 100 * mean(!is.na(PO))),\n      `Met primary outcome` = sprintf(\"%i (%.1f)\", sum(PO, na.rm = TRUE), 100 * mean(PO, na.rm = TRUE)),\n    ) %>%\n    bind_rows(\n      dat  %>%\n        group_by(CAssignment = \"Overall\") %>%\n        summarise(\n          Randomised = n(),\n          `Outcome missing` = sprintf(\"%i (%.1f)\", sum(is.na(PO)), 100 * mean(is.na(PO))),\n          `Outcome observed` = sprintf(\"%i (%.1f)\", sum(!is.na(PO)), 100 * mean(!is.na(PO))),\n          `Met primary outcome` = sprintf(\"%i (%.1f)\", sum(PO, na.rm = TRUE), 100 * mean(PO, na.rm = TRUE)),\n      )\n    ) %>%\n    mutate(CAssignment = fct_inorder(CAssignment)) %>%\n    gather(key, value, -CAssignment, factor_key = T) %>%\n    spread(CAssignment, value)\n  colnames(tab)[1] <- \"n (\\\\%)\"\n  if(format == \"latex\") {\n    colnames(tab) <- linebreak(colnames(tab), align = \"c\", linebreaker = \"<br>\")\n  }\n    kable(tab,\n      format = format,\n      align = \"lrrrrr\",\n      escape = FALSE,\n      booktabs = TRUE\n    ) %>%\n    kable_styling(\n      font_size = 9, \n      latex_options = \"HOLD_position\")  \n}\n\n\nsummarise_posterior <- function(dat, futval = 1.1) {\n  dat %>%\n    mutate(\n      Median = \n        sprintf(\"%.2f\", median(Posterior)),\n      `95\\\\% CrI` = \n        sprintf(\"(%.2f, %.2f)\", quantile(Posterior, 0.025), quantile(Posterior, 0.975)),\n      `Mean (SD)` = \n        sprintf(\"%.2f (%.2f)\", mean(Posterior), sd(Posterior)),\n      `Pr(OR < 1)` = \n        sprintf(\"%.2f\", Pr(Posterior < 1)),\n      `Pr(OR > 1/1.1)` = \n        sprintf(\"%.2f\", Pr(Posterior > 1/futval))\n    )\n}\n\n\nmake_subgroup_summary_table <- function(dat, format = \"html\") {\n  L <- nrow(dat)\n  row_st <- seq(1, L, by = L / 3)\n  row_ed <- seq(L/3, L, by = L / 3)\n  kable(\n    dat[, -1] %>% select(-Posterior),\n    format = format,\n    booktabs = TRUE,\n    align = \"lrrrrr\",\n      escape = FALSE\n  ) %>%\n    kable_styling(\n      latex_options = \"HOLD_position\",\n      font_size = 9\n    ) %>%\n    group_rows(\"Intermediate\", row_st[1], row_ed[1]) %>%\n    pack_rows(\"Low with aspirin\", row_st[2], row_ed[2]) %>%\n    pack_rows(\"Therapeutic\", row_st[3], row_ed[3])  \n}\n\nplot_or_densities <- function(rvs) {\n  tibble(Contrast = fct_inorder(names(rvs)), RV = rvs) %>% \n  ggplot(., aes(y = Contrast, xdist = RV)) + \n  stat_halfeye(\n    aes(fill = \n          stat(cut_cdf_qi(\n            cdf, \n            .width = c(.5, .8, .95, 0.99), \n            labels = scales::percent_format()))),\n    adjust = 1, n = 1001, .width = c(0.5, 0.8, 0.95)\n    ) + \n  scale_fill_brewer(\n    palette = \"Reds\",\n    direction = -1, \n    na.translate = FALSE) + \n  labs(\n    x = \"Odds ratio contrast\",\n    fill = \"Interval\"\n  ) +\n  scale_x_log10(breaks = c(0.1, 0.25, 0.5, 1, 2, 4, 10)) + \n  geom_vline(xintercept = 1)\n}\n\n\nodds_ratio_summary_table <- function(OR, format = \"html\", fn = NULL) {\n  out <- tibble(\n    Parameter = names(OR),\n    Median = median(OR),\n    `95% CrI` = apply(\n      quantile(OR, c(0.025, 0.975)), 2, \n      function(x) sprintf(\"(%.2f, %.2f)\", x[1], x[2])),\n    `Mean (SD)` = sprintf(\"%.2f (%.2f)\", E(OR), sd(OR)),\n    `Pr(OR < 1)` = Pr(OR < 1),\n  ) %>%\n  kable(\n    format = format, \n    digits = 2, \n    align = \"lrrrr\",\n    linesep = \"\",\n    booktabs = TRUE) %>%\n  kable_styling(\n    font_size = 9,\n    bootstrap_options = \"striped\", \n    latex_options = \"HOLD_position\")\n  if (!is.null(fn) & format == \"latex\") {\n    save_tex_table(out, fn)\n  } else {\n    return(out)\n  }\n}\n\n\ndecision_quantity_summary_table <- function(OR, format = \"html\", fut_val = 1.1) {\n  tdat <- tibble(\n    Intervention = names(OR),\n    posterior = OR,\n    Posterior = sprintf(\"%.2f (%.2f, %.2f)\", \n                        median(posterior), \n                        quantile(posterior, 0.025), \n                        quantile(posterior, 0.975)),\n    `Superior\\nPr(OR = min(OR))` = sprintf(\"%.2f\", E(posterior == rvar_min(posterior))),\n    `Effective\\nPr(OR < 1)` = sprintf(\"%.2f\", Pr(posterior < 1)),\n    `Futile\\nPr(OR > 1/1.1)` = sprintf(\"%.2f\", Pr(posterior > 1/fut_val)),\n    `Equivalent\\nPr(1/1.1 < OR < 1.1)` = sprintf(\"%.2f\", Pr(posterior < fut_val & posterior > 1/fut_val))\n  ) %>%\n    select(-posterior)\n  tdat[1, 2] <- \"1.00\"\n  tdat[1, -(1:3)] <- \"-\"\n  if(format == \"latex\") {\n    colnames(tdat) <- linebreak(colnames(tdat), align = \"c\")  \n  }\n  out <- kable(\n    tdat,\n    format = format, \n    digits = 2, \n    align = \"lrrrrr\",\n    linesep = \"\",\n    booktabs = TRUE) %>%\n    kable_styling(\n      font_size = 9,\n      bootstrap_options = \"striped\",\n      latex_options = \"HOLD_position\"\n    )\n  return(out)\n}"
  },
  {
    "objectID": "analyses/primary_outcome.html#day-28-mortality",
    "href": "analyses/primary_outcome.html#day-28-mortality",
    "title": "Primary Outcome",
    "section": "Day 28 mortality",
    "text": "Day 28 mortality\n\n\nSummarise the death component\nmort_table <- all_dat %>%\n  filter_acs_itt() %>%\n  group_by(CAssignment) %>%\n  summarise(\n    `Mortality_Alive at day 28_` = sum(1 - D28_death, na.rm = TRUE),\n    `Mortality_Death within 28 days_Total` = sum(D28_death, na.rm = TRUE),\n    `Mortality_Death within 28 days_Prior to discharge` = sum(DIS_death & DIS_day <= 28, na.rm = TRUE),\n    `Mortality_Death within 28 days_Post-discharge` = sum(D28_death == 1 & DIS_death == 0, na.rm = TRUE),\n    `Mortality_Unknown_` = sum(is.na(D28_death))\n  ) %>%\n  gather(key, Frequency, -CAssignment, factor_key = T) %>%\n  spread(CAssignment, Frequency) %>%\n  separate(key, into = c(\"Measure\", \"Outcome\", \"Breakdown\"), sep = \"_\") %>%\n  mutate(\n    Overall = C1 + C2 + C3 + C4,\n    across(C1:Overall, ~ sprintf(\"%i (%.0f)\", .x, 100 * .x / sum(.x[c(1,2,5)])))\n  )\nkable(\n  mort_table %>% select(-1),\n  caption = \"Composite primary endpoint breakdown - mortality.\",\n  align = \"llrrrrr\") %>%\n  kable_styling(font_size = 11) %>%\n  collapse_rows(1, valign = \"top\", latex_hline = 'custom', custom_latex_hline = 1) %>%\n  group_rows(\"Mortality\", 1, nrow(mort_table))\n\n\n\n\n\n \n  \n    Outcome \n    Breakdown \n    C1 \n    C2 \n    C3 \n    C4 \n    Overall \n  \n \n\n  Mortality\n\n    Alive at day 28 \n     \n    577 (95) \n    588 (96) \n    271 (96) \n    44 (88) \n    1480 (95) \n  \n  \n    Death within 28 days \n    Total \n    19 (3) \n    15 (2) \n    10 (4) \n    6 (12) \n    50 (3) \n  \n  \n    Death within 28 days \n    Prior to discharge \n    15 (2) \n    11 (2) \n    10 (4) \n    4 (8) \n    40 (3) \n  \n  \n    Death within 28 days \n    Post-discharge \n    4 (1) \n    4 (1) \n    0 (0) \n    2 (4) \n    10 (1) \n  \n  \n    Unknown \n     \n    14 (2) \n    10 (2) \n    2 (1) \n    0 (0) \n    26 (2) \n  \n\n\n\nComposite primary endpoint breakdown - mortality."
  },
  {
    "objectID": "analyses/primary_outcome.html#vasopressorinotropic-requirement",
    "href": "analyses/primary_outcome.html#vasopressorinotropic-requirement",
    "title": "Primary Outcome",
    "section": "Vasopressor/inotropic requirement",
    "text": "Vasopressor/inotropic requirement\n\n\nSummarise the vasopressor/inotropes component\nvaso_table <- all_dat %>%\n  filter_acs_itt() %>%\n  group_by(CAssignment) %>%\n  summarise(\n    `Vasopressor/inotropes_Not required_` = sum(1 - ANY_vasop, na.rm = TRUE),\n    `Vasopressor/inotropes_Use within 28 days_Total` = sum(ANY_vasop, na.rm = TRUE),\n    `Vasopressor/inotropes_Use within 28 days_Prior to discharge` = sum(DD_vasop, na.rm = TRUE),\n    `Vasopressor/inotropes_Use within 28 days_Post-discharge` = sum(D28_vasop, na.rm = TRUE),\n    `Vasopressor/inotropes_Unknown_` = sum(is.na(ANY_vasop))\n  ) %>%\n  gather(key, Frequency, -CAssignment, factor_key = T) %>%\n  spread(CAssignment, Frequency) %>%\n  separate(key, into = c(\"Measure\", \"Outcome\", \"Breakdown\"), sep = \"_\") %>%\n  mutate(\n    Overall = C1 + C2 + C3 + C4,\n    across(C1:Overall, ~ sprintf(\"%i (%.0f)\", .x, 100 * .x / sum(.x[c(1,2,5)])))\n  )\nkable(\n  vaso_table %>% select(-1),\n  caption = \"Composite primary endpoint breakdown - vasopressor/inotropes.\",\n  align = \"llrrrr\") %>%\n  kable_styling(font_size = 11) %>%\n  collapse_rows(1, valign = \"top\", latex_hline = 'custom', custom_latex_hline = 1) %>%\n  group_rows(\"Vasopressor/inotropes\", 1, nrow(vaso_table))\n\n\n\n\n\n \n  \n    Outcome \n    Breakdown \n    C1 \n    C2 \n    C3 \n    C4 \n    Overall \n  \n \n\n  Vasopressor/inotropes\n\n    Not required \n     \n    591 (97) \n    595 (97) \n    273 (96) \n    48 (96) \n    1507 (97) \n  \n  \n    Use within 28 days \n    Total \n    6 (1) \n    6 (1) \n    6 (2) \n    2 (4) \n    20 (1) \n  \n  \n    Use within 28 days \n    Prior to discharge \n    5 (1) \n    6 (1) \n    6 (2) \n    2 (4) \n    19 (1) \n  \n  \n    Use within 28 days \n    Post-discharge \n    2 (0) \n    0 (0) \n    0 (0) \n    1 (2) \n    3 (0) \n  \n  \n    Unknown \n     \n    13 (2) \n    12 (2) \n    4 (1) \n    0 (0) \n    29 (2) \n  \n\n\n\nComposite primary endpoint breakdown - vasopressor/inotropes."
  },
  {
    "objectID": "analyses/primary_outcome.html#new-intensive-respiratory-support",
    "href": "analyses/primary_outcome.html#new-intensive-respiratory-support",
    "title": "Primary Outcome",
    "section": "New intensive respiratory support",
    "text": "New intensive respiratory support\n\n\nSummarise the ventilation component\nvent_table <- all_dat %>%\n  filter_acs_itt()  %>%\n  group_by(CAssignment) %>%\n  summarise(\n    `Ventilation_Not required_` = sum(1 - ANY_vent, na.rm = TRUE),\n    `Ventilation_Use within 28 days_Total` = sum(ANY_vent, na.rm = TRUE),\n    `Ventilation_Use within 28 days_Prior to discharge` = sum(ANY_DD_vent, na.rm = TRUE),\n    `Ventilation_Use within 28 days_Post-discharge` = sum(ANY_vent & ANY_DD_vent == 0, na.rm = TRUE),\n    `Ventilation_Unknown_` = sum(is.na(ANY_vent))\n  ) %>%\n  gather(key, Frequency, -CAssignment, factor_key = T) %>%\n  spread(CAssignment, Frequency) %>%\n  separate(key, into = c(\"Measure\", \"Outcome\", \"Breakdown\"), sep = \"_\") %>%\n  mutate(\n    Overall = C1 + C2 + C3 + C4,\n    across(C1:Overall, ~ sprintf(\"%i (%.0f)\", .x, 100 * .x / sum(.x[c(1, 2, 5)])))\n  )\nkable(\n  vent_table %>% select(-1),\n  caption = \"Composite primary endpoint breakdown - respiratory support.\",\n  align = \"llrr\") %>%\n  kable_styling(font_size = 11) %>%\n  collapse_rows(1, valign = \"top\", latex_hline = 'custom', custom_latex_hline = 1) %>%\n  group_rows(\"Ventilation\", 1, nrow(vent_table))\n\n\n\n\n\n \n  \n    Outcome \n    Breakdown \n    C1 \n    C2 \n    C3 \n    C4 \n    Overall \n  \n \n\n  Ventilation\n\n    Not required \n     \n    562 (92) \n    579 (94) \n    263 (93) \n    43 (86) \n    1447 (93) \n  \n  \n    Use within 28 days \n    Total \n    35 (6) \n    24 (4) \n    18 (6) \n    7 (14) \n    84 (5) \n  \n  \n    Use within 28 days \n    Prior to discharge \n    29 (5) \n    19 (3) \n    13 (5) \n    5 (10) \n    66 (4) \n  \n  \n    Use within 28 days \n    Post-discharge \n    6 (1) \n    5 (1) \n    5 (2) \n    2 (4) \n    18 (1) \n  \n  \n    Unknown \n     \n    13 (2) \n    10 (2) \n    2 (1) \n    0 (0) \n    25 (2) \n  \n\n\n\nComposite primary endpoint breakdown - respiratory support."
  },
  {
    "objectID": "analyses/primary_outcome.html#dama-and-likely-to-die",
    "href": "analyses/primary_outcome.html#dama-and-likely-to-die",
    "title": "Primary Outcome",
    "section": "DAMA and Likely to Die",
    "text": "DAMA and Likely to Die\nThere were 3 participants who were DAMA and identified as likely to die. However, the day 28 status was observed for all 3 participants, therefore, no-one met the primary endpoint due to DAMA and unknown day 28 status.\n\n\nSummarise the DAMA component\nall_dat %>%\n  filter_acs_itt()  %>%\n  select(DIS_DAMA, DIS_DAMAlikelytodie, D28_death) %>%\n  dplyr::count(DIS_DAMA, DIS_DAMAlikelytodie, D28_death) %>%\n  spread(D28_death, n) %>%\n  kable(\n    col.names = c(\"DAMA\", \"Likely to die by day 28\", \"No\", \"Yes\", \"(Missing)\")\n  ) %>%\n  kable_styling() %>%\n  add_header_above(c(\" \" = 2, \"Death by day 28\" = 3))\n\n\n\n\n \n\n\nDeath by day 28\n\n  \n    DAMA \n    Likely to die by day 28 \n    No \n    Yes \n    (Missing) \n  \n \n\n  \n    0 \n    0 \n    1447 \n    46 \n    24 \n  \n  \n    1 \n    0 \n    32 \n    2 \n    2 \n  \n  \n    1 \n    1 \n    1 \n    2 \n    NA"
  },
  {
    "objectID": "analyses/primary_outcome.html#composite",
    "href": "analyses/primary_outcome.html#composite",
    "title": "Primary Outcome",
    "section": "Composite",
    "text": "Composite\n\n\nSummarise the composite\ncomp_table <- all_dat %>%\n  filter_acs_itt()  %>%\n  group_by(CAssignment) %>%\n  summarise(\n    `Primary Outcome_No_`  = sum(1 - PO, na.rm = TRUE),\n    `Primary Outcome_Yes_` = sum(PO, na.rm = TRUE),\n    `Primary Outcome_Unknown_Total` = sum(is.na(PO)),\n    `Primary Outcome_Unknown_Day 28 status` = sum(is.na(PO) & is.na(D28_death)),\n    `Primary Outcome_Unknown_Vasopressor/inotropes` = \n      sum(is.na(PO) & !is.na(D28_death) & is.na(ANY_vasop))\n  ) %>%\n  gather(key, Frequency, -CAssignment, factor_key = T) %>%\n  spread(CAssignment, Frequency) %>%\n  separate(key, into = c(\"Measure\", \"Outcome\", \"Breakdown\"), sep = \"_\") %>%\n  mutate(\n    Overall = C1 + C2 + C3 + C4,\n    across(C1:Overall, ~ sprintf(\"%i (%.0f)\", .x, 100 * .x / sum(.x[1:3])))\n  )\nkable(\n  comp_table %>% select(-1),\n  align = \"llrr\") %>%\n  kable_styling(font_size = 11) %>%\n  collapse_rows(1, valign = \"top\", latex_hline = 'custom', custom_latex_hline = 1) %>%\n  group_rows(\"Primary outcome\", 1, nrow(comp_table))\n\n\n\n\n\n \n  \n    Outcome \n    Breakdown \n    C1 \n    C2 \n    C3 \n    C4 \n    Overall \n  \n \n\n  Primary outcome\n\n    No \n     \n    561 (92) \n    576 (94) \n    259 (92) \n    43 (86) \n    1439 (92) \n  \n  \n    Yes \n     \n    35 (6) \n    25 (4) \n    20 (7) \n    7 (14) \n    87 (6) \n  \n  \n    Unknown \n    Total \n    14 (2) \n    12 (2) \n    4 (1) \n    0 (0) \n    30 (2) \n  \n  \n    Unknown \n    Day 28 status \n    13 (2) \n    10 (2) \n    2 (1) \n    0 (0) \n    25 (2) \n  \n  \n    Unknown \n    Vasopressor/inotropes \n    1 (0) \n    2 (0) \n    2 (1) \n    0 (0) \n    5 (0) \n  \n\n\n\nTable 1:  Composite primary endpoint breakdown - overall. \n\n\n\n\nSummarise the all components\ntab <- bind_rows(comp_table, mort_table, vaso_table, vent_table)\ntab_head <- all_dat %>% \n  filter_acs_itt() %>% \n  dplyr::count(CAssignment = factor(CAssignment, labels = intervention_labels()$CAssignment[-1])) %>%\n  mutate(label = paste0(CAssignment, \"<br>(n = \", n, \")\")) %>%\n  pull(label) %>%\n  c(paste0(\"Overall<br><br>(n = \", nrow(all_dat %>% filter_acs_itt()), \")\"))\ncolnames(tab)[4:8] <- tab_head\nkable(\n  tab %>% select(-1),\n  align = \"llrrrrr\",\n  escape = F) %>%\n  kable_styling(font_size = 11) %>%\n  collapse_rows(1, valign = \"top\", latex_hline = 'custom', custom_latex_hline = 1) %>%\n  group_rows(\"Primary outcome\", 1, nrow(comp_table)) %>%\n  group_rows(\"Mortality\", nrow(comp_table) + 1, nrow(comp_table) + nrow(mort_table)) %>%\n  group_rows(\"Vasopressor/inotropes\", 11, 15) %>%\n  group_rows(\"Ventilation\", 16, 20)\n\n\n\n\n\n \n  \n    Outcome \n    Breakdown \n    Lowdose(n = 610) \n    Intermediatedose(n = 613) \n    Low dosewith aspirin(n = 283) \n    Therapeuticdose(n = 50) \n    Overall(n = 1556) \n  \n \n\n  Primary outcome\n\n    No \n     \n    561 (92) \n    576 (94) \n    259 (92) \n    43 (86) \n    1439 (92) \n  \n  \n    Yes \n     \n    35 (6) \n    25 (4) \n    20 (7) \n    7 (14) \n    87 (6) \n  \n  \n    Unknown \n    Total \n    14 (2) \n    12 (2) \n    4 (1) \n    0 (0) \n    30 (2) \n  \n  \n    Unknown \n    Day 28 status \n    13 (2) \n    10 (2) \n    2 (1) \n    0 (0) \n    25 (2) \n  \n  \n    Unknown \n    Vasopressor/inotropes \n    1 (0) \n    2 (0) \n    2 (1) \n    0 (0) \n    5 (0) \n  \n  Mortality\n\n    Alive at day 28 \n     \n    577 (95) \n    588 (96) \n    271 (96) \n    44 (88) \n    1480 (95) \n  \n  \n    Death within 28 days \n    Total \n    19 (3) \n    15 (2) \n    10 (4) \n    6 (12) \n    50 (3) \n  \n  \n    Death within 28 days \n    Prior to discharge \n    15 (2) \n    11 (2) \n    10 (4) \n    4 (8) \n    40 (3) \n  \n  \n    Death within 28 days \n    Post-discharge \n    4 (1) \n    4 (1) \n    0 (0) \n    2 (4) \n    10 (1) \n  \n  \n    Unknown \n     \n    14 (2) \n    10 (2) \n    2 (1) \n    0 (0) \n    26 (2) \n  \n  Vasopressor/inotropes\n\n    Not required \n     \n    591 (97) \n    595 (97) \n    273 (96) \n    48 (96) \n    1507 (97) \n  \n  \n    Use within 28 days \n    Total \n    6 (1) \n    6 (1) \n    6 (2) \n    2 (4) \n    20 (1) \n  \n  \n    Use within 28 days \n    Prior to discharge \n    5 (1) \n    6 (1) \n    6 (2) \n    2 (4) \n    19 (1) \n  \n  \n    Use within 28 days \n    Post-discharge \n    2 (0) \n    0 (0) \n    0 (0) \n    1 (2) \n    3 (0) \n  \n  \n    Unknown \n     \n    13 (2) \n    12 (2) \n    4 (1) \n    0 (0) \n    29 (2) \n  \n  Ventilation\n\n    Not required \n     \n    562 (92) \n    579 (94) \n    263 (93) \n    43 (86) \n    1447 (93) \n  \n  \n    Use within 28 days \n    Total \n    35 (6) \n    24 (4) \n    18 (6) \n    7 (14) \n    84 (5) \n  \n  \n    Use within 28 days \n    Prior to discharge \n    29 (5) \n    19 (3) \n    13 (5) \n    5 (10) \n    66 (4) \n  \n  \n    Use within 28 days \n    Post-discharge \n    6 (1) \n    5 (1) \n    5 (2) \n    2 (4) \n    18 (1) \n  \n  \n    Unknown \n     \n    13 (2) \n    10 (2) \n    2 (1) \n    0 (0) \n    25 (2) \n  \n\n\n\nTable 2:  Composite primary endpoint breakdown. \n\n\n\n\nSave table to outputs\ncolnames(tab)[4:8] <- linebreak(tab_head, align = \"c\", linebreaker = \"<br>\")\nout <- kable(\n  tab %>% select(-1),\n  format = \"latex\",\n  align = \"llrrrrr\",\n  booktabs = TRUE,\n  escape = F) %>%\n  kable_styling(font_size = 9, latex_options = \"HOLD_position\") %>%\n  collapse_rows(1, valign = \"top\", latex_hline = 'none') %>%\n  group_rows(\"Primary outcome\", 1, nrow(comp_table)) %>%\n  group_rows(\"Mortality\", nrow(comp_table) + 1, nrow(comp_table) + nrow(mort_table)) %>%\n  group_rows(\"Vasopressor/inotropes\", 11, 15) %>%\n  group_rows(\"Ventilation\", 16, 20)\nsave_tex_table(out, fn = \"outcomes/primary/composite-breakdown\")\n\n\n\n\nSummarise the component combinations\nlevs <- c(\"None\", \"Death + Vas./Ino. + Ventilation\", \"Death + Vas./Ino.\", \"Death + Ventilation\", \"Vas./Ino. + Ventilation\", \n          \"Death\", \"Vas./Ino.\", \"Ventilation\", \"Unknown\")\ntab <- all_dat %>%\n  filter_acs_itt()  %>%\n  group_by(CAssignment) %>%\n  summarise(\n    `Composite outcomes` = case_when(\n      PO == 0 ~ 0,\n      is.na(PO) ~ 99,\n      D28_death == 1 & ANY_vasop == 1 & ANY_vent == 1 ~ 1,\n      D28_death == 1 & ANY_vasop == 1 & ANY_vent == 0 ~ 2,\n      D28_death == 1 & ANY_vasop == 0 & ANY_vent == 1 ~ 3,\n      D28_death == 0 & ANY_vasop == 1 & ANY_vent == 1 ~ 4,\n      D28_death == 1 ~ 5,\n      ANY_vasop == 1 ~ 6,\n      ANY_vent == 1 ~ 7,\n    )) %>%\n  dplyr::count(CAssignment, `Composite outcomes`) %>%\n  mutate(`Composite outcomes` = factor(`Composite outcomes`, levels = c(0:7, 99), labels = levs)) %>%\n  spread(CAssignment, n, fill = 0) %>%\n  mutate(Overall = C1 + C2 + C3 + C4) %>%\n  mutate(across(C1:Overall, ~ sprintf(\"%i (%.0f)\", .x, 100 * .x / sum(.x))))\ncolnames(tab)[-1] <- tab_head\ncolnames(tab)[1] <- \"Composite outcomes, n (\\\\%)\"\nkable(\n  tab ,\n  align = \"lrrrrr\",\n  escape = F) %>%\n  kable_styling(font_size = 11)\n\n\n\n\n\n \n  \n    Composite outcomes, n (\\%) \n    Lowdose(n = 610) \n    Intermediatedose(n = 613) \n    Low dosewith aspirin(n = 283) \n    Therapeuticdose(n = 50) \n    Overall(n = 1556) \n  \n \n\n  \n    None \n    561 (92) \n    576 (94) \n    259 (92) \n    43 (86) \n    1439 (92) \n  \n  \n    Death + Vas./Ino. + Ventilation \n    6 (1) \n    3 (0) \n    3 (1) \n    2 (4) \n    14 (1) \n  \n  \n    Death + Ventilation \n    13 (2) \n    11 (2) \n    7 (2) \n    4 (8) \n    35 (2) \n  \n  \n    Vas./Ino. + Ventilation \n    0 (0) \n    2 (0) \n    1 (0) \n    0 (0) \n    3 (0) \n  \n  \n    Death \n    0 (0) \n    1 (0) \n    0 (0) \n    0 (0) \n    1 (0) \n  \n  \n    Vas./Ino. \n    0 (0) \n    1 (0) \n    2 (1) \n    0 (0) \n    3 (0) \n  \n  \n    Ventilation \n    16 (3) \n    7 (1) \n    7 (2) \n    1 (2) \n    31 (2) \n  \n  \n    Unknown \n    14 (2) \n    12 (2) \n    4 (1) \n    0 (0) \n    30 (2) \n  \n\n\n\nTable 3:  Observed outcome combinations. \n\n\n\n\nCode\ncolnames(tab) <- linebreak(colnames(tab), align = \"c\", linebreaker = \"<br>\")\nout <- kable(\n  tab,\n  format = \"latex\",\n  align = \"lrrrrr\",\n  booktabs = TRUE,\n  linesep = \"\",\n  escape = F) %>%\n  kable_styling(\n    font_size = 9, \n    latex_options = \"HOLD_position\")\nsave_tex_table(out, fn = \"outcomes/primary/composite-combinations\")"
  },
  {
    "objectID": "analyses/primary_outcome.html#by-interim-analysis",
    "href": "analyses/primary_outcome.html#by-interim-analysis",
    "title": "Primary Outcome",
    "section": "By Interim Analysis",
    "text": "By Interim Analysis\n\n\nCode\nintdat <- all_dat %>%\n  filter_acs_itt() %>%\n  mutate(\n    interim = as.character(case_when(\n      RandDate < get_interim_dates()$meet_date[1] ~ 1,\n      RandDate < get_interim_dates()$meet_date[2] ~ 2,\n      RandDate < get_interim_dates()$meet_date[3] ~ 3,\n      RandDate < get_interim_dates()$meet_date[4] ~ 4,\n      TRUE ~ 4\n    )),\n    CAssignment = factor(\n      CAssignment, labels = c(\"Low\", \"Intermediate\", \"Low\\nwith aspirin\", \"Therapuetic\"))\n  )\nintcounts <- intdat %>% \n  dplyr::count(interim) %>% \n  mutate(label = paste0(\"Interim \", interim, \" (n = \", n, \")\"))\ntrtcounts <- intdat %>% dplyr::count(CAssignment)\novrtab <- intdat %>%\n  group_by(interim = \"Overall\", CAssignment) %>%\n  summarise(\n    Randomised = \n      sprintf(\"%i\", n()),\n    Known = \n      sprintf(\"%i (%.0f)\", sum(!is.na(PO)), 100 * mean(!is.na(PO))),\n    `Met primary outcome` = \n      sprintf(\"%i (%.0f)\", sum(PO, na.rm = T), 100 * mean(PO, na.rm = T)),\n    `Death` = \n      sprintf(\"%i (%.0f)\", sum(D28_death, na.rm = T), 100 * mean(D28_death, na.rm = T)),\n    `Vasopressor/inotropic support` = \n      sprintf(\"%i (%.0f)\", sum(ANY_vasop, na.rm = T), 100 * mean(ANY_vasop, na.rm = T)),\n    `Intensive respiratory support` = \n      sprintf(\"%i (%.0f)\", sum(ANY_vent, na.rm = T), 100 * mean(ANY_vent, na.rm = T))\n  ) %>%\n  pivot_longer(`Randomised`:`Intensive respiratory support`, names_to = \"Outcome\") %>%\n  pivot_wider(names_from = CAssignment, values_from = value, values_fill = \"-\")\ninttab <- intdat %>%\n  group_by(interim, CAssignment) %>%\n  summarise(\n    Randomised = \n      sprintf(\"%i\", n()),\n    Known = \n      sprintf(\"%i (%.0f)\", sum(!is.na(PO)), 100 * mean(!is.na(PO))),\n    `Met primary outcome` = \n      sprintf(\"%i (%.0f)\", sum(PO, na.rm = T), 100 * mean(PO, na.rm = T)),\n    `Death` = \n      sprintf(\"%i (%.0f)\", sum(D28_death, na.rm = T), 100 * mean(D28_death, na.rm = T)),\n    `Vasopressor/inotropic support` = \n      sprintf(\"%i (%.0f)\", sum(ANY_vasop, na.rm = T), 100 * mean(ANY_vasop, na.rm = T)),\n    `Intensive respiratory support` = \n      sprintf(\"%i (%.0f)\", sum(ANY_vent, na.rm = T), 100 * mean(ANY_vent, na.rm = T))\n  ) %>%\n  pivot_longer(`Randomised`:`Intensive respiratory support`, names_to = \"Outcome\") %>%\n  pivot_wider(names_from = CAssignment, values_from = value, values_fill = \"-\")\ntab <- bind_rows(ovrtab, inttab)\n\nsavetab <- kable(\n  tab[, -1],\n  format = \"latex\",\n  align = \"lrrrr\",\n  booktabs = TRUE\n) %>%\n  kable_styling(\n    font_size = 9,\n    latex_options = \"HOLD_position\"\n  ) %>%\n  group_rows(paste0(\"Overall (n = \", sum(intcounts$n), \")\"), 1, 6) %>%\n  group_rows(intcounts$label[1], 7, 12) %>%\n  group_rows(intcounts$label[2], 13, 18) %>%\n  group_rows(intcounts$label[3], 19, 24) %>%\n  group_rows(intcounts$label[4], 25, 30)\nsave_tex_table(savetab, fn = \"outcomes/primary/primary-composite-interims\")\n\nkable(\n  tab[, -1],\n  format = \"html\",\n  align = \"lrrrr\",\n) %>%\n  kable_styling(\n    font_size = 9,\n    latex_options = \"HOLD_position\"\n  ) %>%\n  group_rows(paste0(\"Overall (n = \", sum(intcounts$n), \")\"), 1, 6) %>%\n  group_rows(intcounts$label[1], 7, 12) %>%\n  group_rows(intcounts$label[2], 13, 18) %>%\n  group_rows(intcounts$label[3], 19, 24) %>%\n  group_rows(intcounts$label[4], 25, 30)\n\n\n\n\n \n  \n    Outcome \n    Low \n    Intermediate \n    Low\nwith aspirin \n    Therapuetic \n  \n \n\n  Overall (n = 1556)\n\n    Randomised \n    610 \n    613 \n    283 \n    50 \n  \n  \n    Known \n    596 (98) \n    601 (98) \n    279 (99) \n    50 (100) \n  \n  \n    Met primary outcome \n    35 (6) \n    25 (4) \n    20 (7) \n    7 (14) \n  \n  \n    Death \n    19 (3) \n    15 (2) \n    10 (4) \n    6 (12) \n  \n  \n    Vasopressor/inotropic support \n    6 (1) \n    6 (1) \n    6 (2) \n    2 (4) \n  \n  \n    Intensive respiratory support \n    35 (6) \n    24 (4) \n    18 (6) \n    7 (14) \n  \n  Interim 1 (n = 685)\n\n    Randomised \n    234 \n    226 \n    225 \n    - \n  \n  \n    Known \n    227 (97) \n    222 (98) \n    222 (99) \n    - \n  \n  \n    Met primary outcome \n    22 (10) \n    15 (7) \n    19 (9) \n    - \n  \n  \n    Death \n    13 (6) \n    11 (5) \n    9 (4) \n    - \n  \n  \n    Vasopressor/inotropic support \n    2 (1) \n    3 (1) \n    6 (3) \n    - \n  \n  \n    Intensive respiratory support \n    22 (10) \n    15 (7) \n    17 (8) \n    - \n  \n  Interim 2 (n = 246)\n\n    Randomised \n    90 \n    98 \n    58 \n    - \n  \n  \n    Known \n    90 (100) \n    97 (99) \n    57 (98) \n    - \n  \n  \n    Met primary outcome \n    2 (2) \n    3 (3) \n    1 (2) \n    - \n  \n  \n    Death \n    1 (1) \n    3 (3) \n    1 (2) \n    - \n  \n  \n    Vasopressor/inotropic support \n    1 (1) \n    0 (0) \n    0 (0) \n    - \n  \n  \n    Intensive respiratory support \n    2 (2) \n    3 (3) \n    1 (2) \n    - \n  \n  Interim 3 (n = 384)\n\n    Randomised \n    177 \n    172 \n    - \n    35 \n  \n  \n    Known \n    173 (98) \n    167 (97) \n    - \n    35 (100) \n  \n  \n    Met primary outcome \n    8 (5) \n    4 (2) \n    - \n    6 (17) \n  \n  \n    Death \n    4 (2) \n    0 (0) \n    - \n    5 (14) \n  \n  \n    Vasopressor/inotropic support \n    3 (2) \n    2 (1) \n    - \n    2 (6) \n  \n  \n    Intensive respiratory support \n    8 (5) \n    4 (2) \n    - \n    6 (17) \n  \n  Interim 4 (n = 241)\n\n    Randomised \n    109 \n    117 \n    - \n    15 \n  \n  \n    Known \n    106 (97) \n    115 (98) \n    - \n    15 (100) \n  \n  \n    Met primary outcome \n    3 (3) \n    3 (3) \n    - \n    1 (7) \n  \n  \n    Death \n    1 (1) \n    1 (1) \n    - \n    1 (7) \n  \n  \n    Vasopressor/inotropic support \n    0 (0) \n    1 (1) \n    - \n    0 (0) \n  \n  \n    Intensive respiratory support \n    3 (3) \n    2 (2) \n    - \n    1 (7)"
  },
  {
    "objectID": "analyses/primary_outcome.html#age",
    "href": "analyses/primary_outcome.html#age",
    "title": "Primary Outcome",
    "section": "Age",
    "text": "Age\n\n\nRelationship age to outcome\nagedat <- acs_itt_dat %>%\n  dplyr::count(PO, AgeAtEntry) %>% \n  spread(PO, n, fill = 0) %>% \n  mutate(\n    n = `0` + `1` + `<NA>`,\n    p = `1` / (`1` + `0`))\nagemod <- glm(\n  cbind(`1`, `0`) ~ AgeAtEntry, \n  data = agedat, \n  family = binomial())\nagedat <- agedat %>%\n  mutate(\n    ypred = predict(agemod, newdata = agedat, type = \"response\")\n  )\np1 <- ggplot(agedat, aes(AgeAtEntry, n)) +\n  geom_col(colour = \"grey40\", fill = \"grey40\") +\n  geom_vline(xintercept = 60, linetype = 2) +\n  labs(y = \"Number of\\nparticipants\",\n       x = \"Age at entry\")\np2 <- ggplot(agedat, aes(AgeAtEntry, p)) +\n    geom_point() +\n    geom_vline(xintercept = 60, linetype = 2) +\n    geom_line(aes(y = ypred)) +\n    labs(y = \"Proportion\\nwith outcome\", x = \"Age at entry\")\np <- p1 | p2\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\")\nggsave(file.path(path, \"outcome-age.pdf\"), p, height = 2, width = 6)\np\n\n\n\n\n\nFigure 1: Relationship (logistic regression linear in age) between age at entry and the primary outcome.\n\n\n\n\n\n\nRelationship age 265 60 to outcome\nacs_itt_dat %>%\n  dplyr::count(`Age 60+` = agegte60, PO) %>%\n  group_by(`Age 60+`) %>%\n  spread(PO, n, fill = 0) %>%\n  mutate(\n    p_1 = `1` / (`1` + `0`),\n    p_miss = `<NA>` / (`1` + `0` + `<NA>`)\n  ) %>%\n  kable(digits = 2) %>%\n  kable_styling(bootstrap_options = \"striped\")\n\n\n\n\n\n \n  \n    Age 60+ \n    0 \n    1 \n    <NA> \n    p_1 \n    p_miss \n  \n \n\n  \n    0 \n    1034 \n    47 \n    21 \n    0.04 \n    0.02 \n  \n  \n    1 \n    405 \n    40 \n    9 \n    0.09 \n    0.02 \n  \n\n\n\nTable 4:  Relationship between age >= 60 and the primary outcome."
  },
  {
    "objectID": "analyses/primary_outcome.html#country",
    "href": "analyses/primary_outcome.html#country",
    "title": "Primary Outcome",
    "section": "Country",
    "text": "Country\n\n\nRelationship country to outcome\ntdat <- all_dat %>%\n  filter_acs_itt() %>%\n  dplyr::count(Country = factor(PT_CountryName, levels = c(\"India\", \"Australia\", \"Nepal\", \"New Zealand\")), PO) %>%\n  group_by(Country) %>%\n  spread(PO, n, fill = 0) %>%\n  mutate(\n    n = `1` + `0` + `<NA>`,\n    p_1 = `1` / (`1` + `0`),\n    p_miss = `<NA>` / (`1` + `0` + `<NA>`)\n  )\np1 <- ggplot(tdat, aes(Country, n)) +\n  geom_col() +\n    labs(\n      y = \"Number of\\nparticipants\", \n      x = \"Country of enrolment\")\np2 <- ggplot(tdat, aes(Country, p_1)) +\n  geom_point() +\n    labs(\n      y = \"Proportion meeting\\nprimary outcome\", \n      x = \"Country of enrolment\")  +\n  ylim(0, NA)\np <- p1 | p2\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\")\nggsave(file.path(path, \"outcome-country.pdf\"), p, height = 2, width = 6)\np\n\n\n\n\n\nFigure 2: Primary outcome by country."
  },
  {
    "objectID": "analyses/primary_outcome.html#site",
    "href": "analyses/primary_outcome.html#site",
    "title": "Primary Outcome",
    "section": "Site",
    "text": "Site\n\n\nRelationship site to outcome\ntdat <- all_dat %>%\n  filter_acs_itt() %>%\n  dplyr::count(\n    Country_lab = Country,\n    Site_lab = fct_infreq(Location),\n    Country = factor(PT_CountryName, levels = c(\"India\", \"Australia\", \"Nepal\", \"New Zealand\")),\n    Site = PT_LocationName,\n    PO) %>%\n  group_by(Country, Site) %>%\n  spread(PO, n, fill = 0) %>%\n  mutate(\n    n = `1` + `0` + `<NA>`,\n    p_1 = `1` / (`1` + `0`),\n    p_miss = `<NA>` / (`1` + `0` + `<NA>`)\n  ) %>%\n  ungroup()\n\np1 <- ggplot(tdat, aes(Site_lab, n)) +\n  facet_grid( ~ Country, scales = \"free_x\", space = \"free_x\") +\n  geom_col() +\n    labs(\n      y = \"Number of\\nparticipants\", \n      x = \"\") +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        panel.border = element_rect(fill = NA))\np2 <- ggplot(tdat, aes(Site_lab, p_1)) +\n  facet_grid( ~ Country, scales = \"free_x\", space = \"free_x\") +\n  geom_point() +\n    labs(\n      y = \"Proportion meeting\\nprimary outcome\", \n      x = \"Site of enrolment\") +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        panel.border = element_rect(fill = NA))\np <- p1 / p2\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\")\nggsave(file.path(path, \"outcome-country-site.pdf\"), p, height = 4, width = 6.25)\np\n\n\n\n\n\nFigure 3: Primary outcome by site within country."
  },
  {
    "objectID": "analyses/primary_outcome.html#calendar-time",
    "href": "analyses/primary_outcome.html#calendar-time",
    "title": "Primary Outcome",
    "section": "Calendar Time",
    "text": "Calendar Time\n\n\nRelationship calendar date to outcome\ncaldat <- acs_itt_dat %>%\n  dplyr::count(PO, yr = year(RandDate), mth = month(RandDate)) %>% \n  spread(PO, n, fill = 0) %>% \n  mutate(p = `1` / (`1` + `0`),\n         n = `1` + `0` + `<NA>`)\np1 <- ggplot(caldat, aes(mth, p)) +\n  facet_grid( ~ yr, drop = T, scales = \"free_x\", space = \"free\") +\n    geom_point() +\n    labs(\n      y = \"Proportion meeting\\nprimary outcome\", \n      x = \"Calendar date (month of year)\") +\n  scale_x_continuous(breaks = 1:12) +\n  ylim(0, 0.25)\np2 <- ggplot(caldat, aes(mth, n)) +\n  facet_grid( ~ yr, drop = T, scales = \"free_x\", space = \"free\") +\n    geom_col() +\n    labs(\n      y = \"Number of\\nparticipants\", \n      x = \"Calendar date (month of year)\") +\n  scale_x_continuous(breaks = 1:12)\np <- p2 | p1\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\")\nggsave(file.path(path, \"outcome-calendar-time.pdf\"), p, height = 2, width = 6)\np\n\n\n\n\n\nFigure 4: Relationship between calendar date and the primary outcome."
  },
  {
    "objectID": "analyses/primary_outcome.html#country-and-calendar-time",
    "href": "analyses/primary_outcome.html#country-and-calendar-time",
    "title": "Primary Outcome",
    "section": "Country and Calendar Time",
    "text": "Country and Calendar Time\n\n\nCode\nacs_itt_nona_dat %>% \n  dplyr::group_by(country, epoch) %>% \n  summarise(n = sprintf(\"%i/%i (%.2f)\", sum(PO), n(), mean(PO))) %>% \n  spread(country, n, fill = 0)\n\n\n# A tibble: 12 × 5\n   epoch IN            AU          NP          NZ        \n   <dbl> <chr>         <chr>       <chr>       <chr>     \n 1     1 1/95 (0.01)   0/11 (0.00) 1/25 (0.04) 0/1 (0.00)\n 2     2 1/54 (0.02)   1/5 (0.20)  1/12 (0.08) 0/3 (0.00)\n 3     3 0/62 (0.00)   0/12 (0.00) 4/25 (0.16) 1/3 (0.33)\n 4     4 1/79 (0.01)   2/16 (0.12) 5/53 (0.09) 0/4 (0.00)\n 5     5 4/123 (0.03)  2/25 (0.08) 0           2/3 (0.67)\n 6     6 1/102 (0.01)  1/21 (0.05) 0           0/4 (0.00)\n 7     7 4/91 (0.04)   0/26 (0.00) 0           0         \n 8     8 3/137 (0.02)  0           0           0/1 (0.00)\n 9     9 11/155 (0.07) 0           0           0/1 (0.00)\n10    10 27/191 (0.14) 0/2 (0.00)  0           0         \n11    11 8/102 (0.08)  0           0           0         \n12    12 6/82 (0.07)   0           0           0"
  },
  {
    "objectID": "analyses/primary_outcome.html#days-since-symptom-onset",
    "href": "analyses/primary_outcome.html#days-since-symptom-onset",
    "title": "Primary Outcome",
    "section": "Days since symptom onset",
    "text": "Days since symptom onset\n\n\nRelationship days since sympton onset to outcome\ndsfsdat <- acs_itt_dat %>%\n  dplyr::count(PO, dsfs) %>% \n  spread(PO, n, fill = 0) %>% \n  mutate(n = `1` + `0` + `<NA>`,\n         p = `1` / (`1` + `0`))\ndsfsmod <- glm(\n  cbind(`1`, `0`) ~ dsfs, \n  data = dsfsdat, \n  family = binomial())\ndsfsdat <- dsfsdat %>%\n  mutate(\n    ypred = predict(dsfsmod, newdata = dsfsdat, type = \"response\")\n  )\np1 <- ggplot(dsfsdat, aes(dsfs, n)) +\n  geom_col(colour = \"grey40\", fill = \"grey40\") +\n  geom_vline(xintercept = 7.5, linetype = 2) +\n  labs(y = \"Number of\\nparticipants\",\n       x = \"Days since first symptoms\")\np2 <- ggplot(dsfsdat, aes(dsfs, p)) +\n    geom_point() +\n    geom_vline(xintercept = 7.5, linetype = 2) +\n    geom_line(aes(y = ypred)) +\n    labs(y = \"Proportion\\nwith outcome\", \n         x = \"Days since first symptoms\")\np <- p1 | p2\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\")\nggsave(file.path(path, \"outcome-dsfs.pdf\"), p, height = 2, width = 6)\np\n\n\n\n\n\nFigure 5: Relationship (logistic regression linear) between days since symptom onset at entry and the primary outcome."
  },
  {
    "objectID": "analyses/primary_outcome.html#oxygen",
    "href": "analyses/primary_outcome.html#oxygen",
    "title": "Primary Outcome",
    "section": "Oxygen",
    "text": "Oxygen\n\n\nRelationship of on room air at baseline to outcome\nall_dat %>%\n  filter_fas_itt() %>%\n  dplyr::count(BAS_OnRoomAir24hrsUnknown, BAS_OnRoomAir24hrs, PO) %>%\n  spread(PO, n, fill = 0) %>%\n  mutate(\n    p_1 = `1` / (`1` + `0`),\n    p_miss = `<NA>` / (`1` + `0` + `<NA>`)\n  ) %>%\n  kable(digits = 2) %>%\n  kable_styling(bootstrap_options = \"striped\")\n\n\n\n\n\n \n  \n    BAS_OnRoomAir24hrsUnknown \n    BAS_OnRoomAir24hrs \n    0 \n    1 \n    <NA> \n    p_1 \n    p_miss \n  \n \n\n  \n    No \n    No \n    319 \n    28 \n    10 \n    0.08 \n    0.03 \n  \n  \n    No \n    Yes \n    1113 \n    63 \n    23 \n    0.05 \n    0.02 \n  \n  \n    Yes \n    No \n    25 \n    0 \n    0 \n    0.00 \n    0.00 \n  \n\n\n\nTable 5:  Relationship between on room air and the primary outcome. \n\n\n\n\nRelationship oxygen saturation to outcome\npodat <- acs_itt_dat %>%\n  dplyr::count(PO, oxygen_sat) %>% \n  spread(PO, n, fill = 0) %>% \n  mutate(p = `1` / (`1` + `0`))\npomod <- glm(\n  cbind(`1`, `0`) ~ I(oxygen_sat - 94), \n  data = podat, \n  family = binomial())\npodat <- podat %>%\n  mutate(\n    ypred = predict(pomod, newdata = podat, type = \"response\")\n  )\np <- ggplot(podat, aes(oxygen_sat, p)) +\n    geom_point() +\n    geom_line(aes(y = ypred)) +\n    labs(y = \"Proportion with outcome\", x = \"Days since onset\")\nggplotly(p)\n\n\n\n\n\nFigure 6: Relationship (logistic regression linear) between oxygen saturation at entry and the primary outcome."
  },
  {
    "objectID": "analyses/primary_outcome.html#anti-coagulation-domain",
    "href": "analyses/primary_outcome.html#anti-coagulation-domain",
    "title": "Primary Outcome",
    "section": "Anti-coagulation Domain",
    "text": "Anti-coagulation Domain\n\n\nRelationship anti-coagulation to outcome\nmake_po_table(\n    all_dat %>%\n      filter_acs_itt()\n)\n\n\n\n\n\n \n  \n    n (\\%) \n    Lowdose \n    Intermediatedose \n    Low dosewith aspirin \n    Therapeuticdose \n    Overall \n  \n \n\n  \n    Randomised \n    610 \n    613 \n    283 \n    50 \n    1556 \n  \n  \n    Outcome missing \n    14 (2.3) \n    12 (2.0) \n    4 (1.4) \n    0 (0.0) \n    30 (1.9) \n  \n  \n    Outcome observed \n    596 (97.7) \n    601 (98.0) \n    279 (98.6) \n    50 (100.0) \n    1526 (98.1) \n  \n  \n    Met primary outcome \n    35 (5.9) \n    25 (4.2) \n    20 (7.2) \n    7 (14.0) \n    87 (5.7) \n  \n\n\n\nTable 5:  Primary outcome by anti-coagulation intervention. \n\n\nRelationship anti-coagulation to outcome\nsave_tex_table(make_po_table(\n      all_dat %>%\n      filter_acs_itt(),\n      \"latex\"), \n      \"outcomes/primary/anticoagulation-summary\")"
  },
  {
    "objectID": "analyses/primary_outcome.html#acs-itt",
    "href": "analyses/primary_outcome.html#acs-itt",
    "title": "Primary Outcome",
    "section": "ACS-ITT",
    "text": "ACS-ITT\nIn these analyses, the population is restricted to participants who were randomised to the anti-coagulation domain.\n\nTreatment only\n\n\nData and sampling treatment only model\nres <- fit_primary_model(acs_itt_nona_dat, logistic_mod, seed = 17250)\nnames(res$drws$OR) <- intervention_labels2()$CAssignment[-(1:2)]\n\n\n\n\nCode\nplot_or_densities(res$drws$OR)\n\n\n\n\n\nFigure 6: Posterior densities for odds ratio contrasts.\n\n\n\n\n\n\nCode\nodds_ratio_summary_table(res$drws$OR)\n\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate-dose \n    0.71 \n    (0.43, 1.20) \n    0.74 (0.20) \n    0.90 \n  \n  \n    Low-dose with aspirin \n    1.23 \n    (0.70, 2.14) \n    1.28 (0.37) \n    0.23 \n  \n  \n    Therapeutic-dose \n    2.40 \n    (0.95, 5.34) \n    2.60 (1.16) \n    0.03 \n  \n\n\n\nTable 6:  Posterior summaries for odds ratio contrasts. \n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nres$fit$summary(\"beta\")\n\n\n# A tibble: 6 × 10\n  variable    mean  median    sd   mad      q5     q95  rhat ess_bulk ess_tail\n  <chr>      <dbl>   <dbl> <dbl> <dbl>   <dbl>   <dbl> <dbl>    <dbl>    <dbl>\n1 beta[1]  -2.62   -2.61   0.143 0.143 -2.86   -2.39    1.00   15499.   14290.\n2 beta[2]   0.485   0.494  0.334 0.330 -0.0778  1.02    1.00   17188.   14447.\n3 beta[3]  -0.210  -0.210  0.210 0.211 -0.554   0.136   1.00   17721.   15370.\n4 beta[4]  -0.695  -0.694  0.246 0.245 -1.10   -0.289   1.00   17656.   15552.\n5 beta[5]  -0.0510 -0.0333 0.399 0.396 -0.735   0.580   1.00   20107.   14608.\n6 beta[6]  -0.785  -0.774  0.504 0.501 -1.63    0.0235  1.00   21997.   13319.\n\n\nCode\nres$fit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 1.0843 1.0378 1.0546 1.1228 1.0945 1.0608 0.9765 1.0343\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"beta\"])\n\n\n\n\n\n\n\n\n\n\nTreatment plus covariates (no site or epoch)\nUnder this model a component is added for country (region), \\(\\mathbb{I}[\\text{age}\\geq 60]\\), and intervention specific ineligibility (C3 only)\n\n\nNew terms:\n\\[\n\\begin{aligned}\n\\rho_1 &= 0 \\\\\n\\rho_r &\\overset{\\text{iid}}{\\sim} \\text{Normal}(0, 1), r=2,...,R,\\\\\n\\beta_{\\text{age}\\geq 60} &\\sim \\text{Normal}(0, 2.5^2) \\\\\n\\beta_{\\text{inelgC3}} &\\sim \\text{Normal}(0, 10)\n\\end{aligned}\n\\]\n\n\nCode\nres <- fit_primary_model(\n  acs_itt_nona_dat, \n  logistic_mod, \n  vars = c(\"inelgc3\", \"agegte60\", \"ctry\"),\n  beta_sd_var = c(10, 2.5, 1, 1),\n  seed = 71236)\nnames(res$drws$OR) <- c(\n  intervention_labels2()$CAssignment[-(1:2)], \n  \"Ineligible aspirin\", \"Age \\u2265 60\", \"Australia/New Zealand\", \"Nepal\")\n\n\n\n\nCode\nplot_or_densities(res$drws$OR)\n\n\n\n\n\nFigure 7: Posterior densities for odds ratio contrasts.\n\n\n\n\n\n\nCode\nodds_ratio_summary_table(res$drws$OR)\n\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate-dose \n    0.71 \n    (0.42, 1.21) \n    0.74 (0.20) \n    0.90 \n  \n  \n    Low-dose with aspirin \n    1.32 \n    (0.73, 2.33) \n    1.37 (0.41) \n    0.18 \n  \n  \n    Therapeutic-dose \n    1.85 \n    (0.68, 4.60) \n    2.05 (1.03) \n    0.11 \n  \n  \n    Ineligible aspirin \n    2.39 \n    (0.74, 6.29) \n    2.67 (1.44) \n    0.07 \n  \n  \n    Age ≥ 60 \n    1.96 \n    (1.25, 3.05) \n    2.01 (0.46) \n    0.00 \n  \n  \n    Australia/New Zealand \n    1.00 \n    (0.29, 3.06) \n    1.17 (0.74) \n    0.50 \n  \n  \n    Nepal \n    1.43 \n    (0.65, 2.92) \n    1.53 (0.59) \n    0.18 \n  \n\n\n\nTable 7:  Posterior summaries for odds ratio contrasts. \n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nres$fit$summary(\"beta\")\n\n\n# A tibble: 10 × 10\n   variable    mean   median    sd   mad      q5      q95  rhat ess_bulk\n   <chr>      <dbl>    <dbl> <dbl> <dbl>   <dbl>    <dbl> <dbl>    <dbl>\n 1 beta[1]  -3.00   -3.00    0.198 0.197 -3.33   -2.68     1.00   14028.\n 2 beta[2]   0.253   0.255   0.378 0.378 -0.379   0.866    1.00   15820.\n 3 beta[3]  -0.155  -0.158   0.216 0.216 -0.506   0.198    1.00   19065.\n 4 beta[4]  -0.626  -0.628   0.261 0.262 -1.05   -0.193    1.00   17111.\n 5 beta[5]   0.0869  0.0802  0.646 0.645 -0.960   1.15     1.00   16336.\n 6 beta[6]  -0.795  -0.787   0.497 0.495 -1.62    0.00501  1.00   21338.\n 7 beta[7]   0.843   0.873   0.542 0.532 -0.0981  1.68     1.00   22546.\n 8 beta[8]   0.674   0.675   0.226 0.224  0.298   1.05     1.00   18977.\n 9 beta[9]  -0.0176 -0.00389 0.606 0.600 -1.03    0.953    1.00   16486.\n10 beta[10]  0.352   0.358   0.382 0.381 -0.290   0.965    1.00   18103.\n# … with 1 more variable: ess_tail <dbl>\n\n\nCode\nres$fit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 1.0215 1.0098 1.0926 1.0081 1.0257 0.9988 1.0248 1.0574\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"beta\"])\n\n\n\n\n\n\n\n\n\n\nTreatment plus covariates plus site (no epoch)\nUnder this model a component is added for site nested within country.\n\n\nNew terms\n\\[\n\\begin{aligned}\n\\xi_{rs} &\\overset{\\text{iid}}{\\sim}\\text{Normal}(0,\\sigma^2_{r}), s=1,...,S_r, r=1,...,R \\\\\n\\sigma_r &\\overset{\\text{iid}}{\\sim} \\text{Half-}t(3, 1).\n\\end{aligned}\n\\]\n\n\nData and sampling no site or epoch model\nres <- fit_primary_model(\n  acs_itt_nona_dat, \n  logistic_site_mod, \n  vars = c(\"inelgc3\", \"agegte60\", \"ctry\"),\n  beta_sd_var = c(10, 2.5, 1, 1),\n  seed = 52765,\n  adapt_delta = 0.95)\nnames(res$drws$OR) <- c(\n  intervention_labels2()$CAssignment[-(1:2)], \n  \"Ineligible aspirin\", \"Age \\u2265 60\", \"Australia/New Zealand\", \"Nepal\")\n\n\n\n\nCode\nplot_or_densities(res$drws$OR)\n\n\n\n\n\nFigure 8: Posterior densities for odds ratio contrasts.\n\n\n\n\n\n\nCode\nodds_ratio_summary_table(res$drws$OR)\n\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate-dose \n    0.72 \n    (0.41, 1.24) \n    0.75 (0.21) \n    0.88 \n  \n  \n    Low-dose with aspirin \n    0.94 \n    (0.51, 1.74) \n    0.99 (0.31) \n    0.57 \n  \n  \n    Therapeutic-dose \n    2.07 \n    (0.73, 5.66) \n    2.37 (1.31) \n    0.08 \n  \n  \n    Ineligible aspirin \n    2.72 \n    (0.75, 8.52) \n    3.20 (2.07) \n    0.06 \n  \n  \n    Age ≥ 60 \n    1.80 \n    (1.11, 2.93) \n    1.86 (0.46) \n    0.01 \n  \n  \n    Australia/New Zealand \n    1.01 \n    (0.22, 4.21) \n    1.32 (1.10) \n    0.49 \n  \n  \n    Nepal \n    1.87 \n    (0.46, 6.63) \n    2.30 (1.70) \n    0.17 \n  \n\n\n\nTable 8:  Posterior summaries for odds ratio contrasts. \n\n\n\n\nCode\nplot_site_terms(\n  exp(res$drws$gamma_site), \n  factor(\n    res$dat$region_by_site, \n    labels = c(\"India\", \"Australia\\nNew Zealand\", \"Nepal\"))\n)\n\n\n\n\n\nFigure 9: Site effect odds ratios.\n\n\n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nres$fit$summary(c(\"beta\", \"gamma_site\", \"tau_site\"))\n\n\n# A tibble: 39 × 10\n   variable     mean  median    sd   mad      q5     q95  rhat ess_bulk ess_tail\n   <chr>       <dbl>   <dbl> <dbl> <dbl>   <dbl>   <dbl> <dbl>    <dbl>    <dbl>\n 1 beta[1]  -3.56    -3.55   0.532 0.519 -4.45   -2.71    1.00    5496.    8830.\n 2 beta[2]   0.576    0.577  0.404 0.399 -0.101   1.23    1.00   17006.   14724.\n 3 beta[3]  -0.0975  -0.0956 0.228 0.228 -0.474   0.280   1.00   18674.   15698.\n 4 beta[4]  -0.526   -0.526  0.272 0.272 -0.974  -0.0808  1.00   17773.   14426.\n 5 beta[5]   0.195    0.196  0.700 0.702 -0.961   1.35    1.00   16795.   14547.\n 6 beta[6]  -0.966   -0.955  0.547 0.542 -1.88   -0.0897  1.00   23767.   14794.\n 7 beta[7]   0.978    1.00   0.619 0.613 -0.0588  1.95    1.00   22493.   14369.\n 8 beta[8]   0.588    0.586  0.246 0.243  0.184   0.992   1.00   25540.   15554.\n 9 beta[9]   0.00242  0.0117 0.750 0.745 -1.26    1.20    1.00   12505.   14538.\n10 beta[10]  0.614    0.627  0.667 0.645 -0.510   1.68    1.00    9105.   12175.\n# … with 29 more rows\n\n\nCode\nres$fit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 2\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.8537 0.8557 0.8084 0.8207 0.7391 0.8056 0.8420 0.7953\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"gamma_site\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"tau_site\"])\n\n\n\n\n\n\n\n\n\n\nTreatment plus covariates plus epoch (no site)\n\n\nReplace site terms with epoch terms\n\\[\n\\begin{aligned}\n\\tau_1 &= 0 \\\\\n\\tau_t &= \\tau_{t-1} + \\sigma_\\tau\\epsilon_t \\\\\n\\epsilon_t &\\overset{\\text{iid}}{\\sim} \\text{Normal}(0,1) \\\\\n\\sigma_\\tau &\\sim \\text{Half-}t(3, 1)\n\\end{aligned}\n\\]\n\n\nData and sampling no site model\nres <- fit_primary_model(\n  acs_itt_nona_dat, \n  logistic_epoch_mod, \n  vars = c(\"inelgc3\", \"agegte60\", \"ctry\"),\n  beta_sd_var = c(10, 2.5, 1, 1),\n  seed = 76405,\n  adapt_delta = 0.98)\nnames(res$drws$OR) <- c(\n  intervention_labels2()$CAssignment[-(1:2)], \n  \"Ineligible aspirin\", \"Age \\u2265 60\", \"Australia/New Zealand\", \"Nepal\")\n\n\n\n\nCode\nplot_or_densities(res$drws$OR)\n\n\n\n\n\nFigure 10: Posterior densities for odds ratio contrasts.\n\n\n\n\n\n\nCode\nodds_ratio_summary_table(res$drws$OR)\n\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate-dose \n    0.73 \n    (0.43, 1.24) \n    0.76 (0.21) \n    0.87 \n  \n  \n    Low-dose with aspirin \n    0.92 \n    (0.50, 1.68) \n    0.97 (0.31) \n    0.60 \n  \n  \n    Therapeutic-dose \n    2.30 \n    (0.83, 6.08) \n    2.59 (1.39) \n    0.05 \n  \n  \n    Ineligible aspirin \n    1.70 \n    (0.52, 4.59) \n    1.92 (1.07) \n    0.17 \n  \n  \n    Age ≥ 60 \n    1.95 \n    (1.22, 3.09) \n    2.00 (0.48) \n    0.00 \n  \n  \n    Australia/New Zealand \n    1.41 \n    (0.40, 4.58) \n    1.70 (1.11) \n    0.29 \n  \n  \n    Nepal \n    2.91 \n    (1.15, 7.19) \n    3.23 (1.58) \n    0.01 \n  \n\n\n\nTable 9:  Posterior summaries for odds ratio contrasts. \n\n\n\n\nCode\nplot_epoch_terms(\n  exp(res$drws$gamma_epoch)\n)\n\n\n\n\n\nFigure 11: Epoch effect odds ratios.\n\n\n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nres$fit$summary(c(\"beta\", \"gamma_epoch\", \"tau_epoch\"))\n\n\n# A tibble: 23 × 10\n   variable   mean median    sd   mad      q5     q95  rhat ess_bulk ess_tail\n   <chr>     <dbl>  <dbl> <dbl> <dbl>   <dbl>   <dbl> <dbl>    <dbl>    <dbl>\n 1 beta[1]  -4.22  -4.19  0.528 0.511 -5.13   -3.39    1.00   15486.   12840.\n 2 beta[2]   0.659  0.662 0.406 0.402 -0.0127  1.32    1.00   18941.   15955.\n 3 beta[3]  -0.125 -0.122 0.219 0.219 -0.486   0.235   1.00   20213.   15097.\n 4 beta[4]  -0.535 -0.534 0.266 0.267 -0.976  -0.102   1.00   18884.   15031.\n 5 beta[5]   0.348  0.340 0.654 0.651 -0.709   1.43    1.00   16689.   14620.\n 6 beta[6]  -0.833 -0.819 0.512 0.507 -1.70   -0.0150  1.00   25915.   14359.\n 7 beta[7]   0.504  0.530 0.553 0.547 -0.431   1.37    1.00   24106.   13640.\n 8 beta[8]   0.663  0.667 0.237 0.236  0.273   1.05    1.00   25646.   14940.\n 9 beta[9]   0.339  0.346 0.622 0.625 -0.707   1.34    1.00   17486.   14074.\n10 beta[10]  1.06   1.07  0.465 0.464  0.291   1.82    1.00   17849.   14963.\n# … with 13 more rows\n\n\nCode\nres$fit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.8896 0.7985 0.8545 0.8386 0.8910 0.8580 0.8231 0.8728\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"gamma_epoch\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"tau_epoch\"])\n\n\n\n\n\n\n\n\n\n\nPrimary Model\n\n\nData and sampling primary model\nres <- fit_primary_model(\n  acs_itt_nona_dat,\n  primary_mod,\n  vars = c(\"inelgc3\", \"agegte60\", \"ctry\"),\n  beta_sd_var = c(10, 2.5, 1, 1),\n  seed = 32915,\n  adapt_delta = 0.99\n)\nres$fit$save_object(file.path(\"outputs\", \"models\", \"primary\", \"acs-itt-primary.rds\"))\nnames(res$drws$OR) <- c(\n  intervention_labels2()$CAssignment[-(1:2)], \n  \"Ineligible aspirin\", \"Age \\u2265 60\", \"Australia/New Zealand\", \"Nepal\")\n\n\n\n\nCode\nsave_tex_table(\n  odds_ratio_summary_table(res$drws$OR, \"latex\"),\n  \"outcomes/primary/primary-model-acs-itt-summary-table\")\nodds_ratio_summary_table(res$drws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate-dose \n    0.74 \n    (0.43, 1.27) \n    0.77 (0.22) \n    0.86 \n  \n  \n    Low-dose with aspirin \n    0.88 \n    (0.47, 1.64) \n    0.93 (0.30) \n    0.65 \n  \n  \n    Therapeutic-dose \n    2.22 \n    (0.77, 6.20) \n    2.55 (1.45) \n    0.07 \n  \n  \n    Ineligible aspirin \n    2.50 \n    (0.69, 7.93) \n    2.96 (1.94) \n    0.08 \n  \n  \n    Age ≥ 60 \n    1.88 \n    (1.16, 3.04) \n    1.94 (0.49) \n    0.01 \n  \n  \n    Australia/New Zealand \n    1.05 \n    (0.23, 4.39) \n    1.37 (1.13) \n    0.47 \n  \n  \n    Nepal \n    2.17 \n    (0.51, 7.67) \n    2.66 (1.97) \n    0.13 \n  \n\n\n\nPosterior summaries for model parameters.\n\n\n\nCode\nsave_tex_table(\n  decision_quantity_summary_table(c(\"Low\" = rvar(1), res$drws$OR[1:3]), \"latex\"),\n  \"outcomes/primary/primary-model-acs-itt-decision-table\")\ndecision_quantity_summary_table(\n  c(\"Low\" = rvar(1), res$drws$OR[1:3])\n)\n\n\n\n\n\n \n  \n    Intervention \n    Posterior \n    Superior\nPr(OR = min(OR)) \n    Effective\nPr(OR < 1) \n    Futile\nPr(OR > 1/1.1) \n    Equivalent\nPr(1/1.1 < OR < 1.1) \n  \n \n\n  \n    Low \n    1.00 \n    0.08 \n    - \n    - \n    - \n  \n  \n    Intermediate-dose \n    0.74 (0.43, 1.27) \n    0.63 \n    0.86 \n    0.23 \n    0.15 \n  \n  \n    Low-dose with aspirin \n    0.88 (0.47, 1.64) \n    0.27 \n    0.65 \n    0.47 \n    0.22 \n  \n  \n    Therapeutic-dose \n    2.22 (0.77, 6.20) \n    0.02 \n    0.07 \n    0.95 \n    0.04 \n  \n\n\n\nTable 10:  Decision quantity summaries \n\n\n\n\nCode\np <- plot_or_densities(res$drws$OR[1:3]) +\n  labs(x = \"Odds ratio (log scale)\", y = \"Comparison\")\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\", \"primary-model-acs-itt-odds-ratio-densities.pdf\")\nggsave(pth, p, width = 6, height = 2.5)\np\n\n\n\n\n\nFigure 12: Posterior densities for odds ratio contrasts.\n\n\n\n\n\n\nCode\np <- plot_epoch_site_terms(\n  exp(res$drws$gamma_epoch), \n  exp(res$drws$gamma_site),\n  factor(\n    res$dat$region_by_site, \n    labels = c(\"India\", \"Australia\\nNew Zealand\", \"Nepal\"))\n)\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\", \"primary-model-acs-itt-epoch-site-terms.pdf\")\nggsave(pth, p, width = 6, height = 4.5)\np\n\n\n\n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nres$fit$summary(c(\"beta\", \"gamma_epoch\", \"tau_epoch\", \"gamma_site\", \"tau_site\"))\n\n\n# A tibble: 52 × 10\n   variable    mean  median    sd   mad      q5     q95  rhat ess_bulk ess_tail\n   <chr>      <dbl>   <dbl> <dbl> <dbl>   <dbl>   <dbl> <dbl>    <dbl>    <dbl>\n 1 beta[1]  -4.07   -4.06   0.671 0.654 -5.21   -3.01    1.00    8389.   12597.\n 2 beta[2]   0.666   0.668  0.420 0.416 -0.0262  1.36    1.00   20492.   15814.\n 3 beta[3]  -0.105  -0.103  0.228 0.227 -0.483   0.270   1.00   22714.   15494.\n 4 beta[4]  -0.502  -0.499  0.277 0.277 -0.961  -0.0501  1.00   20392.   14539.\n 5 beta[5]   0.224   0.218  0.698 0.697 -0.910   1.37    1.00   19342.   15216.\n 6 beta[6]  -0.947  -0.944  0.542 0.533 -1.84   -0.0635  1.00   27617.   15229.\n 7 beta[7]   0.899   0.915  0.624 0.618 -0.162   1.89    1.00   27309.   14051.\n 8 beta[8]   0.634   0.633  0.248 0.249  0.222   1.04    1.00   27924.   14818.\n 9 beta[9]   0.0392  0.0515 0.755 0.752 -1.24    1.26    1.00   14945.   14640.\n10 beta[10]  0.749   0.773  0.687 0.683 -0.428   1.83    1.00   11783.   13803.\n# … with 42 more rows\n\n\nCode\nres$fit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.8537 0.7930 0.7605 0.7244 0.7954 0.7820 0.7752 0.7430\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"beta\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"gamma_epoch\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"tau_epoch\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"gamma_site\"])\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"tau_site\"])\n\n\n\n\n\n\n\n\n\nPosterior Predictive Checks\n\n\nCode\ny_ppc <- res$drws$y_ppc\nppc_dat <- bind_cols(acs_itt_nona_dat, tibble(y_ppc = y_ppc))\n\ngrp_ppc <- function(grp) {\n  ppc_dat %>%\n    group_by(grp = !!grp) %>%\n    summarise(\n      mean_y = mean(PO),\n      rvar_mean_y_ppc = rvar_mean(y_ppc)\n    )\n}\nplot_grp_ppc <- function(dat, lab = \"\") {\n  dat %>%\n    ggplot(aes(y = grp, xdist = rvar_mean_y_ppc)) +\n    stat_interval(size = 2) +\n    geom_point(aes(x = mean_y, y = 1:nrow(dat)), colour = \"red\", shape = 23) +\n    labs(\n      x = \"Posterior predictive\\nproportion\", \n      y = lab)  \n}\n\nppc_C <- grp_ppc(sym(\"CAssignment\"))\nppc_ctry <- grp_ppc(sym(\"country\"))\nppc_epoch <- grp_ppc(sym(\"epoch\"))\nppc_site <- ppc_dat %>%\n  group_by(Country = country, grp = site_raw) %>%\n  summarise(\n    mean_y = mean(PO),\n    rvar_mean_y_ppc = rvar_mean(y_ppc)\n  )\n\np1 <- plot_grp_ppc(ppc_C, \"Anticoagulation\\nintervention\") + labs(x = \"\")\np2 <- plot_grp_ppc(ppc_ctry, \"Country\") + labs(x = \"\")\np3 <- plot_grp_ppc(ppc_epoch, \"Epoch\") + labs(x = \"\")\np4 <- plot_grp_ppc(ppc_site %>% filter(Country == \"IN\"), \"Sites\\nIndia\")  + labs(x = \"\")\np5 <- plot_grp_ppc(ppc_site %>% filter(Country == \"AU\"), \"Sites\\nAustralia\") + labs(x = \"\")\np6 <- plot_grp_ppc(ppc_site %>% filter(Country == \"NP\"), \"Sites\\nNepal\")\np7 <- plot_grp_ppc(ppc_site %>% filter(Country == \"NZ\"), \"Sites\\nNZ\")\np <- ((p3 | p1 / p2) / \n        ( (p4 | p5) / (p6 | p7) + \n            plot_layout(heights = c(3, 1)) ) ) +\n  plot_layout(heights = c(1, 1.5), guides = \"collect\")\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\",\n                 \"primary-model-acs-itt-ppc.pdf\")\nggsave(pth, p, width = 6, height = 5.5)\np"
  },
  {
    "objectID": "analyses/primary_outcome.html#sensitivity-analyses",
    "href": "analyses/primary_outcome.html#sensitivity-analyses",
    "title": "Primary Outcome",
    "section": "Sensitivity Analyses",
    "text": "Sensitivity Analyses\n\nSens: Treatment Contrasts\n\n\nCode\nres <- fit_primary_model(\n  acs_itt_nona_dat,\n  primary_mod,\n  vars = c(\"inelgc3\", \"agegte60\", \"ctry\"),\n  beta_sd_var = c(10, 2.5, 1, 1),\n  ctr = contr.treatment,\n  seed = 32915,\n  adapt_delta = 0.99\n)\nnames(res$drws$OR) <- c(\n  intervention_labels2()$CAssignment[-(1:2)], \n  \"Ineligible aspirin\", \"Age \\u2265 60\", \"Australia/New Zealand\", \"Nepal\")\n\n\n\n\nCode\nodds_ratio_summary_table(res$drws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate-dose \n    0.71 \n    (0.42, 1.21) \n    0.74 (0.20) \n    0.90 \n  \n  \n    Low-dose with aspirin \n    0.85 \n    (0.46, 1.55) \n    0.89 (0.28) \n    0.70 \n  \n  \n    Therapeutic-dose \n    2.04 \n    (0.72, 5.39) \n    2.29 (1.22) \n    0.08 \n  \n  \n    Ineligible aspirin \n    2.44 \n    (0.66, 7.74) \n    2.89 (1.92) \n    0.08 \n  \n  \n    Age ≥ 60 \n    1.90 \n    (1.17, 3.07) \n    1.96 (0.49) \n    0.01 \n  \n  \n    Australia/New Zealand \n    1.18 \n    (0.25, 4.84) \n    1.52 (1.27) \n    0.41 \n  \n  \n    Nepal \n    2.10 \n    (0.50, 7.44) \n    2.58 (1.93) \n    0.14 \n  \n\n\n\nPosterior summaries for model parameters under treatment contrast priors.\n\n\n\nCode\nsave_tex_table(\n  odds_ratio_summary_table(res$drws$OR, \"latex\"),\n  \"outcomes/primary/primary-model-acs-itt-trt-ctr-summary-table\")\n\n\n\n\nCode\np <- plot_epoch_site_terms(\n  exp(res$drws$gamma_epoch), \n  exp(res$drws$gamma_site),\n  factor(\n    res$dat$region_by_site, \n    labels = c(\"India\", \"Australia\\nNew Zealand\", \"Nepal\"))\n)\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\",\n                 \"primary-model-acs-itt-trt-ctr-epoch-site-terms.pdf\")\nggsave(pth, p, width = 6, height = 4.5)\np\n\n\n\n\n\n\n\nSens: Weakly Informative Priors\nAs a prior sensitivity assessment, the primary model is re-fit under weakly informative priors (Normal(0, 10)) for all fixed-effect parameters.\n\n\nCode\nres <- fit_primary_model(\n  acs_itt_nona_dat,\n  primary_mod,\n  vars = c(\"inelgc3\", \"agegte60\", \"ctry\"),\n  beta_sd_var = c(10, 10, 10, 10),\n  seed = 32915,\n  adapt_delta = 0.99\n)\nnames(res$drws$OR) <- c(\n  intervention_labels2()$CAssignment[-(1:2)], \n  \"Ineligible aspirin\", \"Age \\u2265 60\", \"Australia/New Zealand\", \"Nepal\")\n\n\n\n\nCode\nodds_ratio_summary_table(res$drws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate-dose \n    0.74 \n    (0.43, 1.29) \n    0.77 (0.22) \n    0.86 \n  \n  \n    Low-dose with aspirin \n    0.89 \n    (0.47, 1.65) \n    0.93 (0.30) \n    0.64 \n  \n  \n    Therapeutic-dose \n    2.10 \n    (0.73, 5.83) \n    2.41 (1.36) \n    0.08 \n  \n  \n    Ineligible aspirin \n    2.51 \n    (0.67, 8.19) \n    2.99 (2.00) \n    0.08 \n  \n  \n    Age ≥ 60 \n    1.89 \n    (1.16, 3.10) \n    1.95 (0.50) \n    0.01 \n  \n  \n    Australia/New Zealand \n    1.37 \n    (0.09, 12.45) \n    2.59 (4.28) \n    0.40 \n  \n  \n    Nepal \n    4.05 \n    (0.54, 32.02) \n    7.29 (17.05) \n    0.07 \n  \n\n\n\nPosterior summaries for model parameters under treatment contrast priors.\n\n\n\nCode\np <- plot_epoch_site_terms(\n  exp(res$drws$gamma_epoch), \n  exp(res$drws$gamma_site),\n  factor(\n    res$dat$region_by_site, \n    labels = c(\"India\", \"Australia\\nNew Zealand\", \"Nepal\"))\n)\np\n\n\n\n\n\n\n\nSens: FAS-ITT\nIn these analyses, the population is includes all participants who were randomised to the platform, even if not randomised into the anticoagulation domain.\n\n\nCode\nres <- fit_primary_model(\n  fas_itt_nona_dat,\n  primary_mod,\n  vars = c(\"inelgc3\", \"agegte60\", \"ctry\"),\n  beta_sd_var = c(10, 2.5, 1, 1),\n  seed = 32915,\n  adapt_delta = 0.99\n)\nnames(res$drws$OR) <- c(\n  intervention_labels2()$CAssignment[-(1:2)], \n  \"Ineligible aspirin\", \"Age \\u2265 60\", \"Australia/New Zealand\", \"Nepal\")\n\n\n\n\n\n\n\nFigure 13: Posterior densities for odds ratio contrasts.\n\n\n\n\n\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate-dose \n    0.74 \n    (0.43, 1.27) \n    0.77 (0.22) \n    0.86 \n  \n  \n    Low-dose with aspirin \n    0.89 \n    (0.48, 1.62) \n    0.93 (0.29) \n    0.64 \n  \n  \n    Therapeutic-dose \n    2.17 \n    (0.77, 6.00) \n    2.48 (1.37) \n    0.07 \n  \n  \n    Ineligible aspirin \n    2.16 \n    (0.60, 6.75) \n    2.55 (1.64) \n    0.11 \n  \n  \n    Age ≥ 60 \n    1.89 \n    (1.18, 3.05) \n    1.95 (0.48) \n    0.01 \n  \n  \n    Australia/New Zealand \n    1.11 \n    (0.26, 4.56) \n    1.43 (1.16) \n    0.44 \n  \n  \n    Nepal \n    2.19 \n    (0.50, 7.89) \n    2.70 (2.00) \n    0.13 \n  \n\n\n\nTable 11:  Posterior summaries for odds ratio contrasts. \n\n\n\n\nCode\nsave_tex_table(\n  odds_ratio_summary_table(res$drws$OR, \"latex\"),\n  \"outcomes/primary/primary-model-fas-itt-summary-table\")\n\n\n\n\nCode\np <- plot_epoch_site_terms(\n  exp(res$drws$gamma_epoch), \n  exp(res$drws$gamma_site),\n  factor(\n    res$dat$region_by_site, \n    labels = c(\"India\", \"Australia\\nNew Zealand\", \"Nepal\"))\n)\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\", \"primary-model-fas-itt-epoch-site-terms.pdf\")\nggsave(pth, p, width = 6, height = 4.5)\np\n\n\n\n\n\n\n\nSens: Worst-Case\nUnder this scenario, all participants with unknown primary outcome status were were to assumed to have met the primary outcome.\n\n\nCode\nmake_po_table(acs_itt_wc_dat)\n\n\n\n\n \n  \n    n (\\%) \n    Lowdose \n    Intermediatedose \n    Low dosewith aspirin \n    Therapeuticdose \n    Overall \n  \n \n\n  \n    Randomised \n    610 \n    613 \n    283 \n    50 \n    1556 \n  \n  \n    Outcome missing \n    0 (0.0) \n    0 (0.0) \n    0 (0.0) \n    0 (0.0) \n    0 (0.0) \n  \n  \n    Outcome observed \n    610 (100.0) \n    613 (100.0) \n    283 (100.0) \n    50 (100.0) \n    1556 (100.0) \n  \n  \n    Met primary outcome \n    49 (8.0) \n    37 (6.0) \n    24 (8.5) \n    7 (14.0) \n    117 (7.5) \n  \n\n\n\n\n\nCode\nsave_tex_table(\n  make_po_table(acs_itt_wc_dat, \"latex\"), \n  \"outcomes/primary/acs-itt-worst-case-anticoagulation-summary\")\n\n\n\n\nCode\nres <- fit_primary_model(\n  acs_itt_wc_dat,\n  primary_mod,\n  vars = c(\"inelgc3\", \"agegte60\", \"ctry\"),\n  beta_sd_var = c(10, 2.5, 1, 1),\n  seed = 32915,\n  adapt_delta = 0.99\n)\nnames(res$drws$OR) <- c(\n  intervention_labels2()$CAssignment[-(1:2)], \n  \"Ineligible aspirin\", \"Age \\u2265 60\", \"Australia/New Zealand\", \"Nepal\")\n\n\n\n\n\n\n\nPosterior densities for odds ratio contrasts.\n\n\n\n\n\n\nCode\nsave_tex_table(\n  odds_ratio_summary_table(res$drws$OR, \"latex\"),\n  \"outcomes/primary/primary-model-acs-itt-worst-case-summary-table\")\nodds_ratio_summary_table(res$drws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate-dose \n    0.74 \n    (0.46, 1.19) \n    0.77 (0.19) \n    0.89 \n  \n  \n    Low-dose with aspirin \n    0.81 \n    (0.46, 1.40) \n    0.84 (0.24) \n    0.77 \n  \n  \n    Therapeutic-dose \n    1.37 \n    (0.50, 3.51) \n    1.53 (0.78) \n    0.26 \n  \n  \n    Ineligible aspirin \n    1.22 \n    (0.35, 3.67) \n    1.42 (0.89) \n    0.37 \n  \n  \n    Age ≥ 60 \n    1.67 \n    (1.07, 2.59) \n    1.71 (0.39) \n    0.01 \n  \n  \n    Australia/New Zealand \n    2.37 \n    (0.54, 9.18) \n    2.99 (2.34) \n    0.12 \n  \n  \n    Nepal \n    1.89 \n    (0.43, 6.83) \n    2.31 (1.72) \n    0.18 \n  \n\n\n\nPosterior summaries for model parameters.\n\n\n\nCode\np <- plot_epoch_site_terms(\n  exp(res$drws$gamma_epoch), \n  exp(res$drws$gamma_site),\n  factor(\n    res$dat$region_by_site, \n    labels = c(\"India\", \"Australia\\nNew Zealand\", \"Nepal\")))\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\", \n                 \"primary-model-acs-itt-worst-case-epoch-site-terms.pdf\")\nggsave(pth, p, width = 6, height = 4.5)\np\n\n\n\n\n\n\n\nSens: Best-Case\nUnder this scenario, all participants with unknown primary outcome status were were to assumed to have not met the primary outcome.\n\n\nCode\nsave_tex_table(\n  make_po_table(acs_itt_bc_dat, \"latex\"), \n  \"outcomes/primary/acs-itt-best-case-anticoagulation-summary\")\nmake_po_table(acs_itt_bc_dat)\n\n\n\n\n \n  \n    n (\\%) \n    Lowdose \n    Intermediatedose \n    Low dosewith aspirin \n    Therapeuticdose \n    Overall \n  \n \n\n  \n    Randomised \n    610 \n    613 \n    283 \n    50 \n    1556 \n  \n  \n    Outcome missing \n    0 (0.0) \n    0 (0.0) \n    0 (0.0) \n    0 (0.0) \n    0 (0.0) \n  \n  \n    Outcome observed \n    610 (100.0) \n    613 (100.0) \n    283 (100.0) \n    50 (100.0) \n    1556 (100.0) \n  \n  \n    Met primary outcome \n    35 (5.7) \n    25 (4.1) \n    20 (7.1) \n    7 (14.0) \n    87 (5.6) \n  \n\n\n\n\n\n\n\nCode\nres <- fit_primary_model(\n  acs_itt_bc_dat,\n  primary_mod,\n  vars = c(\"inelgc3\", \"agegte60\", \"ctry\"),\n  beta_sd_var = c(10, 2.5, 1, 1),\n  seed = 32915,\n  adapt_delta = 0.99\n)\nnames(res$drws$OR) <- c(\n  intervention_labels2()$CAssignment[-(1:2)], \n  \"Ineligible aspirin\", \"Age \\u2265 60\", \"Australia/New Zealand\", \"Nepal\")\n\n\n\n\n\n\n\nPosterior densities for odds ratio contrasts.\n\n\n\n\n\n\nCode\nsave_tex_table(\n  odds_ratio_summary_table(res$drws$OR, \"latex\"),\n  \"outcomes/primary/primary-model-acs-itt-best-case-summary-table\")\nodds_ratio_summary_table(res$drws$OR)\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate-dose \n    0.75 \n    (0.43, 1.30) \n    0.78 (0.22) \n    0.85 \n  \n  \n    Low-dose with aspirin \n    0.91 \n    (0.49, 1.67) \n    0.95 (0.31) \n    0.62 \n  \n  \n    Therapeutic-dose \n    2.32 \n    (0.80, 6.45) \n    2.66 (1.49) \n    0.06 \n  \n  \n    Ineligible aspirin \n    2.83 \n    (0.80, 9.03) \n    3.37 (2.19) \n    0.05 \n  \n  \n    Age ≥ 60 \n    1.86 \n    (1.13, 3.04) \n    1.92 (0.49) \n    0.01 \n  \n  \n    Australia/New Zealand \n    1.00 \n    (0.22, 4.07) \n    1.29 (1.06) \n    0.50 \n  \n  \n    Nepal \n    2.15 \n    (0.49, 7.71) \n    2.64 (1.95) \n    0.14 \n  \n\n\n\nPosterior summaries for model parameters.\n\n\n\nCode\np <- plot_epoch_site_terms(\n  exp(res$drws$gamma_epoch), \n  exp(res$drws$gamma_site),\n  factor(\n    res$dat$region_by_site, \n    labels = c(\"India\", \"Australia\\nNew Zealand\", \"Nepal\")))\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\", \n                 \"primary-model-acs-itt-best-case-epoch-site-terms.pdf\")\nggsave(pth, p, width = 6, height = 4.5)\np\n\n\n\n\n\n\n\nSens: Concurrent Randomisation\n\nIntermediate-dose\n\n\nCode\nsave_tex_table(\n  make_po_table(\n    acs_itt_concurc2_dat,\n    \"latex\"), \n  \"outcomes/primary/acs-itt-c2-summary\")\nmake_po_table(acs_itt_concurc2_dat)\n\n\n\n\n\n \n  \n    n (\\%) \n    Lowdose \n    Intermediatedose \n    Overall \n  \n \n\n  \n    Randomised \n    610 \n    613 \n    1223 \n  \n  \n    Outcome missing \n    14 (2.3) \n    12 (2.0) \n    26 (2.1) \n  \n  \n    Outcome observed \n    596 (97.7) \n    601 (98.0) \n    1197 (97.9) \n  \n  \n    Met primary outcome \n    35 (5.9) \n    25 (4.2) \n    60 (5.0) \n  \n\n\n\nTable 12:  Primary outcome summary for participants randomised to either low-dose or intermediate dose arms (ACS-ITT-intermediate). \n\n\n\n\nCode\nctr <- contr.orthonorm\nX <- model.matrix(\n  ~ CAssignment + agegte60 + ctry, \n  data = acs_itt_concurc2_nona_dat,\n  contrasts.arg = list(CAssignment = ctr))\ny <- acs_itt_concurc2_nona_dat$PO\nsdat <- list(\n  N = nrow(X),\n  K = ncol(X),\n  X = X,\n  y = y,\n  beta_sd = c(2.5, 1, 2.5, 1, 1)\n)\nsnk <- capture.output(\n  sfit <- logistic_mod$sample(\n    data = sdat,\n    seed = 3274,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500\n  )\n)\nsdrws <- as_draws_rvars(sfit$draws(\"beta\"))\nnames(sdrws$beta) <- colnames(X)\nsdrws$beta_trt <- as.vector(\n  transform_coding(cbind(1, ctr(2)), cbind(1, contr.treatment(2))) %**% sdrws$beta[1:2]\n)\nsdrws$OR <- c(\n  \"Intermediate-dose\" = exp(sdrws$beta_trt[2]),\n  \"Age \\u2265 60\" = exp(sdrws$beta[3]),\n  \"Australia/New Zealand\" = exp(sdrws$beta[4]),\n  \"Nepal\" = exp(sdrws$beta[5])\n)\n\n\n\n\nCode\nsave_tex_table(\n  odds_ratio_summary_table(sdrws$OR, \"latex\"),\n  \"outcomes/primary/primary-model-acs-itt-c2-summary-table\")\nodds_ratio_summary_table(sdrws$OR)\n\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate-dose \n    0.69 \n    (0.41, 1.16) \n    0.71 (0.19) \n    0.92 \n  \n  \n    Age ≥ 60 \n    2.19 \n    (1.29, 3.66) \n    2.26 (0.61) \n    0.00 \n  \n  \n    Australia/New Zealand \n    1.39 \n    (0.64, 2.77) \n    1.47 (0.55) \n    0.20 \n  \n  \n    Nepal \n    1.06 \n    (0.40, 2.38) \n    1.15 (0.51) \n    0.45 \n  \n\n\n\nTable 13:  Parameter posterior summaries. \n\n\n\n\n\n\n\n\nDiagnostics\n\n\n\n\n\n\n\nCode\nres$fit$summary(c(\"beta\"))\n\n\n# A tibble: 10 × 10\n   variable    mean   median    sd   mad      q5     q95  rhat ess_bulk ess_tail\n   <chr>      <dbl>    <dbl> <dbl> <dbl>   <dbl>   <dbl> <dbl>    <dbl>    <dbl>\n 1 beta[1]  -4.08   -4.07    0.667 0.652 -5.20   -3.01    1.00    8163.   11086.\n 2 beta[2]   0.678   0.683   0.420 0.417 -0.0206  1.37    1.00   22134.   15754.\n 3 beta[3]  -0.130  -0.131   0.229 0.227 -0.508   0.245   1.00   22749.   15590.\n 4 beta[4]  -0.517  -0.517   0.275 0.276 -0.969  -0.0673  1.00   21721.   16386.\n 5 beta[5]   0.258   0.261   0.698 0.698 -0.898   1.41    1.00   21338.   14916.\n 6 beta[6]  -0.979  -0.968   0.542 0.542 -1.89   -0.112   1.00   30272.   14314.\n 7 beta[7]   1.03    1.04    0.619 0.616 -0.0154  2.02    1.00   29722.   14530.\n 8 beta[8]   0.620   0.620   0.252 0.252  0.204   1.03    1.00   32053.   14952.\n 9 beta[9]  -0.0154 -0.00183 0.743 0.748 -1.26    1.18    1.00   14921.   15151.\n10 beta[10]  0.742   0.767   0.692 0.669 -0.432   1.83    1.00   11785.   14311.\n\n\nCode\nres$fit$diagnostic_summary()\n\n\n$num_divergent\n[1] 0 0 0 0 0 0 0 0\n\n$num_max_treedepth\n[1] 0 0 0 0 0 0 0 0\n\n$ebfmi\n[1] 0.7842 0.7528 0.7704 0.8127 0.7986 0.7521 0.7614 0.7696\n\n\n\n\n\n\n\n\n\n\n\nTrace plots\n\n\n\n\n\n\n\nCode\nmcmc_trace(res$drws[\"beta\"])\n\n\n\n\n\n\n\n\n\n\nLow-dose with aspirin\n\n\nCode\nsave_tex_table(\n  make_po_table(\n    acs_itt_concurc3_dat,\n    \"latex\"), \n  \"outcomes/primary/acs-itt-c3-summary\")\nmake_po_table(acs_itt_concurc3_dat)\n\n\n\n\n\n \n  \n    n (\\%) \n    Lowdose \n    Intermediatedose \n    Low dosewith aspirin \n    Overall \n  \n \n\n  \n    Randomised \n    299 \n    298 \n    283 \n    880 \n  \n  \n    Outcome missing \n    7 (2.3) \n    5 (1.7) \n    4 (1.4) \n    16 (1.8) \n  \n  \n    Outcome observed \n    292 (97.7) \n    293 (98.3) \n    279 (98.6) \n    864 (98.2) \n  \n  \n    Met primary outcome \n    21 (7.2) \n    16 (5.5) \n    20 (7.2) \n    57 (6.6) \n  \n\n\n\nTable 14:  Primary outcome summary for participants randomised whilst the low-dose plus aspirin arm was available (ACS-ITT-aspirin). \n\n\n\n\nCode\nX <- model.matrix(\n  ~ CAssignment + agegte60 + ctry, \n  data = acs_itt_concurc3_nona_dat,\n  contrasts.arg = list(CAssignment = contr.orthonorm))\ny <- acs_itt_concurc3_nona_dat$PO\nsdat <- list(\n  N = nrow(X),\n  K = ncol(X),\n  X = X,\n  y = y,\n  beta_sd = c(2.5, 1, 1, 2.5, 1)\n)\nsnk <- capture.output(\n  sfit <- logistic_mod$sample(\n    data = sdat,\n    seed = 3274,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500\n  )\n)\nsdrws <- as_draws_rvars(sfit$draws(\"beta\"))\nnames(sdrws$beta) <- colnames(X)\n\nsdrws$beta_trt <- as.vector(\n  transform_coding(cbind(1, contr.orthonorm(3)), cbind(1, contr.treatment(3))) %**% sdrws$beta[1:3]\n)\n\nsdrws$OR <- c(\n  \"Intermediate-dose\" = exp(sdrws$beta_trt[2]),\n  \"Low-dose with aspirin\" = exp(sdrws$beta_trt[3]),\n  \"Age \\u2265 60\" = exp(sdrws$beta[4]),\n  \"Australia/New Zealand\" = exp(sdrws$beta[5])\n)\n\n\n\n\nCode\nsave_tex_table(\n  odds_ratio_summary_table(sdrws$OR, \"latex\"),\n  \"outcomes/primary/primary-model-acs-itt-c3-summary-table\")\nodds_ratio_summary_table(sdrws$OR)\n\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate-dose \n    0.75 \n    (0.39, 1.45) \n    0.79 (0.28) \n    0.80 \n  \n  \n    Low-dose with aspirin \n    0.93 \n    (0.50, 1.73) \n    0.98 (0.32) \n    0.59 \n  \n  \n    Age ≥ 60 \n    1.91 \n    (1.09, 3.28) \n    1.98 (0.57) \n    0.01 \n  \n  \n    Australia/New Zealand \n    0.31 \n    (0.07, 1.09) \n    0.38 (0.27) \n    0.97 \n  \n\n\n\nTable 15:  Parameter posterior summaries. \n\n\n\n\nTherapeutic-dose\n\n\nCode\nsave_tex_table(\n  make_po_table(\n    acs_itt_concurc4_dat,\n    \"latex\"), \n  \"outcomes/primary/acs-itt-c4-summary\")\nmake_po_table(acs_itt_concurc4_dat)\n\n\n\n\n\n \n  \n    n (\\%) \n    Lowdose \n    Intermediatedose \n    Therapeuticdose \n    Overall \n  \n \n\n  \n    Randomised \n    79 \n    65 \n    50 \n    194 \n  \n  \n    Outcome missing \n    4 (5.1) \n    3 (4.6) \n    0 (0.0) \n    7 (3.6) \n  \n  \n    Outcome observed \n    75 (94.9) \n    62 (95.4) \n    50 (100.0) \n    187 (96.4) \n  \n  \n    Met primary outcome \n    6 (8.0) \n    3 (4.8) \n    7 (14.0) \n    16 (8.6) \n  \n\n\n\nTable 16:  Primary outcome summary for participants randomised under protocol 5.0 (ACS-ITT-therapeutic). \n\n\n\n\nCode\nX <- model.matrix(\n  ~ CAssignment + agegte60 + ctry,\n  data = acs_itt_concurc4_nona_dat,\n  contrasts.arg = list(CAssignment = contr.orthonorm))\ny <- acs_itt_concurc4_nona_dat$PO\nsdat <- list(\n  N = nrow(X),\n  K = ncol(X),\n  X = X,\n  y = y,\n  beta_sd = c(2.5, 1, 1, 2.5, 1, 1)\n)\nsnk <- capture.output(\n  sfit <- logistic_mod$sample(\n    data = sdat,\n    seed = 3274,\n    chains = 8,\n    parallel_chains = 8,\n    iter_warmup = 1000,\n    iter_sampling = 2500\n  )\n)\nsdrws <- as_draws_rvars(sfit$draws(\"beta\"))\nnames(sdrws$beta) <- colnames(X)\n\nsdrws$beta_trt <- as.vector(\n  transform_coding(cbind(1, contr.orthonorm(3)), cbind(1, contr.treatment(3))) %**% sdrws$beta[1:3]\n)\n\nsdrws$OR <- c(\n  \"Intermediate dose\" = exp(sdrws$beta_trt[2]),\n  \"Therapeutic dose\" = exp(sdrws$beta_trt[3]),\n  \"Age \\u2265 60\" = exp(sdrws$beta[4]),\n  \"India\" = exp(sdrws$beta[5]),\n  \"Australia/New Zealand\" = exp(sdrws$beta[6])\n)\n\n\n\n\nCode\nsave_tex_table(\n  odds_ratio_summary_table(sdrws$OR, \"latex\"),\n  \"outcomes/primary/primary-model-acs-itt-c4-summary-table\")\nodds_ratio_summary_table(sdrws$OR)\n\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate dose \n    0.65 \n    (0.18, 2.25) \n    0.80 (0.57) \n    0.75 \n  \n  \n    Therapeutic dose \n    1.63 \n    (0.54, 5.07) \n    1.93 (1.20) \n    0.19 \n  \n  \n    Age ≥ 60 \n    1.88 \n    (0.66, 5.45) \n    2.18 (1.27) \n    0.12 \n  \n  \n    India \n    0.39 \n    (0.08, 1.62) \n    0.51 (0.41) \n    0.90 \n  \n  \n    Australia/New Zealand \n    1.05 \n    (0.37, 2.84) \n    1.19 (0.65) \n    0.46 \n  \n\n\n\nTable 17:  Parameter posterior summaries."
  },
  {
    "objectID": "analyses/primary_outcome.html#per-protocol-analysis",
    "href": "analyses/primary_outcome.html#per-protocol-analysis",
    "title": "Primary Outcome",
    "section": "Per-Protocol Analysis",
    "text": "Per-Protocol Analysis\nIn the per-protocol analysis, participants who did not satisfy the intervention protocol (as determined by blinded review) are excluded from the analysis set.\n\n\nCode\nall_pp %>%\n  filter(ENR_rec == 1) %>%\n  dplyr::count(Reason)\n\n\n# A tibble: 4 × 2\n  Reason                              n\n  <chr>                           <int>\n1 Patient Withdrawal from Domain     26\n2 Protocol Deviation                 28\n3 Protocol Deviation & Withdrawal     1\n4 <NA>                             1544\n\n\n\n\nCode\nacs_itt_dat %>%\n  left_join(pp, by = \"StudyPatientID\") %>%\n  dplyr::count(CAssignment, Reason) %>%\n  spread(CAssignment, n, fill = 0)\n\n\n# A tibble: 4 × 5\n  Reason                             C1    C2    C3    C4\n  <chr>                           <dbl> <dbl> <dbl> <dbl>\n1 Patient Withdrawal from Domain      2     4     1     0\n2 Protocol Deviation                  9     6     8     3\n3 Protocol Deviation & Withdrawal     0     0     0     1\n4 <NA>                              599   603   274    46\n\n\nCode\nacs_itt_dat %>%\n  left_join(pp, by = \"StudyPatientID\") %>%\n  dplyr::count(country, Reason) %>%\n  spread(country, n, fill = 0)\n\n\n# A tibble: 4 × 5\n  Reason                             IN    AU    NP    NZ\n  <chr>                           <dbl> <dbl> <dbl> <dbl>\n1 Patient Withdrawal from Domain      4     3     0     0\n2 Protocol Deviation                 19     7     0     0\n3 Protocol Deviation & Withdrawal     0     1     0     0\n4 <NA>                             1265   115   118    24\n\n\n\n\nCode\nsave_tex_table(\n  make_po_table(\n    acs_pp_dat,\n    \"latex\"), \n  \"outcomes/primary/acs-pp-outcome-summary\")\nmake_po_table(acs_pp_dat)\n\n\n\n\n\n \n  \n    n (\\%) \n    Lowdose \n    Intermediatedose \n    Low dosewith aspirin \n    Therapeuticdose \n    Overall \n  \n \n\n  \n    Randomised \n    599 \n    603 \n    274 \n    46 \n    1522 \n  \n  \n    Outcome missing \n    13 (2.2) \n    11 (1.8) \n    3 (1.1) \n    0 (0.0) \n    27 (1.8) \n  \n  \n    Outcome observed \n    586 (97.8) \n    592 (98.2) \n    271 (98.9) \n    46 (100.0) \n    1495 (98.2) \n  \n  \n    Met primary outcome \n    35 (6.0) \n    25 (4.2) \n    19 (7.0) \n    7 (15.2) \n    86 (5.8) \n  \n\n\n\nTable 18:  Primary outcome summary for ACS-PP set. \n\n\n\n\nData and sampling primary model\nmdat <- make_primary_model_data(\n  acs_pp_nona_dat,\n  c(\"inelgc3\", \"agegte60\", \"ctry\"),\n  c(10, 2.5, 1, 1)\n)\nsnk <- capture.output(\n  mfit <- primary_mod$sample(\n    data = mdat,\n    seed = 81241,\n    refresh = 0,\n    iter_warmup = 1000,\n    iter_sampling = 2500,\n    chains = 8,\n    parallel_chains = 8,\n    adapt_delta = 0.99\n))\nmdrws <- as_draws_rvars(mfit$draws(c(\n  \"beta\", \n  \"gamma_site\", \"tau_site\", \n  \"gamma_epoch\", \"tau_epoch\", \"y_ppc\")))\nnames(mdrws$beta) <- colnames(mdat$X)\n\n# Transformed samples\nepoch_map <- acs_pp_nona_dat %>% dplyr::count(epoch, epoch_lab)\nsite_map <- acs_pp_nona_dat %>% dplyr::count(site_num, site)\nsite_facet <- factor(mdat$region_by_site, labels = c(\"India\", \"Australia\\nNew Zealand\", \"Nepal\"))\n\nCa <- mdat$ctrA\nCc <- mdat$ctrC\n\nmdrws$Acon <- Ca %**% mdrws$beta[grepl(\"randA[0-9]\", names(mdrws$beta))]\nmdrws$Ccon <- Cc %**% mdrws$beta[grepl(\"randC[0-9]\", names(mdrws$beta))]\nmdrws$Atrt <- mdrws$Acon[-1] - mdrws$Acon[1]\nmdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\n\nmdrws$OR <- setNames(exp(mdrws$Ctrt), c(\"Intermediate\", \"Low with aspirin\", \"Therapeutic\"))\nmdrws$OR <- c(\n  mdrws$OR, \n  \"Ineligible aspirin\" = exp(mdrws$beta[7]), \n  \"Age \\u2265 60\" = exp(mdrws$beta[8]),\n   setNames(exp(mdrws$beta[9:10]), c(\"Australia/New Zealand\", \"Nepal\")))\nmdrws$ORepoch <- setNames(exp(mdrws$gamma_epoch), epoch_map$epoch_lab)\nmdrws$ORsites <- setNames(exp(mdrws$gamma_site), site_map$site)\n\n\n\n\nCode\nsave_tex_table(\n  odds_ratio_summary_table(mdrws$OR, \"latex\"),\n  \"outcomes/primary/primary-model-acs-pp-summary-table\")\nodds_ratio_summary_table(mdrws$OR)\n\n\n\n\n\n \n  \n    Parameter \n    Median \n    95% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  \n    Intermediate \n    0.74 \n    (0.42, 1.28) \n    0.77 (0.22) \n    0.86 \n  \n  \n    Low with aspirin \n    0.85 \n    (0.44, 1.56) \n    0.89 (0.29) \n    0.70 \n  \n  \n    Therapeutic \n    2.52 \n    (0.86, 7.13) \n    2.91 (1.67) \n    0.05 \n  \n  \n    Ineligible aspirin \n    2.46 \n    (0.66, 8.05) \n    2.94 (1.98) \n    0.09 \n  \n  \n    Age ≥ 60 \n    1.87 \n    (1.14, 3.05) \n    1.93 (0.49) \n    0.01 \n  \n  \n    Australia/New Zealand \n    1.11 \n    (0.24, 4.49) \n    1.43 (1.18) \n    0.44 \n  \n  \n    Nepal \n    1.99 \n    (0.49, 7.13) \n    2.47 (1.87) \n    0.16 \n  \n\n\n\nTable 19:  Posterior summaries for model parameters. \n\n\n\n\nCode\np <- plot_epoch_site_terms(mdrws$ORepoch, mdrws$ORsites, site_facet)\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\", \n                 \"primary-model-acs-pp-epoch-site-terms.pdf\")\nggsave(pth, p, width = 6, height = 4.5)\np"
  },
  {
    "objectID": "analyses/primary_outcome_subgroups.html",
    "href": "analyses/primary_outcome_subgroups.html",
    "title": "Primary Outcome - Subgroups",
    "section": "",
    "text": "Load packages\nlibrary(tidyverse)\nlibrary(labelled)\nlibrary(kableExtra)\nlibrary(cmdstanr)\nlibrary(posterior)\nlibrary(bayestestR)\nlibrary(bayesplot)\nlibrary(matrixStats)\nlibrary(plotly)\nlibrary(lubridate)\nlibrary(ggdist)\nlibrary(patchwork)\n\ntheme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank()))\nbayesplot_theme_set(theme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank())))\ncolor_scheme_set(\"red\")\noptions(digits = 4)\n\n\n\n\nPrepare datasets\ndevtools::load_all()\n# Raw data\nall_dat <- read_all_no_daily()\nall_dat_daily <- read_all_daily()\n\n# ACS-ITT\nacs_itt_dat <- all_dat %>% \n  filter_acs_itt() %>%\n  transmute_model_cols_grp_aus_nz()\n# ACS-ITT excluding missing values\nacs_itt_nona_dat <- acs_itt_dat %>% \n  filter(!is.na(PO))\n\n\n\n\nModels\nprimary_mod <- cmdstan_model(\"stan/binary/logistic_site_epoch.stan\")\nlogistic_site_epoch_llik <- cmdstan_model(\"stan/binary/logistic_site_epoch_loglik.stan\")\nlogistic_site_epoch_llik_int <- cmdstan_model(\"stan/subgroup/logistic_site_epoch_loglik_shrinkage.stan\")\n\n\n\n\nHelper functions\nmake_stan_data <- function(\n    dat, \n    vars,\n    beta_sd = c(2.5, rep(1, nXassign), 2.5, 10),\n    ctr = contr.orthonorm) \n{\n  X <- model.matrix(\n     as.formula(paste(\"~\", paste(vars, collapse = \" + \"))),\n    data = dat,\n    contrast = list(\n      AAssignment = ctr,\n      CAssignment = ctr)\n  )\n  nXassign <- sum(grepl(\"Assignment\", colnames(X)))\n\n  y <- dat[[\"PO\"]]\n  N <- dim(X)[1]\n  K <- dim(X)[2]  \n  epoch <- dat$epoch\n  M_epoch <- max(dat$epoch)\n  region <- dat[[\"ctry_num\"]]\n  M_region <- max(region)\n  site <- dat[[\"site_num\"]]\n  M_site <- max(site)\n  region_by_site <- region_by_site <- dat %>% \n    dplyr::count(ctry_num, site_num) %>% \n    pull(ctry_num)\n  \n  list(N = N, K = K, X = X, y = y,\n       M_region = M_region, region = region,\n       M_site = M_site, site = site,\n       M_epoch = M_epoch, epoch = epoch,\n       region_by_site = region_by_site,\n       beta_sd = beta_sd)\n}\n\n\nfit_primary_model <- function(\n    dat,\n    model = primary_mod,\n    vars = NULL,\n    beta_sd = NULL,\n    ctr = contr.treatment,\n    seed = 32915,\n    ...\n) {\n  mdat <- make_stan_data(\n    dat,\n    vars,\n    beta_sd,\n    ctr\n  )\n  snk <- capture.output(\n    mfit <- model[[\"sample\"]](\n      data = mdat,\n      seed = seed,\n      refresh = 0,\n      ...\n  ))\n  mpars <- mfit$metadata()$model_params\n  keep <- mpars[!grepl(\"(_raw|epsilon_)\", mpars)]\n  mdrws <- as_draws_rvars(mfit$draws(keep))\n  names(mdrws$beta) <- colnames(mdat$X)\n  \n  if(any(grepl(\"site\", keep))) {\n    site_map <- dat %>% dplyr::count(site_num, site)  \n    names(mdrws$gamma_site) <- site_map$site\n  }\n  if(any(grepl(\"epoch\", keep))) {\n    epoch_map <- dat %>% dplyr::count(epoch, epoch_lab)  \n    names(mdrws$gamma_epoch) <- epoch_map$epoch_lab\n  }\n  # Transformed samples\n  Ca <- attr(mdat$X, \"contrasts\")$AAssignment\n  Cc <- attr(mdat$X, \"contrasts\")$CAssignment\n  # Get constrained parameters from contrast transformation\n  mdrws$Acon <- Ca %**% mdrws$beta[grepl(\"AAssignment[0-9]$\", names(mdrws$beta))]\n  mdrws$Ccon <- as.vector(Cc %**% mdrws$beta[grepl(\"CAssignment[0-9]$\", names(mdrws$beta))])\n  names(mdrws$Ccon) <- rownames(Cc)\n  # Get treatment effect in case of non treatment-coding\n  mdrws$Atrt <- mdrws$Acon[-1] - mdrws$Acon[1]\n  mdrws$Ctrt <- mdrws$Ccon[-1] - mdrws$Ccon[1]\n  # Get odds ratios\n  mdrws$OR <- exp(mdrws$Ctrt)\n  mdrws$OR <- c(mdrws$OR, exp(mdrws$beta[!grepl(\"(Intercept|Assignment)\", names(mdrws$beta))]))\n  return(list(dat = mdat, fit = mfit, drws = mdrws))\n}\n\n\nmake_base_subgroup_table <- function(dat, grp, format = \"html\") {\n  tdat <- dat %>%\n    dplyr::count(\n      group = {{ grp }},\n      `Anticoagulation intervention` = factor(\n        CAssignment, labels = str_replace(intervention_labels()$CAssignment[-1], \"<br>\", \" \")),\n      PO) %>%\n    complete(group, `Anticoagulation intervention`, PO, fill = list(n = 0)) %>%\n    group_by(group, `Anticoagulation intervention`) %>%\n    spread(PO, n, fill = 0) %>%\n    ungroup() %>%\n    mutate(\n      Patients = `0` + `1` + `<NA>`,\n      Known = `0` + `1`,\n      `Primary outcome` = sprintf(\"%i (%.0f%%)\", `1`, 100 * `1` / Known)\n    ) %>%\n    mutate(`Primary outcome` = str_replace(`Primary outcome`, \"0 \\\\(NaN\\\\%\\\\)\", \"- (-%)\")) %>%\n    select(-group, -`0`, -`1`, -`<NA>`)\n  kable(\n    tdat,\n    format = format,\n    digits = 2,\n    align = \"lrrr\",\n    booktabs = TRUE) %>%\n  kable_styling(\n    font_size = 9,\n    bootstrap_options = \"striped\",\n    latex_options = \"HOLD_position\")\n}\n\nsummarise_posterior <- function(dat, futval = 1.1) {\n  dat %>%\n    mutate(\n      Median = \n        sprintf(\"%.2f\", median(Posterior)),\n      `95\\\\% CrI` = \n        sprintf(\"(%.2f, %.2f)\", quantile(Posterior, 0.025), quantile(Posterior, 0.975)),\n      `Mean (SD)` = \n        sprintf(\"%.2f (%.2f)\", mean(Posterior), sd(Posterior)),\n      `Pr(OR < 1)` = \n        sprintf(\"%.2f\", Pr(Posterior < 1)),\n      `Pr(OR > 1/1.1)` = \n        sprintf(\"%.2f\", Pr(Posterior > 1/futval))\n    )\n}\n\n\nmake_subgroup_summary_table <- function(dat, format = \"html\") {\n  L <- nrow(dat)\n  row_st <- seq(1, L, by = L / 3)\n  row_ed <- seq(L/3, L, by = L / 3)\n  kable(\n    dat[, -1] %>% select(-Posterior),\n    format = format,\n    booktabs = TRUE,\n    align = \"lrrrrr\",\n      escape = FALSE\n  ) %>%\n    kable_styling(\n      latex_options = \"HOLD_position\",\n      font_size = 9\n    ) %>%\n    group_rows(\"Intermediate\", row_st[1], row_ed[1]) %>%\n    pack_rows(\"Low with aspirin\", row_st[2], row_ed[2]) %>%\n    pack_rows(\"Therapeutic\", row_st[3], row_ed[3])  \n}\n\n\nplot_subgroup_or <- function(dat, grp) {\n  ggplot(ordat, aes(xdist = Posterior, y = !!grp)) +\n    facet_grid( ~ Contrast, scales = \"free_x\") +\n    stat_slabinterval(\n      aes(fill = \n            stat(cut_cdf_qi(\n              cdf, \n              .width = c(.5, .8, .95), \n              labels = scales::percent_format()))),\n      adjust = 1, n = 1001, .width = c(0.5, 0.8, 0.95),\n      fatten_point = 1\n      ) + \n    scale_fill_brewer(\n      palette = \"Reds\",\n      direction = -1, \n      na.translate = FALSE) + \n    labs(\n      x = \"Odds ratio contrast\",\n      fill = \"Interval\"\n    ) +\n    geom_vline(xintercept = 1, linetype = 2) +\n    scale_x_log10(\"Odds ratio (log scale)\") +\n    scale_colour_manual(\"\", values = c(\"red\", \"black\")) +\n    guides(colour = \"none\") +\n    theme(panel.border = element_rect(fill = NA),\n          legend.position = \"top\")\n}"
  },
  {
    "objectID": "analyses/primary_outcome_subgroups.html#subgroups",
    "href": "analyses/primary_outcome_subgroups.html#subgroups",
    "title": "Primary Outcome - Subgroups",
    "section": "Subgroups",
    "text": "Subgroups\nIn this document the subgroup analyses for the primary outcome are undertaken. The\n\nCountry\n\n\nCode\nmake_subgroup_country_table <- function(format = \"html\") {\n  make_base_subgroup_table(acs_itt_dat, ctry, format = format) %>%\n    pack_rows(\"India\", 1, 4) %>%\n    pack_rows(\"Australia/New Zealand\", 5, 8) %>%\n    pack_rows(\"Nepal\", 9, 12) \n}\ntab <- make_subgroup_country_table(\"latex\")\nsave_tex_table(tab, \"outcomes/primary/descriptive-acs-itt-subgroup-country-descriptive\")\nmake_subgroup_country_table()\n\n\n\n\n \n  \n    Anticoagulation intervention \n    Patients \n    Known \n    Primary outcome \n  \n \n\n  India\n\n    Low dose \n    493 \n    486 \n    27 (6%) \n  \n  \n    Intermediate dose \n    516 \n    511 \n    20 (4%) \n  \n  \n    Low dose with aspirin \n    275 \n    272 \n    20 (7%) \n  \n  \n    Therapeutic dose \n    4 \n    4 \n    0 (0%) \n  \n  Australia/New Zealand\n\n    Low dose \n    61 \n    57 \n    4 (7%) \n  \n  \n    Intermediate dose \n    66 \n    59 \n    4 (7%) \n  \n  \n    Low dose with aspirin \n    8 \n    7 \n    0 (0%) \n  \n  \n    Therapeutic dose \n    15 \n    15 \n    1 (7%) \n  \n  Nepal\n\n    Low dose \n    56 \n    53 \n    4 (8%) \n  \n  \n    Intermediate dose \n    31 \n    31 \n    1 (3%) \n  \n  \n    Low dose with aspirin \n    0 \n    0 \n    - (-%) \n  \n  \n    Therapeutic dose \n    31 \n    31 \n    6 (19%) \n  \n\n\n\nPrimary outcome by anti-coagulation intervention by country.\n\n\n\nCode\nres <- fit_primary_model(\n  acs_itt_nona_dat,\n  primary_mod,\n  vars = c(\"CAssignment\", \"AAssignment\", \"inelgc3\", \"agegte60\", \"ctry\", \"CAssignment:ctry\"),\n  beta_sd = c(2.5, rep(1, 5), 10, 2.5, 1, 1, rep(1, 6)),\n  ctr = contr.treatment,\n  seed = 97573,\n  iter_warmup = 500,\n  iter_sampling = 2500,\n  chains = 8,\n  parallel_chains = min(8, parallel::detectCores()),\n  adapt_delta = 0.98\n)\n\n# Derive subgroup-specific effects\nbetaC <- res$drws$beta[grepl(\"CAssignment\", names(res$drws$beta))]\nres$drws$trtIN <- betaC[1:3]\nres$drws$trtAUNZ <- betaC[1:3] + betaC[4:6]\nres$drws$trtNP <- betaC[1:3] + betaC[7:9]\nres$drws$logOR <- rbind(res$drws$trtIN, res$drws$trtAUNZ, res$drws$trtNP)\nres$drws$OR <- exp(res$drws$logOR)\nrownames(res$drws$OR) <- c(\"India\", \"Australia/New Zealand\", \"Nepal\")\ncolnames(res$drws$OR) <- intervention_labels_short()$CAssignment[-(1:2)]\nres$drws$compare <- sweep(res$drws$OR, 2, res$drws$OR[1, ], FUN = \"/\")\n\n# Summarise subgroup effects\nordat <- expand_grid(\n  Contrast = intervention_labels_short()$CAssignment[-(1:2)],\n  Region = c(\"India\", \"Australia/New Zealand\", \"Nepal\"),\n) %>%\n  mutate(Posterior = c(res$drws$OR)) %>%\n  summarise_posterior()\n# Summarise comparison of effects (reference is India)\ncompdat <- expand_grid(\n  Contrast = intervention_labels_short()$CAssignment[-(1:2)],\n  Region = c(\"India (ref)\", \"Australia/New Zealand\", \"Nepal\")\n) %>%\n  mutate(Posterior = c(res$drws$compare)) %>%\n  summarise_posterior() %>%\n  select(-`Pr(OR > 1/1.1)`)\n\n\n\n\nCode\np <- plot_subgroup_or(\n  ordat %>% \n    mutate(Region = if_else(Region == \"Australia/New Zealand\", \"Australia\\nNew Zealand\", Region)), \n  sym(\"Region\"))\nggsave(\n  file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\", \"acs-itt-subgroup-country-hte.pdf\"),\n  p, height = 3, width = 6, device = cairo_pdf)\np\n\n\n\n\n\n\n\nCode\ntab <- make_subgroup_summary_table(ordat, \"latex\")\nsave_tex_table(tab, \"outcomes/primary/subgroup/country-odds-ratios\")\nmake_subgroup_summary_table(ordat)\n\n\n\n\n \n  \n    Region \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR < 1) \n    Pr(OR > 1/1.1) \n  \n \n\n  Intermediate\n\n    India \n    0.70 \n    (0.39, 1.22) \n    0.73 (0.21) \n    0.90 \n    0.18 \n  \n  \n    Australia/New Zealand \n    0.95 \n    (0.26, 3.36) \n    1.16 (0.85) \n    0.53 \n    0.52 \n  \n  \n    Nepal \n    0.53 \n    (0.11, 2.07) \n    0.67 (0.55) \n    0.81 \n    0.23 \n  \n  Low with aspirin\n\n    India \n    0.87 \n    (0.46, 1.57) \n    0.91 (0.29) \n    0.68 \n    0.44 \n  \n  \n    Australia/New Zealand \n    0.70 \n    (0.10, 4.46) \n    1.10 (1.29) \n    0.64 \n    0.39 \n  \n  \n    Nepal \n    0.87 \n    (0.11, 6.75) \n    1.51 (2.17) \n    0.55 \n    0.48 \n  \n  Therapeutic\n\n    India \n    1.43 \n    (0.37, 5.36) \n    1.79 (1.34) \n    0.30 \n    0.75 \n  \n  \n    Australia/New Zealand \n    1.29 \n    (0.19, 7.03) \n    1.88 (2.00) \n    0.39 \n    0.65 \n  \n  \n    Nepal \n    2.71 \n    (0.82, 8.89) \n    3.27 (2.20) \n    0.05 \n    0.96 \n  \n\n\n\n\n\n\n\nCode\ntab <- make_subgroup_summary_table(compdat, \"latex\")\nsave_tex_table(tab, \"outcomes/primary/subgroup/country-odds-ratios-compare\")\nmake_subgroup_summary_table(compdat)\n\n\n\n\n \n  \n    Region \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  Intermediate\n\n    India (ref) \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Australia/New Zealand \n    1.37 \n    (0.36, 4.84) \n    1.68 (1.24) \n    0.32 \n  \n  \n    Nepal \n    0.75 \n    (0.16, 3.03) \n    0.97 (0.78) \n    0.65 \n  \n  Low with aspirin\n\n    India (ref) \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Australia/New Zealand \n    0.81 \n    (0.12, 4.97) \n    1.23 (1.38) \n    0.59 \n  \n  \n    Nepal \n    1.00 \n    (0.14, 7.22) \n    1.67 (2.21) \n    0.50 \n  \n  Therapeutic\n\n    India (ref) \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Australia/New Zealand \n    0.88 \n    (0.16, 4.50) \n    1.25 (1.22) \n    0.56 \n  \n  \n    Nepal \n    1.90 \n    (0.46, 7.93) \n    2.49 (2.10) \n    0.19 \n  \n\n\n\n\n\n\n\nAge\n\n\nCode\nmake_subgroup_age_table <- function(format = \"html\") {\n  make_base_subgroup_table(acs_itt_dat, agegte60, format = format)  %>%\n  pack_rows(\"Age < 60 years\", 1, 4) %>%\n  pack_rows(\"Age \\u2265 60 years\", 5, 8)\n}\ntab <- make_subgroup_age_table(\"latex\")\nsave_tex_table(tab, \"outcomes/primary/descriptive-acs-itt-subgroup-age-descriptive\")\nmake_subgroup_age_table()\n\n\n\n\n \n  \n    Anticoagulation intervention \n    Patients \n    Known \n    Primary outcome \n  \n \n\n  Age < 60 years\n\n    Low dose \n    445 \n    436 \n    18 (4%) \n  \n  \n    Intermediate dose \n    436 \n    427 \n    15 (4%) \n  \n  \n    Low dose with aspirin \n    195 \n    192 \n    11 (6%) \n  \n  \n    Therapeutic dose \n    26 \n    26 \n    3 (12%) \n  \n  Age ≥ 60 years\n\n    Low dose \n    165 \n    160 \n    17 (11%) \n  \n  \n    Intermediate dose \n    177 \n    174 \n    10 (6%) \n  \n  \n    Low dose with aspirin \n    88 \n    87 \n    9 (10%) \n  \n  \n    Therapeutic dose \n    24 \n    24 \n    4 (17%) \n  \n\n\n\nPrimary outcome by anti-coagulation intervention by age group\n\n\n\nCode\nres <- fit_primary_model(\n  acs_itt_nona_dat,\n  primary_mod,\n  vars = c(\"CAssignment\", \"AAssignment\", \"inelgc3\", \"agegte60\", \"ctry\", \"CAssignment:agegte60\"),\n  beta_sd = c(2.5, rep(1, 5), 10, 2.5, 1, 1, rep(1, 3)),\n  ctr = contr.treatment,\n  seed = 17691,\n  iter_warmup = 500,\n  iter_sampling = 2500,\n  chains = 8,\n  parallel_chains = min(8, parallel::detectCores()),\n  adapt_delta = 0.98\n)\n\n# Derive subgroup-specific effects\nlabs <- c(\"Age < 60\", \"Age \\u2265 60\")\nbetaC <- res$drws$beta[grepl(\"CAssignment\", names(res$drws$beta))]\nres$drws$trt1 <- betaC[1:3]\nres$drws$trt2 <- betaC[1:3] + betaC[4:6]\nres$drws$logOR <- rbind(res$drws$trt1, res$drws$trt2)\nres$drws$OR <- exp(res$drws$logOR)\nrownames(res$drws$OR) <- labs\ncolnames(res$drws$OR) <- intervention_labels_short()$CAssignment[-(1:2)]\nres$drws$compare <- sweep(res$drws$OR, 2, res$drws$OR[1, ], FUN = \"/\")\n\n# Summarise subgroup effects\nordat <- expand_grid(\n  Contrast = intervention_labels_short()$CAssignment[-(1:2)],\n  Age = labs,\n) %>%\n  mutate(Posterior = c(res$drws$OR)) %>%\n  summarise_posterior()\n# Summarise comparison of effects (reference is India)\ncompdat <- expand_grid(\n  Contrast = intervention_labels_short()$CAssignment[-(1:2)],\n  Age = labs\n) %>%\n  mutate(Posterior = c(res$drws$compare)) %>%\n  summarise_posterior() %>%\n  select(-`Pr(OR > 1/1.1)`)\n\n\n\n\nCode\np <- plot_subgroup_or(ordat, sym(\"Age\"))\nggsave(\n  file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\", \"acs-itt-subgroup-age-hte.pdf\"),\n  p, height = 3, width = 6)\np\n\n\n\n\n\n\n\nCode\ntab <- make_subgroup_summary_table(ordat, \"latex\")\nsave_tex_table(tab, \"outcomes/primary/subgroup/age-odds-ratios\")\nmake_subgroup_summary_table(ordat)\n\n\n\n\n \n  \n    Age \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR < 1) \n    Pr(OR > 1/1.1) \n  \n \n\n  Intermediate\n\n    Age < 60 \n    0.79 \n    (0.41, 1.48) \n    0.83 (0.28) \n    0.77 \n    0.33 \n  \n  \n    Age ≥ 60 \n    0.58 \n    (0.26, 1.28) \n    0.63 (0.27) \n    0.91 \n    0.14 \n  \n  Low with aspirin\n\n    Age < 60 \n    0.95 \n    (0.46, 1.91) \n    1.01 (0.38) \n    0.56 \n    0.55 \n  \n  \n    Age ≥ 60 \n    0.74 \n    (0.31, 1.74) \n    0.81 (0.37) \n    0.75 \n    0.32 \n  \n  Therapeutic\n\n    Age < 60 \n    1.84 \n    (0.58, 5.46) \n    2.14 (1.30) \n    0.15 \n    0.88 \n  \n  \n    Age ≥ 60 \n    2.20 \n    (0.59, 7.65) \n    2.68 (1.91) \n    0.12 \n    0.91 \n  \n\n\n\n\n\n\n\nCode\ntab <- make_subgroup_summary_table(compdat, \"latex\")\nsave_tex_table(tab, \"outcomes/primary/subgroup/age-odds-ratios-compare\")\nmake_subgroup_summary_table(compdat)\n\n\n\n\n \n  \n    Age \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  Intermediate\n\n    Age < 60 \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Age ≥ 60 \n    0.74 \n    (0.29, 1.88) \n    0.83 (0.42) \n    0.73 \n  \n  Low with aspirin\n\n    Age < 60 \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Age ≥ 60 \n    0.78 \n    (0.29, 2.13) \n    0.89 (0.48) \n    0.69 \n  \n  Therapeutic\n\n    Age < 60 \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Age ≥ 60 \n    1.20 \n    (0.32, 4.52) \n    1.50 (1.14) \n    0.40 \n  \n\n\n\n\n\n\n\nDays since symptom onset\n\n\nCode\nmake_subgroup_dsfs_table <- function(format = \"html\") {\n  make_base_subgroup_table(acs_itt_dat, dsfsgt7, format = format)  %>%\n    pack_rows(\"Days since first symptoms < 8\", 1, 4) %>%\n    pack_rows(\"Days since first symptoms \\u2265 8\", 5, 8) \n}\ntab <- make_subgroup_dsfs_table(\"latex\")\nsave_tex_table(tab, \"outcomes/primary/descriptive-acs-itt-subgroup-dsfs-descriptive\")\nmake_subgroup_dsfs_table()\n\n\n\n\n \n  \n    Anticoagulation intervention \n    Patients \n    Known \n    Primary outcome \n  \n \n\n  Days since first symptoms < 8\n\n    Low dose \n    421 \n    412 \n    23 (6%) \n  \n  \n    Intermediate dose \n    432 \n    426 \n    20 (5%) \n  \n  \n    Low dose with aspirin \n    206 \n    203 \n    15 (7%) \n  \n  \n    Therapeutic dose \n    39 \n    39 \n    5 (13%) \n  \n  Days since first symptoms ≥ 8\n\n    Low dose \n    189 \n    184 \n    12 (7%) \n  \n  \n    Intermediate dose \n    181 \n    175 \n    5 (3%) \n  \n  \n    Low dose with aspirin \n    77 \n    76 \n    5 (7%) \n  \n  \n    Therapeutic dose \n    11 \n    11 \n    2 (18%) \n  \n\n\n\nPrimary outcome by anti-coagulation intervention by days since first symptom group.\n\n\n\nCode\nres <- fit_primary_model(\n  acs_itt_nona_dat,\n  primary_mod,\n  vars = c(\"CAssignment\", \"AAssignment\", \"inelgc3\", \"agegte60\", \"dsfsgt7\", \"ctry\", \"CAssignment:dsfsgt7\"),\n  beta_sd = c(2.5, rep(1, 5), 10, 2.5, 2.5, 1, 1, rep(1, 3)),\n  ctr = contr.treatment,\n  seed = 46732,\n  iter_warmup = 500,\n  iter_sampling = 2500,\n  chains = 8,\n  parallel_chains = min(8, parallel::detectCores()),\n  adapt_delta = 0.98\n)\n\n# Derive subgroup-specific effects\nlabs <- c(\"DSFS < 8\", \"DSFS \\u2265 8\")\nbetaC <- res$drws$beta[grepl(\"CAssignment\", names(res$drws$beta))]\nres$drws$trt1 <- betaC[1:3]\nres$drws$trt2 <- betaC[1:3] + betaC[4:6]\nres$drws$logOR <- rbind(res$drws$trt1, res$drws$trt2)\nres$drws$OR <- exp(res$drws$logOR)\nrownames(res$drws$OR) <- labs\ncolnames(res$drws$OR) <- intervention_labels_short()$CAssignment[-(1:2)]\nres$drws$compare <- sweep(res$drws$OR, 2, res$drws$OR[1, ], FUN = \"/\")\n\nordat <- expand_grid(\n  Contrast = intervention_labels_short()$CAssignment[-(1:2)],\n  `Days since first symptoms` = labs\n) %>%\n  mutate(Posterior = c(res$drws$OR)) %>%\n  summarise_posterior()\ncompdat <- expand_grid(\n  Contrast = intervention_labels_short()$CAssignment[-(1:2)],\n  `Days since first symptoms` = labs\n) %>%\n  mutate(Posterior = c(res$drws$compare)) %>%\n  summarise_posterior() %>%\n  select(-`Pr(OR > 1/1.1)`)\n\n\n\n\nCode\np <- plot_subgroup_or(ordat, sym(\"Days since first symptoms\"))\nggsave(file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\", \"acs-itt-subgroup-dsfs-hte.pdf\"),\n       p, device = cairo_pdf,\n       height = 3, width = 6)\np\n\n\n\n\n\n\n\nCode\ntab <- make_subgroup_summary_table(ordat, \"latex\")\nsave_tex_table(tab, \"outcomes/primary/subgroup/dsfs-odds-ratios\")\nmake_subgroup_summary_table(ordat)\n\n\n\n\n \n  \n    Days since first symptoms \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR < 1) \n    Pr(OR > 1/1.1) \n  \n \n\n  Intermediate\n\n    DSFS < 8 \n    0.85 \n    (0.47, 1.52) \n    0.89 (0.27) \n    0.71 \n    0.41 \n  \n  \n    DSFS ≥ 8 \n    0.42 \n    (0.15, 1.08) \n    0.47 (0.24) \n    0.96 \n    0.05 \n  \n  Low with aspirin\n\n    DSFS < 8 \n    0.94 \n    (0.48, 1.82) \n    0.99 (0.34) \n    0.57 \n    0.54 \n  \n  \n    DSFS ≥ 8 \n    0.66 \n    (0.23, 1.78) \n    0.75 (0.41) \n    0.79 \n    0.26 \n  \n  Therapeutic\n\n    DSFS < 8 \n    1.86 \n    (0.65, 5.13) \n    2.12 (1.17) \n    0.12 \n    0.91 \n  \n  \n    DSFS ≥ 8 \n    2.86 \n    (0.56, 12.88) \n    3.84 (3.35) \n    0.10 \n    0.92 \n  \n\n\n\n\n\n\n\nCode\ntab <- make_subgroup_summary_table(compdat, \"latex\")\nsave_tex_table(tab, \"outcomes/primary/subgroup/dsfs-odds-ratios-compare\")\nmake_subgroup_summary_table(compdat)\n\n\n\n\n \n  \n    Days since first symptoms \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  Intermediate\n\n    DSFS < 8 \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    DSFS ≥ 8 \n    0.49 \n    (0.17, 1.40) \n    0.56 (0.32) \n    0.91 \n  \n  Low with aspirin\n\n    DSFS < 8 \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    DSFS ≥ 8 \n    0.70 \n    (0.23, 2.06) \n    0.81 (0.48) \n    0.74 \n  \n  Therapeutic\n\n    DSFS < 8 \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    DSFS ≥ 8 \n    1.55 \n    (0.34, 6.33) \n    2.01 (1.69) \n    0.28 \n  \n\n\n\n\n\n\n\nReceived corticosteroids\nIt is noted that receipt of corticosteroids is a post-randomisation event, and therefore may be affected by both the assigned treatment and the patients progression making interpretation difficult.\n\n\nCode\nmake_subgroup_steroids_table <- function(format = \"html\") {\n  make_base_subgroup_table(acs_itt_dat, rec_steroids, format = format) %>%\n  pack_rows(\"Did not receive corticosteroids\", 1, 4) %>%\n  pack_rows(\"Received corticosteroids\", 5, 8)\n}\ntab <- make_subgroup_steroids_table(\"latex\")\nsave_tex_table(tab, \"outcomes/primary/descriptive-acs-itt-subgroup-steroids-descriptive\")\nmake_subgroup_steroids_table()\n\n\n\n\n \n  \n    Anticoagulation intervention \n    Patients \n    Known \n    Primary outcome \n  \n \n\n  Did not receive corticosteroids\n\n    Low dose \n    214 \n    210 \n    9 (4%) \n  \n  \n    Intermediate dose \n    225 \n    223 \n    6 (3%) \n  \n  \n    Low dose with aspirin \n    100 \n    98 \n    4 (4%) \n  \n  \n    Therapeutic dose \n    13 \n    13 \n    1 (8%) \n  \n  Received corticosteroids\n\n    Low dose \n    396 \n    386 \n    26 (7%) \n  \n  \n    Intermediate dose \n    388 \n    378 \n    19 (5%) \n  \n  \n    Low dose with aspirin \n    183 \n    181 \n    16 (9%) \n  \n  \n    Therapeutic dose \n    37 \n    37 \n    6 (16%) \n  \n\n\n\nPrimary outcome by anti-coagulation intervention by receipt of corticosteroids.\n\n\n\nCode\nres <- fit_primary_model(\n  acs_itt_nona_dat,\n  primary_mod,\n  vars = c(\"CAssignment\", \"AAssignment\", \"inelgc3\", \"agegte60\", \"rec_steroids\", \"ctry\", \"CAssignment:rec_steroids\"),\n  beta_sd = c(2.5, rep(1, 5), 10, 2.5, 2.5, 1, 1, rep(1, 3)),\n  ctr = contr.treatment,\n  seed = 63393,\n  iter_warmup = 500,\n  iter_sampling = 2500,\n  chains = 8,\n  parallel_chains = min(8, parallel::detectCores()),\n  adapt_delta = 0.98\n)\n\n# Derive subgroup-specific effects\nlabs <- c(\"Did not receive\", \"Received\")\nbetaC <- res$drws$beta[grepl(\"CAssignment\", names(res$drws$beta))]\nres$drws$trt1 <- betaC[1:3]\nres$drws$trt2 <- betaC[1:3] + betaC[4:6]\nres$drws$logOR <- rbind(res$drws$trt1, res$drws$trt2)\nres$drws$OR <- exp(res$drws$logOR)\nrownames(res$drws$OR) <- labs\ncolnames(res$drws$OR) <- intervention_labels_short()$CAssignment[-(1:2)]\nres$drws$compare <- sweep(res$drws$OR, 2, res$drws$OR[1, ], FUN = \"/\")\n\nordat <- expand_grid(\n  Contrast = intervention_labels_short()$CAssignment[-(1:2)],\n  `Received corticosteroids` = labs\n) %>%\n  mutate(Posterior = c(res$drws$OR)) %>%\n  summarise_posterior()\ncompdat <- expand_grid(\n  Contrast = intervention_labels_short()$CAssignment[-(1:2)],\n  `Received corticosteroids` = labs\n) %>%\n  mutate(Posterior = c(res$drws$compare)) %>%\n  summarise_posterior() %>%\n  select(-`Pr(OR > 1/1.1)`)\n\n\n\n\nCode\np <- plot_subgroup_or(ordat, sym(\"Received corticosteroids\"))\nggsave(file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\", \"acs-itt-subgroup-steroids-hte.pdf\"),\n       p,\n       height = 3, width = 6)\np\n\n\n\n\n\n\n\nCode\ntab <- make_subgroup_summary_table(ordat, \"latex\")\nsave_tex_table(tab, \"outcomes/primary/subgroup/steroids-odds-ratios\")\nmake_subgroup_summary_table(ordat)\n\n\n\n\n \n  \n    Received corticosteroids \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR < 1) \n    Pr(OR > 1/1.1) \n  \n \n\n  Intermediate\n\n    Did not receive \n    0.70 \n    (0.29, 1.61) \n    0.76 (0.34) \n    0.80 \n    0.27 \n  \n  \n    Received \n    0.70 \n    (0.38, 1.29) \n    0.74 (0.24) \n    0.87 \n    0.21 \n  \n  Low with aspirin\n\n    Did not receive \n    0.76 \n    (0.29, 1.89) \n    0.84 (0.42) \n    0.72 \n    0.35 \n  \n  \n    Received \n    0.90 \n    (0.44, 1.77) \n    0.95 (0.34) \n    0.63 \n    0.48 \n  \n  Therapeutic\n\n    Did not receive \n    1.58 \n    (0.41, 5.65) \n    1.94 (1.41) \n    0.24 \n    0.80 \n  \n  \n    Received \n    2.35 \n    (0.75, 6.99) \n    2.73 (1.66) \n    0.07 \n    0.95 \n  \n\n\n\n\n\n\n\nCode\ntab <- make_subgroup_summary_table(compdat, \"latex\")\nsave_tex_table(tab, \"outcomes/primary/subgroup/steroids-odds-ratios-compare\")\nmake_subgroup_summary_table(compdat)\n\n\n\n\n \n  \n    Received corticosteroids \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  Intermediate\n\n    Did not receive \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Received \n    1.01 \n    (0.38, 2.67) \n    1.14 (0.61) \n    0.49 \n  \n  Low with aspirin\n\n    Did not receive \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Received \n    1.18 \n    (0.41, 3.38) \n    1.36 (0.79) \n    0.38 \n  \n  Therapeutic\n\n    Did not receive \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Received \n    1.49 \n    (0.38, 5.88) \n    1.90 (1.52) \n    0.28 \n  \n\n\n\n\n\n\n\nReceived remdesivir\nIt is noted that receipt of remdesivir is a post-randomisation event, and therefore may be affected by both the assigned treatment and the patients progression making interpretation difficult.\n\n\nCode\nmake_subgroup_remdesivir_table <- function(format = \"html\") {\n  make_base_subgroup_table(acs_itt_dat, rec_remdesivir, format = format) %>%\n  pack_rows(\"Did not receive remdesivir\", 1, 4) %>%\n  pack_rows(\"Received remdesivir\", 5, 8)\n}\ntab <- make_subgroup_remdesivir_table(\"latex\")\nsave_tex_table(tab, \"outcomes/primary/descriptive-acs-itt-subgroup-remdesivir-descriptive\")\nmake_subgroup_remdesivir_table()\n\n\n\n\n \n  \n    Anticoagulation intervention \n    Patients \n    Known \n    Primary outcome \n  \n \n\n  Did not receive remdesivir\n\n    Low dose \n    324 \n    315 \n    6 (2%) \n  \n  \n    Intermediate dose \n    324 \n    316 \n    6 (2%) \n  \n  \n    Low dose with aspirin \n    114 \n    112 \n    2 (2%) \n  \n  \n    Therapeutic dose \n    40 \n    40 \n    5 (12%) \n  \n  Received remdesivir\n\n    Low dose \n    286 \n    281 \n    29 (10%) \n  \n  \n    Intermediate dose \n    289 \n    285 \n    19 (7%) \n  \n  \n    Low dose with aspirin \n    169 \n    167 \n    18 (11%) \n  \n  \n    Therapeutic dose \n    10 \n    10 \n    2 (20%) \n  \n\n\n\nPrimary outcome by anti-coagulation intervention by receipt of remdesivir.\n\n\n\nCode\nres <- fit_primary_model(\n  acs_itt_nona_dat,\n  primary_mod,\n  vars = c(\"CAssignment\", \"AAssignment\", \"inelgc3\", \"agegte60\", \"rec_remdesivir\", \"ctry\", \"CAssignment:rec_remdesivir\"),\n  beta_sd = c(2.5, rep(1, 5), 10, 2.5, 2.5, 1, 1, rep(1, 3)),\n  ctr = contr.treatment,\n  seed = 88071,\n  iter_warmup = 500,\n  iter_sampling = 2500,\n  chains = 8,\n  parallel_chains = min(8, parallel::detectCores()),\n  adapt_delta = 0.98\n)\n\n# Derive subgroup-specific effects\nlabs <- c(\"Did not receive\", \"Received\")\nbetaC <- res$drws$beta[grepl(\"CAssignment\", names(res$drws$beta))]\nres$drws$trt1 <- betaC[1:3]\nres$drws$trt2 <- betaC[1:3] + betaC[4:6]\nres$drws$logOR <- rbind(res$drws$trt1, res$drws$trt2)\nres$drws$OR <- exp(res$drws$logOR)\nrownames(res$drws$OR) <- labs\ncolnames(res$drws$OR) <- intervention_labels_short()$CAssignment[-(1:2)]\nres$drws$compare <- sweep(res$drws$OR, 2, res$drws$OR[1, ], FUN = \"/\")\n\nordat <- expand_grid(\n  Contrast = intervention_labels_short()$CAssignment[-(1:2)],\n  `Received remdesivir` = labs\n) %>%\n  mutate(Posterior = c(res$drws$OR)) %>%\n  summarise_posterior()\ncompdat <- expand_grid(\n  Contrast = intervention_labels_short()$CAssignment[-(1:2)],\n  `Received remdesivir` = labs\n) %>%\n  mutate(Posterior = c(res$drws$compare)) %>%\n  summarise_posterior() %>%\n  select(-`Pr(OR > 1/1.1)`)\n\n\n\n\nCode\np <- plot_subgroup_or(ordat, sym(\"Received remdesivir\"))\nggsave(\n  file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\", \"acs-itt-subgroup-remdesivir-hte.pdf\"),\n  p, height = 3, width = 6)\np\n\n\n\n\n\n\n\nCode\ntab <- make_subgroup_summary_table(ordat, \"latex\")\nsave_tex_table(tab, \"outcomes/primary/subgroup/remdesivir-odds-ratios\")\nmake_subgroup_summary_table(ordat)\n\n\n\n\n \n  \n    Received remdesivir \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR < 1) \n    Pr(OR > 1/1.1) \n  \n \n\n  Intermediate\n\n    Did not receive \n    0.82 \n    (0.33, 1.92) \n    0.90 (0.41) \n    0.68 \n    0.40 \n  \n  \n    Received \n    0.67 \n    (0.35, 1.25) \n    0.70 (0.23) \n    0.90 \n    0.16 \n  \n  Low with aspirin\n\n    Did not receive \n    0.77 \n    (0.25, 2.15) \n    0.88 (0.50) \n    0.69 \n    0.37 \n  \n  \n    Received \n    0.82 \n    (0.42, 1.60) \n    0.87 (0.31) \n    0.72 \n    0.38 \n  \n  Therapeutic\n\n    Did not receive \n    2.31 \n    (0.78, 6.68) \n    2.65 (1.56) \n    0.06 \n    0.95 \n  \n  \n    Received \n    2.25 \n    (0.45, 10.64) \n    3.07 (2.87) \n    0.16 \n    0.87 \n  \n\n\n\n\n\n\n\nCode\ntab <- make_subgroup_summary_table(compdat, \"latex\")\nsave_tex_table(tab, \"outcomes/primary/subgroup/remdesivir-odds-ratios-compare\")\nmake_subgroup_summary_table(compdat)\n\n\n\n\n \n  \n    Received remdesivir \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  Intermediate\n\n    Did not receive \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Received \n    0.81 \n    (0.30, 2.23) \n    0.93 (0.51) \n    0.66 \n  \n  Low with aspirin\n\n    Did not receive \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Received \n    1.07 \n    (0.36, 3.32) \n    1.27 (0.81) \n    0.45 \n  \n  Therapeutic\n\n    Did not receive \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Received \n    0.98 \n    (0.21, 4.30) \n    1.30 (1.13) \n    0.51 \n  \n\n\n\n\n\n\n\nReceipt of other agent intended to be an antiviral agent against SARS-CoV-2\n\n\nCode\nmake_subgroup_antiviral_table <- function(format = \"html\") {\n  make_base_subgroup_table(acs_itt_dat, rec_antiviral, format = format) %>%\n  pack_rows(\"Did not receive other antiviral\", 1, 4) %>%\n  pack_rows(\"Received other antiviral\", 5, 8)\n}\ntab <- make_subgroup_antiviral_table(\"latex\")\nsave_tex_table(tab, \"outcomes/primary/descriptive-acs-itt-subgroup-antiviral-descriptive\")\nmake_subgroup_antiviral_table()\n\n\n\n\n \n  \n    Anticoagulation intervention \n    Patients \n    Known \n    Primary outcome \n  \n \n\n  Did not receive other antiviral\n\n    Low dose \n    337 \n    324 \n    28 (9%) \n  \n  \n    Intermediate dose \n    340 \n    331 \n    23 (7%) \n  \n  \n    Low dose with aspirin \n    169 \n    165 \n    13 (8%) \n  \n  \n    Therapeutic dose \n    48 \n    48 \n    7 (15%) \n  \n  Received other antiviral\n\n    Low dose \n    273 \n    272 \n    7 (3%) \n  \n  \n    Intermediate dose \n    273 \n    270 \n    2 (1%) \n  \n  \n    Low dose with aspirin \n    114 \n    114 \n    7 (6%) \n  \n  \n    Therapeutic dose \n    2 \n    2 \n    0 (0%) \n  \n\n\n\nPrimary outcome by anti-coagulation intervention by receipt of remdesivir.\n\n\n\nCode\nres <- fit_primary_model(\n  acs_itt_nona_dat,\n  primary_mod,\n  vars = c(\"CAssignment\", \"AAssignment\", \"inelgc3\", \"agegte60\", \"rec_antiviral\", \"ctry\", \"CAssignment:rec_antiviral\"),\n  beta_sd = c(2.5, rep(1, 5), 10, 2.5, 2.5, 1, 1, rep(1, 3)),\n  ctr = contr.treatment,\n  seed = 44106,\n  iter_warmup = 500,\n  iter_sampling = 2500,\n  chains = 4,\n  parallel_chains = 4,\n  adapt_delta = 0.98\n)\n\n# Derive subgroup-specific effects\nlabs <- c(\"No\", \"Yes\")\nbetaC <- res$drws$beta[grepl(\"CAssignment\", names(res$drws$beta))]\nres$drws$trt1 <- betaC[1:3]\nres$drws$trt2 <- betaC[1:3] + betaC[4:6]\nres$drws$logOR <- rbind(res$drws$trt1, res$drws$trt2)\nres$drws$OR <- exp(res$drws$logOR)\nrownames(res$drws$OR) <- labs\ncolnames(res$drws$OR) <- intervention_labels_short()$CAssignment[-(1:2)]\nres$drws$compare <- sweep(res$drws$OR, 2, res$drws$OR[1, ], FUN = \"/\")\n\nordat <- expand_grid(\n  Contrast = intervention_labels_short()$CAssignment[-(1:2)],\n  `Received other antiviral` = labs\n) %>%\n  mutate(Posterior = c(res$drws$OR)) %>%\n  summarise_posterior()\ncompdat <- expand_grid(\n  Contrast = intervention_labels_short()$CAssignment[-(1:2)],\n  `Received other antiviral` = labs\n) %>%\n  mutate(Posterior = c(res$drws$compare)) %>%\n  summarise_posterior() %>%\n  select(-`Pr(OR > 1/1.1)`)\n\n\n\n\nCode\np <- plot_subgroup_or(ordat, sym(\"Received other antiviral\"))\nggsave(\n  file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\", \"acs-itt-subgroup-antiviral-hte.pdf\"),\n  p, height = 3, width = 6)\np\n\n\n\n\n\n\n\nCode\ntab <- make_subgroup_summary_table(ordat, \"latex\")\nsave_tex_table(tab, \"outcomes/primary/subgroup/antiviral-odds-ratios\")\nmake_subgroup_summary_table(ordat)\n\n\n\n\n \n  \n    Received other antiviral \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR < 1) \n    Pr(OR > 1/1.1) \n  \n \n\n  Intermediate\n\n    No \n    0.77 \n    (0.44, 1.36) \n    0.81 (0.24) \n    0.82 \n    0.29 \n  \n  \n    Yes \n    0.39 \n    (0.11, 1.20) \n    0.46 (0.29) \n    0.95 \n    0.07 \n  \n  Low with aspirin\n\n    No \n    0.73 \n    (0.37, 1.41) \n    0.77 (0.27) \n    0.82 \n    0.25 \n  \n  \n    Yes \n    1.52 \n    (0.54, 4.16) \n    1.74 (0.95) \n    0.21 \n    0.84 \n  \n  Therapeutic\n\n    No \n    2.02 \n    (0.75, 5.20) \n    2.26 (1.17) \n    0.08 \n    0.94 \n  \n  \n    Yes \n    1.76 \n    (0.22, 13.21) \n    2.97 (4.07) \n    0.29 \n    0.74 \n  \n\n\n\n\n\n\n\nCode\ntab <- make_subgroup_summary_table(compdat, \"latex\")\nsave_tex_table(tab, \"outcomes/primary/subgroup/antiviral-odds-ratios-compare\")\nmake_subgroup_summary_table(compdat)\n\n\n\n\n \n  \n    Received other antiviral \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  Intermediate\n\n    No \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Yes \n    0.51 \n    (0.14, 1.61) \n    0.60 (0.39) \n    0.87 \n  \n  Low with aspirin\n\n    No \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Yes \n    2.10 \n    (0.70, 6.16) \n    2.44 (1.45) \n    0.09 \n  \n  Therapeutic\n\n    No \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Yes \n    0.87 \n    (0.13, 5.30) \n    1.34 (1.58) \n    0.56 \n  \n\n\n\n\n\n\n\nD-dimer\n\n\nCode\nmake_subgroup_ddimer_table <- function(format = \"html\") {\n  make_base_subgroup_table(acs_itt_dat, ddimer_oor, format = format) %>%\n  pack_rows(\"D-Dimer in range\", 1, 4) %>%\n  pack_rows(\"D-Dimer out of range\", 5, 8) %>%\n  pack_rows(\"D-Dimer unknown\", 9, 12)\n}\ntab <- make_subgroup_ddimer_table(\"latex\")\nsave_tex_table(tab, \"outcomes/primary/descriptive-acs-itt-subgroup-ddimer-descriptive\")\nmake_subgroup_ddimer_table()\n\n\n\n\n \n  \n    Anticoagulation intervention \n    Patients \n    Known \n    Primary outcome \n  \n \n\n  D-Dimer in range\n\n    Low dose \n    311 \n    307 \n    15 (5%) \n  \n  \n    Intermediate dose \n    336 \n    332 \n    15 (5%) \n  \n  \n    Low dose with aspirin \n    184 \n    181 \n    13 (7%) \n  \n  \n    Therapeutic dose \n    7 \n    7 \n    0 (0%) \n  \n  D-Dimer out of range\n\n    Low dose \n    182 \n    179 \n    10 (6%) \n  \n  \n    Intermediate dose \n    177 \n    174 \n    3 (2%) \n  \n  \n    Low dose with aspirin \n    63 \n    62 \n    7 (11%) \n  \n  \n    Therapeutic dose \n    10 \n    10 \n    1 (10%) \n  \n  D-Dimer unknown\n\n    Low dose \n    117 \n    110 \n    10 (9%) \n  \n  \n    Intermediate dose \n    100 \n    95 \n    7 (7%) \n  \n  \n    Low dose with aspirin \n    36 \n    36 \n    0 (0%) \n  \n  \n    Therapeutic dose \n    33 \n    33 \n    6 (18%) \n  \n\n\n\nPrimary outcome by anti-coagulation intervention by D-dimer out of range.\n\n\n\nCode\nres <- fit_primary_model(\n  acs_itt_nona_dat,\n  primary_mod,\n  vars = c(\"CAssignment\", \"AAssignment\", \"inelgc3\", \"agegte60\", \"ddimer_oor\", \"ctry\", \"CAssignment:ddimer_oor\"),\n  beta_sd = c(2.5, rep(1, 5), 10, 2.5, 2.5, 2.5, 1, 1, rep(1, 6)),\n  ctr = contr.treatment,\n  seed = 5438,\n  iter_warmup = 500,\n  iter_sampling = 2500,\n  chains = 8,\n  parallel_chains = min(8, parallel::detectCores()),\n  adapt_delta = 0.98\n)\n\n# Derive subgroup-specific effects\nlabs <- c(\"No\", \"Yes\", \"Unknown\")\nbetaC <- res$drws$beta[grepl(\"CAssignment\", names(res$drws$beta))]\nres$drws$trt1 <- betaC[1:3]\nres$drws$trt2 <- betaC[1:3] + betaC[4:6]\nres$drws$trt3 <- betaC[1:3] + betaC[7:9]\nres$drws$logOR <- rbind(res$drws$trt1, res$drws$trt2, res$drws$trt3)\nres$drws$OR <- exp(res$drws$logOR)\nrownames(res$drws$OR) <- labs\ncolnames(res$drws$OR) <- intervention_labels_short()$CAssignment[-(1:2)]\nres$drws$compare <- sweep(res$drws$OR, 2, res$drws$OR[1, ], FUN = \"/\")\n\nordat <- expand_grid(\n  Contrast = intervention_labels_short()$CAssignment[-(1:2)],\n  `D-dimer out of range` = labs\n) %>%\n  mutate(Posterior = c(res$drws$OR)) %>%\n  summarise_posterior()\ncompdat <- expand_grid(\n  Contrast = intervention_labels_short()$CAssignment[-(1:2)],\n  `D-dimer out of range` = labs\n) %>%\n  mutate(Posterior = c(res$drws$compare)) %>%\n  summarise_posterior() %>%\n  select(-`Pr(OR > 1/1.1)`)\n\n\n\n\nCode\np <- plot_subgroup_or(ordat, sym(\"D-dimer out of range\"))\nggsave(\n  file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\", \"acs-itt-subgroup-ddimer-hte.pdf\"),\n  p, height = 3, width = 6)\np\n\n\n\n\n\n\n\nCode\ntab <- make_subgroup_summary_table(ordat, \"latex\")\nsave_tex_table(tab, \"outcomes/primary/subgroup/ddimer-odds-ratios\")\nmake_subgroup_summary_table(ordat)\n\n\n\n\n \n  \n    D-dimer out of range \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR < 1) \n    Pr(OR > 1/1.1) \n  \n \n\n  Intermediate\n\n    No \n    0.78 \n    (0.41, 1.45) \n    0.82 (0.27) \n    0.78 \n    0.31 \n  \n  \n    Yes \n    0.38 \n    (0.12, 1.12) \n    0.44 (0.26) \n    0.96 \n    0.06 \n  \n  \n    Unknown \n    0.89 \n    (0.33, 2.28) \n    0.99 (0.52) \n    0.60 \n    0.48 \n  \n  Low with aspirin\n\n    No \n    0.99 \n    (0.49, 2.01) \n    1.06 (0.39) \n    0.51 \n    0.60 \n  \n  \n    Yes \n    1.36 \n    (0.47, 3.84) \n    1.57 (0.90) \n    0.28 \n    0.78 \n  \n  \n    Unknown \n    0.20 \n    (0.04, 0.75) \n    0.25 (0.19) \n    0.99 \n    0.01 \n  \n  Therapeutic\n\n    No \n    1.31 \n    (0.35, 4.68) \n    1.62 (1.17) \n    0.34 \n    0.71 \n  \n  \n    Yes \n    1.69 \n    (0.23, 10.47) \n    2.60 (2.97) \n    0.30 \n    0.73 \n  \n  \n    Unknown \n    2.74 \n    (0.82, 8.90) \n    3.28 (2.20) \n    0.05 \n    0.96 \n  \n\n\n\n\n\n\n\nCode\ntab <- make_subgroup_summary_table(compdat, \"latex\")\nsave_tex_table(tab, \"outcomes/primary/subgroup/ddimer-odds-ratios-compare\")\nmake_subgroup_summary_table(compdat)\n\n\n\n\n \n  \n    D-dimer out of range \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  Intermediate\n\n    No \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Yes \n    0.49 \n    (0.14, 1.52) \n    0.58 (0.37) \n    0.89 \n  \n  \n    Unknown \n    1.14 \n    (0.39, 3.29) \n    1.31 (0.76) \n    0.41 \n  \n  Low with aspirin\n\n    No \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Yes \n    1.37 \n    (0.44, 4.11) \n    1.61 (1.01) \n    0.29 \n  \n  \n    Unknown \n    0.20 \n    (0.05, 0.76) \n    0.25 (0.19) \n    0.99 \n  \n  Therapeutic\n\n    No \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Yes \n    1.27 \n    (0.24, 6.55) \n    1.80 (1.79) \n    0.39 \n  \n  \n    Unknown \n    2.08 \n    (0.51, 8.33) \n    2.69 (2.19) \n    0.15 \n  \n\n\n\n\n\n\n\nWeight\nDue to small numbers and zero events this subgroup analysis was not undertaken.\n\n\nCode\nmake_subgroup_weight_table <- function(format = \"html\") {\n  make_base_subgroup_table(acs_itt_dat, weightgt120, format = format) %>%\n    pack_rows(\"Weight $\\\\leq$ 120 kg\", 1, 4) %>%\n    pack_rows(\"Weight > 120 kg\", 5, 8)\n}\ntab <- make_subgroup_weight_table(\"latex\")\nsave_tex_table(tab, \"outcomes/primary/descriptive-acs-itt-subgroup-weight-descriptive\")\nmake_subgroup_weight_table()\n\n\n\n\n \n  \n    Anticoagulation intervention \n    Patients \n    Known \n    Primary outcome \n  \n \n\n  Weight $\\leq$ 120 kg\n\n    Low dose \n    599 \n    587 \n    35 (6%) \n  \n  \n    Intermediate dose \n    605 \n    594 \n    25 (4%) \n  \n  \n    Low dose with aspirin \n    282 \n    278 \n    20 (7%) \n  \n  \n    Therapeutic dose \n    49 \n    49 \n    7 (14%) \n  \n  Weight > 120 kg\n\n    Low dose \n    11 \n    9 \n    0 (0%) \n  \n  \n    Intermediate dose \n    8 \n    7 \n    0 (0%) \n  \n  \n    Low dose with aspirin \n    1 \n    1 \n    0 (0%) \n  \n  \n    Therapeutic dose \n    1 \n    1 \n    0 (0%) \n  \n\n\n\nPrimary outcome by anti-coagulation intervention by aspirin use\n\n\n\nAspirin\n\n\nCode\nmake_subgroup_aspirin_table <- function(format = \"html\") {\n  make_base_subgroup_table(acs_itt_dat, aspirin, format = format) %>%\n    pack_rows(\"Patient not taking aspirin\", 1, 4) %>%\n    pack_rows(\"Patient taking aspirin\", 5, 8)\n}\ntab <- make_subgroup_aspirin_table(\"latex\")\nsave_tex_table(tab, \"outcomes/primary/descriptive-acs-itt-subgroup-aspirin-descriptive\")\nmake_subgroup_aspirin_table()\n\n\n\n\n \n  \n    Anticoagulation intervention \n    Patients \n    Known \n    Primary outcome \n  \n \n\n  Patient not taking aspirin\n\n    Low dose \n    590 \n    576 \n    30 (5%) \n  \n  \n    Intermediate dose \n    588 \n    576 \n    23 (4%) \n  \n  \n    Low dose with aspirin \n    281 \n    277 \n    19 (7%) \n  \n  \n    Therapeutic dose \n    47 \n    47 \n    7 (15%) \n  \n  Patient taking aspirin\n\n    Low dose \n    20 \n    20 \n    5 (25%) \n  \n  \n    Intermediate dose \n    25 \n    25 \n    2 (8%) \n  \n  \n    Low dose with aspirin \n    2 \n    2 \n    1 (50%) \n  \n  \n    Therapeutic dose \n    3 \n    3 \n    0 (0%) \n  \n\n\n\nPrimary outcome by anti-coagulation intervention by aspirin use\n\n\n\nCode\nres <- fit_primary_model(\n  acs_itt_nona_dat,\n  primary_mod,\n  vars = c(\"CAssignment\", \"AAssignment\", \"inelgc3\", \"agegte60\", \"aspirin\", \"ctry\", \"CAssignment:aspirin\"),\n  beta_sd = c(2.5, rep(1, 5), 10, 2.5, 2.5, 1, 1, rep(1, 3)),\n  ctr = contr.treatment,\n  seed = 5438,\n  iter_warmup = 500,\n  iter_sampling = 2500,\n  chains = 8,\n  parallel_chains = min(8, parallel::detectCores()),\n  adapt_delta = 0.98\n)\n\n# Derive subgroup-specific effects\nlabs <- c(\"No\", \"Yes\")\nbetaC <- res$drws$beta[grepl(\"CAssignment\", names(res$drws$beta))]\nres$drws$trt1 <- betaC[1:3]\nres$drws$trt2 <- betaC[1:3] + betaC[4:6]\nres$drws$logOR <- rbind(res$drws$trt1, res$drws$trt2)\nres$drws$OR <- exp(res$drws$logOR)\nrownames(res$drws$OR) <- labs\ncolnames(res$drws$OR) <- intervention_labels_short()$CAssignment[-(1:2)]\nres$drws$compare <- sweep(res$drws$OR, 2, res$drws$OR[1, ], FUN = \"/\")\n\nordat <- expand_grid(\n  Contrast = intervention_labels_short()$CAssignment[-(1:2)],\n  `Patient taking aspirin` = labs\n) %>%\n  mutate(Posterior = c(res$drws$OR)) %>%\n  summarise_posterior()\ncompdat <- expand_grid(\n  Contrast = intervention_labels_short()$CAssignment[-(1:2)],\n  `Patient taking aspirin` = labs\n) %>%\n  mutate(Posterior = c(res$drws$compare)) %>%\n  summarise_posterior() %>%\n  select(-`Pr(OR > 1/1.1)`)\n\n\n\n\nCode\np <- plot_subgroup_or(ordat, sym(\"Patient taking aspirin\"))\nggsave(file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\", \"acs-itt-subgroup-aspirin-hte.pdf\"),\n       p, height = 3, width = 6)\np\n\n\n\n\n\n\n\nCode\ntab <- make_subgroup_summary_table(ordat, \"latex\")\nsave_tex_table(tab, \"outcomes/primary/subgroup/aspirin-odds-ratios\")\nmake_subgroup_summary_table(ordat)\n\n\n\n\n \n  \n    Patient taking aspirin \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR < 1) \n    Pr(OR > 1/1.1) \n  \n \n\n  Intermediate\n\n    No \n    0.73 \n    (0.42, 1.26) \n    0.76 (0.22) \n    0.87 \n    0.22 \n  \n  \n    Yes \n    0.56 \n    (0.13, 2.35) \n    0.73 (0.61) \n    0.78 \n    0.26 \n  \n  Low with aspirin\n\n    No \n    0.88 \n    (0.48, 1.61) \n    0.92 (0.29) \n    0.66 \n    0.46 \n  \n  \n    Yes \n    1.27 \n    (0.20, 8.39) \n    2.00 (2.42) \n    0.40 \n    0.64 \n  \n  Therapeutic\n\n    No \n    2.06 \n    (0.74, 5.38) \n    2.32 (1.24) \n    0.08 \n    0.94 \n  \n  \n    Yes \n    1.40 \n    (0.19, 9.82) \n    2.27 (2.97) \n    0.37 \n    0.66 \n  \n\n\n\n\n\n\n\nCode\ntab <- make_subgroup_summary_table(compdat, \"latex\")\nsave_tex_table(tab, \"outcomes/primary/subgroup/aspirin-odds-ratios-compare\")\nmake_subgroup_summary_table(compdat)\n\n\n\n\n \n  \n    Patient taking aspirin \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  Intermediate\n\n    No \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Yes \n    0.77 \n    (0.18, 3.22) \n    1.00 (0.83) \n    0.64 \n  \n  Low with aspirin\n\n    No \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Yes \n    1.45 \n    (0.24, 8.90) \n    2.20 (2.50) \n    0.34 \n  \n  Therapeutic\n\n    No \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Yes \n    0.68 \n    (0.11, 3.96) \n    1.01 (1.13) \n    0.67 \n  \n\n\n\n\n\n\n\nVaccination Status (post-hoc)\n\n\nCode\nmake_subgroup_vax_table <- function(format = \"html\") {\n  make_base_subgroup_table(acs_itt_dat, vax, format = format)  %>%\n  pack_rows(\"Not vaccinated\", 1, 4) %>%\n  pack_rows(\"Vaccinated\", 5, 8)  %>%\n  pack_rows(\"Unknown\", 9, 12)\n}\ntab <- make_subgroup_vax_table(\"latex\")\nsave_tex_table(tab, \"outcomes/primary/descriptive-acs-itt-subgroup-vax-descriptive\")\nmake_subgroup_vax_table()\n\n\n\n\n \n  \n    Anticoagulation intervention \n    Patients \n    Known \n    Primary outcome \n  \n \n\n  Not vaccinated\n\n    Low dose \n    387 \n    378 \n    23 (6%) \n  \n  \n    Intermediate dose \n    371 \n    362 \n    15 (4%) \n  \n  \n    Low dose with aspirin \n    212 \n    208 \n    14 (7%) \n  \n  \n    Therapeutic dose \n    23 \n    23 \n    4 (17%) \n  \n  Vaccinated\n\n    Low dose \n    191 \n    186 \n    4 (2%) \n  \n  \n    Intermediate dose \n    220 \n    217 \n    5 (2%) \n  \n  \n    Low dose with aspirin \n    42 \n    42 \n    1 (2%) \n  \n  \n    Therapeutic dose \n    27 \n    27 \n    3 (11%) \n  \n  Unknown\n\n    Low dose \n    32 \n    32 \n    8 (25%) \n  \n  \n    Intermediate dose \n    22 \n    22 \n    5 (23%) \n  \n  \n    Low dose with aspirin \n    29 \n    29 \n    5 (17%) \n  \n  \n    Therapeutic dose \n    0 \n    0 \n    - (-%) \n  \n\n\n\nPrimary outcome by anti-coagulation intervention by vaccination status\n\n\n\nCode\nres <- fit_primary_model(\n  acs_itt_nona_dat,\n  primary_mod,\n  vars = c(\"CAssignment\", \"AAssignment\", \"inelgc3\", \"agegte60\", \"ctry\", \"vaxfac\", \"CAssignment:vaxfac\"),\n  beta_sd = c(2.5, rep(1, 5), 10, 2.5, 1, 1, 2.5, 2.5, rep(1, 6)),\n  ctr = contr.treatment,\n  seed = 44106,\n  iter_warmup = 500,\n  iter_sampling = 500,\n  chains = 4,\n  parallel_chains = 4,\n  adapt_delta = 0.98\n)\n\n# Derive subgroup-specific effects\nlabs <- c(\"Not vaccinated\", \"Vaccinated\", \"Unknown\")\nbetaC <- res$drws$beta[grepl(\"CAssignment\", names(res$drws$beta))]\nres$drws$trt1 <- betaC[1:3]\nres$drws$trt2 <- betaC[1:3] + betaC[4:6]\nres$drws$trt3 <- betaC[1:3] + betaC[7:9]\nres$drws$logOR <- rbind(res$drws$trt1, res$drws$trt2, res$drws$trt3)\nres$drws$OR <- exp(res$drws$logOR)\nrownames(res$drws$OR) <- labs\ncolnames(res$drws$OR) <- intervention_labels_short()$CAssignment[-(1:2)]\nres$drws$compare <- sweep(res$drws$OR, 2, res$drws$OR[1, ], FUN = \"/\")\n\n# Summarise subgroup effects\nordat <- expand_grid(\n  Contrast = intervention_labels_short()$CAssignment[-(1:2)],\n  `Vaccination status` = fct_inorder(labs),\n) %>%\n  mutate(Posterior = c(res$drws$OR)) %>%\n  summarise_posterior()\n# Summarise comparison of effects (reference is India)\ncompdat <- expand_grid(\n  Contrast = intervention_labels_short()$CAssignment[-(1:2)],\n  `Vaccination status` = fct_inorder(labs)\n) %>%\n  mutate(Posterior = c(res$drws$compare)) %>%\n  summarise_posterior() %>%\n  select(-`Pr(OR > 1/1.1)`)\n\n\n\n\nCode\np <- plot_subgroup_or(ordat, sym(\"Vaccination status\"))\nggsave(\n  file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\", \"acs-itt-subgroup-vax-hte.pdf\"),\n  p, height = 3, width = 6)\np\n\n\n\n\n\n\n\nCode\ntab <- make_subgroup_summary_table(ordat, \"latex\")\nsave_tex_table(tab, \"outcomes/primary/subgroup/vax-odds-ratios\")\nmake_subgroup_summary_table(ordat)\n\n\n\n\n \n  \n    Vaccination status \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR < 1) \n    Pr(OR > 1/1.1) \n  \n \n\n  Intermediate\n\n    Not vaccinated \n    0.71 \n    (0.37, 1.26) \n    0.74 (0.24) \n    0.87 \n    0.22 \n  \n  \n    Vaccinated \n    0.78 \n    (0.24, 2.23) \n    0.90 (0.53) \n    0.67 \n    0.39 \n  \n  \n    Unknown \n    0.98 \n    (0.31, 3.17) \n    1.17 (0.80) \n    0.52 \n    0.56 \n  \n  Low with aspirin\n\n    Not vaccinated \n    0.96 \n    (0.50, 1.93) \n    1.02 (0.36) \n    0.54 \n    0.56 \n  \n  \n    Vaccinated \n    0.90 \n    (0.19, 3.72) \n    1.16 (0.99) \n    0.56 \n    0.50 \n  \n  \n    Unknown \n    0.63 \n    (0.21, 1.88) \n    0.74 (0.44) \n    0.80 \n    0.26 \n  \n  Therapeutic\n\n    Not vaccinated \n    1.91 \n    (0.65, 5.52) \n    2.20 (1.29) \n    0.14 \n    0.90 \n  \n  \n    Vaccinated \n    2.50 \n    (0.56, 9.93) \n    3.13 (2.59) \n    0.12 \n    0.91 \n  \n  \n    Unknown \n    1.89 \n    (0.21, 16.15) \n    3.52 (5.42) \n    0.28 \n    0.74 \n  \n\n\n\n\n\n\n\nCode\ntab <- make_subgroup_summary_table(compdat, \"latex\")\nsave_tex_table(tab, \"outcomes/primary/subgroup/vax-odds-ratios-compare\")\nmake_subgroup_summary_table(compdat)\n\n\n\n\n \n  \n    Vaccination status \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR < 1) \n  \n \n\n  Intermediate\n\n    Not vaccinated \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Vaccinated \n    1.09 \n    (0.33, 3.25) \n    1.30 (0.80) \n    0.44 \n  \n  \n    Unknown \n    1.41 \n    (0.43, 4.52) \n    1.70 (1.15) \n    0.29 \n  \n  Low with aspirin\n\n    Not vaccinated \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Vaccinated \n    0.95 \n    (0.20, 3.70) \n    1.19 (0.98) \n    0.54 \n  \n  \n    Unknown \n    0.66 \n    (0.21, 2.04) \n    0.78 (0.48) \n    0.76 \n  \n  Therapeutic\n\n    Not vaccinated \n    1.00 \n    (1.00, 1.00) \n    1.00 (0.00) \n    0.00 \n  \n  \n    Vaccinated \n    1.32 \n    (0.33, 5.00) \n    1.62 (1.24) \n    0.34 \n  \n  \n    Unknown \n    0.99 \n    (0.14, 6.40) \n    1.60 (1.94) \n    0.50"
  },
  {
    "objectID": "eda/adherence.html",
    "href": "eda/adherence.html",
    "title": "Adherence check and summary",
    "section": "",
    "text": "Load packages\nlibrary(tidyverse)\nlibrary(labelled)\nlibrary(kableExtra)\nlibrary(cmdstanr)\nlibrary(posterior)\nlibrary(bayestestR)\nlibrary(bayesplot)\nlibrary(matrixStats)\nlibrary(ggdist)"
  },
  {
    "objectID": "eda/adherence.html#aspirin",
    "href": "eda/adherence.html#aspirin",
    "title": "Adherence check and summary",
    "section": "Aspirin",
    "text": "Aspirin\n\n\nCode\naspirin_dat <- all_dat_daily %>%\n  filter(ENR_rec == 1) %>%\n  select(all_of(site_vars),\n         all_of(pt_vars),\n         all_of(rand_vars),\n         all_of(day_vars),\n         all_of(aspirin_vars),\n         all_of(date_vars),\n         all_of(flag_vars)\n  )\n\n# Who didn't get aspirin on day 1 AND was allocated to receive aspirin? Consider\n# this case to be per-protocol (e.g. randomisation timing may have prevented\n# drug administration).\nasp_missing_on_d1 <- aspirin_dat %>%\n  filter(CAssignment == \"C3\") %>%\n  filter(DD_StudyDay == 1) %>%\n  filter(DD_AspirinAdministered == \"No\" | is.na(DD_AspirinAdministered)) %>%\n  select(-all_of(rand_vars))\nasp_missing_on_d1 %>% distinct(StudyPatientID)\n\n\n# A tibble: 48 × 1\n   StudyPatientID\n   <chr>         \n 1 AMH00025      \n 2 APM00002      \n 3 APM00005      \n 4 APM00006      \n 5 APM00008      \n 6 APM00010      \n 7 JIV00005      \n 8 MAS00010      \n 9 MAS00014      \n10 MAS00015      \n# … with 38 more rows\n\n\nCode\n# Which Dailies are missing an expected aspirin\n# administration after Day 1 excluding the date of discharge?\nasp_missing_after_d1 <-  aspirin_dat %>%\n  filter(CAssignment == \"C3\") %>%\n  filter(DD_StudyDay > 1) %>%\n  filter(DD_Date < DIS_DateOfDischarge) %>%\n  filter(DD_AspirinAdministered == \"No\" | is.na(DD_AspirinAdministered)) %>%\n  select(-all_of(rand_vars))\nasp_missing_after_d1 %>% distinct(StudyPatientID)\n\n\n# A tibble: 8 × 1\n  StudyPatientID\n  <chr>         \n1 APM00005      \n2 APM00010      \n3 JIV00092      \n4 JIV00110      \n5 MAS00014      \n6 MAS00042      \n7 VEL00064      \n8 VEL00099      \n\n\nCode\nasp_wd <- all_dat_daily %>% select(StudyPatientID, CON_WithdrawnDate)\nasp_sae <- saes %>% select(StudyPatientID, DateofSAEOnset)\n\n\n# Patients not on aspirin at baseline + not randomised to aspirin but received\n# aspirin during hospitalisaion. Used to query sites if clarification needed.\nasp_given_unexpected <- aspirin_dat %>%\n  filter(CAssignment == \"C1\" | CAssignment == \"C2\" | CAssignment == \"C4\") %>%\n  filter(DD_StudyDay > 1) %>%\n  filter(BAS_PatientTakingAspirin == \"No\") %>% # filter added 06.06.2022\n  filter(DD_Date < DIS_DateOfDischarge) %>%\n  filter(DD_AspirinAdministered == \"Yes\") %>%\n  select(-AAssignment, -BAssignment)\nasp_given_unexpected %>%  distinct(StudyPatientID)\n\n\n# A tibble: 6 × 1\n  StudyPatientID\n  <chr>         \n1 APM00044      \n2 COR00024      \n3 JIV00031      \n4 JIV00075      \n5 MID00010      \n6 VEL00020"
  },
  {
    "objectID": "eda/baseline-summaries.html",
    "href": "eda/baseline-summaries.html",
    "title": "Enrolment and Baseline Summaries",
    "section": "",
    "text": "Load packages\nlibrary(tidyverse)\nlibrary(patchwork)\nlibrary(DT)\nlibrary(plotly)\nlibrary(knitr)\nlibrary(kableExtra)\n\ntheme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank()))"
  },
  {
    "objectID": "eda/baseline-summaries.html#intervention-assignments",
    "href": "eda/baseline-summaries.html#intervention-assignments",
    "title": "Enrolment and Baseline Summaries",
    "section": "Intervention Assignments",
    "text": "Intervention Assignments\n\n\nCode\nall_data %>%\n  count(FAS_ITT, ACS_ITT, CAssignment) %>%\n  kable() %>%\n  kable_styling(\"striped\", font_size = 14)\n\n\n\n\n\n \n  \n    FAS_ITT \n    ACS_ITT \n    CAssignment \n    n \n  \n \n\n  \n    1 \n    0 \n    C0 \n    25 \n  \n  \n    1 \n    1 \n    C1 \n    619 \n  \n  \n    1 \n    1 \n    C2 \n    620 \n  \n  \n    1 \n    1 \n    C3 \n    285 \n  \n  \n    1 \n    1 \n    C4 \n    50 \n  \n  \n    1 \n    NA \n    NA \n    646 \n  \n\n\n\nTable 1:  Counts of intervention assignments to anticoagulation \n\n\n\n\nCode\nall_data %>%\n  count(FAS_ITT, ACS_ITT, AVS_ITT, AAssignment, CAssignment) %>%\n  kable() %>%\n  kable_styling(\"striped\", font_size = 14)\n\n\n\n\n\n \n  \n    FAS_ITT \n    ACS_ITT \n    AVS_ITT \n    AAssignment \n    CAssignment \n    n \n  \n \n\n  \n    1 \n    0 \n    1 \n    A1 \n    C0 \n    14 \n  \n  \n    1 \n    0 \n    1 \n    A2 \n    C0 \n    11 \n  \n  \n    1 \n    1 \n    0 \n    A0 \n    C1 \n    568 \n  \n  \n    1 \n    1 \n    0 \n    A0 \n    C2 \n    566 \n  \n  \n    1 \n    1 \n    0 \n    A0 \n    C3 \n    278 \n  \n  \n    1 \n    1 \n    0 \n    A0 \n    C4 \n    35 \n  \n  \n    1 \n    1 \n    1 \n    A1 \n    C1 \n    27 \n  \n  \n    1 \n    1 \n    1 \n    A1 \n    C2 \n    19 \n  \n  \n    1 \n    1 \n    1 \n    A1 \n    C3 \n    6 \n  \n  \n    1 \n    1 \n    1 \n    A1 \n    C4 \n    4 \n  \n  \n    1 \n    1 \n    1 \n    A2 \n    C1 \n    24 \n  \n  \n    1 \n    1 \n    1 \n    A2 \n    C2 \n    35 \n  \n  \n    1 \n    1 \n    1 \n    A2 \n    C3 \n    1 \n  \n  \n    1 \n    1 \n    1 \n    A2 \n    C4 \n    11 \n  \n  \n    1 \n    NA \n    NA \n    NA \n    NA \n    646 \n  \n\n\n\nTable 2:  Counts of intervention assignments to regimen \n\n\n\n\nIntervention allocations overtime\np1 <- all_data %>%\n  filter(ENR_rec == 1) %>%\n  count(Intervention = CAssignment, RandDate) %>%\n  complete(Intervention,\n           RandDate = seq.Date(min(RandDate, na.rm = T),\n                               max(Sys.Date(), na.rm = T),\n                               by = \"1 day\"),\n           fill = list(n = 0)) %>%\n  group_by(Intervention) %>%\n  mutate(cn = cumsum(n)) %>%\n  ungroup() %>%\n  ggplot(., aes(RandDate, cn)) +\n  geom_step(aes(colour = Intervention)) +\n  scale_color_viridis_d(option = \"D\") +\n  labs(x = \"\", y = \"Cumulative allocation\")\np1 / p2\n\n\n\n\n\nFigure 4: Allocation to interventions by calendar date.\n\n\n\n\n\nCountry\nAllocations to interventions by country of enrolment.\n\n\nAllocations by site\nall_data %>%\n  filter(ENR_rec == 1) %>%\n  count(Country = PT_CountryName, Intervention = CAssignment) %>%\n  group_by(Country) %>%\n  mutate(p = n / sum(n)) %>%\n  mutate(lab = sprintf(\"%i (%.2f)\", n, p)) %>%\n  select(-n, -p) %>%\n  ungroup() %>%\n  spread(Intervention, lab, fill = \"0 (0.00)\") %>%\n  kable(align = \"lrrrrr\") %>%\n  kable_styling(bootstrap_options = \"striped\", font_size = 12)\n\n\n\n\n\n \n  \n    Country \n    C0 \n    C1 \n    C2 \n    C3 \n    C4 \n  \n \n\n  \n    Australia \n    23 (0.15) \n    51 (0.34) \n    60 (0.39) \n    7 (0.05) \n    11 (0.07) \n  \n  \n    India \n    0 (0.00) \n    499 (0.38) \n    520 (0.40) \n    277 (0.21) \n    4 (0.00) \n  \n  \n    Nepal \n    0 (0.00) \n    57 (0.47) \n    32 (0.27) \n    0 (0.00) \n    31 (0.26) \n  \n  \n    New Zealand \n    2 (0.07) \n    12 (0.44) \n    8 (0.30) \n    1 (0.04) \n    4 (0.15) \n  \n\n\n\nTable 3:  Allocation to anti-coagulation interventions by country \n\n\n\n\nSite\nAllocations to interventions by site of enrolment.\n\n\nAllocations by site\np <- all_data %>%\n  filter(ENR_rec == 1) %>%\n  count(Country = Country, \n        Site = Location,\n        Intervention = CAssignment) %>%\n  group_by(Site = paste(Country, Site, sep = \": \")) %>%\n  mutate(p = n / sum(n)) %>%\n  ggplot(., aes(Intervention, n)) +\n  facet_wrap( ~ Site, scales = \"free_y\") +\n  geom_col() +\n  scale_y_continuous(\"Frequency\",\n    breaks = function(x) \n      unique(floor(pretty(seq(0, (max(x) + 1) * 1.1)))))\nggplotly(p)\n\n\n\n\n\nFigure 5: Allocation to anti-coagulation interventions by site"
  },
  {
    "objectID": "eda/baseline-summaries.html#demographics",
    "href": "eda/baseline-summaries.html#demographics",
    "title": "Enrolment and Baseline Summaries",
    "section": "Demographics",
    "text": "Demographics\nBaseline demographics are summarised by intervention in the following table.\n\n\nDemographics table\nsdat <- all_data %>%\n    filter_acs_itt() %>%\n  mutate(CAssignment = factor(CAssignment, labels = intervention_labels()$CAssignment[-1]))\ngenerate_baseline_demographics_table(sdat, format = \"html\")\n\n\n\n\n\n\n \n\n\nAnticoagulation\n\n\n  \n    Variable \n    Lowdose(n = 610) \n    Intermediatedose(n = 613) \n    Low dosewith aspirin(n = 283) \n    Therapeuticdose(n = 50) \n    Overall(n = 1556) \n  \n \n\n  \n    Age (years), Median (IQR) \n    48 (37, 60) \n    48 (37, 61) \n    50 (38, 62) \n    58 (46, 69) \n    49 (37, 61) \n  \n  Country\n\n    India, n (\\%) \n    493 (81) \n    516 (84) \n    275 (97) \n    4 (8) \n    1288 (83) \n  \n  \n    Australia, n (\\%) \n    49 (8) \n    59 (10) \n    7 (2) \n    11 (22) \n    126 (8) \n  \n  \n    Nepal, n (\\%) \n    56 (9) \n    31 (5) \n    0 (0) \n    31 (62) \n    118 (8) \n  \n  \n    New Zealand, n (\\%) \n    12 (2) \n    7 (1) \n    1 (0) \n    4 (8) \n    24 (2) \n  \n  Sex\n\n    Male, n (\\%) \n    354 (58) \n    387 (63) \n    157 (55) \n    25 (50) \n    923 (59) \n  \n  \n    Female, n (\\%) \n    256 (42) \n    226 (37) \n    126 (45) \n    25 (50) \n    633 (41) \n  \n  Weight (kg)\n\n    Median, (IQR) \n    68 (62, 76) \n    70 (62, 77) \n    68 (62, 76) \n    66 (57, 80) \n    69 (62, 76) \n  \n  \n    Missing, n (\\%) \n    0 (0) \n    0 (0) \n    0 (0) \n    0 (0) \n    0 (0) \n  \n  Vaccinated1\n\n    Yes, n (\\%) \n    191 (31) \n    220 (36) \n    42 (15) \n    27 (54) \n    480 (31) \n  \n  \n    Missing, n (\\%) \n    32 (5) \n    22 (4) \n    29 (10) \n    0 (0) \n    83 (5) \n  \n  Ethnicity\n\n    Indian, n (\\%) \n    494 (81) \n    518 (85) \n    275 (97) \n    4 (8) \n    1291 (83) \n  \n  \n    European, n (\\%) \n    21 (3) \n    18 (3) \n    4 (1) \n    4 (8) \n    47 (3) \n  \n  \n    Asian, n (\\%) \n    20 (3) \n    12 (2) \n    1 (0) \n    10 (20) \n    43 (3) \n  \n  \n    Pacific Islander, n (\\%) \n    13 (2) \n    12 (2) \n    2 (1) \n    3 (6) \n    30 (2) \n  \n  \n    Middle Eastern, n (\\%) \n    11 (2) \n    11 (2) \n    0 (0) \n    0 (0) \n    22 (1) \n  \n  \n    Maori, n (\\%) \n    3 (0) \n    4 (1) \n    0 (0) \n    3 (6) \n    10 (1) \n  \n  \n    African, n (\\%) \n    1 (0) \n    0 (0) \n    1 (0) \n    0 (0) \n    2 (0) \n  \n  \n    Aboriginal, n (\\%) \n    0 (0) \n    1 (0) \n    0 (0) \n    1 (2) \n    2 (0) \n  \n  \n    Latin American, n (\\%) \n    0 (0) \n    1 (0) \n    0 (0) \n    0 (0) \n    1 (0) \n  \n  \n    Other, n (\\%) \n    45 (7) \n    28 (5) \n    0 (0) \n    23 (46) \n    96 (6) \n  \n  \n    Unknown, n (\\%) \n    8 (1) \n    9 (1) \n    0 (0) \n    3 (6) \n    20 (1) \n  \n  Smoking\n\n    Current, n (\\%) \n    17 (3) \n    21 (3) \n    3 (1) \n    5 (10) \n    46 (3) \n  \n  \n    Former, n (\\%) \n    74 (12) \n    53 (9) \n    15 (5) \n    14 (28) \n    156 (10) \n  \n  \n    Never, n (\\%) \n    519 (85) \n    539 (88) \n    265 (94) \n    31 (62) \n    1354 (87) \n  \n  \n    Missing, n (\\%) \n    0 (0) \n    0 (0) \n    0 (0) \n    0 (0) \n    0 (0) \n  \n\n\n1 Site LUD did not have ethics approval for collection of vaccination status.\n\n\nTable 4:  Baseline demographics for participants randomised into the anticoagulation domain. \n\n\n\n\nSave table to outputs\nsave_tex_table(\n  generate_baseline_demographics_table(sdat, format = \"latex\"),\n  \"baseline/demographics\"\n)"
  },
  {
    "objectID": "eda/baseline-summaries.html#co-morbidities",
    "href": "eda/baseline-summaries.html#co-morbidities",
    "title": "Enrolment and Baseline Summaries",
    "section": "Co-morbidities",
    "text": "Co-morbidities\nBaseline co-morbidities are summarised by anti-coagulation intervention in the following table.\n\n\nCo-morbidities table\nsdat <- all_data %>%\n    filter_acs_itt() %>%\n  mutate(CAssignment = factor(CAssignment, labels = intervention_labels()$CAssignment[-1]))\ngenerate_baseline_comorbidities_table(sdat, format = \"html\")\n\n\n\n\n\n\n \n\n\nAnticoagulation\n\n\n  \n    Comorbidity \n    Lowdose(n = 610) \n    Intermediatedose(n = 613) \n    Low dosewith aspirin(n = 283) \n    Therapeuticdose(n = 50) \n    Overall(n = 1556) \n  \n \n\n  \n    None, n (\\%) \n    364 ( 60) \n    378 ( 62) \n    166 ( 59) \n    19 ( 38) \n    927 ( 60) \n  \n  \n    Hypertension, n (\\%) \n    147 ( 24) \n    140 ( 23) \n    68 ( 24) \n    14 ( 28) \n    369 ( 24) \n  \n  \n    Diabetes, n (\\%) \n    140 ( 23) \n    139 ( 23) \n    78 ( 28) \n    11 ( 22) \n    368 ( 24) \n  \n  \n    Obesity, n (\\%) \n    23 (  4) \n    22 (  4) \n    3 (  1) \n    5 ( 10) \n    53 (  3) \n  \n  \n    Asthma, n (\\%) \n    19 (  3) \n    16 (  3) \n    6 (  2) \n    4 (  8) \n    45 (  3) \n  \n  \n    Chronic lung disease, n (\\%) \n    16 (  3) \n    13 (  2) \n    1 (  0) \n    7 ( 14) \n    37 (  2) \n  \n  \n    Chronic cardiac disease, n (\\%) \n    11 (  2) \n    15 (  2) \n    1 (  0) \n    2 (  4) \n    29 (  2) \n  \n  \n    Obstructive sleep apnoea, n (\\%) \n    3 (  0) \n    2 (  0) \n    2 (  1) \n    0 (  0) \n    7 (  0) \n  \n  \n    Iatrogenic immunosuppression, n (\\%) \n    1 (  0) \n    6 (  1) \n    0 (  0) \n    0 (  0) \n    7 (  0) \n  \n  \n    Chronic kidney disease, n (\\%) \n    0 (  0) \n    5 (  1) \n    1 (  0) \n    0 (  0) \n    6 (  0) \n  \n  \n    Malignant neoplasm, n (\\%) \n    1 (  0) \n    2 (  0) \n    0 (  0) \n    1 (  2) \n    4 (  0) \n  \n  \n    Moderate or severe liver disease, n (\\%) \n    2 (  0) \n    1 (  0) \n    0 (  0) \n    0 (  0) \n    3 (  0) \n  \n  \n    Dialysis, n (\\%) \n    0 (  0) \n    1 (  0) \n    0 (  0) \n    0 (  0) \n    1 (  0) \n  \n  \n    HIV infection, n (\\%) \n    1 (  0) \n    0 (  0) \n    0 (  0) \n    0 (  0) \n    1 (  0) \n  \n  \n    Dementia, n (\\%) \n    0 (  0) \n    0 (  0) \n    0 (  0) \n    0 (  0) \n    0 (  0) \n  \n  \n    Missing, n (\\%) \n    0 (  0) \n    0 (  0) \n    0 (  0) \n    0 (  0) \n    0 (0.0) \n  \n\n\n\nTable 5:  Baseline co-morbidities for participants randomised into then anticoagulation domain. \n\n\n\n\nSave table to outputs\nsave_tex_table(\n  generate_baseline_comorbidities_table(sdat, format = \"latex\"),\n  \"baseline/comorbidities\"\n)"
  },
  {
    "objectID": "eda/baseline-summaries.html#prognostics",
    "href": "eda/baseline-summaries.html#prognostics",
    "title": "Enrolment and Baseline Summaries",
    "section": "Prognostics",
    "text": "Prognostics\nBaseline prognostics are summarised by anti-coagulation intervention in the following table.\n\n\nPrognostics table\nsdat <- all_data %>%\n    filter_acs_itt() %>%\n  mutate(CAssignment = factor(CAssignment, labels = intervention_labels()$CAssignment[-1]))\ngenerate_baseline_prognostics_table(sdat, format = \"html\")\n\n\n\n\n\n\n \n\n\nAnticoagulation\n\n\n  \n    Variable \n    Lowdose(n = 610) \n    Intermediatedose(n = 613) \n    Low dosewith aspirin(n = 283) \n    Therapeuticdose(n = 50) \n    Overall(n = 1556) \n  \n \n\n  Was the patient on room air for any of the preceding 24 hours?\n\n    Yes, n (\\%) \n    460 (75) \n    460 (75) \n    224 (79) \n    39 (78) \n    1183 (76) \n  \n  \n    Missing, n (\\%) \n    0 (0) \n    0 (0) \n    0 (0) \n    0 (0) \n    0 (0) \n  \n  Was the patient's GCS < 15?\n\n    Yes, n (\\%) \n    63 (10) \n    65 (11) \n    6 (2) \n    2 (4) \n    136 (9) \n  \n  \n    Missing, n (\\%) \n    125 (20) \n    135 (22) \n    60 (21) \n    0 (0) \n    320 (21) \n  \n  Peripheral oxygen saturation (SpO2) on room air (Lowest)\n\n    Median (IQR) \n    95 (94, 97) \n    96 (94, 97) \n    96 (94, 97) \n    94 (92, 96) \n    96 (94, 97) \n  \n  \n    Missing, n (\\%) \n    148 (24) \n    150 (24) \n    54 (19) \n    10 (20) \n    362 (23) \n  \n  Highest respiratory rate (breaths/minute)\n\n    Median (IQR) \n    22 (21, 25) \n    22 (21, 26) \n    22 (20, 26) \n    22 (20, 24) \n    22 (21, 26) \n  \n  \n    Missing, n (\\%) \n    0 (0) \n    1 (0) \n    0 (0) \n    0 (0) \n    1 (0) \n  \n  Highest recorded Urea in the last 24 hours (mmol/L)\n\n    Median (IQR) \n    4 (3, 5) \n    5 (4, 6) \n    4 (3, 6) \n    4 (3, 6) \n    4 (3, 6) \n  \n  \n    Missing, n (\\%) \n    30 (5) \n    33 (5) \n    16 (6) \n    1 (2) \n    80 (5) \n  \n  Highest recorded CRP in the last 24 hours (mg/L)\n\n    Median (IQR) \n    70 (37, 190) \n    75 (38, 220) \n    77 (44, 223) \n    68 (33, 129) \n    73 (39, 200) \n  \n  \n    Missing, n (\\%) \n    74 (12) \n    59 (10) \n    18 (6) \n    29 (58) \n    180 (12) \n  \n  APTT\\\\textsuperscript{1}\n\n    Median (IQR) \n    33 (29, 36) \n    33 (30, 36) \n    32 (28, 37) \n    33 (28, 38) \n    33 (29, 36) \n  \n  \n    Missing, n (\\%) \n    430 (70) \n    439 (72) \n    195 (69) \n    35 (70) \n    1099 (71) \n  \n  INR\\\\textsuperscript{1}\n\n    Mean (SD) \n    1.19 (0.39) \n    1.23 (0.58) \n    1.32 (1.34) \n    1.12 (0.18) \n    1.23 (0.72) \n  \n  \n    Missing, n (\\%) \n    103 (17) \n    105 (17) \n    47 (17) \n    7 (14) \n    262 (17) \n  \n  Fibrinogen\\\\textsuperscript{1} (g/L)\n\n    Mean (SD) \n    5.19 (2.01) \n    5.20 (1.60) \n    4.75 (1.40) \n    6.49 (1.52) \n    5.14 (1.71) \n  \n  \n    Missing, n (\\%) \n    564 (92) \n    555 (91) \n    243 (86) \n    42 (84) \n    1404 (90) \n  \n  Prothrombin time\\\\textsuperscript{1} (sec)\n\n    Median (IQR) \n    14 (13, 17) \n    14 (13, 17) \n    15 (13, 16) \n    13 (12, 14) \n    14 (13, 16) \n  \n  \n    Missing, n (\\%) \n    193 (32) \n    204 (33) \n    116 (41) \n    10 (20) \n    523 (34) \n  \n  Taking aspirin\n\n    Yes, n (\\%) \n    20 (3) \n    25 (4) \n    2 (1) \n    3 (6) \n    50 (3) \n  \n  \n    Missing, n (\\%) \n    0 (0) \n    0 (0) \n    0 (0) \n    0 (0) \n    0 (0) \n  \n  Time from onset of symptoms to hospitalisation\n\n    Median (IQR) \n    5 (3, 7) \n    5 (3, 6) \n    4 (2, 6) \n    4 (3, 6) \n    4 (3, 6) \n  \n  Time from hospitalisation to randomisation\n\n    Median (IQR) \n    1 (0, 2) \n    1 (0, 2) \n    1 (1, 2) \n    1 (1, 1) \n    1 (0, 2) \n  \n\n\n1 For APTT, INR, Fibrinogen, and Prothrombin only at least one required.\n\n\nTable 6:  Baseline prognostic variables for participants randomised into anticoagulation domain. \n\n\n\n\nSave table to outputs\nsave_tex_table(\n  generate_baseline_prognostics_table(sdat, format = \"latex\"),\n  \"baseline/prognostics\"\n)"
  },
  {
    "objectID": "eda/baseline-summaries.html#age",
    "href": "eda/baseline-summaries.html#age",
    "title": "Enrolment and Baseline Summaries",
    "section": "Age",
    "text": "Age\n\n\nHistogram of age\np_age <- all_data %>%\n  filter_acs_itt() %>%\n  ggplot(., aes(AgeAtEntry)) + \n  geom_histogram(\n    breaks = c(18, seq(20, 100, 5)), \n    colour = \"white\", \n    closed=\"left\") +\n  labs(\n    x = \"Age at randomisation (5-year bins, 30 to 34, 35 to 39, etc.)\", \n    y = \"Count\") +\n  scale_x_continuous(breaks = seq(20, 95, 5))\np_age\n\n\n\n\n\nFigure 6: Distribution of age\n\n\n\n\n\n\nCode\npth <- file.path(\"outputs\", \"figures\", \"baseline\")\nggsave(file.path(pth, \"age-overall.pdf\"), p_age, height = 2, width = 4)\n\n\n\n\nHistogram of age by anti-coagulation intervention\np <- all_data %>%\n  filter_acs_itt() %>%\n  ggplot(., aes(AgeAtEntry)) + \n  facet_wrap( ~ CAssignment, scales = \"free_y\", ncol = 2) +\n  geom_histogram(\n    breaks = c(18, seq(20, 100, 5)), \n    colour = \"white\", \n    closed=\"left\") +\n  labs(\n    x = \"Age at randomisation (5-year bins, 30 to 34, 35 to 39, etc.)\", \n    y = \"Count\") +\n  scale_x_continuous(breaks = seq(20, 95, 5))\np\n\n\n\n\n\nFigure 7: Distribution of age by anti-coagulation intervention"
  },
  {
    "objectID": "eda/baseline-summaries.html#weight",
    "href": "eda/baseline-summaries.html#weight",
    "title": "Enrolment and Baseline Summaries",
    "section": "Weight",
    "text": "Weight\n\n\nHistogram of weight\np <- all_data %>%\n  filter_acs_itt() %>%\n  filter(!is.na(BAS_WeightMeasurement)) %>%\n  # 2 with weight reported as 0, make NA\n  mutate(BAS_Weight = if_else(BAS_Weight == 0, NA_real_, BAS_Weight)) %>%\n  ggplot(., aes(BAS_Weight)) +\n  facet_wrap( ~ BAS_WeightMeasurement, scales = \"free_y\") +\n  geom_histogram()\np\n\n\n\n\n\nFigure 8: Distribution of weight"
  },
  {
    "objectID": "eda/baseline-summaries.html#oxygen",
    "href": "eda/baseline-summaries.html#oxygen",
    "title": "Enrolment and Baseline Summaries",
    "section": "Oxygen",
    "text": "Oxygen\n\n\nCode\nall_data %>% \n  dplyr::count(\n    BAS_OnRoomAir24hrs,\n    BAS_OnRoomAir24hrsUnknown,\n    is.na(BAS_PeripheralOxygen)\n  )\n\n\n# A tibble: 5 × 4\n  BAS_OnRoomAir24hrs BAS_OnRoomAir24hrsUnknown `is.na(BAS_PeripheralOxyg…`     n\n  <chr>              <chr>                     <lgl>                       <int>\n1 No                 No                        FALSE                          11\n2 No                 No                        TRUE                          354\n3 No                 Yes                       TRUE                           25\n4 Yes                No                        FALSE                        1209\n5 <NA>               <NA>                      TRUE                          646\n\n\nCode\nall_data %>%\n  dplyr::count(\n    BAS_OnRoomAir24hrs == \"Yes\",\n    BAS_PeripheralOxygen < 94\n  )\n\n\n# A tibble: 6 × 3\n  `BAS_OnRoomAir24hrs == \"Yes\"` `BAS_PeripheralOxygen < 94`     n\n  <lgl>                         <lgl>                       <int>\n1 FALSE                         FALSE                           6\n2 FALSE                         TRUE                            5\n3 FALSE                         NA                            379\n4 TRUE                          FALSE                         921\n5 TRUE                          TRUE                          288\n6 NA                            NA                            646"
  },
  {
    "objectID": "eda/baseline-summaries.html#date-since-first-symptoms",
    "href": "eda/baseline-summaries.html#date-since-first-symptoms",
    "title": "Enrolment and Baseline Summaries",
    "section": "Date since first symptoms",
    "text": "Date since first symptoms\n\n\n\n\n\nCode\npth <- file.path(\"outputs\", \"figures\", \"baseline\")\nggsave(file.path(pth, \"days-between-events-overall.pdf\"), p, height = 3, width = 6)\n\n\n\n\nCode\ntsfs_dat %>%\n  dplyr::count(CAssignment, `TSFS > 7 days` = fs_to_rand > 7) %>%\n  spread(CAssignment, n)\n\n\n# A tibble: 2 × 5\n  `TSFS > 7 days`    C1    C2    C3    C4\n  <lgl>           <int> <int> <int> <int>\n1 FALSE             421   432   206    39\n2 TRUE              189   181    77    11"
  },
  {
    "objectID": "eda/baseline-summaries.html#d-dimer",
    "href": "eda/baseline-summaries.html#d-dimer",
    "title": "Enrolment and Baseline Summaries",
    "section": "D-dimer",
    "text": "D-dimer\n\n\nCode\nall_data %>%\n  filter_acs_itt() %>%\n  dplyr::count(\n    BAS_DDimerTestPerformed,\n    BAS_DDimerOutOfRange, \n    BAS_DDimerUnits)\n\n\n# A tibble: 7 × 4\n  BAS_DDimerTestPerformed BAS_DDimerOutOfRange BAS_DDimerUnits     n\n  <chr>                   <chr>                <chr>           <int>\n1 No                      <NA>                 ug/mL OR mg/L       1\n2 No                      <NA>                 <NA>              283\n3 Yes                     No                   ug/L OR ng/mL     287\n4 Yes                     No                   ug/mL OR mg/L     551\n5 Yes                     Yes                  ug/L OR ng/mL     215\n6 Yes                     Yes                  ug/mL OR mg/L     217\n7 Yes                     <NA>                 ug/mL OR mg/L       2\n\n\n\n\nCode\nall_data %>% \n  filter_acs_itt() %>%\n  ggplot(., aes(BAS_DDimerEntered, BAS_DDimerResult)) +\n  facet_wrap( ~ BAS_DDimerUnits, scales = \"free_x\") +\n  geom_point()\n\n\n\n\n\n\n\nCode\nall_data %>% \n  filter_acs_itt() %>%\n  ggplot(., aes(BAS_DDimerResult)) +\n  geom_histogram() +\n  scale_x_log10()"
  },
  {
    "objectID": "eda/baseline-summaries.html#serum-creatinine",
    "href": "eda/baseline-summaries.html#serum-creatinine",
    "title": "Enrolment and Baseline Summaries",
    "section": "Serum Creatinine",
    "text": "Serum Creatinine\nThere is an issue with the serum creatinine units for some participants. These have been reported as “umol/L” when in fact it is more likely they are in mg/dL (spike at values reported as umol/L and less than 1, noting that 1 mg/dL = 88.42 umol/L).\n\n\nCode\nall_data %>%\n  filter(\n    EL_SerumCreatinineUnits == \"umol/L\",\n    EL_SerumCreatinineBlood <= 1.5\n  ) %>%\n  select(\n    EligibilityCode, \n    StudyPatientID, \n    starts_with(\"EL_Serum\"))\n\n\n# A tibble: 0 × 7\n# … with 7 variables: EligibilityCode <chr>, StudyPatientID <chr>,\n#   EL_SerumCreatinineBlood <dbl>, EL_SerumCreatinineUnits <chr>,\n#   EL_SerumCreatinine_umolL <dbl>, EL_SerumPotassium <dbl>,\n#   EL_SerumSodium <dbl>\n\n\nCode\n  # write_csv(file.path(ASCOT_DATA, \"derived\", \"low_creatinine_values.csv\"))\nggplot(all_data %>% \n         filter(!is.na(EL_SerumCreatinineUnits)), \n       aes(EL_SerumCreatinine_umolL)) +\n  geom_histogram(bins = 25, boundary = 0) +\n  facet_wrap( ~ EL_SerumCreatinineUnits) +\n  scale_x_log10()\n\n\n\n\n\nFigure 9: Histogram of serum creatinine levels at baseline by reported units. Note the cluster at ~ 1 umol/L for values reported in umol/L.\n\n\n\n\n\n\nCode\ntmp <- all_data %>%\n  filter(!is.na(EL_SerumCreatinineUnits)) %>%\n  mutate(\n    clearance = creatinine_clearance(\n      Sex, AgeAtEntry, BAS_Weight, EL_SerumCreatinine_umolL)\n  )\np1 <- ggplot(tmp, aes(clearance)) + \n  facet_wrap( ~ EL_SerumCreatinineUnits) +\n  geom_histogram() + \n  geom_vline(xintercept = 30) +\n  scale_x_log10() +\n  labs(x = \"Creatinine clearance\\n(mL/min)\", y = \"Frequency\")\np2 <- ggplot(tmp, aes(EL_SerumCreatinine_umolL, clearance)) + \n  facet_wrap( ~ EL_SerumCreatinineUnits) +\n  geom_point() + \n  scale_x_log10() +\n  scale_y_log10() +\n  labs(x = \"Serum creatinine\\n(umol/L)\", y = \"Creatinine clearance\\n(mL/min)\")\np1 / p2\n\n\n\n\n\nFigure 10: Creatinine clearance rate from formula. Facets are the reported units (converted to umol/L where required). Vertical line marks 30 mL/min."
  },
  {
    "objectID": "eda/data-overview.html",
    "href": "eda/data-overview.html",
    "title": "Data Overview",
    "section": "",
    "text": "Code\nlibrary(tidyverse)\nlibrary(patchwork)\nlibrary(DT)\nlibrary(plotly)\nlibrary(knitr)\nlibrary(kableExtra)\n\ntheme_set(theme_minimal(base_size = 12))"
  },
  {
    "objectID": "eda/data-overview.html#dictionary",
    "href": "eda/data-overview.html#dictionary",
    "title": "Data Overview",
    "section": "Dictionary",
    "text": "Dictionary\n\n\nCode\ndict <- read_dictionary() %>%\n  select(HeadingName, DbField, FieldTitle, FieldFormatting, ValidationNotes)\ndatatable(dict)"
  },
  {
    "objectID": "eda/data-overview.html#data-completeness",
    "href": "eda/data-overview.html#data-completeness",
    "title": "Data Overview",
    "section": "Data Completeness",
    "text": "Data Completeness\n\n\nCode\ncompleteness <- summarise_completeness_data(generate_completeness_data(all_daily_data %>% filter(ENR_rec == 1)))\ncompleteness$combined %>%\n  datatable() %>%\n  formatStyle(2:10, 'text-align' = \"right\", \"white-space\" = \"nowrap\")"
  },
  {
    "objectID": "eda/data-overview.html#available-records",
    "href": "eda/data-overview.html#available-records",
    "title": "Data Overview",
    "section": "Available Records",
    "text": "Available Records\n\n\nCode\nall_data %>%\n  count(EL_rec, ENR_rec, BAS_rec, DIS_rec, D28_rec, WTH_rec) %>%\n  kable(\"html\") %>%\n  kable_styling(\"striped\", font_size = 14)\n\n\n\n\n\n \n  \n    EL_rec \n    ENR_rec \n    BAS_rec \n    DIS_rec \n    D28_rec \n    WTH_rec \n    n \n  \n \n\n  \n    1 \n    0 \n    0 \n    0 \n    0 \n    0 \n    646 \n  \n  \n    1 \n    1 \n    1 \n    0 \n    0 \n    1 \n    17 \n  \n  \n    1 \n    1 \n    1 \n    0 \n    1 \n    1 \n    1 \n  \n  \n    1 \n    1 \n    1 \n    1 \n    1 \n    0 \n    1567 \n  \n  \n    1 \n    1 \n    1 \n    1 \n    1 \n    1 \n    14 \n  \n\n\n\nTable 1:  Patterns of record availability for all screened participants."
  },
  {
    "objectID": "eda/patient-disposition.html",
    "href": "eda/patient-disposition.html",
    "title": "Patient Disposition and Baseline",
    "section": "",
    "text": "Load packages\nlibrary(tidyverse)\nlibrary(labelled)\nlibrary(kableExtra)\nlibrary(plotly)\n\ntheme_set(theme_minimal(base_size = 12))\n\n\n\n\nPrepare dataset\ndevtools::load_all()\ndat <- read_all_no_daily()"
  },
  {
    "objectID": "eda/patient-disposition.html#anti-coagulation-domain-criteria",
    "href": "eda/patient-disposition.html#anti-coagulation-domain-criteria",
    "title": "Patient Disposition and Baseline",
    "section": "Anti-Coagulation Domain Criteria",
    "text": "Anti-Coagulation Domain Criteria\nFor reference, the exclusion criteria for the anti-coagulation domain follows (derived variable EL_inelg_c):\n\nReceiving dual antiplatelet therapy (EL_DualAntiplateletTherapy)\nThe treating clinician intends to continue or commence therapeutic anticoagulation (EL_TherapeuticAnticoag)\nContraindication to receiving low molecular weight heparin or unfractionated heparin (EL_ContraHeparinReact)\nSevere thrombocytopenia (platelet count less than 30 x \\(10^9\\)/L [protocol version 3.0] or less than 50 x \\(10^9\\)/L [protocol version 5.0] (EL_BloodPlateletTestAs_x10_9_L)\nHistory of intracranial haemorrhage in the previous 3 months (EL_IntracranialHaemorrhage)\nSevere renal impairment, defined as estimated glomerular filtration rate less than 15ml/min/1.73m\\(^2\\) (EL_eGFR)\nA current or recurrent condition with a high risk of major bleeding (e.g. bleeding disorder), or a baseline coagulation profile (within the previous 3 days) that indicates a high risk of bleeding, that would be considered a contraindication to receive therapeutic anticoagulation (EL_BleedingConditionThrombo)\n\n\n\nConsent to anticoagulation domain\ndat %>%\n  filter(ENR_rec == 1) %>%\n  dplyr::count(\n    EL_inelg_c,\n    CAssignment,\n    EL_Con_DomainC\n  )\n\n\n# A tibble: 7 × 4\n  EL_inelg_c CAssignment EL_Con_DomainC     n\n   <int+lbl> <chr>       <chr>          <int>\n1          0 C0          No                12\n2          0 C1          Yes              619\n3          0 C2          Yes              620\n4          0 C3          Yes              285\n5          0 C4          Yes               50\n6          1 C0          <NA>               2\n7         NA C0          <NA>              11\n\n\nThe one participant with blood platelet less than 50 was correctly enrolled under protocol version 3.0 (blood platelet was > 30).\n\n\nEligibility of those who consent\ndat %>%\n  filter(\n    ENR_rec == 1, \n    EL_Con_DomainC == \"Yes\",\n    !is.na(EL_Con_DomainC)\n  ) %>%\n  summarise(\n    `Receiving therapeutic anticoag` = \n      sum(EL_TherapeuticAnticoag == \"Yes\"),\n    `Dualy antiplatelet therapy` = \n      sum(EL_DualAntiplateletTherapy == \"Yes\"),\n    `Blood platelet < 30` = \n      sum(EL_BloodPlateletTestAs_x10_9_L < 30),\n    `Blood platelet < 50` = \n      sum(EL_BloodPlateletTestAs_x10_9_L < 50),\n    `Contraindication heparin` = \n      sum(EL_ContraHeparinReact == \"Yes\"),\n    `Intracranial haemorrahge` = \n      sum(EL_IntracranialHaemorrhage == \"Yes\"),\n    `Bleeding condition` = \n      sum(EL_BleedingConditionThrombo == \"Yes\"),\n    `eGFR < 15` = \n      sum(EL_eGFR < 15)\n  ) %>%\n  gather()\n\n\n# A tibble: 8 × 2\n  key                            value\n  <chr>                          <int>\n1 Receiving therapeutic anticoag     0\n2 Dualy antiplatelet therapy         0\n3 Blood platelet < 30                0\n4 Blood platelet < 50                1\n5 Contraindication heparin           0\n6 Intracranial haemorrahge           0\n7 Bleeding condition                 0\n8 eGFR < 15                          0\n\n\n\nIntervention Specific Criteria\nOnly the standard dose plus aspirin intervention had intervention specific exclusion criteria (appendix version 3.0). For reference, these criteria were (derived variable EL_inelg_c3):\n\nReceiving an antiplatelet agent will exclude a patient from receiving standard thromboprophylaxis plus aspirin (EL_ReceivingAntiplatelet)\nHypersensitivity to aspirin will exclude a patient from receiving standard thrmoboprophylaxis plus aspirin (EL_HyperAspirin)\n\nAfter this intervention had been dropped from the platform, the eligibility criteria ceased to be assessed, so this information is not available for participants enrolled after the intervention had been removed.\n\n\nEligibility for C3 intervention\ndat %>%\n  filter(ENR_rec == 1) %>%\n  dplyr::count(\n    EL_inelg_c3,\n    EL_ReceivingAntiplatelet,\n    EL_HyperAspirin,\n    CAssignment,\n    EL_Con_DomainC\n  )\n\n\n# A tibble: 13 × 6\n   EL_inelg_c3 EL_ReceivingAnt… EL_HyperAspirin CAssignment EL_Con_DomainC     n\n     <int+lbl> <chr>            <chr>           <chr>       <chr>          <int>\n 1           0 No               No              C0          No                 3\n 2           0 No               No              C1          Yes              356\n 3           0 No               No              C2          Yes              347\n 4           0 No               No              C3          Yes              285\n 5           1 Yes              No              C0          No                 1\n 6           1 Yes              No              C1          Yes               20\n 7           1 Yes              No              C2          Yes               18\n 8           1 Yes              Yes             C2          Yes                1\n 9          NA <NA>             <NA>            C0          No                 8\n10          NA <NA>             <NA>            C0          <NA>              13\n11          NA <NA>             <NA>            C1          Yes              243\n12          NA <NA>             <NA>            C2          Yes              254\n13          NA <NA>             <NA>            C4          Yes               50"
  },
  {
    "objectID": "analyses/7-1_time_to_clinical_recovery.html",
    "href": "analyses/7-1_time_to_clinical_recovery.html",
    "title": "7-1 Time to clinical recovery during the first 28 days",
    "section": "",
    "text": "Load packages\nlibrary(tidyverse)\nlibrary(labelled)\nlibrary(kableExtra)\nlibrary(cmdstanr)\nlibrary(posterior)\nlibrary(bayestestR)\nlibrary(bayesplot)\nlibrary(matrixStats)\nlibrary(plotly)\nlibrary(lubridate)\nlibrary(ggdist)\nlibrary(patchwork)\nlibrary(VGAM)\n\ntheme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank()))\nbayesplot_theme_set(theme_set(theme_classic(base_size = 10, base_family = \"Palatino\") +\n  theme(panel.grid = element_blank(),\n        strip.background = element_blank())))\ncolor_scheme_set(\"red\")\noptions(digits = 4)\n\n\n\n\nLoad Models\nmlogit_mod <- cmdstan_model(\"stan/tte/tte_competing_alt.stan\")\nmlogit_rw <- cmdstan_model(\"stan/tte/tte_competing_rw.stan\")\nmlogit_epoch <- cmdstan_model(\"stan/tte/tte_competing_epoch.stan\")\nmlogit_site_epoch <- cmdstan_model(\"stan/tte/tte_competing_site_epoch.stan\") \n\n\n\n\nCode\nmlogit <- function(x) exp(x) / (1 + rvar_sum(exp(x)))\n\n\nmake_ttr_summary <- function(dat, format = \"html\") {\n  tdat <- dat %>%\n    group_by(\n      Intervention = \n        factor(CAssignment, \n               levels = c(\"C1\", \"C2\", \"C3\", \"C4\"),\n               labels = c(\"Low\", \"Intermediate\", \n                          \"Low with aspirin\", \"Therapeutic\"))) %>%\n    summarise(\n      Randomised = n(),\n      Known = sum(!is.na(out_ttr)),\n      Died = sprintf(\"%i (%.1f)\", sum(out_rec == 2), 100 * mean(out_rec == 2)),\n      Recovered = sprintf(\"%i (%.1f)\", sum(out_rec == 1), 100 * mean(out_rec == 1)),\n      Unrecovered = sprintf(\"%i (%.1f)\", sum(out_rec == 0), 100 * mean(out_rec == 0)),\n      `TTR, Median (Q1, Q3)` = sprintf(\n        \"%i (%.2f, %.2f)\",\n        median(out_ttr[out_rec == 1]),\n        quantile(out_ttr[out_rec == 1], 0.25),\n        quantile(out_ttr[out_rec == 1], 0.75)\n      )\n    ) \n  kable(\n    tdat,\n    format = format,\n    align = \"lrrrrrr\",\n    booktabs = TRUE) %>%\n    kable_styling(font_size = 9, latex_options = \"HOLD_position\")\n}\n\nmake_odds_ratio_table <- function(drws, format = \"html\") {\n  tdat <- as_tibble(drws$OR, rownames = \"Factor\") %>%\n  pivot_longer(Recovery:Death) %>%\n  mutate(name = factor(name, levels = c(\"Recovery\", \"Death\"))) %>%\n  arrange(name) %>%\n  mutate(\n    Median = sprintf(\"%.2f\", median(value)),\n    `95\\\\% CrI` = sprintf(\"(%.2f, %.2f)\", quantile(value, 0.025), quantile(value, 0.975)),\n    `Mean (SD)` = sprintf(\"%.2f (%.2f)\", mean(value), sd(value)),\n    `Pr(OR > 1)` = sprintf(\"%.2f\", Pr(value > 1))\n  )\n  kable(\n    tdat %>% select(-name, -value),\n    format = format,\n    align = \"lrrrr\",\n    booktabs = TRUE,\n    escape = F\n  ) %>%\n    kable_styling(\n      font_size = 9,\n      latex_options = \"HOLD_position\"\n    ) %>%\n    group_rows(\"Recovery\", 1, nrow(drws$OR)) %>%\n    group_rows(\"Death\", nrow(drws$OR) + 1, 2*nrow(drws$OR))\n}\n\nget_arm_specific_probs <- function(drws, shift = FALSE) {\n  haztbl <- vector(\"list\", nrow(drws$Ccon))\n  names(haztbl) <- rownames(drws$Ccon)\n  if(shift) {\n    alph <- drws$alpha_shift\n  } else {\n    alph <- drws$alpha\n  }\n  for (k in 1:nrow(drws$Ccon)) {\n    haz <- t(do.call(cbind, apply(sweep(alph, 2, drws$Ccon[k, ], \"+\"), 1, mlogit)))\n    haz <- cbind(1 - (haz[, 1] + haz[, 2]), haz)\n    colnames(haz) <- c(\"haz0\", \"haz1\", \"haz2\")\n    haztbl[[k]] <- bind_cols(time = 1:28, as_tibble(haz)) %>%\n      mutate(\n        surv = cumprod(haz0),\n        prob1 = haz1 * lag(surv, default = rvar(1)),\n        prob2 = haz2 * lag(surv, default = rvar(1)),\n        cprob1 = cumsum(prob1),\n        cprob2 = cumsum(prob2)\n      )\n  }\n  out <- bind_rows(haztbl, .id = \"intervention\")\n  return(out)\n}\n\nplot_baseline_hazard <- function(drws) {\n  as_tibble(drws$alpha, rownames = \"day\") %>%\n    mutate(day = as.numeric(day)) %>%\n    rename(Recovery = V1, Death = V2) %>%\n    pivot_longer(Recovery:Death) %>%\n    ggplot(., \n           aes(xdist=value, y = day)) + \n    facet_wrap( ~ name, scales = \"free_x\") +\n    stat_pointinterval() +\n    labs(x = \"Baseline cause-specific hazard (logit)\", y = \"Study day\") +\n    scale_y_continuous(breaks = c(1, 7, 14, 21, 28))\n}\n\n\n\n\nPrepare dataset\ndevtools::load_all()\nall_dat <- read_all_no_daily()\n\nacs_itt_dat <- all_dat %>% \n  filter_acs_itt() %>%\n  transmute_model_cols_grp_aus_nz()\nacs_itt_nona_dat <- acs_itt_dat %>% \n  filter(!is.na(out_ttr))\n\nttr_seq <- expand_grid(\n  StudyPatientID = unique(acs_itt_nona_dat$StudyPatientID),\n  time = 1:28)\nacs_itt_outdat <- acs_itt_nona_dat %>%\n  left_join(ttr_seq, by = \"StudyPatientID\") %>%\n  filter(time <= out_ttr) %>%\n  mutate(\n    y = if_else(out_ttr == time, out_rec, 0),\n    y0 = if_else(out_ttr > time | out_ttr == time & out_rec == 0, 1, 0), # Not recovered or died\n    y1 = if_else(out_ttr == time & out_rec == 1, 1, 0), # Recovered\n    y2 = if_else(out_ttr == time & out_rec == 2, 1, 0)  # Died\n  )\nacs_itt_outdat_agg <- acs_itt_outdat %>%\n  complete(CAssignment, time, fill = list(y = 0)) %>%\n  group_by(CAssignment, time) %>%\n  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = \"drop\") %>%\n  group_by(CAssignment) %>%\n  mutate(cy1 = cumsum(y1), \n         cp1 = cy1 / n[1],\n         cy2 = cumsum(y2),\n         cp2 = cy2 / n[1],\n         cpn = (n[1] - cy1 - cy2) / n[1]) %>%\n  ungroup() %>%\n  mutate(CAssignment = factor(\n    CAssignment, labels = str_replace(intervention_labels()$CAssignment[-1], \"<br>\", \" \")))\n\n\nacs_itt_concurc2_dat <- acs_itt_dat %>%\n  filter_concurrent_intermediate()\nacs_itt_concurc2_nona_dat <- acs_itt_concurc2_dat %>% \n  filter(!is.na(out_ttr)) %>%\n  left_join(ttr_seq, by = \"StudyPatientID\") %>%\n  filter(time <= out_ttr) %>%\n  mutate(\n    y = if_else(out_ttr == time, out_rec, 0),\n    y0 = if_else(out_ttr > time | out_ttr == time & out_rec == 0, 1, 0), # Not recovered or died\n    y1 = if_else(out_ttr == time & out_rec == 1, 1, 0), # Recovered\n    y2 = if_else(out_ttr == time & out_rec == 2, 1, 0)  # Died\n  )\n\n# Aspirin\nacs_itt_concurc3_dat <- acs_itt_dat %>%\n  filter_concurrent_std_aspirin()\nacs_itt_concurc3_nona_dat <- acs_itt_concurc3_dat %>% \n  filter(!is.na(out_ttr)) %>%\n  left_join(ttr_seq, by = \"StudyPatientID\") %>%\n  filter(time <= out_ttr) %>%\n  mutate(\n    y = if_else(out_ttr == time, out_rec, 0),\n    y0 = if_else(out_ttr > time | out_ttr == time & out_rec == 0, 1, 0), # Not recovered or died\n    y1 = if_else(out_ttr == time & out_rec == 1, 1, 0), # Recovered\n    y2 = if_else(out_ttr == time & out_rec == 2, 1, 0)  # Died\n  )\n\nacs_itt_concurc4_dat <- acs_itt_dat %>%\n  filter_concurrent_therapeutic()\nacs_itt_concurc4_nona_dat <- acs_itt_concurc4_dat %>% \n  filter(!is.na(out_ttr)) %>%\n  left_join(ttr_seq, by = \"StudyPatientID\") %>%\n  filter(time <= out_ttr) %>%\n  mutate(\n    y = if_else(out_ttr == time, out_rec, 0),\n    y0 = if_else(out_ttr > time | out_ttr == time & out_rec == 0, 1, 0), # Not recovered or died\n    y1 = if_else(out_ttr == time & out_rec == 1, 1, 0), # Recovered\n    y2 = if_else(out_ttr == time & out_rec == 2, 1, 0)  # Died\n  )"
  },
  {
    "objectID": "analyses/7-1_time_to_clinical_recovery.html#time-to-recovery",
    "href": "analyses/7-1_time_to_clinical_recovery.html#time-to-recovery",
    "title": "7-1 Time to clinical recovery during the first 28 days",
    "section": "Time to recovery",
    "text": "Time to recovery\n\n\nCode\nsave_tex_table(\n  make_ttr_summary(acs_itt_dat, \"latex\"),\n  file.path(\"outcomes\", \"secondary\", \"7-1-acs-itt-summary\")\n)\nmake_ttr_summary(acs_itt_dat)\n\n\n\n\n \n  \n    Intervention \n    Randomised \n    Known \n    Died \n    Recovered \n    Unrecovered \n    TTR, Median (Q1, Q3) \n  \n \n\n  \n    Low \n    610 \n    610 \n    15 (2.5) \n    592 (97.0) \n    3 (0.5) \n    6 (4.00, 7.00) \n  \n  \n    Intermediate \n    613 \n    613 \n    10 (1.6) \n    598 (97.6) \n    5 (0.8) \n    6 (4.00, 7.00) \n  \n  \n    Low with aspirin \n    283 \n    283 \n    9 (3.2) \n    271 (95.8) \n    3 (1.1) \n    6 (4.00, 8.00) \n  \n  \n    Therapeutic \n    50 \n    50 \n    4 (8.0) \n    46 (92.0) \n    0 (0.0) \n    6 (4.25, 9.00) \n  \n\n\n\nSummary of time to recovery to day 28 by anticoagulation intervention.\n\n\n\nCode\nacs_itt_nona_dat %>%\n  dplyr::count(out_rec, out_ttr) %>%\n  ggplot(., aes(out_ttr, n, fill = factor(out_rec, labels = c(\"censored\", \"recovered\", \"died\")))) +\n  geom_col() +\n  scale_x_continuous(breaks = 1:28) +\n  scale_fill_viridis_d(option = \"A\", begin = 0.2, end = 0.8) +\n  labs(x = \"Time to recovery (to day 28)\", y = \"Count\", fill = \"Outcome\")\n\n\n\n\n\nFigure 1: Distribution of time to recovery."
  },
  {
    "objectID": "analyses/7-1_time_to_clinical_recovery.html#anticoagulation",
    "href": "analyses/7-1_time_to_clinical_recovery.html#anticoagulation",
    "title": "7-1 Time to clinical recovery during the first 28 days",
    "section": "Anticoagulation",
    "text": "Anticoagulation\n\n\nCode\np <- acs_itt_outdat_agg %>% \n  select(-y1, -y2, -cy1, -cy2) %>% \n  pivot_longer(cp1:cpn) %>% \n  mutate(name = factor(\n    name, \n    levels = c(\"cp1\", \"cp2\", \"cpn\"), \n    labels = c(\"Recovered\", \"Died\", \"Not recovered\"))) %>%\n  ggplot(., aes(time, value, fill = name, colour = name)) + \n  facet_wrap(~CAssignment) + \n  geom_col(width = 1) +\n  scale_fill_viridis_d(option = \"B\", begin = 0.2, end = 0.8) +\n  scale_colour_viridis_d(option = \"B\", begin = 0.2, end = 0.8) +\n  scale_x_continuous(breaks = c(1, 7, 14, 21, 28)) +\n  labs(x = \"Study day\", y = \"Cumulative proportion\", fill = \"Status\", colour = \"Status\") +\n  theme(panel.grid.minor = element_blank())\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"outcome-7-1-descriptive.pdf\"), p, height = 2.5, width = 6)\np\n\n\n\n\n\nFigure 2: Progression to recovery by anticoagulation intervention.\n\n\n\n\n\n\nCode\np <- acs_itt_outdat_agg %>% \n  select(-y1, -y2, -cy1, -cy2) %>% \n  pivot_longer(cp1:cpn) %>% \n  mutate(name = factor(\n    name, \n    levels = c(\"cp1\", \"cp2\", \"cpn\"), \n    labels = c(\"Recovered\", \"Died\", \"Not recovered\"))) %>%\n  ggplot(., aes(time, value, colour = CAssignment)) + \n  facet_wrap(~ name, scales = \"free_y\") + \n  geom_step() +\n  scale_colour_viridis_d(option = \"B\", begin = 0.2, end = 0.8) +\n  scale_x_continuous(breaks = c(1, 7, 14, 21, 28)) +\n  labs(x = \"Study day\", y = \"Cumulative proportion\", colour = \"Intervention\") +\n  theme(panel.grid.minor = element_blank(),\n        legend.position = \"bottom\") +\n  guides(colour = guide_legend(title.position=\"top\", title.hjust = 0.5))\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"outcome-7-1-descriptive-alt.pdf\"), p, height = 2.5, width = 6)\np\n\n\n\n\n\nFigure 3: Progression to recovery by anticoagulation intervention."
  },
  {
    "objectID": "analyses/7-1_time_to_clinical_recovery.html#age",
    "href": "analyses/7-1_time_to_clinical_recovery.html#age",
    "title": "7-1 Time to clinical recovery during the first 28 days",
    "section": "Age",
    "text": "Age\n\n\nCode\ntmp_agg <- acs_itt_outdat %>%\n  complete(agegte60, time, fill = list(y = 0)) %>%\n  group_by(agegte60, time) %>%\n  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = \"drop\") %>%\n  group_by(agegte60) %>%\n  mutate(cy1 = cumsum(y1), \n         cp1 = cy1 / n[1],\n         cy2 = cumsum(y2),\n         cp2 = cy2 / n[1],\n         cy0 = (n[1] - cy1 - cy2),\n         cpn = (n[1] - cy1 - cy2) / n[1]) %>%\n  ungroup() %>%\n  mutate(agegte60 = factor(agegte60, levels = c(0, 1), labels = c(\"Age < 60\", \"Age \\u2265 60\")))\np <- tmp_agg %>% \n  select(-y1, -y2, -cp1, -cp2, -cpn) %>% \n  pivot_longer(cy1:cy0) %>% \n  mutate(name = factor(\n    name, \n    levels = c(\"cy1\", \"cy2\", \"cy0\"), \n    labels = c(\"Recovered\", \"Died\", \"Not recovered\"))) %>%\n  ggplot(., aes(time, value, fill = name, colour = name)) + \n  facet_wrap(~agegte60, scales = \"free_y\") + \n  geom_col(width = 1) +\n  scale_fill_viridis_d(option = \"B\", begin = 0.2, end = 0.8) +\n  scale_colour_viridis_d(option = \"B\", begin = 0.2, end = 0.8) +\n  scale_x_continuous(breaks = c(1, 7, 14, 21, 28)) +\n  labs(x = \"Study day\", y = \"Cumulative proportion\", fill = \"Status\", colour = \"Status\") +\n  theme(panel.grid.minor = element_blank())\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-1-age.pdf\"), p, height = 2, width = 6)\np\n\n\n\n\n\nFigure 4: Progression to recovery by anticoagulation intervention."
  },
  {
    "objectID": "analyses/7-1_time_to_clinical_recovery.html#country",
    "href": "analyses/7-1_time_to_clinical_recovery.html#country",
    "title": "7-1 Time to clinical recovery during the first 28 days",
    "section": "Country",
    "text": "Country\n\n\nCode\ntmp_agg <- acs_itt_outdat %>%\n  complete(country, time, fill = list(y = 0)) %>%\n  group_by(country, time) %>%\n  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = \"drop\") %>%\n  group_by(country) %>%\n  mutate(cy1 = cumsum(y1), \n         cp1 = cy1 / n[1],\n         cy2 = cumsum(y2),\n         cp2 = cy2 / n[1],\n         cy0 = (n[1] - cy1 - cy2),\n         cpn = (n[1] - cy1 - cy2) / n[1]) %>%\n  ungroup() %>%\n  mutate(country = factor(country, levels = c(\"IN\", \"AU\", \"NP\", \"NZ\"),\n                          labels = c(\"India\", \"Australia\", \"Nepal\", \"New Zealand\")))\np <- tmp_agg %>% \n  select(-y1, -y2, -cp1, -cp2, -cpn) %>% \n  pivot_longer(cy1:cy0) %>% \n  mutate(name = factor(\n    name, \n    levels = c(\"cy1\", \"cy2\", \"cy0\"), \n    labels = c(\"Recovered\", \"Died\", \"Not recovered\"))) %>%\n  ggplot(., aes(time, value, fill = name, colour = name)) + \n  facet_wrap(~country, scales = \"free_y\") + \n  geom_col(width = 1) +\n  scale_fill_viridis_d(option = \"B\", begin = 0.2, end = 0.8) +\n  scale_colour_viridis_d(option = \"B\", begin = 0.2, end = 0.8) +\n  scale_x_continuous(breaks = c(1, 7, 14, 21, 28)) +\n  labs(x = \"Study day\", y = \"Cumulative count\", fill = \"Status\", colour = \"Status\") +\n  theme(panel.grid.minor = element_blank())\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-1-country.pdf\"), p, height = 2.5, width = 6)\np\n\n\n\n\n\nFigure 5: Progression to recovery by country."
  },
  {
    "objectID": "analyses/7-1_time_to_clinical_recovery.html#calender-time",
    "href": "analyses/7-1_time_to_clinical_recovery.html#calender-time",
    "title": "7-1 Time to clinical recovery during the first 28 days",
    "section": "Calender Time",
    "text": "Calender Time\n\n\nCode\ntmp_agg <- acs_itt_outdat %>%\n  mutate(yr = year(RandDate), mth = month(RandDate)) %>%\n  complete(nesting(yr, mth), time, fill = list(y = 0)) %>%\n  group_by(yr, mth, time) %>%\n  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = \"drop\") %>%\n  group_by(yr, mth) %>%\n  mutate(cy1 = cumsum(y1), \n         cp1 = cy1 / n[1],\n         cy2 = cumsum(y2),\n         cp2 = cy2 / n[1],\n         cy0 = (n[1] - cy1 - cy2),\n         cpn = (n[1] - cy1 - cy2) / n[1]) %>%\n  ungroup() %>%\n  mutate(label = fct_inorder(paste(yr, mth, sep = \"-\")))\np <- tmp_agg %>% \n  select(-y1, -y2, -cp1, -cp2, -cpn) %>% \n  pivot_longer(cy1:cy0) %>% \n  mutate(name = factor(\n    name, \n    levels = c(\"cy1\", \"cy2\", \"cy0\"), \n    labels = c(\"Recovered\", \"Died\", \"Not recovered\"))) %>%\n  ggplot(., aes(time, value, fill = name, colour = name)) + \n  facet_wrap(~label, scales = \"free_y\", ncol = 5) + \n  geom_col(width = 1) +\n  scale_fill_viridis_d(option = \"B\", begin = 0.2, end = 0.8) +\n  scale_colour_viridis_d(option = \"B\", begin = 0.2, end = 0.8) +\n  scale_x_continuous(breaks = c(1, 7, 14, 21, 28)) +\n  labs(x = \"Study day\", y = \"Cumulative count\", fill = \"Status\", colour = \"Status\") +\n  theme(panel.grid.minor = element_blank(),\n        legend.position = \"bottom\")\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-1-calendar-time.pdf\"), p, height = 4, width = 6)\np\n\n\n\n\n\nFigure 6: Progression to recovery by calendar time"
  },
  {
    "objectID": "analyses/7-1_time_to_clinical_recovery.html#site",
    "href": "analyses/7-1_time_to_clinical_recovery.html#site",
    "title": "7-1 Time to clinical recovery during the first 28 days",
    "section": "Site",
    "text": "Site\n\n\nCode\ntmp_agg <- acs_itt_outdat %>%\n  complete(nesting(country, site_raw), time, fill = list(y = 0)) %>%\n  mutate(site_raw = fct_infreq(site_raw)) %>%\n  group_by(country, site_raw, time) %>%\n  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = \"drop\") %>%\n  group_by(country, site_raw) %>%\n  mutate(cy1 = cumsum(y1), \n         cp1 = cy1 / n[1],\n         cy2 = cumsum(y2),\n         cp2 = cy2 / n[1],\n         cy0 = (n[1] - cy1 - cy2),\n         cpn = (n[1] - cy1 - cy2) / n[1]) %>%\n  ungroup()\n\nplot_country <- function(ctr, ncol = 2) {\n  tmp_agg %>% \n    filter(country == ctr) %>%\n    select(-y1, -y2, -cp1, -cp2, -cpn) %>% \n    pivot_longer(cy1:cy0) %>% \n    mutate(name = factor(\n      name, \n      levels = c(\"cy1\", \"cy2\", \"cy0\"), \n      labels = c(\"Recovered\", \"Died\", \"Not recovered\"))) %>%\n    ggplot(., aes(time, value, fill = name, colour = name)) + \n    facet_wrap( ~ site_raw, scales = \"free_y\", ncol = ncol) + \n    geom_col(width = 1) +\n    scale_fill_viridis_d(option = \"B\", begin = 0.2, end = 0.8) +\n    scale_colour_viridis_d(option = \"B\", begin = 0.2, end = 0.8) +\n    scale_x_continuous(breaks = c(1, 7, 14, 21, 28)) +\n    scale_y_continuous(breaks = function(x) unique(floor(pretty(seq(0, (max(x) + 1) * 1.1))))) +\n    labs(x = \"Study day\", y = \"Cumulative\\ncount\", fill = \"Status\", colour = \"Status\") +\n    theme(panel.grid.minor = element_blank(),\n          legend.position = \"bottom\",\n          plot.title = element_text(size = rel(1), face = \"bold\"))\n}\n\np_in <- plot_country(\"IN\", 6) + labs(title = \"Sites India\")\np_au <- plot_country(\"AU\", 6) + labs(title = \"Sites Australia\")\np_np <- plot_country(\"NP\", 2) + labs(title = \"Sites Nepal\")\np_nz <- plot_country(\"NZ\", 4) + labs(title = \"Sites New Zealand\")\np1 <- p_in / p_au\np2 <- (p_np | p_nz) + plot_layout(widths = c(1, 2))\np <- (p1 / p2) + \n  plot_layout(guides = \"collect\", heights = c(2,3.5,1)) &\n  theme(legend.position='bottom')\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(file.path(path, \"7-1-country-site.pdf\"), p, height = 7, width = 6)\np\n\n\n\n\n\nFigure 7: Progression to recovery by site."
  },
  {
    "objectID": "analyses/7-1_time_to_clinical_recovery.html#primary-model",
    "href": "analyses/7-1_time_to_clinical_recovery.html#primary-model",
    "title": "7-1 Time to clinical recovery during the first 28 days",
    "section": "Primary Model",
    "text": "Primary Model\n\n\nPrepare data\nX <- make_X_design(acs_itt_outdat, c(\"inelgc3\", \"agegte60\", \"ctry\"))\nXm <- X[, -1]\nepoch <- acs_itt_outdat$epoch\nM_epoch <- max(acs_itt_outdat$epoch)\nregion <- acs_itt_outdat$ctry_num\nM_region <- max(region)\nsite <- acs_itt_outdat$site_num\nM_site <- max(site)\nregion_by_site <- acs_itt_outdat %>% \n  dplyr::count(ctry_num, site_num) %>% \n  pull(ctry_num)\nsdat <- list(\n  N = nrow(acs_itt_outdat),\n  R = 2,\n  K = ncol(Xm),\n  M_region = M_region,\n  M_site = M_site,\n  M_epoch = M_epoch,\n  T = 28,\n  time = acs_itt_outdat$time,\n  site = site,\n  region_by_site = region_by_site,\n  epoch = epoch,\n  X = Xm,\n  y = as.matrix(acs_itt_outdat[, c(\"y0\", \"y1\", \"y2\")]),\n  beta_sd = c(1, 1, 1, 1, 1, 10, 2.5, 1, 1)\n)\n\n\n\n\nFit model\nfit <- mlogit_site_epoch$sample(\n  data = sdat, \n  chains = 3,\n  parallel_chains = 3,\n  iter_sampling = 500, \n  iter_warmup = 250,\n  adapt_delta = 0.99)\nfit$save_object(file.path(\"outputs\", \"models\", \"secondary\", \"7-1-ttr\", \"primary.rds\"))\n\n\n\n\nCode\nfit <- readRDS(file.path(\"outputs\", \"models\", \"secondary\", \"7-1-ttr\", \"primary.rds\"))\ndrws <- as_draws_rvars(fit$draws())\nrownames(drws$beta) <- colnames(sdat$X)\nepoch_map <- acs_itt_outdat %>% dplyr::count(epoch, epoch_lab)\nsite_map <- acs_itt_outdat %>% dplyr::count(site_num, site)\nrownames(drws$gamma_site) <- site_map$site\nrownames(drws$gamma_epoch) <- epoch_map$epoch_lab\ndrws$Ccon <- contr.orthonorm(4) %**% drws$beta[1:3, ]\nrownames(drws$Ccon) <- c(\"Low\", \"Intermediate\", \"Low with aspirin\", \"Therapeutic\")\ndrws$Ctrt <- drws$Ccon[-1, ] - drws$Ccon[1, ]\ndrws$shift <- rvar_apply(sweep(drws$beta[6:9, ], 1, colMeans(sdat$X)[6:9], \"*\"), 2, rvar_sum)\ndrws$alpha_shift <- sweep(drws$alpha, 2, drws$shift, \"+\")\ndrws$OR <- exp(rbind(drws$Ctrt, drws$beta[-(1:5), ]))\nrownames(drws$OR)[-(1:3)] <- c(\"Ineligible aspirin\", \"Age \\u2265 60\", \"Australia/New Zealand\", \"Nepal\")\ncolnames(drws$OR) <- c(\"Recovery\", \"Death\")\n\n\n\n\nCode\nsave_tex_table(\n  make_odds_ratio_table(drws, format = \"latex\"),\n  \"outcomes/secondary/7-1-primary-model-acs-itt-summary-table\"\n)\nmake_odds_ratio_table(drws)\n\n\n\n\n \n  \n    Factor \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR > 1) \n  \n \n\n  Recovery\n\n    Intermediate \n    1.13 \n    (0.98, 1.29) \n    1.13 (0.08) \n    0.95 \n  \n  \n    Low with aspirin \n    1.00 \n    (0.84, 1.19) \n    1.00 (0.09) \n    0.50 \n  \n  \n    Therapeutic \n    0.89 \n    (0.61, 1.29) \n    0.90 (0.18) \n    0.27 \n  \n  \n    Ineligible aspirin \n    0.77 \n    (0.49, 1.17) \n    0.78 (0.17) \n    0.11 \n  \n  \n    Age ≥ 60 \n    0.64 \n    (0.56, 0.74) \n    0.65 (0.05) \n    0.00 \n  \n  \n    Australia/New Zealand \n    0.72 \n    (0.40, 1.27) \n    0.75 (0.23) \n    0.13 \n  \n  \n    Nepal \n    0.68 \n    (0.23, 2.54) \n    0.85 (0.68) \n    0.24 \n  \n  Death\n\n    Intermediate \n    0.62 \n    (0.26, 1.47) \n    0.69 (0.31) \n    0.14 \n  \n  \n    Low with aspirin \n    0.92 \n    (0.37, 2.18) \n    1.01 (0.47) \n    0.42 \n  \n  \n    Therapeutic \n    2.96 \n    (0.75, 11.08) \n    3.71 (2.82) \n    0.94 \n  \n  \n    Ineligible aspirin \n    4.28 \n    (1.06, 15.46) \n    5.32 (4.07) \n    0.98 \n  \n  \n    Age ≥ 60 \n    0.89 \n    (0.41, 1.91) \n    0.96 (0.39) \n    0.38 \n  \n  \n    Australia/New Zealand \n    0.57 \n    (0.12, 2.66) \n    0.77 (0.69) \n    0.23 \n  \n  \n    Nepal \n    1.78 \n    (0.38, 7.88) \n    2.37 (2.07) \n    0.78 \n  \n\n\n\n\n\n\n\nCode\np1 <- plot_epoch_site_terms(\n  exp(drws$gamma_epoch)[, 1], \n  exp(drws$gamma_site)[, 1],\n  factor(\n    sdat$region_by_site, \n    labels = c(\"India\", \"Australia\\nNew Zealand\", \"Nepal\"))) +\n  plot_annotation(title = \"Recovery\")\np2 <- plot_epoch_site_terms(\n  exp(drws$gamma_epoch)[, 2], \n  exp(drws$gamma_site)[, 2],\n  factor(\n    sdat$region_by_site, \n    labels = c(\"India\", \"Australia\\nNew Zealand\", \"Nepal\"))) +\n  plot_annotation(title = \"Death\")\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\", \n                 \"7-1-primary-model-acs-itt-epoch-site-recovery.pdf\")\nggsave(pth, p1, width = 6, height = 4.5)\npth <- file.path(\"outputs\", \"figures\", \"outcomes\", \"primary\", \n                 \"7-1-primary-model-acs-itt-epoch-site-death.pdf\")\nggsave(pth, p2, width = 6, height = 4.5)\np1\n\n\n\n\n\nCode\np2\n\n\n\n\n\n\n\nCode\np <- plot_baseline_hazard(drws) +\n  coord_flip()\nggsave(\n  file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\", \"7-1-acs-itt-baseline-haz.pdf\"),\n  p, height = 3, width = 6\n)\np\n\n\n\n\n\nBaseline hazard (logit) for death and recovery."
  },
  {
    "objectID": "analyses/7-1_time_to_clinical_recovery.html#sensitivity-concurrent-enrolements",
    "href": "analyses/7-1_time_to_clinical_recovery.html#sensitivity-concurrent-enrolements",
    "title": "7-1 Time to clinical recovery during the first 28 days",
    "section": "Sensitivity: Concurrent Enrolements",
    "text": "Sensitivity: Concurrent Enrolements\n\nIntermediate dose\n\n\nCode\nsave_tex_table(\n  make_ttr_summary(acs_itt_concurc2_dat, \"latex\"),\n  file.path(\"outcomes\", \"secondary\", \"7-1-acs-itt-intermediate-summary\")\n)\nmake_ttr_summary(acs_itt_concurc2_dat)\n\n\n\n\n \n  \n    Intervention \n    Randomised \n    Known \n    Died \n    Recovered \n    Unrecovered \n    TTR, Median (Q1, Q3) \n  \n \n\n  \n    Low \n    610 \n    610 \n    15 (2.5) \n    592 (97.0) \n    3 (0.5) \n    6 (4.00, 7.00) \n  \n  \n    Intermediate \n    613 \n    613 \n    10 (1.6) \n    598 (97.6) \n    5 (0.8) \n    6 (4.00, 7.00) \n  \n\n\n\nSummary of time to recovery to day 28 by anticoagulation intervention.\n\n\n\nCode\np <- acs_itt_concurc2_nona_dat %>%\n  complete(CAssignment, time, fill = list(y = 0)) %>%\n  group_by(CAssignment, time) %>%\n  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = \"drop\") %>%\n  group_by(CAssignment) %>%\n  mutate(cy1 = cumsum(y1), \n         cp1 = cy1 / n[1],\n         cy2 = cumsum(y2),\n         cp2 = cy2 / n[1],\n         cpn = (n[1] - cy1 - cy2) / n[1]) %>%\n  ungroup() %>%\n  mutate(CAssignment = factor(\n    CAssignment, \n    levels = c(\"C1\", \"C2\", \"C3\", \"C4\"), \n    labels = str_replace(intervention_labels()$CAssignment[-1], \"<br>\", \" \"))) %>%\n  select(-y1, -y2, -cy1, -cy2) %>% \n  pivot_longer(cp1:cpn) %>% \n  mutate(name = factor(\n    name, \n    levels = c(\"cp1\", \"cp2\", \"cpn\"), \n    labels = c(\"Recovered\", \"Died\", \"Not recovered\"))) %>%\n  ggplot(., aes(time, value, fill = name, colour = name)) + \n  facet_wrap(~CAssignment) + \n  geom_col(width = 1) +\n  scale_fill_viridis_d(option = \"B\", begin = 0.2, end = 0.8) +\n  scale_colour_viridis_d(option = \"B\", begin = 0.2, end = 0.8) +\n  scale_x_continuous(breaks = c(1, 7, 14, 21, 28)) +\n  labs(x = \"Study day\", y = \"Cumulative proportion\", fill = \"Status\", colour = \"Status\") +\n  theme(panel.grid.minor = element_blank())\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(\n  file.path(path, \"outcome-7-1-descriptive-acs-itt-intermediate.pdf\"), \n  p, height = 2.5, width = 6)\np\n\n\n\n\n\nFigure 8: Progression to recovery by anticoagulation intervention.\n\n\n\n\n\n\nCode\n# Sanity check frequentist fit with smoothed time\nfreqfit <-vgam(\n  cbind(y0, y1, y2) ~ s(time) + CAssignment + agegte60 + ctry, \n  multinomial(refLevel = 1), \n  data = acs_itt_concurc2_nona_dat)\n\nX <- make_X_design(\n  acs_itt_concurc2_nona_dat, \n  c(\"agegte60\", \"ctry\"), \n  includeA = FALSE)\nXm <- X[, -1]\nsdat <- list(\n  N = nrow(acs_itt_concurc2_nona_dat),\n  R = 2,\n  K = ncol(Xm),\n  T = 28,\n  time = acs_itt_concurc2_nona_dat$time,\n  X = Xm,\n  y = as.matrix(acs_itt_concurc2_nona_dat[, c(\"y0\", \"y1\", \"y2\")]),\n  beta_sd = c(1, 2.5, 1, 1)\n)\n\n\n\n\nFit and save the model\nfit <- mlogit_rw$sample(\n  data = sdat, \n  seed = 71252,\n  chains = 4,\n  parallel_chains = parallel::detectCores(),\n  iter_sampling = 2500, \n  iter_warmup = 250,\n  adapt_delta = 0.95)\nfit$save_object(file.path(\"outputs\", \"models\", \"secondary\", \"7-1-ttr\", \"concurc2.rds\"))\n\n\n\n\nCode\nfit <- readRDS(file.path(\"outputs\", \"models\", \"secondary\", \"7-1-ttr\", \"concurc2.rds\"))\ndrws <- as_draws_rvars(fit$draws())\nrownames(drws$beta) <- colnames(sdat$X)\ndrws$Ccon <- contr.orthonorm(2) %**% drws$beta[1, ]\nrownames(drws$Ccon) <- c(\"Low\", \"Intermediate\")\ndrws$Ctrt <- drws$Ccon[-1, ] - drws$Ccon[1, ]\ndrws$shift <- rvar_apply(sweep(drws$beta[2:4, ], 1, colMeans(sdat$X)[2:4], \"*\"), 2, rvar_sum)\ndrws$alpha_shift <- sweep(drws$alpha, 2, drws$shift, \"+\")\ndrws$OR <- exp(rbind(\n  drws$Ctrt,\n  drws$beta[-1, ]\n))\nrownames(drws$OR) <- c(\"Intermediate\", \"Age \\u2265 60\", \"Australia/New Zealand\", \"Nepal\")\ncolnames(drws$OR) <- c(\"Recovery\", \"Death\")\n\n\n\n\nCode\nsave_tex_table(\n  make_odds_ratio_table(drws, format = \"latex\"),\n  \"outcomes/secondary/7-1-primary-model-acs-itt-intermediate-summary-table\"\n)\nmake_odds_ratio_table(drws)\n\n\n\n\n \n  \n    Factor \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR > 1) \n  \n \n\n  Recovery\n\n    Intermediate \n    1.14 \n    (1.00, 1.30) \n    1.14 (0.08) \n    0.97 \n  \n  \n    Age ≥ 60 \n    0.67 \n    (0.58, 0.78) \n    0.67 (0.05) \n    0.00 \n  \n  \n    Australia/New Zealand \n    0.70 \n    (0.57, 0.87) \n    0.71 (0.08) \n    0.00 \n  \n  \n    Nepal \n    0.68 \n    (0.53, 0.87) \n    0.69 (0.09) \n    0.00 \n  \n  Death\n\n    Intermediate \n    0.86 \n    (0.38, 1.89) \n    0.93 (0.39) \n    0.35 \n  \n  \n    Age ≥ 60 \n    1.05 \n    (0.46, 2.39) \n    1.14 (0.50) \n    0.55 \n  \n  \n    Australia/New Zealand \n    0.35 \n    (0.09, 1.01) \n    0.40 (0.24) \n    0.03 \n  \n  \n    Nepal \n    0.60 \n    (0.17, 1.72) \n    0.69 (0.40) \n    0.18 \n  \n\n\n\n\n\n\n\nCode\np <- plot_baseline_hazard(drws) +\n  coord_flip()\nggsave(\n  file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\", \n            \"7-1-concurrent-intermediate-baseline-haz.pdf\"),\n  p, height = 3, width = 6\n)\np\n\n\n\n\n\nBaseline hazard (logit) for death and recovery.\n\n\n\n\n\n\nCode\nhaz <- get_arm_specific_probs(drws, TRUE) %>%\n  mutate(intervention = fct_inorder(intervention))\npdat <- haz %>% \n  select(intervention, time, unrecovered = surv, recovered = cprob1, died = cprob2) %>%\n  pivot_longer(unrecovered:died, names_to = \"event\", values_to = \"posterior\")\nobsdat <- acs_itt_concurc2_nona_dat %>%\n  # filter(ctry == \"IN\", agegte60 == 0) %>%\n  complete(CAssignment, time, fill = list(y = 0)) %>%\n  group_by(intervention = factor(CAssignment, labels = c(\"Low\", \"Intermediate\")), time) %>%\n  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = \"drop\") %>%\n  group_by(intervention) %>%\n  mutate(cy1 = cumsum(y1), \n         recovered = cy1 / n[1],\n         cy2 = cumsum(y2),\n         died = cy2 / n[1],\n         unrecovered = (n[1] - cy1 - cy2) / n[1]) %>%\n  ungroup() %>%\n  pivot_longer(c(unrecovered, recovered, died), names_to = \"event\", values_to = \"proportion\")\np <- ggplot(pdat, aes(time, fill = event, colour = event)) +\n  facet_wrap( ~ intervention) +\n  geom_rect(aes(xmin = time, \n                xmax = time + 1,\n                ymin = quantile(posterior, 0.025), \n                ymax = quantile(posterior, 0.975)),\n              alpha = 0.25, colour = NA) +\n  geom_step(aes(y = median(posterior))) +\n  geom_point(data = obsdat, aes(y = proportion, x = time + 0.5)) +\n  scale_fill_viridis_d(\"Event\", option = \"B\", begin = 0.2, end = 0.8) +\n  scale_colour_viridis_d(\"Event\", option = \"B\", begin = 0.2, end = 0.8) +\n  scale_x_continuous(\"Day\", breaks = c(1, 7, 14, 21, 28), limits = c(1, 28)) +\n  labs(y = \"Proportion\")\nggsave(\n  file.path(\n    \"outputs\", \"figures\", \"outcomes\", \"secondary\", \n    \"7-1-concurrent-intermediate-marginal-ttr.pdf\"),\n  p, height = 2.5, width = 6\n)\np\n\n\n\n\n\nIntervention specific recovery progression (India, age < 60).\n\n\n\n\n\n\nLow-dose with aspirin\n\n\nCode\nsave_tex_table(\n  make_ttr_summary(acs_itt_concurc3_dat, \"latex\"),\n  file.path(\"outcomes\", \"secondary\", \"7-1-acs-itt-stdaspirin-summary\")\n)\nmake_ttr_summary(acs_itt_concurc3_dat)\n\n\n\n\n \n  \n    Intervention \n    Randomised \n    Known \n    Died \n    Recovered \n    Unrecovered \n    TTR, Median (Q1, Q3) \n  \n \n\n  \n    Low \n    299 \n    299 \n    10 (3.3) \n    286 (95.7) \n    3 (1.0) \n    6 (4.00, 8.00) \n  \n  \n    Intermediate \n    298 \n    298 \n    7 (2.3) \n    288 (96.6) \n    3 (1.0) \n    6 (4.00, 7.00) \n  \n  \n    Low with aspirin \n    283 \n    283 \n    9 (3.2) \n    271 (95.8) \n    3 (1.1) \n    6 (4.00, 8.00) \n  \n\n\n\nSummary of time to recovery to day 28 by anticoagulation intervention.\n\n\n\nCode\np <- acs_itt_concurc3_nona_dat %>%\n  complete(CAssignment, time, fill = list(y = 0)) %>%\n  group_by(CAssignment, time) %>%\n  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = \"drop\") %>%\n  group_by(CAssignment) %>%\n  mutate(cy1 = cumsum(y1), \n         cp1 = cy1 / n[1],\n         cy2 = cumsum(y2),\n         cp2 = cy2 / n[1],\n         cpn = (n[1] - cy1 - cy2) / n[1]) %>%\n  ungroup() %>%\n  mutate(CAssignment = factor(\n    CAssignment, \n    levels = c(\"C1\", \"C2\", \"C3\", \"C4\"), \n    labels = str_replace(intervention_labels()$CAssignment[-1], \"<br>\", \" \"))) %>%\n  select(-y1, -y2, -cy1, -cy2) %>% \n  pivot_longer(cp1:cpn) %>% \n  mutate(name = factor(\n    name, \n    levels = c(\"cp1\", \"cp2\", \"cpn\"), \n    labels = c(\"Recovered\", \"Died\", \"Not recovered\"))) %>%\n  ggplot(., aes(time, value, fill = name, colour = name)) + \n  facet_wrap(~CAssignment) + \n  geom_col(width = 1) +\n  scale_fill_viridis_d(option = \"B\", begin = 0.2, end = 0.8) +\n  scale_colour_viridis_d(option = \"B\", begin = 0.2, end = 0.8) +\n  scale_x_continuous(breaks = c(1, 7, 14, 21, 28)) +\n  labs(x = \"Study day\", y = \"Cumulative proportion\", fill = \"Status\", colour = \"Status\") +\n  theme(panel.grid.minor = element_blank())\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(\n  file.path(path, \"outcome-7-1-descriptive-acs-itt-stdaspirin.pdf\"), \n  p, height = 2.5, width = 6)\np\n\n\n\n\n\nFigure 9: Progression to recovery by anticoagulation intervention.\n\n\n\n\n\n\nFit and save the model\nX <- make_X_design(\n  acs_itt_concurc3_nona_dat, \n  c(\"agegte60\", \"ctry\"), \n  includeA = F)\nXm <- X[, -1]\nsdat <- list(\n  N = nrow(acs_itt_concurc3_nona_dat),\n  R = 2,\n  K = ncol(Xm),\n  T = 28,\n  time = acs_itt_concurc3_nona_dat$time,\n  X = Xm,\n  y = as.matrix(acs_itt_concurc3_nona_dat[, c(\"y0\", \"y1\", \"y2\")]),\n  beta_sd = c(1, 1, 2.5, 1)\n)\n\n\n\n\nFit and save the model\nfit <- mlogit_rw$sample(\n  data = sdat, \n  seed = 12085,\n  chains = 8,\n  parallel_chains = min(8, parallel::detectCores()),\n  iter_sampling = 2500, \n  iter_warmup = 1000,\n  adapt_delta = 0.99\n)\n# Save model to outputs\nfit$save_output_files(\n  dir = file.path(\"outputs\", \"models\", \"secondary\", \"7-1-ttr\"),\n  basename = \"concurc3\",\n  timestamp = FALSE, \n  random = FALSE)\nfit$save_object(file.path(\"outputs\", \"models\", \"secondary\", \"7-1-ttr\", \"concurc3.rds\"))\n\n\n\n\nLoad the model and summarise draws\nfit <- as_cmdstan_fit(\n  grep(\"concurc3-[0-9].csv\", \n       list.files(\n         file.path(\"outputs\", \"models\", \"secondary\", \"7-1-ttr\"), \n         full.names = T), \n       value = T)\n)\n\ndrws <- as_draws_rvars(fit$draws())\nrownames(drws$beta) <- colnames(sdat$X)\ndrws$Ccon <- attr(X, \"contrasts\")$randC %**% drws$beta[1:2, ]\nrownames(drws$Ccon) <- c(\"Low\", \"Intermediate\", \"Low with aspirin\")\ndrws$Ctrt <- drws$Ccon[-1, ] - drws$Ccon[1, ]\ndrws$shift <- rvar_apply(sweep(drws$beta[3:4, ], 1, colMeans(sdat$X)[3:4], \"*\"), 2, rvar_sum)\ndrws$alpha_shift <- sweep(drws$alpha, 2, drws$shift, \"+\")\ndrws$OR <- exp(rbind(\n  drws$Ctrt,\n  drws$beta[-(1:2), ]\n))\nrownames(drws$OR) <- c(\"Intermediate\", \"Low with aspirin\", \"Age \\u2265 60\", \"Australia/New Zealand\")\ncolnames(drws$OR) <- c(\"Recovery\", \"Death\")\n\n\n\n\nCode\nsave_tex_table(\n  make_odds_ratio_table(drws, format = \"latex\"),\n  \"outcomes/secondary/7-1-primary-model-acs-itt-stdaspirin-summary-table\"\n)\nmake_odds_ratio_table(drws)\n\n\n\n\n \n  \n    Factor \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR > 1) \n  \n \n\n  Recovery\n\n    Intermediate \n    1.22 \n    (1.01, 1.47) \n    1.22 (0.12) \n    0.98 \n  \n  \n    Low with aspirin \n    1.02 \n    (0.85, 1.23) \n    1.03 (0.10) \n    0.60 \n  \n  \n    Age ≥ 60 \n    0.75 \n    (0.63, 0.89) \n    0.75 (0.07) \n    0.00 \n  \n  \n    Australia/New Zealand \n    1.04 \n    (0.75, 1.42) \n    1.05 (0.17) \n    0.58 \n  \n  Death\n\n    Intermediate \n    1.00 \n    (0.38, 2.49) \n    1.11 (0.55) \n    0.50 \n  \n  \n    Low with aspirin \n    0.93 \n    (0.38, 2.24) \n    1.02 (0.48) \n    0.43 \n  \n  \n    Age ≥ 60 \n    1.40 \n    (0.63, 3.16) \n    1.53 (0.66) \n    0.79 \n  \n  \n    Australia/New Zealand \n    0.54 \n    (0.10, 2.30) \n    0.71 (0.60) \n    0.22 \n  \n\n\n\n\n\n\n\nCode\np <- plot_baseline_hazard(drws) +\n  coord_flip()\nggsave(\n  file.path(\n    \"outputs\", \"figures\", \"outcomes\", \"secondary\", \n    \"7-1-concurrent-stdaspirin-baseline-haz.pdf\"),\n  p, height = 3, width = 6\n)\np\n\n\n\n\n\n\n\nCode\nhaz <- get_arm_specific_probs(drws, TRUE) %>%\n  mutate(intervention = fct_inorder(intervention))\npdat <- haz %>% \n  select(intervention, time, unrecovered = surv, recovered = cprob1, died = cprob2) %>%\n  pivot_longer(unrecovered:died, names_to = \"event\", values_to = \"posterior\")\nobsdat <- acs_itt_concurc3_nona_dat %>%\n  # filter(ctry == \"IN\", agegte60 == 0) %>%\n  complete(CAssignment, time, fill = list(y = 0)) %>%\n  group_by(intervention = \n             factor(CAssignment, \n                    labels = c(\"Low\", \"Intermediate\", \"Low with aspirin\")), \n           time) %>%\n  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = \"drop\") %>%\n  group_by(intervention) %>%\n  mutate(cy1 = cumsum(y1), \n         recovered = cy1 / n[1],\n         cy2 = cumsum(y2),\n         died = cy2 / n[1],\n         unrecovered = (n[1] - cy1 - cy2) / n[1]) %>%\n  ungroup() %>%\n  pivot_longer(c(unrecovered, recovered, died), names_to = \"event\", values_to = \"proportion\")\n\np <- ggplot(pdat, aes(time, fill = event, colour = event)) +\n  facet_wrap( ~ intervention) +\n  geom_rect(aes(xmin = time, \n                xmax = time + 1,\n                ymin = quantile(posterior, 0.025), \n                ymax = quantile(posterior, 0.975)),\n              alpha = 0.25, colour = NA) +\n  geom_step(aes(y = median(posterior))) +\n  geom_point(data = obsdat, aes(y = proportion, x = time + 0.5)) +\n  scale_fill_viridis_d(\"Event\", option = \"B\", begin = 0.2, end = 0.8) +\n  scale_colour_viridis_d(\"Event\", option = \"B\", begin = 0.2, end = 0.8) +\n  scale_x_continuous(\"Day\", breaks = c(1, 7, 14, 21, 28), limits = c(1, 28)) +\n  labs(y = \"Proportion\")\nggsave(\n  file.path(\n    \"outputs\", \"figures\", \"outcomes\", \"secondary\", \n    \"7-1-concurrent-stdaspirin-marginal-ttr.pdf\"),\n  p, height = 2.5, width = 6\n)\np\n\n\n\n\n\nIntervention specific recovery progression (India, age < 60).\n\n\n\n\n\n\nTherapeutic dose\n\n\nCode\nsave_tex_table(\n  make_ttr_summary(acs_itt_concurc4_dat, \"latex\"),\n  file.path(\"outcomes\", \"secondary\", \"7-1-acs-itt-therapeutic-summary\")\n)\nmake_ttr_summary(acs_itt_concurc4_dat)\n\n\n\n\n \n  \n    Intervention \n    Randomised \n    Known \n    Died \n    Recovered \n    Unrecovered \n    TTR, Median (Q1, Q3) \n  \n \n\n  \n    Low \n    79 \n    79 \n    1 (1.3) \n    78 (98.7) \n    0 (0.0) \n    6 (4.25, 9.00) \n  \n  \n    Intermediate \n    65 \n    65 \n    1 (1.5) \n    63 (96.9) \n    1 (1.5) \n    6 (4.00, 9.00) \n  \n  \n    Therapeutic \n    50 \n    50 \n    4 (8.0) \n    46 (92.0) \n    0 (0.0) \n    6 (4.25, 9.00) \n  \n\n\n\nSummary of time to recovery to day 28 by anticoagulation intervention.\n\n\n\nCode\np <- acs_itt_concurc4_nona_dat %>%\n  complete(CAssignment, time, fill = list(y = 0)) %>%\n  group_by(CAssignment, time) %>%\n  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = \"drop\") %>%\n  group_by(CAssignment) %>%\n  mutate(cy1 = cumsum(y1), \n         cp1 = cy1 / n[1],\n         cy2 = cumsum(y2),\n         cp2 = cy2 / n[1],\n         cpn = (n[1] - cy1 - cy2) / n[1]) %>%\n  ungroup() %>%\n  mutate(CAssignment = factor(\n    CAssignment, \n    levels = c(\"C1\", \"C2\", \"C3\", \"C4\"), \n    labels = str_replace(intervention_labels()$CAssignment[-1], \"<br>\", \" \"))) %>%\n  select(-y1, -y2, -cy1, -cy2) %>% \n  pivot_longer(cp1:cpn) %>% \n  mutate(name = factor(\n    name, \n    levels = c(\"cp1\", \"cp2\", \"cpn\"), \n    labels = c(\"Recovered\", \"Died\", \"Not recovered\"))) %>%\n  ggplot(., aes(time, value, fill = name, colour = name)) + \n  facet_wrap(~CAssignment) + \n  geom_col(width = 1) +\n  scale_fill_viridis_d(option = \"B\", begin = 0.2, end = 0.8) +\n  scale_colour_viridis_d(option = \"B\", begin = 0.2, end = 0.8) +\n  scale_x_continuous(breaks = c(1, 7, 14, 21, 28)) +\nlabs(x = \"Study day\", y = \"Cumulative proportion\", fill = \"Status\", colour = \"Status\") +\n  theme(panel.grid.minor = element_blank())\npath <- file.path(\"outputs\", \"figures\", \"outcomes\", \"secondary\")\nggsave(\n  file.path(path, \"outcome-7-1-descriptive-acs-itt-therapeutic.pdf\"), \n  p, height = 2.5, width = 6)\np\n\n\n\n\n\nFigure 10: Progression to recovery by anticoagulation intervention, ACS-ITT-therapeutic.\n\n\n\n\n\n\nCode\n# Sanity check frequentist fit with smoothed time\nX <- make_X_design(\n  acs_itt_concurc4_nona_dat, \n  c(\"agegte60\", \"ctry\"), \n  includeA = F)\nXm <- X[, -1]\nsdat <- list(\n  N = nrow(acs_itt_concurc4_nona_dat),\n  R = 2,\n  K = ncol(Xm),\n  T = 28,\n  time = acs_itt_concurc4_nona_dat$time,\n  X = Xm,\n  y = as.matrix(acs_itt_concurc4_nona_dat[, c(\"y0\", \"y1\", \"y2\")]),\n  beta_sd = c(1, 1, 2.5, 1, 1)\n)\n\n\n\n\nFit and save the model\nfit <- mlogit_rw$sample(\n  data = sdat, \n  seed = 81743,\n  chains = 8,\n  parallel_chains = min(8, parallel::detectCores()),\n  iter_sampling = 2500, \n  iter_warmup = 1000,\n  adapt_delta = 0.95\n)\n# Save model to outputs\nfit$save_output_files(\n  dir = file.path(\"outputs\", \"models\", \"secondary\", \"7-1-ttr\"),\n  basename = \"concurc4\",\n  timestamp = FALSE, \n  random = FALSE)\nfit$save_object(file.path(\"outputs\", \"models\", \"secondary\", \"7-1-ttr\", \"concurc4.rds\"))\n\n\n\n\nLoad the model and summarise draws\nfit <- as_cmdstan_fit(\n  grep(\"concurc4-[0-9].csv\", \n       list.files(\n         file.path(\"outputs\", \"models\", \"secondary\", \"7-1-ttr\"), \n         full.names = T), \n       value = T)\n)\ndrws <- as_draws_rvars(fit$draws())\nrownames(drws$beta) <- colnames(sdat$X)\ndrws$Ccon <- attr(X, \"contrasts\")$randC %**% drws$beta[1:2, ]\nrownames(drws$Ccon) <- c(\"Low\", \"Intermediate\", \"Therapeutic\")\ndrws$Ctrt <- drws$Ccon[-1, ] - drws$Ccon[1, ]\ndrws$shift <- rvar_apply(sweep(drws$beta[3:5, ], 1, colMeans(sdat$X)[3:5], \"*\"), 2, rvar_sum)\ndrws$alpha_shift <- sweep(drws$alpha, 2, drws$shift, \"+\")\ndrws$OR <- exp(rbind(\n  drws$Ctrt,\n  drws$beta[-(1:2), ]\n))\nrownames(drws$OR) <- c(\"Intermediate\", \"Therapeutic\", \"Age \\u2265 60\", \"India\", \"Australia/New Zealand\")\ncolnames(drws$OR) <- c(\"Recovery\", \"Death\")\n\n\n\n\nCode\nsave_tex_table(\n  make_odds_ratio_table(drws, format = \"latex\"),\n  \"outcomes/secondary/7-1-primary-model-acs-itt-therapeutic-summary-table\"\n)\nmake_odds_ratio_table(drws)\n\n\n\n\n \n  \n    Factor \n    Median \n    95\\% CrI \n    Mean (SD) \n    Pr(OR > 1) \n  \n \n\n  Recovery\n\n    Intermediate \n    0.99 \n    (0.67, 1.45) \n    1.01 (0.20) \n    0.47 \n  \n  \n    Therapeutic \n    0.99 \n    (0.65, 1.49) \n    1.01 (0.21) \n    0.47 \n  \n  \n    Age ≥ 60 \n    0.47 \n    (0.32, 0.68) \n    0.48 (0.09) \n    0.00 \n  \n  \n    India \n    2.37 \n    (1.27, 4.31) \n    2.47 (0.78) \n    1.00 \n  \n  \n    Australia/New Zealand \n    1.22 \n    (0.84, 1.76) \n    1.24 (0.23) \n    0.86 \n  \n  Death\n\n    Intermediate \n    1.71 \n    (0.24, 11.60) \n    2.76 (3.46) \n    0.70 \n  \n  \n    Therapeutic \n    7.75 \n    (1.36, 51.10) \n    12.26 (14.77) \n    0.99 \n  \n  \n    Age ≥ 60 \n    0.10 \n    (0.01, 0.95) \n    0.19 (0.35) \n    0.02 \n  \n  \n    India \n    0.91 \n    (0.13, 5.90) \n    1.43 (1.69) \n    0.46 \n  \n  \n    Australia/New Zealand \n    0.33 \n    (0.07, 1.43) \n    0.44 (0.38) \n    0.08 \n  \n\n\n\n\n\n\n\nCode\np <- plot_baseline_hazard(drws) +\n  coord_flip()\nggsave(\n  file.path(\n    \"outputs\", \"figures\", \"outcomes\", \"secondary\", \n    \"7-1-concurrent-therapeutic-baseline-haz.pdf\"),\n  p, height = 3, width = 6\n)\np\n\n\n\n\n\n\n\nCode\nhaz <- get_arm_specific_probs(drws, TRUE) %>%\n  mutate(intervention = fct_inorder(intervention))\npdat <- haz %>% \n  select(intervention, time, unrecovered = surv, recovered = cprob1, died = cprob2) %>%\n  pivot_longer(unrecovered:died, names_to = \"event\", values_to = \"posterior\")\nobsdat <- acs_itt_concurc4_nona_dat %>%\n  # filter(ctry == \"NP\", agegte60 == 0) %>%\n  complete(nesting(StudyPatientID, CAssignment), time = 1:28, fill = list(y = 0)) %>%\n  group_by(intervention = \n             factor(CAssignment, \n                    labels = c(\"Low\", \"Intermediate\", \"Therapeutic\")), \n           time) %>%\n  summarise(n = n(), y1 = sum(y == 1), y2 = sum(y == 2), .groups = \"drop\") %>%\n  group_by(intervention) %>%\n  mutate(cy1 = cumsum(y1), \n         recovered = cy1 / n[1],\n         cy2 = cumsum(y2),\n         died = cy2 / n[1],\n         unrecovered = (n[1] - cy1 - cy2) / n[1]) %>%\n  ungroup() %>%\n  pivot_longer(c(unrecovered, recovered, died), names_to = \"event\", values_to = \"proportion\")\np <- ggplot(pdat, aes(time, fill = event, colour = event)) +\n  facet_wrap( ~ intervention) +\n  geom_rect(aes(xmin = time, \n                xmax = time + 1,\n                ymin = quantile(posterior, 0.025), \n                ymax = quantile(posterior, 0.975)),\n              alpha = 0.25, colour = NA) +\n  geom_step(aes(y = median(posterior))) +\n  geom_point(data = obsdat, aes(y = proportion, x = time + 0.5)) +\n  scale_fill_viridis_d(\"Event\", option = \"B\", begin = 0.2, end = 0.8) +\n  scale_colour_viridis_d(\"Event\", option = \"B\", begin = 0.2, end = 0.8) +\n  scale_x_continuous(\"Day\", breaks = c(1, 7, 14, 21, 28), limits = c(1, 28)) +\n  labs(y = \"Proportion\")\nggsave(\n  file.path(\n    \"outputs\", \"figures\", \"outcomes\", \"secondary\", \n    \"7-1-concurrent-therapeutic-marginal-ttr.pdf\"),\n  p, height = 2.5, width = 6\n)\np\n\n\n\n\n\nIntervention specific recovery progression (Nepal, age < 60)."
  }
]